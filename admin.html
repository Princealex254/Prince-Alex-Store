<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Online Store - Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; /* A fresh green */
            --secondary-color: #8BC34A; /* Lighter green */
            --text-color: #333;
            --light-bg: #f9f9f9;
            --white: #fff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --border-color: #ddd;
            --dark-text: #222;
            --star-color: #FFD700; /* Gold for stars */
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #66BB6A;
            --secondary-color: #9CCC65;
            --text-color: #E0E0E0;
            --light-bg: #2C2C2C;
            --white: #3A3A3A;
            --shadow: 0 4px 8px rgba(0,0,0,0.4);
            --border-color: #555;
            --dark-text: #F0F0F0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary-color);
        }

        .nav-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-icons span, .nav-icons button {
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            transition: color 0.3s;
        }
        .nav-icons span:hover, .nav-icons button:hover {
            color: var(--primary-color);
        }

        .hamburger-menu {
            display: none; /* Hidden on desktop */
            font-size: 24px;
            cursor: pointer;
        }

        main {
            flex-grow: 1;
        }

        section {
            padding: 60px 0;
            display: none; /* Hide all pages by default */
        }
        
        section.active {
            display: block; /* Show active page */
        }

        .hero {
            text-align: center;
            padding: 100px 20px;
            background-color: var(--secondary-color);
            color: var(--white);
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .hero p {
            font-size: 20px;
            margin-bottom: 30px;
        }

        .cta-button {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .cta-button:hover {
            background-color: var(--dark-text);
        }

        .section-title {
            text-align: center;
            font-size: 36px;
            margin-bottom: 40px;
            color: var(--primary-color);
        }

        .product-grid, .features-grid, .contact-info, .social-links, .about-content, .admin-orders-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .product-card, .feature-item, .order-card, .contact-submission-card {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .product-card h3 {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--dark-text);
        }

        .product-card .price {
            font-size: 18px;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-cart-btn:hover {
            background-color: var(--secondary-color);
        }

        .features-grid .feature-item h4 {
            color: var(--primary-color);
            margin-top: 10px;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .cart-table th, .cart-table td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-text);
        }

        .cart-table th {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quantity-controls button {
            background-color: var(--border-color);
            border: none;
            width: 30px;
            height: 30px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            color: var(--dark-text);
        }
        .quantity-controls button:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .cart-summary-totals {
            text-align: right;
            margin-top: 20px;
            color: var(--dark-text);
        }
        .cart-summary-totals div {
            font-size: 18px;
            margin-bottom: 5px;
        }
        .cart-summary-totals .cart-total-grand {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 10px;
        }

        .checkout-btn {
            display: block;
            margin-top: 20px;
            width: 100%;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 15px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: var(--secondary-color);
        }

        .forms-container, .contact-form-container, .admin-panel-login {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .admin-form input, .admin-form textarea, .contact-form input, .contact-form textarea, .order-track-form input, .admin-panel-login input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: inherit;
            background-color: var(--light-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .admin-form input:focus, .admin-form textarea:focus, .contact-form input:focus, .contact-form textarea:focus, .order-track-form input:focus, .admin-panel-login input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .admin-form button, .contact-form button, .order-track-form button, .admin-panel-login button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s;
        }

        .admin-form button:hover, .contact-form button:hover, .order-track-form button:hover, .admin-panel-login button:hover {
            background-color: var(--secondary-color);
        }

        #order-status {
            text-align: center;
            font-size: 20px;
            margin-top: 20px;
            color: var(--dark-text);
        }
        #order-status strong {
            color: var(--primary-color);
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        footer {
            background-color: var(--dark-text);
            color: var(--white);
            padding: 40px 0;
            margin-top: auto;
            transition: background-color 0.3s;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .footer-column h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .footer-column a {
            color: var(--white);
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
            transition: color 0.3s;
        }
        
        .footer-column a:hover {
            color: var(--primary-color);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .social-links a {
            font-size: 24px;
            color: var(--white);
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--primary-color);
        }

        .whatsapp-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .whatsapp-widget a {
            background-color: #25D366;
            color: var(--white);
            padding: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 24px;
            text-decoration: none;
            transition: transform 0.3s;
        }
        .whatsapp-widget a:hover {
            transform: scale(1.1);
        }

        /* Success/Error Message Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 80%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: translateY(-50px);
            opacity: 0;
            animation: fadeInDown 0.3s forwards;
            color: var(--dark-text);
        }

        @keyframes fadeInDown {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-content button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-content button:hover {
            background-color: var(--secondary-color);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
        }
        .close-button:hover {
            color: var(--primary-color);
        }

        /* Admin Panel - Orders and Products List */
        .admin-section {
            margin-top: 40px;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            color: var(--dark-text);
        }
        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-list-item:last-child {
            border-bottom: none;
        }
        .admin-list-item button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        .admin-list-item .delete-btn {
            background-color: #f44336;
            color: var(--white);
            border: none;
        }
        .admin-list-item .delete-btn:hover {
            background-color: #d32f2f;
        }
        .admin-list-item .mark-delivered-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
        }
        .admin-list-item .mark-delivered-btn:hover {
            background-color: var(--secondary-color);
        }
        .admin-list-item .status-delivered {
            color: var(--primary-color);
            font-weight: 600;
        }
        .admin-list-item .order-items-list {
            font-size: 0.9em;
            color: #666;
        }
        body.dark-mode .admin-list-item .order-items-list {
            color: #ccc;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .nav-links {
                display: none; /* Hide by default on mobile */
                flex-direction: column;
                width: 100%;
                background-color: var(--white);
                position: absolute;
                top: 70px; /* Adjust based on header height */
                left: 0;
                box-shadow: var(--shadow);
                padding: 20px 0;
                text-align: center;
            }
            .nav-links.active {
                display: flex; /* Show when active */
            }
            .nav-links li {
                margin-bottom: 10px;
            }
            .hamburger-menu {
                display: block; /* Show hamburger on mobile */
            }
            nav {
                flex-wrap: wrap;
            }
            .nav-icons {
                order: 1; /* Place icons first on small screens */
            }
            .logo {
                order: 2;
                flex-grow: 1;
                text-align: center;
            }
            .hamburger-menu {
                order: 3;
            }
            .hero h1 {
                font-size: 36px;
            }
            .product-grid, .features-grid, .admin-orders-grid {
                grid-template-columns: 1fr;
            }
            .footer-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">Prince Alex Store - Admin</div>
                <ul class="nav-links" id="nav-links">
                    <li><a href="#" class="page-link active" data-page="admin-home">Admin Home</a></li>
                    <li><a href="#" class="page-link" data-page="manage-products">Manage Products</a></li>
                    <li><a href="#" class="page-link" data-page="manage-orders">Manage Orders</a></li>
                    <li><a href="#" class="page-link" data-page="contact-submissions">Contact Submissions</a></li>
                    <li><a href="#" class="page-link" data-page="logout">Logout</a></li>
                </ul>
                <div class="nav-icons">
                    <button id="dark-mode-toggle"><i class="fas fa-moon"></i></button>
                    <span class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></span>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        
        <!-- Admin Home Page / Login -->
        <section id="admin-home-page" class="active">
            <h2 class="section-title">Admin Panel</h2>
            <div id="admin-login" class="admin-panel-login">
                <p>Please log in to access the Admin Panel.</p>
                <input type="email" id="admin-email" placeholder="Admin Email" value="admin@princealex.com">
                <input type="password" id="admin-password" placeholder="Password">
                <button onclick="loginAdmin()">Login</button>
            </div>
            <div id="admin-content" style="display: none;">
                <div class="hero">
                    <h1>Welcome, Admin!</h1>
                    <p>Manage products, orders, and customer inquiries.</p>
                </div>

                <div id="product-upload-form" class="forms-container">
                    <h3>Add a New Product</h3>
                    <form class="admin-form" onsubmit="addProduct(event)">
                        <input type="text" id="product-name" placeholder="Product Name" required>
                        <input type="text" id="product-image" placeholder="Image URL (e.g., https://...)" required>
                        <textarea id="product-description" rows="3" placeholder="Description" required></textarea>
                        <input type="number" id="product-price" placeholder="Price (KES)" required step="0.01">
                        <input type="text" id="product-unit" placeholder="Unit (e.g., per kg, per bunch)" required>
                        <input type="number" id="product-rating" placeholder="Rating (1-5)" min="1" max="5" step="0.1" value="4.5">
                        <input type="text" id="product-badge" placeholder="Badge (New, Best Seller, Organic, Discount, or leave empty)">
                        <input type="number" id="product-stock" placeholder="Stock (quantity)" required min="0" value="100">
                        <input type="text" id="product-tags" placeholder="Tags (comma-separated, e.g., Vitamin A-rich, Low calories)">
                        <input type="text" id="product-category" placeholder="Category (e.g., leafy greens, fruits)" required>
                        <button type="submit">Upload Product</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Manage Products Section -->
        <section id="manage-products-page">
            <h2 class="section-title">Manage Products</h2>
            <div class="admin-section">
                <h3>Current Products</h3>
                <div id="admin-product-list">
                    <p style="text-align: center;">Please log in to view products.</p>
                </div>
            </div>
        </section>

        <!-- Manage Orders Section -->
        <section id="manage-orders-page">
            <h2 class="section-title">Manage Orders</h2>
            <div class="admin-section">
                <h3>Customer Orders</h3>
                <div id="admin-order-list">
                    <p style="text-align: center;">Please log in to view orders.</p>
                </div>
            </div>
        </section>

        <!-- Contact Submissions Section -->
        <section id="contact-submissions-page">
            <h2 class="section-title">Contact Submissions</h2>
            <div class="admin-section">
                <h3>Customer Messages</h3>
                <div id="admin-contact-submissions">
                    <p style="text-align: center;">Please log in to view contact submissions.</p>
                </div>
            </div>
        </section>

    </main>

    <footer>
        <div class="container footer-grid">
            <div class="footer-column">
                <h4>Admin Links</h4>
                <a href="#" class="page-link" data-page="admin-home">Admin Home</a>
                <a href="#" class="page-link" data-page="manage-products">Manage Products</a>
                <a href="#" class="page-link" data-page="manage-orders">Manage Orders</a>
            </div>
            <div class="footer-column">
                <h4>Contact Info</h4>
                <p><i class="fas fa-phone-alt"></i> 0717384875</p>
                <p><i class="fas fa-envelope"></i> princealexdigital@gmail.com</p>
            </div>
            <div class="footer-column">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://tiktok.com" target="_blank"><i class="fab fa-tiktok"></i></a>
                    <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-column">
                <h4>Admin Tools</h4>
                <p>Quick access to backend management.</p>
            </div>
        </div>
    </footer>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, addDoc, updateDoc, deleteDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Firebase Configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyAlS1nqRKolwc-7mySezN6XBcwk5p2Al4U",
            authDomain: "prince-alex-store.firebaseapp.com",
            projectId: "prince-alex-store",
            storageBucket: "prince-alex-store.firebasestorage.app",
            messagingSenderId: "266163776280",
            appId: "1:266163776280:web:fdd89c30f84ed03540cc6d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let firebaseUser = null; // To store the logged-in admin user

        // --- UI Elements ---
        const pages = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.page-link');
        const adminLoginDiv = document.getElementById('admin-login');
        const adminContentDiv = document.getElementById('admin-content');
        const adminProductListDiv = document.getElementById('admin-product-list');
        const adminOrderListDiv = document.getElementById('admin-order-list');
        const adminContactSubmissionsDiv = document.getElementById('admin-contact-submissions');

        // Message Modal elements
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        // --- Utility Functions ---
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            messageModal.style.display = 'flex';
        }

        function closeModal() {
            messageModal.style.display = 'none';
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            navLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.page-link[data-page="${pageId.replace('-page', '')}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            // Close mobile menu if open
            document.getElementById('nav-links').classList.remove('active');

            // Specific page rendering/updates - only if user is logged in
            if (firebaseUser) {
                if (pageId === 'manage-products-page') {
                    renderAdminProducts();
                } else if (pageId === 'manage-orders-page') {
                    renderAdminOrders();
                } else if (pageId === 'contact-submissions-page') {
                    renderAdminContactSubmissions();
                }
            } else {
                // If not logged in, ensure content areas show login prompt
                adminProductListDiv.innerHTML = '<p style="text-align: center;">Please log in to view products.</p>';
                adminOrderListDiv.innerHTML = '<p style="text-align: center;">Please log in to view orders.</p>';
                adminContactSubmissionsDiv.innerHTML = '<p style="text-align: center;">Please log in to view contact submissions.</p>';
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'logout') {
                    logoutAdmin();
                } else {
                    showPage(pageData + '-page');
                }
            });
        });

        // --- Mobile Hamburger Menu ---
        document.getElementById('hamburger-menu').addEventListener('click', () => {
            document.getElementById('nav-links').classList.toggle('active');
        });

        // --- Dark Mode Toggle ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            // Save preference to localStorage (optional, but good for persistence)
            localStorage.setItem('darkModeAdmin', isDarkMode);
            darkModeToggle.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        });

        function applyDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkModeAdmin') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // --- Admin Authentication ---
        async function loginAdmin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            try {
                // Authenticate using Firebase signInWithEmailAndPassword
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Optional: You can add logic here to check for specific admin roles/claims
                // For example, if you set a custom claim 'admin: true' for admin users:
                // const idTokenResult = await userCredential.user.getIdTokenResult();
                // if (!idTokenResult.claims.admin) {
                //     await signOut(auth); // Log out if not an admin
                //     showModal('Access Denied', 'You do not have admin privileges.');
                //     return;
                // }

                showModal('Admin Login', 'Welcome to the Admin Panel!');
                adminLoginDiv.style.display = 'none';
                adminContentDiv.style.display = 'block';
                // Automatically load data after successful login
                renderAdminProducts();
                renderAdminOrders();
                renderAdminContactSubmissions();
            } catch (error) {
                let errorMessage = 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password. Please check your credentials and ensure the user exists in Firebase Authentication.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format.';
                }
                showModal('Login Failed', errorMessage);
                console.error("Admin login error:", error);
            }
        }

        async function logoutAdmin() {
            try {
                await signOut(auth);
                showModal('Logged Out', 'You have been successfully logged out.');
                adminLoginDiv.style.display = 'block';
                adminContentDiv.style.display = 'none';
                document.getElementById('admin-email').value = 'admin@princealex.com'; // Reset email
                document.getElementById('admin-password').value = ''; // Clear password
                showPage('admin-home-page'); // Go back to login screen
            } catch (error) {
                showModal('Logout Failed', 'Error logging out: ' + error.message);
                console.error("Admin logout error:", error);
            }
        }

        // --- Product Management (Firestore) ---
        async function addProduct(event) {
            event.preventDefault();
            const name = document.getElementById('product-name').value;
            const image = document.getElementById('product-image').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const unit = document.getElementById('product-unit').value;
            const rating = parseFloat(document.getElementById('product-rating').value);
            const badge = document.getElementById('product-badge').value;
            const stock = parseInt(document.getElementById('product-stock').value);
            const tagsInput = document.getElementById('product-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : [];
            const category = document.getElementById('product-category').value;

            if (!name || !image || !description || isNaN(price) || price <= 0 || !unit || isNaN(rating) || rating < 1 || rating > 5 || isNaN(stock) || stock < 0 || !category) {
                showModal('Error', 'Please fill out all fields correctly. Price and stock must be numbers, rating between 1-5.');
                return;
            }

            const originalPriceInput = prompt("Enter original price if this is an offer (leave blank otherwise):");
            const originalPrice = originalPriceInput ? parseFloat(originalPriceInput) : undefined;

            if (originalPriceInput && isNaN(originalPrice)) {
                showModal('Error', 'Invalid original price. Please enter a number or leave blank.');
                return;
            }

            const newProduct = { 
                name, 
                image, 
                description, 
                price, 
                unit, 
                rating, 
                badge, 
                stock, 
                tags, 
                category,
                originalPrice: originalPrice,
                createdAt: new Date().toISOString() // Timestamp for ordering
            };

            try {
                await addDoc(collection(db, "products"), newProduct);
                showModal('Product Added', `Product "${name}" added successfully!`);
                document.querySelector('.admin-form').reset();
                renderAdminProducts(); // Refresh the product list
            } catch (error) {
                console.error("Error adding product:", error);
                showModal('Error', 'Failed to add product. Please try again.');
            }
        }

        async function renderAdminProducts() {
            adminProductListDiv.innerHTML = '<p style="text-align: center;">Loading products...</p>';
            try {
                const productsCol = collection(db, "products");
                const q = query(productsCol, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    adminProductListDiv.innerHTML = '<p style="text-align: center;">No products to manage.</p>';
                    return;
                }

                adminProductListDiv.innerHTML = ''; // Clear loading message
                querySnapshot.forEach(doc => {
                    const product = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'admin-list-item';
                    listItem.innerHTML = `
                        <div>
                            <strong>${product.name}</strong> (KES ${product.price.toFixed(2)} / ${product.unit})<br>
                            Stock: ${product.stock}, Category: ${product.category}<br>
                            <small>ID: ${doc.id}</small>
                        </div>
                        <div>
                            <button class="delete-btn" onclick="deleteProduct('${doc.id}')">Delete</button>
                        </div>
                    `;
                    adminProductListDiv.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error rendering admin products:", error);
                adminProductListDiv.innerHTML = '<p style="text-align: center; color: red;">Error loading products for management.</p>';
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await deleteDoc(doc(db, "products", productId));
                    showModal('Product Deleted', 'Product removed successfully!');
                    renderAdminProducts(); // Refresh admin product list
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showModal('Error', 'Failed to delete product. Please try again.');
                }
            }
        }

        // --- Order Management (Firestore) ---
        async function renderAdminOrders() {
            adminOrderListDiv.innerHTML = '<p style="text-align: center;">Loading orders...</p>';
            try {
                const ordersCol = collection(db, "orders");
                const q = query(ordersCol, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    adminOrderListDiv.innerHTML = '<p style="text-align: center;">No orders to manage.</p>';
                    return;
                }

                adminOrderListDiv.innerHTML = ''; // Clear loading message
                querySnapshot.forEach(doc => {
                    const order = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'admin-list-item';
                    const itemsSummary = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    const statusClass = order.status === 'Delivered' ? 'status-delivered' : '';
                    listItem.innerHTML = `
                        <div>
                            <strong>Order ID: ${doc.id}</strong><br>
                            Customer: ${order.customer.fullName} (${order.customer.phoneNumber})<br>
                            Delivery: ${order.customer.deliveryLocation}, ${order.customer.houseName || 'N/A'}<br>
                            Total: KES ${order.total.toFixed(2)} (${order.paymentMethod})<br>
                            Status: <span class="${statusClass}">${order.status}</span><br>
                            Date: ${new Date(order.date).toLocaleString()}<br>
                            <span class="order-items-list">Items: ${itemsSummary}</span>
                        </div>
                        <div>
                            ${order.status !== 'Delivered' ? `<button class="mark-delivered-btn" onclick="markOrderDelivered('${doc.id}')">Mark Delivered</button>` : ''}
                        </div>
                    `;
                    adminOrderListDiv.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error rendering admin orders:", error);
                adminOrderListDiv.innerHTML = '<p style="text-align: center; color: red;">Error loading orders for management.</p>';
            }
        }

        async function markOrderDelivered(orderId) {
            if (confirm('Are you sure you want to mark this order as Delivered?')) {
                try {
                    await updateDoc(doc(db, "orders", orderId), { status: 'Delivered' });
                    showModal('Order Status Updated', 'Order marked as delivered!');
                    renderAdminOrders(); // Refresh admin order list
                } catch (error) {
                    console.error("Error updating order status:", error);
                    showModal('Error', 'Failed to update order status. Please try again.');
                }
            }
        }

        // --- Contact Submissions (Firestore) ---
        async function renderAdminContactSubmissions() {
            adminContactSubmissionsDiv.innerHTML = '<p style="text-align: center;">Loading contact submissions...</p>';
            try {
                const submissionsCol = collection(db, "contactSubmissions");
                const q = query(submissionsCol, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    adminContactSubmissionsDiv.innerHTML = '<p style="text-align: center;">No contact submissions.</p>';
                    return;
                }

                adminContactSubmissionsDiv.innerHTML = ''; // Clear loading message
                querySnapshot.forEach(doc => {
                    const submission = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'admin-list-item'; // Reusing style
                    listItem.innerHTML = `
                        <div>
                            <strong>From: ${submission.name} (${submission.email})</strong><br>
                            Message: ${submission.message}<br>
                            Date: ${new Date(submission.date).toLocaleString()}
                        </div>
                        <div>
                            <button class="delete-btn" onclick="deleteContactSubmission('${doc.id}')">Delete</button>
                        </div>
                    `;
                    adminContactSubmissionsDiv.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error rendering contact submissions:", error);
                adminContactSubmissionsDiv.innerHTML = '<p style="text-align: center; color: red;">Error loading contact submissions.</p>';
            }
        }

        async function deleteContactSubmission(submissionId) {
            if (confirm('Are you sure you want to delete this contact submission?')) {
                try {
                    await deleteDoc(doc(db, "contactSubmissions", submissionId));
                    showModal('Deleted', 'Contact submission deleted!');
                    renderAdminContactSubmissions(); // Refresh list
                } catch (error) {
                    console.error("Error deleting contact submission:", error);
                    showModal('Error', 'Failed to delete submission. Please try again.');
                }
            }
        }

        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, (user) => {
            firebaseUser = user;
            if (user) {
                // User is signed in, check if they are an admin
                // For this example, we assume any logged-in user to admin.html is an admin.
                // In a real app, you'd check custom claims or a separate 'admins' collection.
                adminLoginDiv.style.display = 'none';
                adminContentDiv.style.display = 'block';
                // Load data immediately if already logged in
                renderAdminProducts();
                renderAdminOrders();
                renderAdminContactSubmissions();
            } else {
                // User is signed out
                adminLoginDiv.style.display = 'block';
                adminContentDiv.style.display = 'none';

                // Clear content and show login prompt when logged out
                adminProductListDiv.innerHTML = '<p style="text-align: center;">Please log in to view products.</p>';
                adminOrderListDiv.innerHTML = '<p style="text-align: center;">Please log in to view orders.</p>';
                adminContactSubmissionsDiv.innerHTML = '<p style="text-align: center;">Please log in to view contact submissions.</p>';
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            applyDarkModePreference();
            // Initial page load, will be handled by onAuthStateChanged
        });
    </script>

</body>
</html>
