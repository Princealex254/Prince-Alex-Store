<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Store Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; /* A fresh green */
            --secondary-color: #8BC34A; /* Lighter green */
            --accent-color: #FF6B35; /* Vibrant orange for highlights */
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --text-color: #2c3e50;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 10px 25px rgba(0,0,0,0.08);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.12);
            --border-color: #e2e8f0;
            --dark-text: #1a202c;
            --gradient-primary: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            --gradient-accent: linear-gradient(135deg, #FF6B35 0%, #FF9800 100%);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Variables */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #66BB6A;
                --secondary-color: #9CCC65;
                --accent-color: #FF8A65;
                --text-color: #e2e8f0;
                --light-bg: #1a202c;
                --white: #2d3748;
                --card-bg: #2d3748;
                --shadow: 0 10px 25px rgba(0,0,0,0.3);
                --shadow-hover: 0 20px 40px rgba(0,0,0,0.4);
                --border-color: #4a5568;
                --dark-text: #f7fafc;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--light-bg) 0%, #e8f5e8 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        .section-title {
            text-align: center;
            font-size: 42px;
            margin-bottom: 48px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
        }

        .section-title::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        /* Forms */
        .forms-container {
            max-width: 520px;
            margin: 0 auto 40px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .forms-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .forms-container:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .forms-container h3, .forms-container p {
            text-align: center;
            margin-bottom: 24px;
            color: var(--dark-text);
        }

        .forms-container h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .forms-container p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .auth-form input {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: var(--transition);
            position: relative;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            transform: translateY(-1px);
        }

        .auth-form input::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }

        .auth-form button {
            width: 100%;
            padding: 18px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .auth-form button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .auth-form button:hover::before {
            left: 100%;
        }

        .auth-form button:active {
            transform: translateY(0);
        }

        /* Admin Content Navigation */
        .admin-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .admin-nav .cta-button {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .admin-nav .cta-button:hover {
            background: var(--gradient-primary);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .admin-nav .cta-button.active {
            background: var(--gradient-primary);
            color: var(--white);
            border-color: var(--primary-color);
        }

        /* Admin Sections */
        .admin-section {
            margin-top: 24px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            color: var(--dark-text);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .admin-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .admin-section:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 32px;
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            position: relative;
        }

        .admin-section h3::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        .admin-form input,
        .admin-form textarea {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: var(--transition);
            resize: vertical;
        }

        .admin-form input:focus,
        .admin-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            transform: translateY(-1px);
        }

        .admin-form textarea {
            min-height: 100px;
        }

        .admin-form button {
            width: 100%;
            padding: 18px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .admin-form button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .admin-form button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .admin-form button:hover::before {
            left: 100%;
        }

        hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 48px 0;
            position: relative;
        }

        hr::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            margin-bottom: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            font-size: 1.1em;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .admin-list-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .admin-list-item:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .admin-list-item:last-child {
            margin-bottom: 0;
        }

        .admin-list-item button {
            padding: 12px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 600;
            margin-left: 12px;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .admin-list-item .delete-btn {
            background: linear-gradient(135deg, var(--error-color) 0%, #d32f2f 100%);
            color: var(--white);
            border: none;
        }

        .admin-list-item .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.3);
        }

        .admin-list-item .mark-delivered-btn {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
        }

        .admin-list-item .mark-delivered-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .admin-list-item .status-delivered {
            color: var(--primary-color);
            font-weight: 600;
        }
        .admin-list-item .status-pending {
            color: #FFC107; /* Amber for pending */
            font-weight: 600;
        }

        .admin-list-item .order-items-list {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            padding-left: 20px;
        }

        .order-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .view-details-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
        }

        .view-details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }

        /* Customer Management Styles */
        .customer-search-section {
            margin-bottom: 32px;
        }

        .search-form {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 16px;
        }

        .search-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
        }

        .search-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .customer-profile-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 24px;
        }

        .customer-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .customer-profile-header h5 {
            font-size: 24px;
            color: var(--dark-text);
            margin: 0;
        }

        .customer-status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .customer-profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-section {
            background: var(--light-bg);
            padding: 16px;
            border-radius: var(--border-radius-sm);
        }

        .profile-section h6 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-section p {
            margin: 4px 0;
            font-size: 16px;
            color: var(--dark-text);
        }

        .profile-section strong {
            color: var(--primary-color);
        }

        .customer-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .action-btn i {
            font-size: 18px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }

        .orders-btn {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .orders-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .referrals-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
        }

        .referrals-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        .message-btn {
            background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
            color: white;
        }

        .message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(253, 126, 20, 0.3);
        }

        .status-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .create-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #FF6B35 0%, #e55a00 100%);
            color: white;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
        }

        /* Ensure voucher action buttons are clickable */
        .voucher-actions .action-btn {
            position: relative;
            z-index: 10;
            pointer-events: auto;
            cursor: pointer;
            user-select: none;
        }

        .voucher-actions .action-btn:active {
            transform: translateY(1px);
        }

        .voucher-actions .action-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* New Voucher Button */
        .new-voucher-button {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        .new-voucher-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
        }

        .new-voucher-button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .new-voucher-button:focus {
            outline: 3px solid rgba(76, 175, 80, 0.5);
            outline-offset: 2px;
        }

        .new-voucher-button i {
            font-size: 18px;
        }

        /* Simple Voucher Form */
        .simple-voucher-form {
            max-width: 100%;
            margin: 0 auto;
        }

        .simple-voucher-form .form-group {
            margin-bottom: 20px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .simple-voucher-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .simple-voucher-form input,
        .simple-voucher-form select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--white);
            transition: var(--transition);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }

        .simple-voucher-form input:focus,
        .simple-voucher-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .simple-voucher-form small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-color);
        }

        .simple-voucher-form .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .simple-voucher-form .cancel-btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .simple-voucher-form .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .simple-voucher-form .create-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .simple-voucher-form .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .simple-voucher-form .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Make voucher form scrollable */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simple-voucher-form {
            max-height: calc(90vh - 120px); /* Account for header and padding */
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px; /* Space for scrollbar */
            scroll-behavior: smooth;
        }

        /* Keep form header visible */
        .modal-content h3 {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Custom scrollbar styling */
        .simple-voucher-form::-webkit-scrollbar {
            width: 6px;
        }

        .simple-voucher-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .simple-voucher-form::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .simple-voucher-form::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        /* Responsive Design for Voucher Form */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .simple-voucher-form {
                max-height: calc(95vh - 100px);
                padding-right: 5px;
            }

            .simple-voucher-form {
                padding: 0;
            }

            .simple-voucher-form .form-group {
                margin-bottom: 15px;
                padding: 8px;
            }

            .simple-voucher-form label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .simple-voucher-form input,
            .simple-voucher-form select {
                padding: 10px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 6px;
            }

            .simple-voucher-form small {
                font-size: 11px;
                margin-top: 4px;
            }

            .simple-voucher-form .form-actions {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }

            .simple-voucher-form .cancel-btn,
            .simple-voucher-form .create-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 16px;
                border-radius: 6px;
            }

            .modal-content h3 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .close-button {
                top: 12px;
                right: 16px;
                font-size: 28px;
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            .simple-voucher-form {
                max-height: calc(98vh - 80px);
                padding-right: 3px;
            }

            .simple-voucher-form .form-group {
                margin-bottom: 12px;
                padding: 6px;
            }

            .simple-voucher-form input,
            .simple-voucher-form select {
                padding: 8px 10px;
                font-size: 14px;
            }

            .modal-content h3 {
                font-size: 20px;
                margin-bottom: 15px;
            }

            .simple-voucher-form .cancel-btn,
            .simple-voucher-form .create-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        /* Desktop optimizations */
        @media (min-width: 769px) {
            .modal-content {
                max-width: 600px;
                padding: 40px;
            }

            .simple-voucher-form {
                max-width: 500px;
                margin: 0 auto;
            }

            .simple-voucher-form .form-group {
                margin-bottom: 20px;
                padding: 15px;
            }

            .simple-voucher-form input,
            .simple-voucher-form select {
                padding: 12px 16px;
                font-size: 14px;
            }

            .simple-voucher-form .form-actions {
                justify-content: flex-end;
                gap: 12px;
            }

            .simple-voucher-form .cancel-btn,
            .simple-voucher-form .create-btn {
                padding: 12px 24px;
                font-size: 14px;
                width: auto;
            }
        }

        /* Universal Scrollable Modal System for Admin */
        .modal {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* Keep all modal headers visible */
        .modal-content h3 {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Custom scrollbar styling for all admin modals */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        /* Order Details Modal Scrollable */
        .order-details-modal {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .order-details-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .order-details-body {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
            scroll-behavior: smooth;
        }

        /* Order Edit Modal Scrollable */
        .order-edit-modal {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .order-edit-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .order-edit-body {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
            scroll-behavior: smooth;
        }

        /* Status Update Modal Scrollable */
        .status-update-modal {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .status-update-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* Responsive scrollable design for all admin modals */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .order-details-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .order-edit-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .status-update-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .order-details-body {
                max-height: calc(95vh - 120px);
                padding-right: 5px;
            }

            .order-edit-body {
                max-height: calc(95vh - 100px);
                padding-right: 5px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            .order-details-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            .order-edit-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            .status-update-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            .order-details-body {
                max-height: calc(98vh - 100px);
                padding-right: 3px;
            }

            .order-edit-body {
                max-height: calc(98vh - 80px);
                padding-right: 3px;
            }
        }

        .customer-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .customer-list-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .customer-list-info {
            flex: 1;
        }

        .customer-list-info h6 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 4px;
        }

        .customer-list-info p {
            font-size: 14px;
            color: var(--text-color);
            margin: 2px 0;
        }

        .customer-list-actions {
            display: flex;
            gap: 8px;
        }

        .customer-list-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-view-btn {
            background: var(--primary-color);
            color: white;
        }

        .quick-view-btn:hover {
            background: var(--secondary-color);
        }
        body.dark-mode .admin-list-item .order-items-list {
            color: #ccc;
        }

        /* Referral Analytics Styles */
        .referral-analytics {
            margin-bottom: 32px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: var(--transition);
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .analytics-card h5 {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-card span {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .referral-stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .referral-stats-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .referral-stats-item .customer-info {
            flex: 1;
        }

        .referral-stats-item .customer-info h6 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 4px;
        }

        .referral-stats-item .customer-info p {
            font-size: 14px;
            color: var(--text-color);
            margin: 2px 0;
        }

        .referral-stats-item .stats-info {
            text-align: right;
            margin-left: 20px;
        }

        .referral-stats-item .stats-info .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .referral-stats-item .stats-info .stat-label {
            font-size: 12px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .referral-activity-item {
            padding: 20px;
            margin-bottom: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
        }

        .referral-activity-item .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .referral-activity-item .activity-header .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .referral-activity-item .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .referral-activity-item .status-accepted {
            background: #d4edda;
            color: #155724;
        }

        .referral-activity-item .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .referral-activity-item .activity-details {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.5;
        }

        .referral-activity-item .activity-details strong {
            color: var(--dark-text);
        }

        /* Modal Alerts */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            width: 90%;
            max-width: 520px;
            text-align: center;
            position: relative;
            color: var(--dark-text);
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 24px;
            font-size: 28px;
            font-weight: 600;
        }

        .modal-content p {
            margin-bottom: 32px;
            font-size: 16px;
            line-height: 1.6;
        }

        .modal-content button {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 14px 28px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .modal-content button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .close-button {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-button:hover {
            color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
        }

        footer {
            background: linear-gradient(135deg, var(--dark-text) 0%, #2c3e50 100%);
            color: var(--white);
            padding: 32px 0;
            text-align: center;
            margin-top: auto;
            position: relative;
        }

        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .section-title {
                font-size: 32px;
                margin-bottom: 32px;
            }
            
            .forms-container {
                padding: 32px 24px;
                margin-bottom: 32px;
            }
            
            .admin-nav {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }
            
            .admin-nav .cta-button {
                width: 100%;
                padding: 16px 24px;
            }
            
            .admin-section {
                padding: 32px 24px;
            }
            
            .admin-section h3 {
                font-size: 24px;
                margin-bottom: 24px;
            }
            
            .admin-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
                padding: 20px;
            }
            
            .admin-list-item button {
                width: 100%;
                margin-left: 0;
                padding: 14px 20px;
            }
            
            .modal-content {
                padding: 32px 24px;
                margin: 20px;
            }
            
            .modal-content h3 {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 28px;
            }
            
            .forms-container {
                padding: 24px 16px;
            }
            
            .admin-section {
                padding: 24px 16px;
            }
            
            .admin-section h3 {
                font-size: 20px;
            }
        }

        /* Order Management Styles */
        .order-controls {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .search-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .search-input-group {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .filter-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .refresh-btn {
            padding: 10px 16px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Voucher Management Styles */
        .voucher-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .voucher-stats {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .voucher-stats h4 {
            margin-bottom: 16px;
            color: var(--dark-text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .voucher-filters {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .voucher-filters h4 {
            margin-bottom: 16px;
            color: var(--dark-text);
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            font-size: 14px;
            transition: var(--transition);
        }

        .filter-controls select:focus,
        .filter-controls input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .voucher-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            overflow: hidden;
            transition: var(--transition);
        }

        .voucher-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .voucher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .voucher-info h4 {
            margin: 0 0 8px 0;
            color: var(--dark-text);
            font-size: 18px;
        }

        .voucher-code {
            font-family: 'Courier New', monospace;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .voucher-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .voucher-status.active {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .voucher-status.inactive {
            background: #fff3cd;
            color: #856404;
        }

        .voucher-status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .voucher-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            padding: 20px;
        }

        .voucher-detail {
            text-align: center;
        }

        .voucher-detail-label {
            font-size: 12px;
            color: var(--text-color);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .voucher-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .voucher-actions-card {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: var(--light-bg);
            border-top: 1px solid var(--border-color);
        }

        .voucher-action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .voucher-action-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .voucher-action-btn.toggle {
            background: #fff3cd;
            color: #856404;
        }

        .voucher-action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .voucher-action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.8;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-color);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .cancel-btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .create-btn {
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .orders-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
        }

        .orders-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .order-card {
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            transition: var(--transition);
        }

        .order-card:last-child {
            border-bottom: none;
        }

        .order-card:hover {
            background: var(--light-bg);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-id {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .order-date {
            font-size: 14px;
            color: var(--text-color);
        }

        .order-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-processing {
            background: #d4edda;
            color: #155724;
        }

        .status-transit {
            background: #cce5ff;
            color: #004085;
        }

        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .order-info-label {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .order-info-value {
            font-size: 14px;
            color: var(--dark-text);
            font-weight: 600;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-view {
            background: var(--primary-color);
            color: white;
        }

        .btn-view:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-status {
            background: var(--accent-color);
            color: white;
        }

        .btn-status:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
        }

        .loading-state i {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--border-color);
        }

        /* Order Details Modal */
        .order-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .order-details-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
        }

        .order-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .order-details-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .order-details-body {
            display: grid;
            gap: 24px;
        }

        .details-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius-sm);
        }

        .details-section h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 12px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: var(--dark-text);
            font-weight: 600;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-card {
            background: var(--white);
            padding: 16px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .item-details {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-color);
        }

        /* Status Update Modal */
        .status-update-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .status-update-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            max-width: 500px;
            box-shadow: var(--shadow-hover);
        }

        .status-options {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .status-option {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-option:hover {
            border-color: var(--primary-color);
            background: rgba(76, 175, 80, 0.05);
        }

        .status-option.selected {
            border-color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
        }

        .status-icon {
            font-size: 18px;
        }

        .status-text {
            font-weight: 600;
        }

        /* Voucher Management Styles */
        .voucher-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .voucher-stats {
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-card h5 {
            margin: 0 0 8px 0;
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
        }

        .stat-card span {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .voucher-filters {
            margin-bottom: 24px;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            color: var(--text-color);
        }

        .filter-controls input {
            flex: 1;
            min-width: 200px;
        }

        .voucher-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .voucher-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .voucher-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .voucher-info h4 {
            margin: 0 0 4px 0;
            color: var(--dark-text);
            font-size: 18px;
        }

        .voucher-code {
            font-family: 'Courier New', monospace;
            background: var(--light-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .voucher-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .voucher-status.active {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .voucher-status.inactive {
            background: #ffebee;
            color: #f44336;
        }

        .voucher-status.expired {
            background: #fff3e0;
            color: #ff9800;
        }

        .voucher-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .voucher-detail {
            text-align: center;
        }

        .voucher-detail-label {
            font-size: 12px;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .voucher-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .voucher-actions-card {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .voucher-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .voucher-action-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .voucher-action-btn.toggle {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .voucher-action-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .voucher-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-color);
            font-size: 12px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .create-btn {
            background: var(--primary-color);
            color: white;
        }

        .form-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .search-section {
                flex-direction: column;
            }

            .filter-section {
                flex-direction: column;
            }

            .voucher-actions {
                flex-direction: column;
            }

            .filter-controls {
                flex-direction: column;
            }

            .voucher-header {
                flex-direction: column;
                gap: 12px;
            }

            .voucher-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

            .order-summary {
                grid-template-columns: 1fr;
            }

            .order-actions {
                flex-direction: column;
            }

            .order-details-content {
                margin: 16px;
                max-width: calc(100% - 32px);
            }

            .details-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Professional Admin Layout Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--light-bg) 0%, #e8f5e8 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-subtitle {
            color: var(--text-color);
            font-size: 18px;
            margin-top: 10px;
        }

        .login-description {
            color: var(--text-color);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Admin Dashboard Layout */
        #admin-dashboard {
            display: flex;
            min-height: 100vh;
            background: var(--light-bg);
        }

        /* Sidebar Styles */
        .admin-sidebar {
            width: 280px;
            background: var(--white);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--gradient-primary);
            color: white;
        }

        .sidebar-header .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: white;
            background: none;
            -webkit-text-fill-color: white;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .admin-details {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            font-size: 14px;
        }

        .admin-email {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 24px 12px;
            opacity: 0.7;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
        }

        .nav-item:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }

        .nav-item.active {
            background: rgba(76, 175, 80, 0.1);
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-badge {
            background: var(--accent-color);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Main Content Area */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-header {
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--light-bg);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-text);
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--light-bg);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .stat-item i {
            color: var(--primary-color);
        }

        /* Content Area */
        .admin-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 32px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-text);
            margin: 0 0 8px 0;
        }

        .section-header p {
            color: var(--text-color);
            font-size: 16px;
            margin: 0;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: var(--transition);
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .card-content h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 8px 0;
        }

        .card-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-text);
            margin: 0 0 4px 0;
        }

        .card-change {
            font-size: 12px;
            color: var(--text-color);
        }

        .card-change.positive {
            color: var(--success-color);
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .chart-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin: 0 0 20px 0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: var(--light-bg);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .quick-action-btn i {
            font-size: 20px;
        }

        .quick-action-btn span {
            font-size: 12px;
            font-weight: 600;
        }

        /* Products Layout */
        .products-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
        }

        .products-sidebar {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .products-main {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .products-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark-text);
            margin: 0;
        }

        .products-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .products-list {
            display: grid;
            gap: 16px;
        }

        /* Recent Orders Styles */
        .recent-orders {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recent-order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .recent-order-item:hover {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .recent-order-item .order-info {
            flex: 1;
        }

        .recent-order-item .order-id {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 14px;
        }

        .recent-order-item .order-customer {
            color: var(--text-color);
            font-size: 12px;
            margin-top: 2px;
        }

        .recent-order-item .order-status {
            margin: 0 16px;
        }

        .recent-order-item .order-total {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        /* Order Editing Styles */
        .order-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .edit-order-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
        }

        .edit-order-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .order-edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .order-edit-content {
            background-color: var(--white);
            margin: 2% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
        }

        .order-edit-body {
            padding: 24px;
        }

        .edit-section {
            margin-bottom: 24px;
        }

        .edit-section h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light-bg);
        }

        .editable-items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .editable-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .editable-item:hover {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 4px;
        }

        .item-unit {
            color: var(--text-color);
            font-size: 14px;
        }

        .item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-input {
            width: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-weight: 600;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--secondary-color);
        }

        .quantity-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 80px;
            text-align: right;
        }

        .remove-item-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
        }

        .remove-item-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .order-summary-edit {
            background: var(--light-bg);
            padding: 16px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .total-row {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 8px;
            padding-top: 12px;
        }

        #modification-notes {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .edit-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .cancel-btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .save-btn {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .save-btn:hover {
            background: var(--secondary-color);
        }

        .save-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .admin-sidebar {
                transform: translateX(-100%);
            }

            .admin-sidebar.open {
                transform: translateX(0);
            }

            .admin-main {
                margin-left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .dashboard-charts {
                grid-template-columns: 1fr;
            }

            .products-container {
                grid-template-columns: 1fr;
            }

            .products-sidebar {
                order: 2;
            }

            .products-main {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .admin-content {
                padding: 16px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header-stats {
                display: none;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .section-header h2 {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .login-card {
                padding: 24px;
                margin: 16px;
            }

            .admin-content {
                padding: 12px;
            }

            .dashboard-card {
                padding: 16px;
            }

            .card-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .card-number {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

    <!-- Admin Login Section -->
    <div id="admin-login-section" class="login-container">
        <div class="login-card">
            <div class="login-header">
            <div class="logo">Prince Alex Store Admin</div>
                <p class="login-subtitle">Admin Panel Access</p>
        </div>
            <p class="login-description">Please log in with your account credentials to access the admin dashboard. Any registered user can access the admin panel.</p>
            <form id="admin-login-form" class="auth-form">
                <input type="email" id="admin-email" placeholder="Your Email Address" required>
                <input type="password" id="admin-password" placeholder="Your Password" required>
                <button type="submit">Access Admin Panel</button>
            </form>
        </div>
        </div>

    <!-- Admin Dashboard Layout -->
    <div id="admin-dashboard" style="display: none;">
        <!-- Sidebar Navigation -->
        <aside id="admin-sidebar" class="admin-sidebar">
            <div class="sidebar-header">
                <div class="logo">Prince Alex Store</div>
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-details">
                        <div class="admin-name" id="admin-name">Admin User</div>
                        <div class="admin-email" id="admin-email-display">admin@example.com</div>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#" class="nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-item" data-page="products">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </a>
                    <a href="#" class="nav-item" data-page="orders">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                        <span class="nav-badge" id="pending-orders-badge">0</span>
                    </a>
                    <a href="#" class="nav-item" data-page="customers">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Marketing</div>
                    <a href="#" class="nav-item" data-page="referrals">
                        <i class="fas fa-share-alt"></i>
                        <span>Referrals</span>
                    </a>
                    <a href="#" class="nav-item" data-page="vouchers">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Vouchers</span>
                        <span class="nav-badge" id="active-vouchers-badge">0</span>
                    </a>
                    <a href="#" class="nav-item" data-page="contacts">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                        <span class="nav-badge" id="unread-messages-badge">0</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" id="admin-logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Log Out</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <!-- Top Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button id="sidebar-toggle" class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="header-stats">
                        <div class="stat-item">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="header-total-orders">0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span id="header-pending-orders">0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span id="header-total-customers">0</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="admin-content">
                <!-- Dashboard Overview -->
                <div id="admin-dashboard-section" class="admin-section admin-page active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="card-content">
                                <h3>Total Orders</h3>
                                <div class="card-number" id="dashboard-total-orders">0</div>
                                <div class="card-change positive">+12% from last month</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="card-content">
                                <h3>Pending Orders</h3>
                                <div class="card-number" id="dashboard-pending-orders">0</div>
                                <div class="card-change">Needs attention</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="card-content">
                                <h3>Total Customers</h3>
                                <div class="card-number" id="dashboard-total-customers">0</div>
                                <div class="card-change positive">+8% from last month</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="card-content">
                                <h3>Revenue</h3>
                                <div class="card-number" id="dashboard-revenue">KES 0</div>
                                <div class="card-change positive">+15% from last month</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-charts">
                        <div class="chart-card">
                            <h3>Recent Orders</h3>
                            <div id="recent-orders-list" class="recent-orders">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading recent orders...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3>Quick Actions</h3>
                            <div class="quick-actions">
                                <button class="quick-action-btn" data-page="products">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Product</span>
                                </button>
                                <button class="quick-action-btn" data-page="orders">
                                    <i class="fas fa-eye"></i>
                                    <span>View Orders</span>
                                </button>
                                <button class="quick-action-btn" data-page="customers">
                                    <i class="fas fa-search"></i>
                                    <span>Search Customer</span>
                                </button>
                                <button class="quick-action-btn" data-page="contacts">
                                    <i class="fas fa-envelope"></i>
                                    <span>View Messages</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Manage Products Section -->
                <div id="admin-products-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Product Management</h2>
                        <p>Manage your product inventory and add new products</p>
                    </div>
                    
                    <div class="products-container">
                        <div class="products-sidebar">
                <h3>Add New Product</h3>
                <form id="add-product-form" class="admin-form">
                    <input type="text" id="product-name" placeholder="Product Name" required>
                    <input type="url" id="product-image-url" placeholder="Image URL (e.g., https://.../image.jpg)" required>
                    <div id="image-preview" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <!-- Image preview will be shown here -->
                    </div>
                    <textarea id="product-description" rows="3" placeholder="Product Description" required></textarea>
                    <input type="number" id="product-price" placeholder="Price (KES)" step="0.01" required>
                    <input type="text" id="product-unit" placeholder="Unit (e.g., per Kg)" required>
                    <input type="number" id="product-stock" placeholder="Stock Quantity" min="0" required>
                    <select id="product-category" required>
                        <option value="">Select Category</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="leafy greens">Leafy Greens</option>
                        <option value="herbs">Herbs</option>
                        <option value="fruits">Fruits</option>
                        <option value="organic">Organic</option>
                    </select>
                    <input type="number" id="product-rating" placeholder="Rating (1-5)" min="1" max="5" step="0.1" value="4.5">
                    <input type="text" id="product-tags" placeholder="Tags (comma-separated, e.g., fresh, organic, local)">
                    <button type="submit">Add Product</button>
                </form>
                        </div>
                        
                        <div class="products-main">
                            <div class="products-header">
                <h3>Existing Products</h3>
                                <div class="products-actions">
                                    <button class="action-btn" onclick="loadProducts()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="products-list" class="products-list">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading products...</p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Manage Orders Section -->
                <div id="admin-orders-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Order Management</h2>
                        <p>Manage customer orders and track delivery status</p>
                    </div>
                
                <!-- Order Search and Filters -->
                <div class="order-controls">
                    <div class="search-section">
                        <div class="search-input-group">
                            <input type="text" id="order-search" placeholder="Search by email, phone, or order ID..." class="search-input">
                            <button type="button" id="search-orders-btn" class="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="filter-section">
                            <select id="status-filter" class="filter-select">
                                <option value="">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Confirmed">Confirmed</option>
                                <option value="Processing">Processing</option>
                                <option value="On Transit">On Transit</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                            <select id="date-filter" class="filter-select">
                                <option value="">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                            <button type="button" id="refresh-orders-btn" class="refresh-btn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Orders Statistics -->
                <div class="orders-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-orders">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="processing-orders">0</div>
                        <div class="stat-label">Processing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="delivered-orders">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                </div>

                <!-- Orders List -->
                <div id="orders-list" class="orders-container">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading orders...</p>
                    </div>
                </div>
            </div>

            <!-- Manage Customers Section -->
                <div id="admin-customers-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Customer Management</h2>
                        <p>Search and manage customer accounts</p>
                    </div>
                
                <!-- Customer Search -->
                <div class="customer-search-section">
                    <h4> Search Customer</h4>
                    <div class="search-form">
                        <input type="email" id="customer-search-email" placeholder="Enter customer email address" required>
                        <button onclick="searchCustomer()" class="cta-button">Search Customer</button>
                    </div>
                </div>

                <hr>

                <!-- Customer Details -->
                <div id="customer-details-section" style="display: none;">
                    <h4> Customer Profile</h4>
                    <div id="customer-profile-display">
                        <!-- Customer profile will be loaded here -->
                    </div>
                </div>

                <hr>

                <!-- Customer Actions -->
                <div id="customer-actions-section" style="display: none;">
                    <h4> Customer Actions</h4>
                    <div class="customer-actions-grid">
                        <button onclick="editCustomerProfile()" class="action-btn edit-btn">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button onclick="resetCustomerPassword()" class="action-btn reset-btn">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                        <button onclick="viewCustomerOrders()" class="action-btn orders-btn">
                            <i class="fas fa-shopping-bag"></i> View Orders
                        </button>
                        <button onclick="viewCustomerReferrals()" class="action-btn referrals-btn">
                            <i class="fas fa-users"></i> View Referrals
                        </button>
                        <button onclick="sendCustomerMessage()" class="action-btn message-btn">
                            <i class="fas fa-envelope"></i> Send Message
                        </button>
                        <button onclick="toggleCustomerStatus()" class="action-btn status-btn">
                            <i class="fas fa-user-check"></i> Toggle Status
                        </button>
                    </div>
                </div>

                <hr>

                <!-- All Customers List -->
                <h4> All Customers</h4>
                <div id="all-customers-list">
                    <p style="text-align: center;">Loading customers...</p>
                </div>
            </div>

            <!-- Manage Referrals Section -->
                <div id="admin-referrals-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Referral Management</h2>
                        <p>Track referral activities and rewards</p>
                    </div>
                
                <!-- Referral Analytics -->
                <div class="referral-analytics">
                    <h4> Referral Analytics</h4>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h5>Total Referrals</h5>
                            <span id="total-referrals-count">0</span>
                        </div>
                        <div class="analytics-card">
                            <h5>Successful Referrals</h5>
                            <span id="successful-referrals-count">0</span>
                        </div>
                        <div class="analytics-card">
                            <h5>Total Rewards Given</h5>
                            <span id="total-rewards-given">0</span>
                        </div>
                        <div class="analytics-card">
                            <h5>Top Referrers</h5>
                            <span id="top-referrers-count">0</span>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Customer Referral Stats -->
                <h4> Customer Referral Stats</h4>
                <div id="customer-referral-stats">
                    <p style="text-align: center;">Loading customer referral data...</p>
                </div>

                <hr>

                <!-- All Referrals -->
                <h4> All Referral Activities</h4>
                <div id="all-referrals-list">
                    <p style="text-align: center;">Loading referral activities...</p>
                </div>

                <hr>

                <!-- Referral Visits -->
                <h4> Referral Visits</h4>
                <div id="referral-visits-list">
                    <p style="text-align: center;">Loading referral visits...</p>
                </div>
            </div>

            <!-- Manage Contact Submissions Section -->
                <div id="admin-contacts-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Contact Messages</h2>
                        <p>View and manage customer inquiries</p>
                    </div>
                <div id="contact-submissions-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading messages...</p>
                        </div>
                    </div>
                </div>

                <!-- Voucher Management Section -->
                <div id="admin-vouchers-section" class="admin-section admin-page">
                    <div class="section-header">
                        <h2>Voucher Management</h2>
                        <p>Create, manage, and track voucher usage</p>
                    </div>

                    <!-- Voucher Actions -->
                    <div class="voucher-actions">
                        <button id="new-voucher-btn" class="new-voucher-button">
                            <i class="fas fa-plus"></i> Create New Voucher
                        </button>
                        <button onclick="refreshVouchers()" class="action-btn refresh-btn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>

                    <!-- Voucher Statistics -->
                    <div class="voucher-stats">
                        <h4> Voucher Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h5>Active Vouchers</h5>
                                <span id="active-vouchers-count">0</span>
                            </div>
                            <div class="stat-card">
                                <h5>Total Usage</h5>
                                <span id="total-voucher-usage">0</span>
                            </div>
                            <div class="stat-card">
                                <h5>Total Discount Given</h5>
                                <span id="total-discount-given">KES 0.00</span>
                            </div>
                            <div class="stat-card">
                                <h5>Expired Vouchers</h5>
                                <span id="expired-vouchers-count">0</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Voucher Filters -->
                    <div class="voucher-filters">
                        <h4> Filter Vouchers</h4>
                        <div class="filter-controls">
                            <select id="voucher-status-filter" onchange="filterVouchers()">
                                <option value="all">All Vouchers</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive Only</option>
                                <option value="expired">Expired Only</option>
                            </select>
                            <input type="text" id="voucher-search" placeholder="Search by code or description..." onkeyup="filterVouchers()">
                        </div>
                    </div>

                    <hr>

                    <!-- Vouchers List -->
                    <h4> All Vouchers</h4>
                    <div id="vouchers-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading vouchers...</p>
                        </div>
                </div>
            </div>
        </div>
    </main>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="order-details-modal">
        <div class="order-details-content">
            <div class="order-details-header">
                <h3 class="order-details-title" id="order-details-title">Order Details</h3>
                <div class="order-header-actions">
                    <button id="edit-order-btn" class="edit-order-btn" onclick="toggleOrderEditMode()">
                        <i class="fas fa-edit"></i> Edit Order
                    </button>
                    <span class="close-button" onclick="closeOrderDetailsModal()">&times;</span>
                </div>
            </div>
            <div class="order-details-body" id="order-details-body">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Order Edit Modal -->
    <div id="order-edit-modal" class="order-edit-modal">
        <div class="order-edit-content">
            <div class="order-details-header">
                <h3 class="order-details-title">Edit Order</h3>
                <span class="close-button" onclick="closeOrderEditModal()">&times;</span>
            </div>
            <div class="order-edit-body">
                <div class="edit-section">
                    <h4>Order Items</h4>
                    <div id="editable-items-list" class="editable-items-list">
                        <!-- Editable items will be populated here -->
                    </div>
                </div>
                
                <div class="edit-section">
                    <h4>Order Summary</h4>
                    <div class="order-summary-edit">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="edit-subtotal">KES 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee:</span>
                            <span id="edit-delivery-fee">KES 0.00</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total:</span>
                            <span id="edit-total">KES 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h4>Modification Notes</h4>
                    <textarea id="modification-notes" placeholder="Add notes about the order modification (optional)"></textarea>
                </div>

                <div class="edit-actions">
                    <button onclick="closeOrderEditModal()" class="cancel-btn">Cancel</button>
                    <button onclick="saveOrderChanges()" class="save-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-update-modal" class="status-update-modal">
        <div class="status-update-content">
            <div class="order-details-header">
                <h3 class="order-details-title">Update Order Status</h3>
                <span class="close-button" onclick="closeStatusUpdateModal()">&times;</span>
            </div>
            <div class="status-options" id="status-options">
                <div class="status-option" data-status="Pending">
                    <i class="fas fa-clock status-icon"></i>
                    <span class="status-text">Pending</span>
                </div>
                <div class="status-option" data-status="Confirmed">
                    <i class="fas fa-check-circle status-icon"></i>
                    <span class="status-text">Confirmed</span>
                </div>
                <div class="status-option" data-status="Processing">
                    <i class="fas fa-cogs status-icon"></i>
                    <span class="status-text">Processing</span>
                </div>
                <div class="status-option" data-status="On Transit">
                    <i class="fas fa-truck status-icon"></i>
                    <span class="status-text">On Transit</span>
                </div>
                <div class="status-option" data-status="Delivered">
                    <i class="fas fa-check-double status-icon"></i>
                    <span class="status-text">Delivered</span>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeStatusUpdateModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                <button onclick="updateOrderStatus()" id="confirm-status-btn" style="padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Create Voucher Modal -->
    <div id="create-voucher-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCreateVoucherModal()">&times;</span>
            <h3>Create New Voucher</h3>
            
            <div class="simple-voucher-form">
                <div class="form-group">
                    <label for="voucher-code">Voucher Code *</label>
                    <input type="text" id="voucher-code" placeholder="e.g., WELCOME10" maxlength="20" required>
                    <small>Enter a unique code (uppercase letters and numbers only)</small>
                </div>
                
                <div class="form-group">
                    <label for="voucher-description">Description *</label>
                    <input type="text" id="voucher-description" placeholder="e.g., Welcome discount for new customers" required>
                </div>
                
                <div class="form-group">
                    <label for="voucher-discount-type">Discount Type *</label>
                    <select id="voucher-discount-type" required>
                        <option value="fixed">Fixed Amount (KES)</option>
                        <option value="percentage">Percentage (%)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="voucher-discount-amount">Discount Amount *</label>
                    <input type="number" id="voucher-discount-amount" placeholder="e.g., 100 or 10" min="0" step="0.01" required>
                    <small id="discount-help-text">Enter the discount amount in KES</small>
                </div>
                
                <div class="form-group">
                    <label for="voucher-min-order">Minimum Order Amount</label>
                    <input type="number" id="voucher-min-order" placeholder="e.g., 500" min="0" step="0.01">
                    <small>Minimum order amount required to use this voucher (optional)</small>
                </div>
                
                <div class="form-group">
                    <label for="voucher-usage-limit">Usage Limit</label>
                    <input type="number" id="voucher-usage-limit" placeholder="e.g., 100" min="1">
                    <small>Maximum number of times this voucher can be used (optional)</small>
                </div>
                
                <div class="form-group">
                    <label for="voucher-expiry-date">Expiry Date</label>
                    <input type="datetime-local" id="voucher-expiry-date">
                    <small>When this voucher expires (optional)</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="voucher-is-active" checked> Active Voucher
                    </label>
                    <small>Uncheck to create an inactive voucher</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeCreateVoucherModal()" class="cancel-btn">Cancel</button>
                    <button type="button" id="create-voucher-btn" class="create-btn">Create Voucher</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Prince Alex Store Admin. All Rights Reserved.</p>
    </footer>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, addDoc, updateDoc, deleteDoc, where, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variable to store current Firebase user
        let firebaseUser = null;

        // --- Modal Alert Functions ---
        function showModal(title, message, isError = false) {
            console.log('showModal called:', title, message, isError);
            
            try {
                const modal = document.getElementById('message-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                
                console.log('Modal elements:', { modal, modalTitle, modalMessage });
                
                if (!modal || !modalTitle || !modalMessage) {
                    console.error('Modal elements not found:', { modal, modalTitle, modalMessage });
                    // Fallback to browser alert
                    alert(`${title}: ${message}`);
                    return;
                }
                
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                
                // Add error styling if needed
                if (isError) {
                    modalTitle.style.color = '#dc3545';
                } else {
                    modalTitle.style.color = '#28a745';
                }
                
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                console.log('Modal shown successfully:', title, message);
            } catch (error) {
                console.error('Error showing modal:', error);
                // Fallback to browser alert
                alert(`${title}: ${message}`);
            }
        }

        function closeModal() {
            try {
                const modal = document.getElementById('message-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto'; // Restore scrolling
                    
                    // Clear modal content
                    const modalTitle = document.getElementById('modal-title');
                    const modalMessage = document.getElementById('modal-message');
                    if (modalTitle) modalTitle.textContent = '';
                    if (modalMessage) modalMessage.innerHTML = '';
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        // Expose closeModal to global scope for onclick events
        window.closeModal = closeModal;

        // --- Professional Admin Page Switching Logic ---
        function switchAdminPage(pageName) {
            // Hide all admin pages
            const adminPages = document.querySelectorAll('.admin-page');
            adminPages.forEach(page => page.classList.remove('active'));

            // Remove active class from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // Show the requested page
            const targetPage = document.getElementById(`admin-${pageName}-section`);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // Update page title
            const pageTitle = document.getElementById('page-title');
            const pageTitles = {
                'dashboard': 'Dashboard',
                'products': 'Product Management',
                'orders': 'Order Management',
                'customers': 'Customer Management',
                'referrals': 'Referral Management',
                'vouchers': 'Voucher Management',
                'contacts': 'Contact Messages'
            };
            if (pageTitle && pageTitles[pageName]) {
                pageTitle.textContent = pageTitles[pageName];
            }

            // Add active class to current nav item
            const currentNavItem = document.querySelector(`[data-page="${pageName}"]`);
            if (currentNavItem) {
                currentNavItem.classList.add('active');
            }

            // Auto-refresh data when switching pages
            if (pageName === 'dashboard') {
                loadDashboardData();
            } else if (pageName === 'products') {
                loadProducts();
            } else if (pageName === 'orders') {
                loadOrders();
            } else if (pageName === 'customers') {
                loadAllCustomers();
            } else if (pageName === 'referrals') {
                loadReferralData();
            } else if (pageName === 'vouchers') {
                loadVouchers();
            } else if (pageName === 'contacts') {
                loadContactSubmissions();
            }
        }

        // --- Dashboard Data Loading ---
        async function loadDashboardData() {
            try {
                // Load recent orders
                const ordersQuery = query(collection(db, "orders"), orderBy("date", "desc"), limit(5));
                const ordersSnapshot = await getDocs(ordersQuery);
                
                const recentOrdersList = document.getElementById('recent-orders-list');
                if (ordersSnapshot.empty) {
                    recentOrdersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>No recent orders</p>
                        </div>
                    `;
                } else {
                    recentOrdersList.innerHTML = '';
                    ordersSnapshot.forEach((orderDoc) => {
                        const order = orderDoc.data();
                        const orderItem = document.createElement('div');
                        orderItem.className = 'recent-order-item';
                        orderItem.innerHTML = `
                            <div class="order-info">
                                <div class="order-id">${orderDoc.id}</div>
                                <div class="order-customer">${order.customer ? order.customer.fullName : 'Unknown Customer'}</div>
                            </div>
                            <div class="order-status">
                                <span class="status-badge status-${order.status ? order.status.toLowerCase().replace(' ', '-') : 'pending'}">${order.status || 'Pending'}</span>
                            </div>
                            <div class="order-total">KES ${order.total ? order.total.toFixed(2) : '0.00'}</div>
                        `;
                        recentOrdersList.appendChild(orderItem);
                    });
                }

                // Update dashboard stats
                await updateDashboardStats();

            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        // --- Update Dashboard Statistics ---
        async function updateDashboardStats() {
            try {
                // Get orders count
                const ordersSnapshot = await getDocs(collection(db, "orders"));
                const totalOrders = ordersSnapshot.size;
                const pendingOrders = ordersSnapshot.docs.filter(doc => doc.data().status === 'Pending').length;

                // Get customers count
                const customersSnapshot = await getDocs(collection(db, "customers"));
                const totalCustomers = customersSnapshot.size;

                // Calculate revenue
                let totalRevenue = 0;
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.total) {
                        totalRevenue += order.total;
                    }
                });

                // Update dashboard cards
                document.getElementById('dashboard-total-orders').textContent = totalOrders;
                document.getElementById('dashboard-pending-orders').textContent = pendingOrders;
                document.getElementById('dashboard-total-customers').textContent = totalCustomers;
                document.getElementById('dashboard-revenue').textContent = `KES ${totalRevenue.toFixed(2)}`;

                // Update header stats
                document.getElementById('header-total-orders').textContent = totalOrders;
                document.getElementById('header-pending-orders').textContent = pendingOrders;
                document.getElementById('header-total-customers').textContent = totalCustomers;

                // Update sidebar badges
                document.getElementById('pending-orders-badge').textContent = pendingOrders;

            } catch (error) {
                console.error("Error updating dashboard stats:", error);
            }
        }

        // --- Sidebar Toggle Functionality ---
        function toggleSidebar() {
            const sidebar = document.getElementById('admin-sidebar');
            sidebar.classList.toggle('open');
        }

        // --- Update Admin Info ---
        function updateAdminInfo(user) {
            const adminName = document.getElementById('admin-name');
            const adminEmail = document.getElementById('admin-email-display');
            
            if (adminName) {
                adminName.textContent = user.displayName || user.email || 'Admin User';
            }
            if (adminEmail) {
                adminEmail.textContent = user.email || 'admin@example.com';
            }
        }

        // --- UI Update based on Admin Authentication State ---
        function updateAdminUI() {
            console.log("updateAdminUI called, firebaseUser:", firebaseUser);
            
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminDashboard = document.getElementById('admin-dashboard');
            
            console.log("Elements found:", {
                adminLoginSection: !!adminLoginSection,
                adminDashboard: !!adminDashboard
            });

            // Check if user is logged in (any authenticated Firebase user is now considered an admin)
            if (firebaseUser) {
                console.log("User is logged in, showing admin dashboard");
                if (adminLoginSection) adminLoginSection.style.display = 'none'; // Hide login form
                if (adminDashboard) adminDashboard.style.display = 'flex'; // Show admin dashboard
                
                // Update admin info
                updateAdminInfo(firebaseUser);
                
                // Load initial data
                loadDashboardData();
                
                // Default to dashboard page on login
                switchAdminPage('dashboard');
            } else {
                console.log("User is not logged in, showing login form");
                if (adminLoginSection) adminLoginSection.style.display = 'block'; // Show login form
                if (adminDashboard) adminDashboard.style.display = 'none'; // Hide admin dashboard
            }
        }

        // ---  1. Admin Login & Logout ---
        // Wait for DOM to be ready before attaching event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('admin-login-form');
            if (!loginForm) {
                console.error('Admin login form not found!');
                return;
            }
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Login form submitted');
                
                const emailInput = document.getElementById('admin-email');
                const passwordInput = document.getElementById('admin-password');
                
                if (!emailInput || !passwordInput) {
                    console.error('Login form inputs not found!');
                    showModal('Error', 'Login form is not properly loaded. Please refresh the page.', true);
                    return;
                }
                
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!email || !password) {
                    showModal('Error', 'Please enter both email and password.', true);
                    return;
                }
                
                console.log('Attempting login with email:', email);
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log('Login successful');
                    
                    // Try modal first, fallback to alert
                    try {
                        showModal('Login Successful', `Welcome to the admin panel! You are now logged in as: ${email}`);
                    } catch (modalError) {
                        console.error('Modal failed, using alert:', modalError);
                        alert(`Login Successful!\nWelcome to the admin panel!\nYou are now logged in as: ${email}`);
                    }
                    
                    // UI update handled by onAuthStateChanged listener
                } catch (error) {
                    console.error("Admin login error:", error);
                    let errorMessage = 'Login failed. Please check your credentials.';
                    
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email address.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'The email address is not valid.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many login attempts. Please try again later.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your internet connection.';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'Invalid email or password.';
                    }
                    
                    // Try modal first, fallback to alert
                    try {
                        showModal('Login Failed', errorMessage, true);
                    } catch (modalError) {
                        console.error('Modal failed, using alert:', modalError);
                        alert(`Login Failed!\n${errorMessage}`);
                    }
                }
            });
        });

        document.getElementById('admin-logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showModal('Logged Out', 'You have been successfully logged out from the admin panel.');
                // UI update handled by onAuthStateChanged listener
            } catch (error) {
                showModal('Error', `Logout failed: ${error.message}`, true);
                console.error("Admin logout error:", error);
            }
        });

        // Firebase Auth State Listener: Crucial for updating UI on login/logout
        onAuthStateChanged(auth, (user) => {
            firebaseUser = user; // Update the global user object
            console.log("Auth state changed. Current user:", firebaseUser ? firebaseUser.email : "No user"); // Debug log
            console.log("Calling updateAdminUI...");
            updateAdminUI(); // Call the UI update function
            console.log("updateAdminUI completed");
        });

        // --- Professional Navigation Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar navigation
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.dataset.page;
                    switchAdminPage(page);
                });
            });

            // Sidebar toggle for mobile
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }

            // Quick action buttons
            document.querySelectorAll('.quick-action-btn[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.dataset.page;
                    switchAdminPage(page);
                });
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('admin-sidebar');
                const sidebarToggle = document.getElementById('sidebar-toggle');
                
                if (window.innerWidth <= 1024 && 
                    sidebar && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) &&
                    sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
        });


        // ---  2. Manage Products ---
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productName = document.getElementById('product-name').value;
            const productImageUrl = document.getElementById('product-image-url').value;
            const productDescription = document.getElementById('product-description').value;
            const productPrice = parseFloat(document.getElementById('product-price').value);
            const productUnit = document.getElementById('product-unit').value;
            const productStock = parseInt(document.getElementById('product-stock').value);
            const productCategory = document.getElementById('product-category').value;
            const productRating = parseFloat(document.getElementById('product-rating').value);
            const productTagsInput = document.getElementById('product-tags').value;

            if (!productName || !productImageUrl || !productDescription || isNaN(productPrice) || !productUnit || isNaN(productStock) || !productCategory) {
                showModal('Error', 'Please fill in all required product details correctly.', true);
                return;
            }

            // Validate image URL
            if (!isValidImageUrl(productImageUrl)) {
                showModal('Error', 'Please enter a valid image URL (must start with http:// or https:// and end with .jpg, .jpeg, .png, .gif, or .webp)', true);
                return;
            }

            // Validate stock
            if (productStock < 0) {
                showModal('Error', 'Stock quantity cannot be negative.', true);
                return;
            }

            // Validate rating
            if (productRating < 1 || productRating > 5) {
                showModal('Error', 'Rating must be between 1 and 5.', true);
                return;
            }

            // Process tags
            const productTags = productTagsInput ? productTagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : ['fresh'];

            // Debug logs before attempting to add product
            console.log("Attempting to add product...");
            console.log("Current firebaseUser:", firebaseUser ? firebaseUser.email : "No user logged in");
            console.log("Auth.currentUser:", auth.currentUser ? auth.currentUser.email : "No user from auth.currentUser");

            try {
                await addDoc(collection(db, "products"), {
                    name: productName,
                    image: productImageUrl,
                    description: productDescription,
                    price: productPrice,
                    unit: productUnit,
                    stock: productStock,
                    category: productCategory,
                    rating: productRating,
                    tags: productTags,
                    createdAt: new Date().toISOString()
                });
                showModal('Success', 'Product added successfully! The product will be visible on the customer page immediately.');
                document.getElementById('add-product-form').reset();
                document.getElementById('image-preview').style.display = 'none'; // Hide preview
                loadProducts(); // Reload the product list
                
                // Notify customer page to refresh products (if it's open)
                if (window.parent && window.parent !== window) {
                    try {
                        window.parent.postMessage({ type: 'PRODUCT_ADDED', productId: 'new' }, '*');
                    } catch (e) {
                        console.log('Could not notify parent window:', e);
                    }
                }
            } catch (error) {
                showModal('Error', `Failed to add product: ${error.message}`, true);
                console.error("Error adding product:", error);
            }
        });

        // Image URL validation function
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const validProtocols = ['http:', 'https:'];
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
                
                if (!validProtocols.includes(urlObj.protocol)) {
                    return false;
                }
                
                const pathname = urlObj.pathname.toLowerCase();
                return validExtensions.some(ext => pathname.endsWith(ext));
            } catch (e) {
                return false;
            }
        }

        // Image preview functionality
        document.getElementById('product-image-url').addEventListener('input', function() {
            const imageUrl = this.value;
            const preview = document.getElementById('image-preview');
            
            if (imageUrl && isValidImageUrl(imageUrl)) {
                preview.innerHTML = `
                    <h4>Image Preview:</h4>
                    <img src="${imageUrl}" alt="Product Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" 
                         onerror="this.parentElement.innerHTML='<p style=\'color: red;\'> Image failed to load. Please check the URL.</p>'">
                `;
                preview.style.display = 'block';
            } else if (imageUrl) {
                preview.innerHTML = '<p style="color: orange;"> Please enter a valid image URL</p>';
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        });

        async function loadProducts() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '<p style="text-align: center;">Loading products...</p>';
            try {
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    productsList.innerHTML = '<p style="text-align: center;">No products found.</p>';
                    return;
                }

                productsList.innerHTML = ''; // Clear loading message
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productItem = document.createElement('div');
                    productItem.className = 'admin-list-item';
                    
                    const stockStatus = product.stock > 0 ? 'in-stock' : 'out-of-stock';
                    const stockText = product.stock > 0 ? `${product.stock} in stock` : 'Out of stock';
                    
                    productItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <img src="${product.image || 'https://placehold.co/60x60/cccccc/333333?text=No+Image'}" 
                                 alt="${product.name}" 
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6;"
                                 onerror="this.src='https://placehold.co/60x60/cccccc/333333?text=No+Image'">
                            <div>
                                <strong>${product.name}</strong><br>
                                <span style="color: #666; font-size: 14px;">KES ${product.price.toFixed(2)} / ${product.unit}</span><br>
                                <span style="color: #999; font-size: 12px;">Category: ${product.category || 'N/A'} | Rating: ${product.rating || 'N/A'}</span><br>
                                <span style="color: ${stockStatus === 'in-stock' ? '#28a745' : '#dc3545'}; font-size: 12px; font-weight: 600;">${stockText}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="edit-btn" onclick="editProduct('${doc.id}')" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Edit</button>
                            <button class="delete-btn" onclick="deleteProduct('${doc.id}')" style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Delete</button>
                        </div>
                    `;
                    productsList.appendChild(productItem);
                });
            } catch (error) {
                productsList.innerHTML = '<p style="text-align: center; color: red;">Error loading products.</p>';
                showModal('Error', `Failed to load products: ${error.message}`, true);
                console.error("Error loading products:", error);
            }
        }

        // Expose editProduct to the global scope for onclick events
        window.editProduct = async function(productId) {
            try {
                const productRef = doc(db, "products", productId);
                const productSnap = await getDoc(productRef);
                
                if (!productSnap.exists()) {
                    showModal('Error', 'Product not found.', true);
                    return;
                }
                
                const product = productSnap.data();
                
                const editFormHtml = `
                    <div style="text-align: left; max-width: 600px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Edit Product</h4>
                        <form id="edit-product-form">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Product Name</label>
                                <input type="text" id="edit-product-name" value="${product.name || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Image URL</label>
                                <input type="url" id="edit-product-image-url" value="${product.image || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description</label>
                                <textarea id="edit-product-description" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>${product.description || ''}</textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Price (KES)</label>
                                    <input type="number" id="edit-product-price" value="${product.price || 0}" step="0.01" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Unit</label>
                                    <input type="text" id="edit-product-unit" value="${product.unit || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Quantity</label>
                                    <input type="number" id="edit-product-stock" value="${product.stock || 0}" min="0" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Category</label>
                                    <select id="edit-product-category" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;" required>
                                        <option value="vegetables" ${product.category === 'vegetables' ? 'selected' : ''}>Vegetables</option>
                                        <option value="leafy greens" ${product.category === 'leafy greens' ? 'selected' : ''}>Leafy Greens</option>
                                        <option value="herbs" ${product.category === 'herbs' ? 'selected' : ''}>Herbs</option>
                                        <option value="fruits" ${product.category === 'fruits' ? 'selected' : ''}>Fruits</option>
                                        <option value="organic" ${product.category === 'organic' ? 'selected' : ''}>Organic</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rating (1-5)</label>
                                    <input type="number" id="edit-product-rating" value="${product.rating || 4.5}" min="1" max="5" step="0.1" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tags (comma-separated)</label>
                                    <input type="text" id="edit-product-tags" value="${product.tags ? product.tags.join(', ') : ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button type="button" onclick="saveProductEdit('${productId}')" class="cta-button" style="flex: 1;">Save Changes</button>
                                <button type="button" onclick="closeModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal('Edit Product', editFormHtml);
                
            } catch (error) {
                showModal('Error', `Failed to load product for editing: ${error.message}`, true);
                console.error("Error loading product for edit:", error);
            }
        };

        // Save product edit
        window.saveProductEdit = async function(productId) {
            try {
                const productName = document.getElementById('edit-product-name').value;
                const productImageUrl = document.getElementById('edit-product-image-url').value;
                const productDescription = document.getElementById('edit-product-description').value;
                const productPrice = parseFloat(document.getElementById('edit-product-price').value);
                const productUnit = document.getElementById('edit-product-unit').value;
                const productStock = parseInt(document.getElementById('edit-product-stock').value);
                const productCategory = document.getElementById('edit-product-category').value;
                const productRating = parseFloat(document.getElementById('edit-product-rating').value);
                const productTagsInput = document.getElementById('edit-product-tags').value;

                if (!productName || !productImageUrl || !productDescription || isNaN(productPrice) || !productUnit || isNaN(productStock) || !productCategory) {
                    showModal('Error', 'Please fill in all required product details correctly.', true);
                    return;
                }

                // Validate image URL
                if (!isValidImageUrl(productImageUrl)) {
                    showModal('Error', 'Please enter a valid image URL (must start with http:// or https:// and end with .jpg, .jpeg, .png, .gif, or .webp)', true);
                    return;
                }

                // Validate stock
                if (productStock < 0) {
                    showModal('Error', 'Stock quantity cannot be negative.', true);
                    return;
                }

                // Validate rating
                if (productRating < 1 || productRating > 5) {
                    showModal('Error', 'Rating must be between 1 and 5.', true);
                    return;
                }

                // Process tags
                const productTags = productTagsInput ? productTagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : ['fresh'];

                const productRef = doc(db, "products", productId);
                await updateDoc(productRef, {
                    name: productName,
                    image: productImageUrl,
                    description: productDescription,
                    price: productPrice,
                    unit: productUnit,
                    stock: productStock,
                    category: productCategory,
                    rating: productRating,
                    tags: productTags,
                    lastUpdated: new Date().toISOString()
                });

                showModal('Success', 'Product updated successfully!');
                closeModal();
                loadProducts(); // Reload the product list
                
                // Notify customer page to refresh products (if it's open)
                if (window.parent && window.parent !== window) {
                    try {
                        window.parent.postMessage({ type: 'PRODUCT_UPDATED', productId: productId }, '*');
                    } catch (e) {
                        console.log('Could not notify parent window:', e);
                    }
                }
                
            } catch (error) {
                showModal('Error', `Failed to update product: ${error.message}`, true);
                console.error("Error updating product:", error);
            }
        };

        // Expose deleteProduct to the global scope for onclick events
        window.deleteProduct = async function(productId) {
            // Using a custom modal for confirmation instead of browser's confirm()
            showModal('Confirm Deletion', 'Are you sure you want to delete this product? <br><br><button onclick="confirmDeleteProduct(\'' + productId + '\')">Yes, Delete</button> <button onclick="closeModal()">Cancel</button>');
        }

        async function confirmDeleteProduct(productId) {
            closeModal(); // Close the confirmation modal
            try {
                await deleteDoc(doc(db, "products", productId));
                showModal('Success', 'Product deleted successfully!');
                loadProducts(); // Reload the list
            } catch (error) {
                showModal('Error', `Failed to delete product: ${error.message}`, true);
                console.error("Error deleting product:", error);
            }
        }

        // ---  3. Comprehensive Order Management System ---
        let allOrders = [];
        let filteredOrders = [];
        let currentOrderId = null;

        async function loadOrders() {
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading orders...</p>
                </div>
            `;

            try {
                const q = query(collection(db, "orders"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    ordersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h4>No Orders Found</h4>
                            <p>No orders have been placed yet.</p>
                        </div>
                    `;
                    updateOrderStats([]);
                    return;
                }

                allOrders = [];
                querySnapshot.forEach((orderDoc) => {
                    const order = orderDoc.data();
                    order.id = orderDoc.id;
                    allOrders.push(order);
                });

                filteredOrders = [...allOrders];
                renderOrders();
                updateOrderStats(allOrders);
                setupOrderEventListeners();

            } catch (error) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Error Loading Orders</h4>
                        <p>Failed to load orders: ${error.message}</p>
                    </div>
                `;
                showModal('Error', `Failed to load orders: ${error.message}`, true);
                console.error("Error loading orders:", error);
            }
        }

        function renderOrders() {
            const ordersList = document.getElementById('orders-list');
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h4>No Orders Match Your Search</h4>
                        <p>Try adjusting your search criteria.</p>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = '';
            
            filteredOrders.forEach((order) => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                    const customerName = order.customer ? order.customer.fullName : 'Unknown Customer';
                    const customerEmail = order.userEmail || 'No email';
                    const customerPhone = order.customer ? order.customer.phoneNumber : 'No phone';
                    const deliveryLocation = order.customer ? order.customer.deliveryLocation : 'No location';
                const itemsCount = order.items ? order.items.length : 0;
                const itemsSummary = order.items ? order.items.slice(0, 2).map(item => `${item.name} (x${item.quantity})`).join(', ') : 'No items';
                const moreItems = itemsCount > 2 ? ` +${itemsCount - 2} more` : '';
                
                const statusClass = order.status ? order.status.toLowerCase().replace(' ', '-') : 'pending';
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">
                            <strong>${order.id}</strong>
                            <span class="order-date">${new Date(order.date).toLocaleDateString()}</span>
                        </div>
                        <div class="order-status">
                            <span class="status-badge status-${statusClass}">${order.status || 'Pending'}</span>
                        </div>
                    </div>
                    
                    <div class="order-summary">
                        <div class="order-info">
                            <span class="order-info-label">Customer</span>
                            <span class="order-info-value">${customerName}</span>
                        </div>
                        <div class="order-info">
                            <span class="order-info-label">Email</span>
                            <span class="order-info-value">${customerEmail}</span>
                        </div>
                        <div class="order-info">
                            <span class="order-info-label">Phone</span>
                            <span class="order-info-value">${customerPhone}</span>
                        </div>
                        <div class="order-info">
                            <span class="order-info-label">Delivery</span>
                            <span class="order-info-value">${deliveryLocation}</span>
                        </div>
                        <div class="order-info">
                            <span class="order-info-label">Items</span>
                            <span class="order-info-value">${itemsSummary}${moreItems}</span>
                        </div>
                        <div class="order-info">
                            <span class="order-info-label">Total</span>
                            <span class="order-info-value">KES ${order.total ? order.total.toFixed(2) : '0.00'}</span>
                        </div>
                    </div>
                    
                        <div class="order-actions">
                        <button class="action-btn btn-view" onclick="viewOrderDetails('${order.id}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        <button class="action-btn btn-status" onclick="openStatusUpdateModal('${order.id}')">
                            <i class="fas fa-edit"></i> Update Status
                        </button>
                    </div>
                `;
                
                ordersList.appendChild(orderCard);
            });
        }

        function updateOrderStats(orders) {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(order => order.status === 'Pending').length;
            const processingOrders = orders.filter(order => order.status === 'Processing' || order.status === 'Confirmed').length;
            const deliveredOrders = orders.filter(order => order.status === 'Delivered').length;

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('processing-orders').textContent = processingOrders;
            document.getElementById('delivered-orders').textContent = deliveredOrders;
        }

        function setupOrderEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('order-search');
            const searchBtn = document.getElementById('search-orders-btn');
            const statusFilter = document.getElementById('status-filter');
            const dateFilter = document.getElementById('date-filter');
            const refreshBtn = document.getElementById('refresh-orders-btn');

            const performSearch = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const statusFilterValue = statusFilter.value;
                const dateFilterValue = dateFilter.value;

                filteredOrders = allOrders.filter(order => {
                    const matchesSearch = !searchTerm || 
                        order.id.toLowerCase().includes(searchTerm) ||
                        (order.userEmail && order.userEmail.toLowerCase().includes(searchTerm)) ||
                        (order.customer && order.customer.phoneNumber && order.customer.phoneNumber.includes(searchTerm)) ||
                        (order.customer && order.customer.fullName && order.customer.fullName.toLowerCase().includes(searchTerm));

                    const matchesStatus = !statusFilterValue || order.status === statusFilterValue;

                    const matchesDate = !dateFilterValue || (() => {
                        const orderDate = new Date(order.date);
                        const now = new Date();
                        
                        switch (dateFilterValue) {
                            case 'today':
                                return orderDate.toDateString() === now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                return orderDate >= weekAgo;
                            case 'month':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                return orderDate >= monthAgo;
                            default:
                                return true;
                        }
                    })();

                    return matchesSearch && matchesStatus && matchesDate;
                });

                renderOrders();
            };

            searchInput.addEventListener('input', performSearch);
            searchBtn.addEventListener('click', performSearch);
            statusFilter.addEventListener('change', performSearch);
            dateFilter.addEventListener('change', performSearch);
            refreshBtn.addEventListener('click', loadOrders);
        }

        // --- Order Details View Functions ---
        window.viewOrderDetails = async function(orderId) {
            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    showModal('Error', 'Order not found.', true);
                    return;
                }

                const customerName = order.customer ? order.customer.fullName : 'Unknown Customer';
                const customerEmail = order.userEmail || 'No email';
                const customerPhone = order.customer ? order.customer.phoneNumber : 'No phone';
                const customerId = order.customer ? order.customer.idNumber : 'No ID';
                const deliveryLocation = order.customer ? order.customer.deliveryLocation : 'No location';
                const houseName = order.customer ? order.customer.houseName : 'N/A';
                const additionalNotes = order.customer ? order.customer.additionalNotes : 'No special instructions';

                const itemsHtml = order.items ? order.items.map(item => `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">${item.name}</span>
                            <span class="item-price">KES ${item.totalPrice ? item.totalPrice.toFixed(2) : (item.price * item.quantity).toFixed(2)}</span>
                        </div>
                        <div class="item-details">
                            <span>Quantity: ${item.quantity} ${item.unit || 'units'}</span>
                            <span>Unit Price: KES ${item.price ? item.price.toFixed(2) : '0.00'}</span>
                            <span>Stock at Order: ${item.stockAtTimeOfOrder || 'N/A'}</span>
                        </div>
                    </div>
                `).join('') : '<p>No items found</p>';

                const orderDetailsHtml = `
                    <div class="details-section">
                        <h4> Order Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Order ID</span>
                                <span class="detail-value">${order.id}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">${order.status || 'Pending'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Order Date</span>
                                <span class="detail-value">${new Date(order.date).toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Method</span>
                                <span class="detail-value">${order.paymentMethod || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4> Customer Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Full Name</span>
                                <span class="detail-value">${customerName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email</span>
                                <span class="detail-value">${customerEmail}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Phone Number</span>
                                <span class="detail-value">${customerPhone}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ID Number</span>
                                <span class="detail-value">${customerId}</span>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4> Delivery Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Delivery Location</span>
                                <span class="detail-value">${deliveryLocation}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">House Name/Number</span>
                                <span class="detail-value">${houseName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Special Instructions</span>
                                <span class="detail-value">${additionalNotes}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Estimated Delivery</span>
                                <span class="detail-value">${order.deliveryInfo ? order.deliveryInfo.estimatedDelivery : '30 minutes'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4> Order Items</h4>
                        <div class="items-list">
                            ${itemsHtml}
                        </div>
                    </div>

                    <div class="details-section">
                        <h4> Order Summary</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Subtotal</span>
                                <span class="detail-value">KES ${order.subtotal ? order.subtotal.toFixed(2) : '0.00'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Delivery Fee</span>
                                <span class="detail-value">KES ${order.transportationFee ? order.transportationFee.toFixed(2) : '0.00'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Total Amount</span>
                                <span class="detail-value" style="font-weight: 700; color: var(--primary-color);">KES ${order.total ? order.total.toFixed(2) : '0.00'}</span>
                            </div>
                        </div>
                        </div>
                    `;

                document.getElementById('order-details-title').textContent = `Order Details - ${order.id}`;
                document.getElementById('order-details-body').innerHTML = orderDetailsHtml;
                document.getElementById('order-details-modal').style.display = 'flex';

            } catch (error) {
                showModal('Error', `Failed to load order details: ${error.message}`, true);
                console.error("Error loading order details:", error);
            }
        }

        // --- Status Update Functions ---
        window.openStatusUpdateModal = function(orderId) {
            currentOrderId = orderId;
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showModal('Error', 'Order not found.', true);
                return;
            }

            // Clear previous selections
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Highlight current status
            const currentStatus = order.status || 'Pending';
            const currentOption = document.querySelector(`[data-status="${currentStatus}"]`);
            if (currentOption) {
                currentOption.classList.add('selected');
            }

            document.getElementById('status-update-modal').style.display = 'flex';

            // Add click handlers for status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                };
            });
        }

        window.updateOrderStatus = async function() {
            if (!currentOrderId) {
                showModal('Error', 'No order selected.', true);
                return;
            }

            const selectedOption = document.querySelector('.status-option.selected');
            if (!selectedOption) {
                showModal('Error', 'Please select a status.', true);
                return;
            }

            const newStatus = selectedOption.dataset.status;
            const order = allOrders.find(o => o.id === currentOrderId);
            
            if (!order) {
                showModal('Error', 'Order not found.', true);
                return;
            }

            try {
                const orderRef = doc(db, "orders", currentOrderId);
                await updateDoc(orderRef, { 
                    status: newStatus,
                    lastUpdated: new Date().toISOString()
                });

                // Update local data
                order.status = newStatus;
                order.lastUpdated = new Date().toISOString();

                // Send email notification if status is "On Transit"
                if (newStatus === 'On Transit') {
                    await sendStatusUpdateEmail(order, newStatus);
                }

                showModal('Success', `Order status updated to ${newStatus} successfully!`);
                closeStatusUpdateModal();
                renderOrders();
                updateOrderStats(allOrders);

            } catch (error) {
                showModal('Error', `Failed to update order status: ${error.message}`, true);
                console.error("Error updating order status:", error);
            }
        }

        // --- Email Notification Functions ---
        async function sendStatusUpdateEmail(order, newStatus) {
            try {
                const customerEmail = order.userEmail;
                if (!customerEmail) {
                    console.log('No customer email found, skipping email notification');
                    return;
                }

                const customerName = order.customer ? order.customer.fullName : 'Valued Customer';
                const deliveryLocation = order.customer ? order.customer.deliveryLocation : 'Your location';

                // Generate voucher code
                const voucherCode = 'TRANSIT' + Math.random().toString(36).substring(2, 8).toUpperCase();
                const voucherValue = 50; // KES 50 voucher

                const emailData = {
                    to: customerEmail,
                    message: {
                        subject: ` Your Order ${order.id} is On Transit!`,
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                    <h1 style="margin: 0; font-size: 28px;"> Order On Transit!</h1>
                                    <p style="margin: 10px 0 0 0; font-size: 16px;">Your order is on its way to you!</p>
                                </div>
                                
                                <div style="padding: 30px; background: white;">
                                    <p style="font-size: 16px; color: #333;">Hello ${customerName},</p>
                                    <p style="font-size: 16px; color: #333;">Great news! Your order <strong>${order.id}</strong> is now on transit and will be delivered to:</p>
                                    
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                        <h3 style="color: #4CAF50; margin: 0 0 15px 0;"> Delivery Address</h3>
                                        <p style="margin: 5px 0; color: #333;"><strong>${deliveryLocation}</strong></p>
                                        <p style="margin: 5px 0; color: #666;">Please ensure someone is available to receive the order.</p>
                                    </div>

                                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                                        <h3 style="color: #856404; margin: 0 0 15px 0;"> Special Voucher!</h3>
                                        <p style="margin: 5px 0; color: #856404;">As a thank you for your patience, here's a special voucher for your next order:</p>
                                        <div style="background: #FF6B35; color: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                            <div style="font-size: 24px; font-weight: 700;">${voucherCode}</div>
                                            <div style="font-size: 16px;">KES ${voucherValue} OFF</div>
                                        </div>
                                        <p style="margin: 5px 0; color: #856404; font-size: 14px;">Use this code at checkout for your next order!</p>
                                    </div>
                                    
                                    <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                        <h3 style="color: #0c5460; margin: 0 0 15px 0;"> Order Summary</h3>
                                        <p style="margin: 5px 0; color: #0c5460;"><strong>Order ID:</strong> ${order.id}</p>
                                        <p style="margin: 5px 0; color: #0c5460;"><strong>Total Amount:</strong> KES ${order.total ? order.total.toFixed(2) : '0.00'}</p>
                                        <p style="margin: 5px 0; color: #0c5460;"><strong>Estimated Delivery:</strong> Within 30 minutes</p>
                                    </div>
                                    
                                    <p style="font-size: 16px; color: #333;">Thank you for choosing Prince Alex Store!</p>
                                    <p style="font-size: 16px; color: #333; margin-bottom: 0;"><strong>The Prince Alex Store Team</strong> </p>
                                </div>
                            </div>
                        `
                    },
                    emailType: 'status_update',
                    orderId: order.id,
                    customerEmail: customerEmail,
                    customerName: customerName,
                    status: newStatus,
                    voucherCode: voucherCode,
                    voucherValue: voucherValue,
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    priority: 'high'
                };

                // Save email to mail collection
                await addDoc(collection(db, "mail"), emailData);
                console.log(` Status update email queued for ${customerEmail}`);

            } catch (error) {
                console.error(" Error sending status update email:", error);
                // Don't show error to user as this is a background process
            }
        }

        // --- Modal Close Functions ---
        window.closeOrderDetailsModal = function() {
            document.getElementById('order-details-modal').style.display = 'none';
        }

        window.closeStatusUpdateModal = function() {
            document.getElementById('status-update-modal').style.display = 'none';
            currentOrderId = null;
        }

        // --- Order Editing Functions ---
        let currentEditingOrder = null;
        let originalOrderData = null;

        window.toggleOrderEditMode = function() {
            if (!currentOrderId) {
                showModal('Error', 'No order selected for editing.', true);
                return;
            }

            const order = allOrders.find(o => o.id === currentOrderId);
            if (!order) {
                showModal('Error', 'Order not found.', true);
                return;
            }

            // Store original order data for comparison
            originalOrderData = JSON.parse(JSON.stringify(order));
            currentEditingOrder = { ...order };

            // Populate the edit modal
            populateOrderEditModal(order);
            document.getElementById('order-edit-modal').style.display = 'flex';
        }

        function populateOrderEditModal(order) {
            const itemsList = document.getElementById('editable-items-list');
            
            if (!order.items || order.items.length === 0) {
                itemsList.innerHTML = '<p>No items in this order.</p>';
                return;
            }

            itemsList.innerHTML = order.items.map((item, index) => `
                <div class="editable-item" data-item-index="${index}">
                    <img src="${item.image || '/images/placeholder.jpg'}" alt="${item.name}" class="item-image" onerror="this.src='/images/placeholder.jpg'">
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-unit">${item.unit || 'per item'}</div>
                    </div>
                    <div class="item-quantity-controls">
                        <button class="quantity-btn" onclick="decreaseItemQuantity(${index})" ${item.quantity <= 1 ? 'disabled' : ''}>
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateItemQuantity(${index}, this.value)">
                        <button class="quantity-btn" onclick="increaseItemQuantity(${index})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="item-price">KES ${(item.price * item.quantity).toFixed(2)}</div>
                    <button class="remove-item-btn" onclick="removeItemFromOrder(${index})" title="Remove item">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            // Update order summary
            updateOrderSummary();
        }

        window.increaseItemQuantity = function(index) {
            if (currentEditingOrder && currentEditingOrder.items[index]) {
                currentEditingOrder.items[index].quantity += 1;
                updateItemQuantityInput(index);
                updateOrderSummary();
            }
        }

        window.decreaseItemQuantity = function(index) {
            if (currentEditingOrder && currentEditingOrder.items[index] && currentEditingOrder.items[index].quantity > 1) {
                currentEditingOrder.items[index].quantity -= 1;
                updateItemQuantityInput(index);
                updateOrderSummary();
            }
        }

        window.updateItemQuantity = function(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity >= 1 && currentEditingOrder && currentEditingOrder.items[index]) {
                currentEditingOrder.items[index].quantity = quantity;
                updateItemQuantityInput(index);
                updateOrderSummary();
            }
        }

        function updateItemQuantityInput(index) {
            const input = document.querySelector(`[data-item-index="${index}"] .quantity-input`);
            const item = currentEditingOrder.items[index];
            if (input && item) {
                input.value = item.quantity;
                
                // Update price display
                const priceElement = document.querySelector(`[data-item-index="${index}"] .item-price`);
                if (priceElement) {
                    priceElement.textContent = `KES ${(item.price * item.quantity).toFixed(2)}`;
                }

                // Update button states
                const decreaseBtn = document.querySelector(`[data-item-index="${index}"] .quantity-btn:first-child`);
                if (decreaseBtn) {
                    decreaseBtn.disabled = item.quantity <= 1;
                }
            }
        }

        window.removeItemFromOrder = function(index) {
            if (currentEditingOrder && currentEditingOrder.items[index]) {
                const item = currentEditingOrder.items[index];
                const confirmRemove = confirm(`Are you sure you want to remove "${item.name}" from this order?`);
                
                if (confirmRemove) {
                    currentEditingOrder.items.splice(index, 1);
                    
                    // Re-render the items list
                    populateOrderEditModal(currentEditingOrder);
                    
                    // Check if no items left
                    if (currentEditingOrder.items.length === 0) {
                        showModal('Warning', 'All items have been removed from this order. The order will be cancelled if you save.', true);
                    }
                }
            }
        }

        function updateOrderSummary() {
            if (!currentEditingOrder) return;

            let subtotal = 0;
            currentEditingOrder.items.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            const deliveryFee = currentEditingOrder.transportationFee || 0;
            const total = subtotal + deliveryFee;

            document.getElementById('edit-subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
            document.getElementById('edit-delivery-fee').textContent = `KES ${deliveryFee.toFixed(2)}`;
            document.getElementById('edit-total').textContent = `KES ${total.toFixed(2)}`;

            // Update the current editing order totals
            currentEditingOrder.subtotal = subtotal;
            currentEditingOrder.total = total;
        }

        window.closeOrderEditModal = function() {
            document.getElementById('order-edit-modal').style.display = 'none';
            currentEditingOrder = null;
            originalOrderData = null;
            document.getElementById('modification-notes').value = '';
        }

        window.saveOrderChanges = async function() {
            if (!currentEditingOrder || !currentOrderId) {
                showModal('Error', 'No order changes to save.', true);
                return;
            }

            // Check if order has items
            if (!currentEditingOrder.items || currentEditingOrder.items.length === 0) {
                const confirmCancel = confirm('This order has no items left. Do you want to cancel this order?');
                if (confirmCancel) {
                    await cancelOrder();
                }
                return;
            }

            try {
                // Show loading state
                const saveBtn = document.querySelector('.save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                // Prepare order update data
                const orderUpdateData = {
                    items: currentEditingOrder.items,
                    subtotal: currentEditingOrder.subtotal,
                    total: currentEditingOrder.total,
                    lastModified: new Date(),
                    modificationNotes: document.getElementById('modification-notes').value.trim()
                };

                // Add modification history
                if (!currentEditingOrder.modificationHistory) {
                    currentEditingOrder.modificationHistory = [];
                }
                
                currentEditingOrder.modificationHistory.push({
                    timestamp: new Date(),
                    adminUser: firebaseUser ? firebaseUser.email : 'Unknown Admin',
                    changes: getOrderChanges(originalOrderData, currentEditingOrder),
                    notes: orderUpdateData.modificationNotes
                });

                orderUpdateData.modificationHistory = currentEditingOrder.modificationHistory;

                // Update order in Firestore
                const orderRef = doc(db, 'orders', currentOrderId);
                await updateDoc(orderRef, orderUpdateData);

                // Send notification email to customer
                await sendOrderModificationNotification(currentEditingOrder, originalOrderData);

                // Update local data
                const orderIndex = allOrders.findIndex(o => o.id === currentOrderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex] = { ...allOrders[orderIndex], ...orderUpdateData };
                }

                // Refresh orders list
                await loadOrders();

                // Close modal and show success message
                closeOrderEditModal();
                showModal('Success', 'Order has been successfully updated and the customer has been notified.');

            } catch (error) {
                console.error('Error saving order changes:', error);
                showModal('Error', `Failed to save order changes: ${error.message}`, true);
            } finally {
                // Restore button state
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            }
        }

        function getOrderChanges(original, modified) {
            const changes = [];
            
            // Check for item changes
            if (original.items.length !== modified.items.length) {
                changes.push(`Items count changed from ${original.items.length} to ${modified.items.length}`);
            }

            // Check for quantity changes
            original.items.forEach((originalItem, index) => {
                const modifiedItem = modified.items[index];
                if (modifiedItem && originalItem.quantity !== modifiedItem.quantity) {
                    changes.push(`Quantity of "${originalItem.name}" changed from ${originalItem.quantity} to ${modifiedItem.quantity}`);
                }
            });

            // Check for removed items
            const removedItems = original.items.filter(originalItem => 
                !modified.items.some(modifiedItem => modifiedItem.id === originalItem.id)
            );
            removedItems.forEach(item => {
                changes.push(`"${item.name}" was removed from the order`);
            });

            // Check for total changes
            if (original.total !== modified.total) {
                changes.push(`Total amount changed from KES ${original.total.toFixed(2)} to KES ${modified.total.toFixed(2)}`);
            }

            return changes;
        }

        async function sendOrderModificationNotification(modifiedOrder, originalOrder) {
            try {
                const customerEmail = modifiedOrder.customer ? modifiedOrder.customer.email : null;
                if (!customerEmail) {
                    console.warn('No customer email found for order modification notification');
                    return;
                }

                const changes = getOrderChanges(originalOrder, modifiedOrder);
                const modificationNotes = document.getElementById('modification-notes').value.trim();

                // Create email content
                const emailContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 10px 10px 0 0; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;">Order Update Notification</h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">Prince Alex Store</p>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none;">
                            <h3 style="color: #333; margin-top: 0;">Hello ${modifiedOrder.customer ? modifiedOrder.customer.fullName : 'Valued Customer'},</h3>
                            
                            <p style="color: #666; line-height: 1.6;">We wanted to inform you that your order <strong>#${modifiedOrder.id}</strong> has been updated by our team.</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h4 style="color: #333; margin-top: 0;">Changes Made:</h4>
                                <ul style="color: #666; padding-left: 20px;">
                                    ${changes.map(change => `<li>${change}</li>`).join('')}
                                </ul>
                            </div>
                            
                            ${modificationNotes ? `
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <h4 style="color: #1976d2; margin-top: 0;">Admin Notes:</h4>
                                    <p style="color: #666; margin: 0;">${modificationNotes}</p>
                                </div>
                            ` : ''}
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h4 style="color: #333; margin-top: 0;">Updated Order Summary:</h4>
                                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                                    <span>Subtotal:</span>
                                    <span>KES ${modifiedOrder.subtotal.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                                    <span>Delivery Fee:</span>
                                    <span>KES ${(modifiedOrder.transportationFee || 0).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; font-size: 18px; color: #4CAF50; border-top: 2px solid #4CAF50; padding-top: 10px;">
                                    <span>Total:</span>
                                    <span>KES ${modifiedOrder.total.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <p style="color: #666; line-height: 1.6;">If you have any questions about these changes, please don't hesitate to contact us.</p>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="mailto:info@princealexstore.com" style="background: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Contact Support</a>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; text-align: center; color: #666; font-size: 14px;">
                            <p style="margin: 0;">Thank you for choosing Prince Alex Store!</p>
                            <p style="margin: 5px 0 0 0;">Fresh vegetables delivered to your doorstep</p>
                        </div>
                    </div>
                `;

                // Save email to mail collection
                await addDoc(collection(db, 'mail'), {
                    to: customerEmail,
                    message: {
                        subject: `Order Update - Order #${modifiedOrder.id}`,
                        html: emailContent
                    },
                    createdAt: new Date(),
                    type: 'order_modification',
                    orderId: modifiedOrder.id
                });

                console.log('Order modification notification email saved to mail collection');

            } catch (error) {
                console.error('Error sending order modification notification:', error);
                // Don't throw error as this shouldn't prevent order update
            }
        }

        async function cancelOrder() {
            try {
                const orderRef = doc(db, 'orders', currentOrderId);
                await updateDoc(orderRef, {
                    status: 'Cancelled',
                    cancelledAt: new Date(),
                    cancellationReason: 'All items removed by admin',
                    lastModified: new Date()
                });

                // Send cancellation notification
                await sendOrderCancellationNotification(currentEditingOrder);

                // Update local data
                const orderIndex = allOrders.findIndex(o => o.id === currentOrderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = 'Cancelled';
                }

                // Refresh orders list
                await loadOrders();

                // Close modal and show success message
                closeOrderEditModal();
                showModal('Success', 'Order has been cancelled and the customer has been notified.');

            } catch (error) {
                console.error('Error cancelling order:', error);
                showModal('Error', `Failed to cancel order: ${error.message}`, true);
            }
        }

        async function sendOrderCancellationNotification(order) {
            try {
                const customerEmail = order.customer ? order.customer.email : null;
                if (!customerEmail) {
                    console.warn('No customer email found for order cancellation notification');
                    return;
                }

                const emailContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; border-radius: 10px 10px 0 0; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px;">Order Cancellation Notice</h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">Prince Alex Store</p>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none;">
                            <h3 style="color: #333; margin-top: 0;">Hello ${order.customer ? order.customer.fullName : 'Valued Customer'},</h3>
                            
                            <p style="color: #666; line-height: 1.6;">We regret to inform you that your order <strong>#${order.id}</strong> has been cancelled.</p>
                            
                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                                <h4 style="color: #856404; margin-top: 0;">Reason for Cancellation:</h4>
                                <p style="color: #856404; margin: 0;">All items were removed from your order by our admin team.</p>
                            </div>
                            
                            <p style="color: #666; line-height: 1.6;">If you have any questions about this cancellation or would like to place a new order, please don't hesitate to contact us.</p>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="mailto:info@princealexstore.com" style="background: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Contact Support</a>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; text-align: center; color: #666; font-size: 14px;">
                            <p style="margin: 0;">Thank you for choosing Prince Alex Store!</p>
                            <p style="margin: 5px 0 0 0;">Fresh vegetables delivered to your doorstep</p>
                        </div>
                    </div>
                `;

                // Save email to mail collection
                await addDoc(collection(db, 'mail'), {
                    to: customerEmail,
                    message: {
                        subject: `Order Cancelled - Order #${order.id}`,
                        html: emailContent
                    },
                    createdAt: new Date(),
                    type: 'order_cancellation',
                    orderId: order.id
                });

                console.log('Order cancellation notification email saved to mail collection');

            } catch (error) {
                console.error('Error sending order cancellation notification:', error);
            }
        }

        // Expose markOrderAsDelivered to the global scope for onclick events
        window.markOrderAsDelivered = async function(orderId) {
            showModal('Confirm Delivery', 'Are you sure you want to mark this order as delivered? <br><br><button onclick="confirmMarkOrderAsDelivered(\'' + orderId + '\')">Yes, Mark Delivered</button> <button onclick="closeModal()">Cancel</button>');
        }

        async function confirmMarkOrderAsDelivered(orderId) {
            closeModal(); // Close the confirmation modal
            try {
                const orderRef = doc(db, "orders", orderId);
                await updateDoc(orderRef, { status: "Delivered" });
                showModal('Success', 'Order status updated to Delivered!');
                loadOrders(); // Reload the order list
            } catch (error) {
                showModal('Error', `Failed to update order status: ${error.message}`, true);
                console.error("Error marking order as delivered:", error);
            }
        }

        // Expose viewOrderDetails to the global scope for onclick events
        window.viewOrderDetails = async function(orderId) {
            try {
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);
                
                if (!orderSnap.exists()) {
                    showModal('Error', 'Order not found.', true);
                    return;
                }
                
                const order = orderSnap.data();
                const customerName = order.customer ? order.customer.fullName : 'Unknown Customer';
                const customerEmail = order.userEmail || 'No email';
                const customerPhone = order.customer ? order.customer.phoneNumber : 'No phone';
                const deliveryLocation = order.customer ? order.customer.deliveryLocation : 'No location';
                const houseName = order.customer ? order.customer.houseName : 'N/A';
                
                // Format items for display
                let itemsHtml = '';
                order.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span>${item.name} (x${item.quantity})</span>
                            <span>KES ${itemTotal.toFixed(2)}</span>
                        </div>
                    `;
                });
                
                const orderDetailsHtml = `
                    <div style="text-align: left; max-width: 500px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Order Details - ${orderId}</h4>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="margin-bottom: 10px;">Customer Information</h5>
                            <p><strong>Name:</strong> ${customerName}</p>
                            <p><strong>Email:</strong> ${customerEmail}</p>
                            <p><strong>Phone:</strong> ${customerPhone}</p>
                            <p><strong>Delivery Location:</strong> ${deliveryLocation}</p>
                            <p><strong>House Name:</strong> ${houseName}</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="margin-bottom: 10px;">Order Items</h5>
                            ${itemsHtml}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="margin-bottom: 10px;">Order Summary</h5>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>Subtotal:</span>
                                <span>KES ${order.subtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span>Transport Fee:</span>
                                <span>KES ${order.transportationFee.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-top: 2px solid var(--primary-color); margin-top: 10px; font-weight: bold;">
                                <span>Total:</span>
                                <span>KES ${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5 style="margin-bottom: 10px;">Order Information</h5>
                            <p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status}</span></p>
                            <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                            <p><strong>Order Date:</strong> ${new Date(order.date).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                showModal('Order Details', orderDetailsHtml);
            } catch (error) {
                showModal('Error', `Failed to load order details: ${error.message}`, true);
                console.error("Error loading order details:", error);
            }
        }

        // ---  4. Manage Contact Submissions ---
        async function loadContactSubmissions() {
            const messagesList = document.getElementById('contact-submissions-list');
            messagesList.innerHTML = '<p style="text-align: center;">Loading messages...</p>';
            try {
                const q = query(collection(db, "contactSubmissions"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    messagesList.innerHTML = '<p style="text-align: center;">No messages found.</p>';
                    return;
                }

                messagesList.innerHTML = ''; // Clear loading message
                querySnapshot.forEach((msgDoc) => {
                    const message = msgDoc.data();
                    const messageItem = document.createElement('div');
                    messageItem.className = 'admin-list-item';
                    messageItem.innerHTML = `
                        <div>
                            <strong>From:</strong> ${message.name} (${message.email})
                            <br>
                            <strong>Message:</strong> ${message.message}
                            <br>
                            <small>Date: ${new Date(message.createdAt).toLocaleString()}</small>
                        </div>
                        <button class="delete-btn" onclick="deleteContactSubmission('${msgDoc.id}')">Delete</button>
                    `;
                    messagesList.appendChild(messageItem);
                });
            } catch (error) {
                messagesList.innerHTML = '<p style="text-align: center; color: red;">Error loading messages.</p>';
                showModal('Error', `Failed to load messages: ${error.message}`, true);
                console.error("Error loading contact submissions:", error);
            }
        }

        // Expose deleteContactSubmission to the global scope for onclick events
        window.deleteContactSubmission = async function(messageId) {
            showModal('Confirm Deletion', 'Are you sure you want to delete this message? <br><br><button onclick="confirmDeleteContactSubmission(\'' + messageId + '\')">Yes, Delete</button> <button onclick="closeModal()">Cancel</button>');
        }

        async function confirmDeleteContactSubmission(messageId) {
            closeModal(); // Close the confirmation modal
            try {
                await deleteDoc(doc(db, "contactSubmissions", messageId));
                showModal('Success', 'Message deleted successfully!');
                loadContactSubmissions(); // Reload the list
            } catch (error) {
                showModal('Error', `Failed to delete message: ${error.message}`, true);
                console.error("Error deleting contact submission:", error);
            }
        }

        // ---  Customer Management Functions ---
        let currentCustomer = null;

        // Search for customer by email
        window.searchCustomer = async function() {
            console.log('searchCustomer called');
            const email = document.getElementById('customer-search-email').value.trim();
            console.log('Searching for email:', email);
            
            if (!email) {
                showModal('Error', 'Please enter a customer email address.', true);
                return;
            }

            try {
                console.log('Querying customers collection...');
                const customersCol = collection(db, "customers");
                const q = query(customersCol, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                console.log('Query result:', querySnapshot.size, 'documents found');

                if (querySnapshot.empty) {
                    showModal('Customer Not Found', `No customer found with email: ${email}`, true);
                    hideCustomerSections();
                    return;
                }

                const customerDoc = querySnapshot.docs[0];
                currentCustomer = { id: customerDoc.id, ...customerDoc.data() };
                console.log('Customer found:', currentCustomer);
                
                displayCustomerProfile(currentCustomer);
                showCustomerSections();
                
            } catch (error) {
                console.error("Error searching customer:", error);
                showModal('Error', `Failed to search customer: ${error.message}`, true);
            }
        };

        // Display customer profile
        function displayCustomerProfile(customer) {
            const profileDisplay = document.getElementById('customer-profile-display');
            
            const statusClass = customer.status === 'active' ? 'status-active' : 'status-inactive';
            const statusText = customer.status === 'active' ? 'Active' : 'Inactive';
            
            profileDisplay.innerHTML = `
                <div class="customer-profile-card">
                    <div class="customer-profile-header">
                        <h5>${customer.fullname || 'Unknown Customer'}</h5>
                        <span class="customer-status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="customer-profile-grid">
                        <div class="profile-section">
                            <h6>Personal Information</h6>
                            <p><strong>Name:</strong> ${customer.fullname || 'N/A'}</p>
                            <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${customer.phoneNumber || 'N/A'}</p>
                            <p><strong>ID Number:</strong> ${customer.idNumber || 'N/A'}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h6>Account Information</h6>
                            <p><strong>User ID:</strong> ${customer.id}</p>
                            <p><strong>Status:</strong> ${statusText}</p>
                            <p><strong>Referral Code:</strong> ${customer.referralCode || 'N/A'}</p>
                            <p><strong>Created:</strong> ${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h6>Loyalty & Rewards</h6>
                            <p><strong>Loyalty Points:</strong> ${customer.loyaltyPoints || 0}</p>
                            <p><strong>Total Orders:</strong> ${customer.totalOrders || 0}</p>
                            <p><strong>Total Spent:</strong> KES ${customer.totalSpent || 0}</p>
                            <p><strong>Last Order:</strong> ${customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h6>Referral Statistics</h6>
                            <p><strong>Referrals Sent:</strong> ${customer.referralStats ? customer.referralStats.totalSent : 0}</p>
                            <p><strong>Successful Referrals:</strong> ${customer.referralStats ? customer.referralStats.totalAccepted : 0}</p>
                            <p><strong>Referral Rewards:</strong> ${customer.referralStats ? customer.referralStats.totalRewards : 0} points</p>
                            <p><strong>Last Referral:</strong> ${customer.lastReferralDate ? new Date(customer.lastReferralDate).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show customer sections
        function showCustomerSections() {
            console.log('showCustomerSections called');
            const detailsSection = document.getElementById('customer-details-section');
            const actionsSection = document.getElementById('customer-actions-section');
            
            if (detailsSection) {
                detailsSection.style.display = 'block';
                console.log('Customer details section shown');
            } else {
                console.error('Customer details section not found');
            }
            
            if (actionsSection) {
                actionsSection.style.display = 'block';
                console.log('Customer actions section shown');
            } else {
                console.error('Customer actions section not found');
            }
        }

        // Hide customer sections
        function hideCustomerSections() {
            document.getElementById('customer-details-section').style.display = 'none';
            document.getElementById('customer-actions-section').style.display = 'none';
        }

        // Load all customers
        async function loadAllCustomers() {
            const customersList = document.getElementById('all-customers-list');
            customersList.innerHTML = '<p style="text-align: center;">Loading customers...</p>';
            
            try {
                const customersCol = collection(db, "customers");
                const q = query(customersCol, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    customersList.innerHTML = '<p style="text-align: center;">No customers found.</p>';
                    return;
                }

                customersList.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const customer = doc.data();
                    const customerItem = document.createElement('div');
                    customerItem.className = 'customer-list-item';
                    
                    const statusClass = customer.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = customer.status === 'active' ? 'Active' : 'Inactive';
                    
                    customerItem.innerHTML = `
                        <div class="customer-list-info">
                            <h6>${customer.fullname || 'Unknown Customer'}</h6>
                            <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${customer.phoneNumber || 'N/A'}</p>
                            <p><strong>Loyalty Points:</strong> ${customer.loyaltyPoints || 0} | <strong>Orders:</strong> ${customer.totalOrders || 0}</p>
                            <p><strong>Status:</strong> <span class="customer-status-badge ${statusClass}">${statusText}</span></p>
                        </div>
                        <div class="customer-list-actions">
                            <button class="quick-view-btn" onclick="quickViewCustomer('${doc.id}')">Quick View</button>
                            <button class="quick-view-btn" onclick="selectCustomer('${doc.id}')">Select</button>
                        </div>
                    `;
                    
                    customersList.appendChild(customerItem);
                });
                
            } catch (error) {
                customersList.innerHTML = '<p style="text-align: center; color: red;">Error loading customers.</p>';
                showModal('Error', `Failed to load customers: ${error.message}`, true);
                console.error("Error loading customers:", error);
            }
        }

        // Quick view customer
        window.quickViewCustomer = async function(customerId) {
            try {
                const customerRef = doc(db, "customers", customerId);
                const customerSnap = await getDoc(customerRef);
                
                if (!customerSnap.exists()) {
                    showModal('Error', 'Customer not found.', true);
                    return;
                }
                
                currentCustomer = { id: customerSnap.id, ...customerSnap.data() };
                displayCustomerProfile(currentCustomer);
                showCustomerSections();
                
                // Scroll to customer details
                document.getElementById('customer-details-section').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showModal('Error', `Failed to load customer: ${error.message}`, true);
                console.error("Error loading customer:", error);
            }
        };

        // Select customer for management
        window.selectCustomer = async function(customerId) {
            await quickViewCustomer(customerId);
        };

        // Customer Actions
        window.editCustomerProfile = function() {
            console.log('editCustomerProfile called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Editing customer:', currentCustomer.fullname);
            
            const editFormHtml = `
                <div style="text-align: left; max-width: 500px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px;">Edit Customer Profile</h4>
                    <form id="edit-customer-form">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Full Name</label>
                            <input type="text" id="edit-fullname" value="${currentCustomer.fullname || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Phone Number</label>
                            <input type="text" id="edit-phone" value="${currentCustomer.phoneNumber || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">ID Number</label>
                            <input type="text" id="edit-id" value="${currentCustomer.idNumber || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Loyalty Points</label>
                            <input type="number" id="edit-points" value="${currentCustomer.loyaltyPoints || 0}" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Status</label>
                            <select id="edit-status" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                                <option value="active" ${currentCustomer.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${currentCustomer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="saveCustomerProfile()" class="cta-button" style="flex: 1;">Save Changes</button>
                            <button type="button" onclick="closeModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal('Edit Customer Profile', editFormHtml);
        };

        // Save customer profile
        window.saveCustomerProfile = async function() {
            if (!currentCustomer) {
                showModal('Error', 'No customer selected.', true);
                return;
            }

            try {
                const fullname = document.getElementById('edit-fullname').value;
                const phoneNumber = document.getElementById('edit-phone').value;
                const idNumber = document.getElementById('edit-id').value;
                const loyaltyPoints = parseInt(document.getElementById('edit-points').value);
                const status = document.getElementById('edit-status').value;

                const customerRef = doc(db, "customers", currentCustomer.id);
                await updateDoc(customerRef, {
                    fullname: fullname,
                    phoneNumber: phoneNumber,
                    idNumber: idNumber,
                    loyaltyPoints: loyaltyPoints,
                    status: status,
                    lastUpdated: new Date().toISOString()
                });

                showModal('Success', 'Customer profile updated successfully!');
                closeModal();
                
                // Refresh customer data
                await quickViewCustomer(currentCustomer.id);
                loadAllCustomers();
                
            } catch (error) {
                showModal('Error', `Failed to update customer: ${error.message}`, true);
                console.error("Error updating customer:", error);
            }
        };

        // Reset customer password
        window.resetCustomerPassword = async function() {
            console.log('resetCustomerPassword called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Resetting password for:', currentCustomer.email);

            const confirmHtml = `
                <div style="text-align: center;">
                    <p>Are you sure you want to send a password reset email to:</p>
                    <p><strong>${currentCustomer.email}</strong></p>
                    <p style="color: #666; font-size: 14px; margin-top: 16px;">This will send a password reset link to the customer's email address.</p>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button onclick="confirmPasswordReset()" class="cta-button" style="flex: 1;">Send Reset Email</button>
                        <button onclick="closeModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                    </div>
                </div>
            `;
            
            showModal('Reset Password', confirmHtml);
        };

        // Confirm password reset
        window.confirmPasswordReset = async function() {
            try {
                // Note: In a real implementation, you would use Firebase Admin SDK
                // For now, we'll simulate the password reset
                showModal('Password Reset Sent', `Password reset email has been sent to ${currentCustomer.email}. The customer will receive instructions to reset their password.`);
                closeModal();
                
                // Log the action
                console.log(`Password reset requested for customer: ${currentCustomer.email}`);
                
            } catch (error) {
                showModal('Error', `Failed to send password reset: ${error.message}`, true);
                console.error("Error sending password reset:", error);
            }
        };

        // View customer orders
        window.viewCustomerOrders = async function() {
            console.log('viewCustomerOrders called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Viewing orders for:', currentCustomer.fullname);

            try {
                const ordersCol = collection(db, "orders");
                const q = query(ordersCol, where("userId", "==", currentCustomer.id), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                let ordersHtml = `
                    <div style="text-align: left; max-width: 600px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Orders for ${currentCustomer.fullname}</h4>
                `;

                if (querySnapshot.empty) {
                    ordersHtml += '<p style="text-align: center; color: #666;">No orders found for this customer.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const order = doc.data();
                        const itemsSummary = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                        
                        ordersHtml += `
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong>Order #${doc.id}</strong>
                                    <span class="status-${order.status.toLowerCase()}">${order.status}</span>
                                </div>
                                <p><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</p>
                                <p><strong>Total:</strong> KES ${order.total.toFixed(2)}</p>
                                <p><strong>Payment:</strong> ${order.paymentMethod}</p>
                                <p><strong>Items:</strong> ${itemsSummary}</p>
                            </div>
                        `;
                    });
                }

                ordersHtml += '</div>';
                showModal('Customer Orders', ordersHtml);

            } catch (error) {
                showModal('Error', `Failed to load customer orders: ${error.message}`, true);
                console.error("Error loading customer orders:", error);
            }
        };

        // View customer referrals
        window.viewCustomerReferrals = async function() {
            console.log('viewCustomerReferrals called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Viewing referrals for:', currentCustomer.fullname);

            try {
                const referralsCol = collection(db, "referrals");
                const q = query(referralsCol, where("referrerEmail", "==", currentCustomer.email), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                let referralsHtml = `
                    <div style="text-align: left; max-width: 600px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Referrals by ${currentCustomer.fullname}</h4>
                `;

                if (querySnapshot.empty) {
                    referralsHtml += '<p style="text-align: center; color: #666;">No referrals found for this customer.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const referral = doc.data();
                        const statusClass = referral.status === 'pending' ? 'status-pending' : 
                                          referral.status === 'accepted' ? 'status-accepted' : 'status-completed';
                        
                        referralsHtml += `
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong>Referral #${doc.id}</strong>
                                    <span class="status-badge ${statusClass}">${referral.status}</span>
                                </div>
                                <p><strong>Referred:</strong> ${referral.refereeEmail}</p>
                                <p><strong>Date:</strong> ${new Date(referral.date).toLocaleString()}</p>
                                <p><strong>Reward:</strong> ${referral.rewardEarned || 0} points</p>
                                <p><strong>Code:</strong> ${referral.referralCode || 'N/A'}</p>
                            </div>
                        `;
                    });
                }

                referralsHtml += '</div>';
                showModal('Customer Referrals', referralsHtml);

            } catch (error) {
                showModal('Error', `Failed to load customer referrals: ${error.message}`, true);
                console.error("Error loading customer referrals:", error);
            }
        };

        // Send customer message
        window.sendCustomerMessage = function() {
            console.log('sendCustomerMessage called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Sending message to:', currentCustomer.fullname);

            const messageFormHtml = `
                <div style="text-align: left; max-width: 500px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px;">Send Message to ${currentCustomer.fullname}</h4>
                    <form id="send-message-form">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Subject</label>
                            <input type="text" id="message-subject" placeholder="Message subject" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Message</label>
                            <textarea id="message-content" rows="6" placeholder="Type your message here..." style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="sendMessageToCustomer()" class="cta-button" style="flex: 1;">Send Message</button>
                            <button type="button" onclick="closeModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal('Send Message', messageFormHtml);
        };

        // Send message to customer
        window.sendMessageToCustomer = async function() {
            if (!currentCustomer) {
                showModal('Error', 'No customer selected.', true);
                return;
            }

            try {
                const subject = document.getElementById('message-subject').value;
                const content = document.getElementById('message-content').value;

                if (!subject || !content) {
                    showModal('Error', 'Please fill in both subject and message.', true);
                    return;
                }

                // Send message via Firestore mail collection
                await addDoc(collection(db, "mail"), {
                    to: currentCustomer.email,
                    message: {
                        subject: subject,
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <h2 style="color: var(--primary-color);">Message from Prince Alex Store</h2>
                                <p>Dear ${currentCustomer.fullname},</p>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                    ${content.replace(/\n/g, '<br>')}
                                </div>
                                <p>Best regards,<br>Prince Alex Store Team</p>
                            </div>
                        `
                    },
                    emailType: 'admin_message',
                    customerId: currentCustomer.id,
                    customerEmail: currentCustomer.email,
                    adminEmail: firebaseUser.email,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                });

                showModal('Message Sent', `Message has been sent to ${currentCustomer.email}. The customer will receive your message via email.`);
                closeModal();

            } catch (error) {
                showModal('Error', `Failed to send message: ${error.message}`, true);
                console.error("Error sending message:", error);
            }
        };

        // Toggle customer status
        window.toggleCustomerStatus = async function() {
            console.log('toggleCustomerStatus called');
            if (!currentCustomer) {
                console.log('No customer selected');
                showModal('Error', 'No customer selected.', true);
                return;
            }
            console.log('Toggling status for:', currentCustomer.fullname, 'Current status:', currentCustomer.status);

            const newStatus = currentCustomer.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';

            const confirmHtml = `
                <div style="text-align: center;">
                    <p>Are you sure you want to <strong>${action}</strong> this customer?</p>
                    <p><strong>${currentCustomer.fullname}</strong> (${currentCustomer.email})</p>
                    <p style="color: #666; font-size: 14px; margin-top: 16px;">
                        ${newStatus === 'active' ? 'This will allow the customer to place orders and access their account.' : 'This will prevent the customer from placing orders and accessing their account.'}
                    </p>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button onclick="confirmToggleStatus('${newStatus}')" class="cta-button" style="flex: 1;">${action.charAt(0).toUpperCase() + action.slice(1)} Customer</button>
                        <button onclick="closeModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                    </div>
                </div>
            `;
            
            showModal('Toggle Customer Status', confirmHtml);
        };

        // Confirm toggle status
        window.confirmToggleStatus = async function(newStatus) {
            try {
                const customerRef = doc(db, "customers", currentCustomer.id);
                await updateDoc(customerRef, {
                    status: newStatus,
                    lastUpdated: new Date().toISOString()
                });

                // Send alert email to customer about status change
                const action = newStatus === 'active' ? 'activated' : 'deactivated';
                const emailSubject = `Account ${action.charAt(0).toUpperCase() + action.slice(1)} - Prince Alex Store`;
                
                let emailContent = '';
                if (newStatus === 'inactive') {
                    emailContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h2 style="color: #856404; margin: 0 0 10px 0;"> Account Temporarily Suspended</h2>
                            </div>
                            
                            <p>Dear ${currentCustomer.fullname},</p>
                            
                            <p>We are writing to inform you that your Prince Alex Store account has been temporarily suspended by our administration team.</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #dc3545; margin-top: 0;">What this means:</h3>
                                <ul style="color: #6c757d;">
                                    <li>You cannot place new orders</li>
                                    <li>You cannot access certain account features</li>
                                    <li>Your existing orders remain unaffected</li>
                                    <li>Your loyalty points are preserved</li>
                                </ul>
                            </div>
                            
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #0c5460; margin-top: 0;">What you can do:</h3>
                                <ul style="color: #0c5460;">
                                    <li>Contact our customer support for more information</li>
                                    <li>Check your email for any outstanding issues</li>
                                    <li>Ensure all pending orders are completed</li>
                                </ul>
                            </div>
                            
                            <p>If you have any questions or concerns about this suspension, please contact our customer support team immediately.</p>
                            
                            <p>We apologize for any inconvenience this may cause.</p>
                            
                            <p>Best regards,<br>
                            <strong>Prince Alex Store Administration Team</strong></p>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                            <p style="font-size: 12px; color: #6c757d; text-align: center;">
                                This is an automated message. Please do not reply to this email.
                            </p>
                        </div>
                    `;
                } else {
                    emailContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h2 style="color: #155724; margin: 0 0 10px 0;"> Account Reactivated</h2>
                            </div>
                            
                            <p>Dear ${currentCustomer.fullname},</p>
                            
                            <p>Great news! Your Prince Alex Store account has been reactivated and you now have full access to all our services.</p>
                            
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #0c5460; margin-top: 0;">You can now:</h3>
                                <ul style="color: #0c5460;">
                                    <li>Place new orders</li>
                                    <li>Access all account features</li>
                                    <li>Use your loyalty points</li>
                                    <li>Enjoy our full range of services</li>
                                </ul>
                            </div>
                            
                            <p>We're excited to continue serving you and thank you for your patience.</p>
                            
                            <p>Welcome back!</p>
                            
                            <p>Best regards,<br>
                            <strong>Prince Alex Store Administration Team</strong></p>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                            <p style="font-size: 12px; color: #6c757d; text-align: center;">
                                This is an automated message. Please do not reply to this email.
                            </p>
                        </div>
                    `;
                }

                // Send status change email to customer
                await addDoc(collection(db, "mail"), {
                    to: currentCustomer.email,
                    message: {
                        subject: emailSubject,
                        html: emailContent
                    },
                    emailType: 'account_status_change',
                    customerId: currentCustomer.id,
                    customerEmail: currentCustomer.email,
                    adminEmail: firebaseUser.email,
                    newStatus: newStatus,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                });

                showModal('Status Updated', `Customer status has been updated to ${newStatus}. An email notification has been sent to ${currentCustomer.email}.`);
                closeModal();
                
                // Refresh customer data
                await quickViewCustomer(currentCustomer.id);
                loadAllCustomers();
                
            } catch (error) {
                showModal('Error', `Failed to update customer status: ${error.message}`, true);
                console.error("Error updating customer status:", error);
            }
        };

        // ---  Referral Management Functions ---
        async function loadReferralData() {
            try {
                await Promise.all([
                    loadReferralAnalytics(),
                    loadCustomerReferralStats(),
                    loadAllReferrals(),
                    loadReferralVisits()
                ]);
            } catch (error) {
                console.error("Error loading referral data:", error);
                showModal('Error', 'Failed to load referral data', true);
            }
        }

        async function loadReferralAnalytics() {
            try {
                // Load all referrals
                const referralsQuery = query(collection(db, "referrals"), orderBy("date", "desc"));
                const referralsSnapshot = await getDocs(referralsQuery);
                
                // Load all customers with referral stats
                const customersQuery = query(collection(db, "customers"));
                const customersSnapshot = await getDocs(customersQuery);
                
                let totalReferrals = 0;
                let successfulReferrals = 0;
                let totalRewardsGiven = 0;
                let topReferrers = 0;
                
                // Count referrals
                referralsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalReferrals++;
                    if (data.status === 'accepted' || data.status === 'completed') {
                        successfulReferrals++;
                        totalRewardsGiven += data.rewardEarned || 0;
                    }
                });
                
                // Count customers with referral stats
                customersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.referralStats && data.referralStats.totalSent > 0) {
                        topReferrers++;
                    }
                });
                
                // Update analytics display
                document.getElementById('total-referrals-count').textContent = totalReferrals;
                document.getElementById('successful-referrals-count').textContent = successfulReferrals;
                document.getElementById('total-rewards-given').textContent = totalRewardsGiven;
                document.getElementById('top-referrers-count').textContent = topReferrers;
                
            } catch (error) {
                console.error("Error loading referral analytics:", error);
            }
        }

        async function loadCustomerReferralStats() {
            try {
                const customersQuery = query(collection(db, "customers"));
                const customersSnapshot = await getDocs(customersQuery);
                
                const statsContainer = document.getElementById('customer-referral-stats');
                statsContainer.innerHTML = '';
                
                const customersWithReferrals = [];
                
                customersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.referralStats && data.referralStats.totalSent > 0) {
                        customersWithReferrals.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // Sort by total referrals sent
                customersWithReferrals.sort((a, b) => 
                    (b.referralStats.totalSent || 0) - (a.referralStats.totalSent || 0)
                );
                
                if (customersWithReferrals.length === 0) {
                    statsContainer.innerHTML = '<p style="text-align: center;">No customer referral data found.</p>';
                    return;
                }
                
                customersWithReferrals.forEach(customer => {
                    const statsItem = document.createElement('div');
                    statsItem.className = 'referral-stats-item';
                    
                    const totalSent = customer.referralStats.totalSent || 0;
                    const totalAccepted = customer.referralStats.totalAccepted || 0;
                    const totalRewards = customer.referralStats.totalRewards || 0;
                    
                    statsItem.innerHTML = `
                        <div class="customer-info">
                            <h6>${customer.fullname || customer.email || 'Unknown Customer'}</h6>
                            <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${customer.phoneNumber || 'N/A'}</p>
                            <p><strong>Referral Code:</strong> ${customer.referralCode || 'N/A'}</p>
                        </div>
                        <div class="stats-info">
                            <span class="stat-number">${totalSent}</span>
                            <span class="stat-label">Referrals Sent</span>
                            <br><br>
                            <span class="stat-number">${totalAccepted}</span>
                            <span class="stat-label">Successful</span>
                            <br><br>
                            <span class="stat-number">${totalRewards}</span>
                            <span class="stat-label">Points Earned</span>
                        </div>
                    `;
                    
                    statsContainer.appendChild(statsItem);
                });
                
            } catch (error) {
                console.error("Error loading customer referral stats:", error);
                document.getElementById('customer-referral-stats').innerHTML = 
                    '<p style="text-align: center; color: red;">Error loading customer referral stats.</p>';
            }
        }

        async function loadAllReferrals() {
            try {
                const referralsQuery = query(collection(db, "referrals"), orderBy("date", "desc"));
                const referralsSnapshot = await getDocs(referralsQuery);
                
                const referralsContainer = document.getElementById('all-referrals-list');
                referralsContainer.innerHTML = '';
                
                if (referralsSnapshot.empty) {
                    referralsContainer.innerHTML = '<p style="text-align: center;">No referral activities found.</p>';
                    return;
                }
                
                referralsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const activityItem = document.createElement('div');
                    activityItem.className = 'referral-activity-item';
                    
                    const statusClass = data.status === 'pending' ? 'status-pending' : 
                                      data.status === 'accepted' ? 'status-accepted' : 'status-completed';
                    
                    activityItem.innerHTML = `
                        <div class="activity-header">
                            <strong>Referral ID: ${doc.id}</strong>
                            <span class="status-badge ${statusClass}">${data.status || 'pending'}</span>
                        </div>
                        <div class="activity-details">
                            <strong>Referrer:</strong> ${data.referrerEmail || 'N/A'}<br>
                            <strong>Referred:</strong> ${data.refereeEmail || 'N/A'}<br>
                            <strong>Date:</strong> ${new Date(data.date).toLocaleString()}<br>
                            <strong>Reward Earned:</strong> ${data.rewardEarned || 0} points<br>
                            <strong>Referral Code:</strong> ${data.referralCode || 'N/A'}
                        </div>
                    `;
                    
                    referralsContainer.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error("Error loading all referrals:", error);
                document.getElementById('all-referrals-list').innerHTML = 
                    '<p style="text-align: center; color: red;">Error loading referral activities.</p>';
            }
        }

        async function loadReferralVisits() {
            try {
                const visitsQuery = query(collection(db, "referralVisits"), orderBy("timestamp", "desc"));
                const visitsSnapshot = await getDocs(visitsQuery);
                
                const visitsContainer = document.getElementById('referral-visits-list');
                visitsContainer.innerHTML = '';
                
                if (visitsSnapshot.empty) {
                    visitsContainer.innerHTML = '<p style="text-align: center;">No referral visits found.</p>';
                    return;
                }
                
                visitsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const visitItem = document.createElement('div');
                    visitItem.className = 'referral-activity-item';
                    
                    visitItem.innerHTML = `
                        <div class="activity-header">
                            <strong>Visit ID: ${doc.id}</strong>
                            <span class="status-badge status-pending">Visit</span>
                        </div>
                        <div class="activity-details">
                            <strong>Referral Code:</strong> ${data.referralCode || 'N/A'}<br>
                            <strong>Visitor IP:</strong> ${data.visitorIP || 'N/A'}<br>
                            <strong>User Agent:</strong> ${data.userAgent ? data.userAgent.substring(0, 50) + '...' : 'N/A'}<br>
                            <strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}<br>
                            <strong>Converted:</strong> ${data.converted ? 'Yes' : 'No'}
                        </div>
                    `;
                    
                    visitsContainer.appendChild(visitItem);
                });
                
            } catch (error) {
                console.error("Error loading referral visits:", error);
                document.getElementById('referral-visits-list').innerHTML = 
                    '<p style="text-align: center; color: red;">Error loading referral visits.</p>';
            }
        }


        // Debug function to test admin login system
        window.debugAdminLogin = function() {
            console.log('=== Admin Login Debug Info ===');
            console.log('Firebase App:', app);
            console.log('Firebase Auth:', auth);
            console.log('Firebase DB:', db);
            console.log('Current User:', firebaseUser);
            console.log('Login Form:', document.getElementById('admin-login-form'));
            console.log('Email Input:', document.getElementById('admin-email'));
            console.log('Password Input:', document.getElementById('admin-password'));
            console.log('Modal:', document.getElementById('message-modal'));
            console.log('Modal Title:', document.getElementById('modal-title'));
            console.log('Modal Message:', document.getElementById('modal-message'));
            console.log('==============================');
        };

        // Test modal function
        window.testModal = function() {
            showModal('Test Modal', 'This is a test modal to check if the modal system is working.');
        };

        // Test login function
        window.testLogin = function() {
            console.log('Testing login...');
            console.log('Current firebaseUser:', firebaseUser);
            updateAdminUI();
        };

        // Force show admin content (for testing)
        window.showAdminContent = function() {
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminContentSection = document.getElementById('admin-content');
            if (adminLoginSection) adminLoginSection.style.display = 'none';
            if (adminContentSection) adminContentSection.style.display = 'block';
            console.log('Admin content forced to show');
        };

        // Test login process (for debugging)
        window.testLoginProcess = function() {
            alert('Testing login process...');
            console.log('Testing login process...');
            
            // Test modal
            try {
                showModal('Test', 'This is a test modal');
            } catch (e) {
                console.error('Modal test failed:', e);
                alert('Modal test failed: ' + e.message);
            }
            
            // Test Firebase connection
            console.log('Firebase App:', app);
            console.log('Firebase Auth:', auth);
            console.log('Current User:', firebaseUser);
        };

        // Debug function to test customer management system
        window.debugCustomerManagement = function() {
            console.log('=== Customer Management Debug Info ===');
            console.log('Current Customer:', currentCustomer);
            console.log('Customer Search Input:', document.getElementById('customer-search-email'));
            console.log('Customer Details Section:', document.getElementById('customer-details-section'));
            console.log('Customer Actions Section:', document.getElementById('customer-actions-section'));
            console.log('Customer Profile Display:', document.getElementById('customer-profile-display'));
            console.log('All Customers List:', document.getElementById('all-customers-list'));
            
            // Test if all customer action functions exist
            const functions = [
                'searchCustomer', 'editCustomerProfile', 'resetCustomerPassword',
                'viewCustomerOrders', 'viewCustomerReferrals', 'sendCustomerMessage',
                'toggleCustomerStatus', 'quickViewCustomer', 'selectCustomer'
            ];
            
            functions.forEach(funcName => {
                const func = window[funcName];
                console.log(`${funcName}:`, typeof func === 'function' ? ' Defined' : ' Missing');
            });
            
            console.log('==============================');
        };

        // --- Voucher Management Functions ---
        let allVouchers = [];
        let filteredVouchers = [];

        // Load vouchers from Firestore
        async function loadVouchers() {
            try {
                console.log('Loading vouchers...');
                const vouchersRef = collection(db, 'vouchers');
                const querySnapshot = await getDocs(vouchersRef);
                
                allVouchers = [];
                querySnapshot.forEach((doc) => {
                    const voucher = { id: doc.id, ...doc.data() };
                    allVouchers.push(voucher);
                });
                
                // Sort by creation date (newest first)
                allVouchers.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                
                console.log(`Loaded ${allVouchers.length} vouchers`);
                updateVoucherStats();
                filterVouchers();
                
            } catch (error) {
                console.error('Error loading vouchers:', error);
                showModal('Error', `Failed to load vouchers: ${error.message}`, true);
            }
        }

        // Update voucher statistics
        function updateVoucherStats() {
            const activeCount = allVouchers.filter(v => v.isActive && (!v.expiryDate || new Date(v.expiryDate) > new Date())).length;
            const expiredCount = allVouchers.filter(v => v.expiryDate && new Date(v.expiryDate) <= new Date()).length;
            const totalUsage = allVouchers.reduce((sum, v) => sum + (v.usageCount || 0), 0);
            const totalDiscount = allVouchers.reduce((sum, v) => {
                const usageCount = v.usageCount || 0;
                const discountPerUse = v.discountType === 'percentage' ? 0 : v.discountAmount;
                return sum + (usageCount * discountPerUse);
            }, 0);

            document.getElementById('active-vouchers-count').textContent = activeCount;
            document.getElementById('expired-vouchers-count').textContent = expiredCount;
            document.getElementById('total-voucher-usage').textContent = totalUsage;
            document.getElementById('total-discount-given').textContent = `KES ${totalDiscount.toFixed(2)}`;
            document.getElementById('active-vouchers-badge').textContent = activeCount;
        }

        // Filter vouchers based on search and status
        function filterVouchers() {
            const statusFilter = document.getElementById('voucher-status-filter').value;
            const searchTerm = document.getElementById('voucher-search').value.toLowerCase();
            
            filteredVouchers = allVouchers.filter(voucher => {
                // Status filter
                let statusMatch = true;
                if (statusFilter === 'active') {
                    statusMatch = voucher.isActive && (!voucher.expiryDate || new Date(voucher.expiryDate) > new Date());
                } else if (statusFilter === 'inactive') {
                    statusMatch = !voucher.isActive;
                } else if (statusFilter === 'expired') {
                    statusMatch = voucher.expiryDate && new Date(voucher.expiryDate) <= new Date();
                }
                
                // Search filter
                const searchMatch = !searchTerm || 
                    voucher.id.toLowerCase().includes(searchTerm) ||
                    voucher.description.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            displayVouchers();
        }

        // Display vouchers in the UI
        function displayVouchers() {
            const vouchersList = document.getElementById('vouchers-list');
            
            if (filteredVouchers.length === 0) {
                vouchersList.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-ticket-alt" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                        <p>No vouchers found</p>
                    </div>
                `;
                return;
            }
            
            vouchersList.innerHTML = filteredVouchers.map(voucher => {
                const isExpired = voucher.expiryDate && new Date(voucher.expiryDate) <= new Date();
                const statusClass = isExpired ? 'expired' : (voucher.isActive ? 'active' : 'inactive');
                const statusText = isExpired ? 'Expired' : (voucher.isActive ? 'Active' : 'Inactive');
                
                const discountText = voucher.discountType === 'percentage' 
                    ? `${voucher.discountAmount}%` 
                    : `KES ${voucher.discountAmount}`;
                
                const usageText = voucher.usageLimit 
                    ? `${voucher.usageCount || 0}/${voucher.usageLimit}` 
                    : (voucher.usageCount || 0);
                
                return `
                    <div class="voucher-card">
                        <div class="voucher-header">
                            <div class="voucher-info">
                                <h4>${voucher.description}</h4>
                                <div class="voucher-code">${voucher.id}</div>
                            </div>
                            <div class="voucher-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="voucher-details">
                            <div class="voucher-detail">
                                <div class="voucher-detail-label">Discount</div>
                                <div class="voucher-detail-value">${discountText}</div>
                            </div>
                            <div class="voucher-detail">
                                <div class="voucher-detail-label">Usage</div>
                                <div class="voucher-detail-value">${usageText}</div>
                            </div>
                            <div class="voucher-detail">
                                <div class="voucher-detail-label">Min Order</div>
                                <div class="voucher-detail-value">${voucher.minOrderAmount ? `KES ${voucher.minOrderAmount}` : 'None'}</div>
                            </div>
                            <div class="voucher-detail">
                                <div class="voucher-detail-label">Expires</div>
                                <div class="voucher-detail-value">${voucher.expiryDate ? new Date(voucher.expiryDate).toLocaleDateString() : 'Never'}</div>
                            </div>
                        </div>
                        
                        <div class="voucher-actions-card">
                            <button class="voucher-action-btn edit" onclick="editVoucher('${voucher.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="voucher-action-btn toggle" onclick="toggleVoucherStatus('${voucher.id}', ${!voucher.isActive})">
                                <i class="fas fa-power-off"></i> ${voucher.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="voucher-action-btn delete" onclick="deleteVoucher('${voucher.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open create voucher modal
        function openCreateVoucherModal() {
            console.log('Opening voucher modal...');
            const modal = document.getElementById('create-voucher-modal');
            console.log('Modal element:', modal);
            
            if (!modal) {
                console.error('Modal element not found!');
                showModal('Error', 'Voucher modal not found. Please refresh the page.', true);
                return;
            }
            
            console.log('Modal current display:', modal.style.display);
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            console.log('Modal display set to:', modal.style.display);
            console.log('Modal should now be visible');
            
            // Debug: Check if form fields are visible
            setTimeout(() => {
                const voucherCodeField = document.getElementById('voucher-code');
                console.log('Voucher code field after modal open:', voucherCodeField);
                console.log('Field visible:', voucherCodeField ? voucherCodeField.offsetHeight > 0 : false);
                console.log('Field display:', voucherCodeField ? window.getComputedStyle(voucherCodeField).display : 'N/A');
            }, 100);
        }

        // Close create voucher modal
        function closeCreateVoucherModal() {
            document.getElementById('create-voucher-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Reset form fields
            document.getElementById('voucher-code').value = '';
            document.getElementById('voucher-description').value = '';
            document.getElementById('voucher-discount-type').value = 'fixed';
            document.getElementById('voucher-discount-amount').value = '';
            document.getElementById('voucher-min-order').value = '';
            document.getElementById('voucher-usage-limit').value = '';
            document.getElementById('voucher-expiry-date').value = '';
            document.getElementById('voucher-is-active').checked = true;
            
            // Reset button
            const createBtn = document.getElementById('create-voucher-btn');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Voucher';
            }
        }

        // Update discount input help text
        function updateDiscountInput() {
            const discountType = document.getElementById('voucher-discount-type').value;
            const helpText = document.getElementById('discount-help-text');
            const amountInput = document.getElementById('voucher-discount-amount');
            
            if (discountType === 'percentage') {
                helpText.textContent = 'Enter the percentage discount (e.g., 10 for 10%)';
                amountInput.max = 100;
            } else {
                helpText.textContent = 'Enter the discount amount in KES';
                amountInput.removeAttribute('max');
            }
        }

        // Simple voucher creation function
        async function createVoucherSimple() {
            console.log('=== SIMPLE VOUCHER CREATION STARTED ===');
            
            try {
                // Get form elements first
                const voucherCodeEl = document.getElementById('voucher-code');
                const descriptionEl = document.getElementById('voucher-description');
                const discountTypeEl = document.getElementById('voucher-discount-type');
                const discountAmountEl = document.getElementById('voucher-discount-amount');
                const minOrderEl = document.getElementById('voucher-min-order');
                const usageLimitEl = document.getElementById('voucher-usage-limit');
                const expiryDateEl = document.getElementById('voucher-expiry-date');
                const isActiveEl = document.getElementById('voucher-is-active');
                
                console.log('Form elements found:', {
                    voucherCodeEl, descriptionEl, discountTypeEl, discountAmountEl,
                    minOrderEl, usageLimitEl, expiryDateEl, isActiveEl
                });
                
                // Get form values
                const voucherCode = voucherCodeEl ? voucherCodeEl.value.trim().toUpperCase() : '';
                const description = descriptionEl ? descriptionEl.value.trim() : '';
                const discountType = discountTypeEl ? discountTypeEl.value : '';
                const discountAmount = discountAmountEl ? parseFloat(discountAmountEl.value) : 0;
                const minOrderAmount = minOrderEl && minOrderEl.value ? parseFloat(minOrderEl.value) : null;
                const usageLimit = usageLimitEl && usageLimitEl.value ? parseInt(usageLimitEl.value) : null;
                const expiryDate = expiryDateEl ? expiryDateEl.value : '';
                const isActive = isActiveEl ? isActiveEl.checked : true;
                
                console.log('Form data collected:', {
                    voucherCode, description, discountType, discountAmount,
                    minOrderAmount, usageLimit, expiryDate, isActive
                });
                
                console.log('Raw voucher code value:', voucherCodeEl ? voucherCodeEl.value : 'Element not found');
                
                // Basic validation
                if (!voucherCode) {
                    alert('Voucher code is required!');
                    return;
                }
                
                if (!description) {
                    alert('Voucher description is required!');
                    return;
                }
                
                if (!discountAmount || discountAmount <= 0) {
                    alert('Discount amount must be greater than 0!');
                    return;
                }
                
                if (discountType === 'percentage' && discountAmount > 100) {
                    alert('Percentage discount cannot exceed 100%!');
                    return;
                }
                
                // Validate voucher code format
                if (!/^[A-Z0-9]+$/.test(voucherCode)) {
                    alert('Voucher code must contain only uppercase letters and numbers!');
                    return;
                }
                
                // Check if voucher code already exists
                const existingVoucher = allVouchers.find(v => v.id === voucherCode);
                if (existingVoucher) {
                    alert('A voucher with this code already exists. Please choose a different code.');
                    return;
                }
                
                // Create voucher data
                const voucherData = {
                    id: voucherCode,
                    description: description,
                    discountType: discountType,
                    discountAmount: discountAmount,
                    minOrderAmount: minOrderAmount,
                    usageLimit: usageLimit,
                    usageCount: 0,
                    expiryDate: expiryDate || null,
                    isActive: isActive,
                    createdAt: new Date().toISOString(),
                    createdBy: firebaseUser ? firebaseUser.uid : 'admin'
                };
                
                console.log('Saving voucher to Firestore:', voucherData);
                
                // Disable button to prevent double submission
                const createBtn = document.getElementById('create-voucher-btn');
                createBtn.disabled = true;
                createBtn.textContent = 'Creating...';
                
                // Save to Firestore
                const voucherRef = doc(db, 'vouchers', voucherCode);
                await setDoc(voucherRef, voucherData);
                
                console.log('Voucher created successfully:', voucherData);
                
                // Refresh vouchers list
                await loadVouchers();
                
                // Close modal and show success message
                closeCreateVoucherModal();
                alert(`Voucher "${voucherCode}" created successfully!`);
                
            } catch (error) {
                console.error('Error creating voucher:', error);
                alert(`Failed to create voucher: ${error.message}`);
                
                // Re-enable button
                const createBtn = document.getElementById('create-voucher-btn');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Voucher';
            }
        }

        // Legacy function for compatibility
        async function createVoucher(event) {
            if (event) {
                event.preventDefault();
            }
            return createVoucherSimple();
        }

        // Toggle voucher status
        async function toggleVoucherStatus(voucherId, newStatus) {
            try {
                const voucherRef = doc(db, 'vouchers', voucherId);
                await updateDoc(voucherRef, {
                    isActive: newStatus,
                    lastModified: new Date().toISOString()
                });
                
                // Update local data
                const voucherIndex = allVouchers.findIndex(v => v.id === voucherId);
                if (voucherIndex !== -1) {
                    allVouchers[voucherIndex].isActive = newStatus;
                }
                
                // Refresh display
                updateVoucherStats();
                filterVouchers();
                
                showModal('Success', `Voucher ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                
            } catch (error) {
                console.error('Error toggling voucher status:', error);
                showModal('Error', `Failed to update voucher status: ${error.message}`, true);
            }
        }

        // Delete voucher
        async function deleteVoucher(voucherId) {
            const confirmHtml = `
                <div style="text-align: center;">
                    <p>Are you sure you want to <strong>delete</strong> this voucher?</p>
                    <p><strong>${voucherId}</strong></p>
                    <p style="color: #dc3545; font-size: 14px; margin-top: 16px;">
                        This action cannot be undone. All usage history will be lost.
                    </p>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button onclick="confirmDeleteVoucher('${voucherId}')" class="cta-button" style="flex: 1; background: #dc3545;">Delete Voucher</button>
                        <button onclick="closeModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                    </div>
                </div>
            `;
            
            showModal('Delete Voucher', confirmHtml);
        }

        // Confirm delete voucher
        window.confirmDeleteVoucher = async function(voucherId) {
            try {
                const voucherRef = doc(db, 'vouchers', voucherId);
                await deleteDoc(voucherRef);
                
                // Update local data
                allVouchers = allVouchers.filter(v => v.id !== voucherId);
                
                // Refresh display
                updateVoucherStats();
                filterVouchers();
                
                closeModal();
                showModal('Success', 'Voucher deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting voucher:', error);
                showModal('Error', `Failed to delete voucher: ${error.message}`, true);
            }
        };

        // Refresh vouchers
        function refreshVouchers() {
            loadVouchers();
        }

        // Edit voucher (placeholder for future implementation)
        function editVoucher(voucherId) {
            showModal('Edit Voucher', 'Voucher editing functionality will be implemented in a future update.', true);
        }

        // Debug function for voucher creation
        window.debugVoucherCreation = function() {
            console.log('=== Voucher Creation Debug Info ===');
            console.log('Firebase User:', firebaseUser);
            console.log('Firebase DB:', db);
            console.log('All Vouchers:', allVouchers);
            console.log('Voucher Functions Available:');
            console.log('- openCreateVoucherModal:', typeof openCreateVoucherModal);
            console.log('- createVoucher:', typeof createVoucher);
            console.log('- loadVouchers:', typeof loadVouchers);
            console.log('- showModal:', typeof showModal);
            console.log('Voucher Form Elements:');
            console.log('- voucher-code:', document.getElementById('voucher-code'));
            console.log('- voucher-description:', document.getElementById('voucher-description'));
            console.log('- voucher-discount-type:', document.getElementById('voucher-discount-type'));
            console.log('- voucher-discount-amount:', document.getElementById('voucher-discount-amount'));
            console.log('- create-voucher-form:', document.getElementById('create-voucher-form'));
            console.log('Voucher Button Elements:');
            const createBtn = document.querySelector('.voucher-actions .create-btn');
            console.log('- Create Voucher Button:', createBtn);
            console.log('- Button onclick:', createBtn ? createBtn.onclick : 'No onclick');
            console.log('- Button style:', createBtn ? createBtn.style.cssText : 'No style');
            console.log('- Button computed style:', createBtn ? window.getComputedStyle(createBtn) : 'No computed style');
            console.log('=====================================');
        };

        // Test function to manually trigger voucher modal
        window.testVoucherModal = function() {
            console.log('Testing voucher modal...');
            alert('Testing voucher modal - check console for details');
            try {
                openCreateVoucherModal();
                console.log('Modal opened successfully');
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('Error opening modal: ' + error.message);
            }
        };

        // Test function to check form fields
        window.testFormFields = function() {
            console.log('=== TESTING FORM FIELDS ===');
            const fields = [
                'voucher-code', 'voucher-description', 'voucher-discount-type',
                'voucher-discount-amount', 'voucher-min-order', 'voucher-usage-limit',
                'voucher-expiry-date', 'voucher-is-active'
            ];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                console.log(`${fieldId}:`, element ? element.value || element.checked : 'NOT FOUND');
            });
            
            // Test setting a value
            const codeField = document.getElementById('voucher-code');
            if (codeField) {
                codeField.value = 'TEST123';
                console.log('Set voucher-code to TEST123, current value:', codeField.value);
            }
        };

        // Expose voucher functions to global scope for HTML onclick events
        window.openCreateVoucherModal = openCreateVoucherModal;
        window.closeCreateVoucherModal = closeCreateVoucherModal;
        window.createVoucher = createVoucher;
        window.createVoucherSimple = createVoucherSimple;
        window.updateDiscountInput = updateDiscountInput;
        window.refreshVouchers = refreshVouchers;
        window.filterVouchers = filterVouchers;
        window.editVoucher = editVoucher;
        window.toggleVoucherStatus = toggleVoucherStatus;
        window.deleteVoucher = deleteVoucher;
        window.debugVoucherCreation = debugVoucherCreation;
        window.testVoucherModal = testVoucherModal;
        window.testFormFields = testFormFields;

        // Initial load of UI when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded - Admin page initialized');
            updateAdminUI(); // Set initial visibility based on auth state
            
            // Add click event listener to new voucher button
            const newVoucherBtn = document.getElementById('new-voucher-btn');
            if (newVoucherBtn) {
                console.log('New voucher button found, adding click listener');
                newVoucherBtn.addEventListener('click', function(e) {
                    console.log('New voucher button clicked!', e);
                    e.preventDefault();
                    openCreateVoucherModal();
                });
            } else {
                console.log('New voucher button not found');
            }

            // Add click event listener to new create voucher button
            const createVoucherBtn = document.getElementById('create-voucher-btn');
            if (createVoucherBtn) {
                console.log('Create voucher button found, adding click listener');
                createVoucherBtn.addEventListener('click', function(e) {
                    console.log('Create voucher button clicked!', e);
                    e.preventDefault();
                    createVoucherSimple();
                });
            } else {
                console.log('Create voucher button not found');
            }
            
            // Run debug info
            setTimeout(() => {
                window.debugAdminLogin();
            }, 1000);
        });

    </script>
</body>
</html>

