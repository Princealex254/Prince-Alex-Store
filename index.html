<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Online Store - Farm Fresh Veggies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- AOS Animate On Scroll Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Fresh Green */
            --secondary-color: #8BC34A; /* Lighter Green */
            --accent-color-orange: #FF6B35; /* Vibrant Orange */
            --accent-color-yellow: #FFC107; /* Sunny Yellow */
            --accent-color-blue: #2196F3; /* Modern Blue */
            --text-color: #2c3e50;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 10px 25px rgba(0,0,0,0.08);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.12);
            --border-color: #e2e8f0;
            --dark-text: #1a202c;
            --star-color: #FFD700; /* Gold for stars */
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --input-bg: #f0f0f0;
            --promo-banner-bg: #FFEB3B; /* Yellow for promo */
            --promo-banner-text: #333;
            --flash-sale-bg: #F44336; /* Red for flash sale */
            --flash-sale-text: #fff;
            --gradient-primary: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            --gradient-accent: linear-gradient(135deg, #FF6B35 0%, #FF9800 100%);
            --gradient-hero: linear-gradient(135deg, rgba(76, 175, 80, 0.9) 0%, rgba(139, 195, 74, 0.9) 100%);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #66BB6A;
            --secondary-color: #9CCC65;
            --accent-color-orange: #FF8A65;
            --accent-color-yellow: #FFEB3B;
            --accent-color-blue: #64B5F6;
            --text-color: #e2e8f0;
            --light-bg: #1a202c;
            --white: #2d3748;
            --card-bg: #2d3748;
            --shadow: 0 10px 25px rgba(0,0,0,0.3);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.4);
            --border-color: #4a5568;
            --dark-text: #f7fafc;
            --input-bg: #444;
            --promo-banner-bg: #FFB74D;
            --promo-banner-text: #222;
            --flash-sale-bg: #D32F2F;
            --flash-sale-text: #eee;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--light-bg) 0%, #e8f5e8 100%);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hamburger-menu {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: var(--transition);
            position: relative;
            z-index: 1001;
        }

        .hamburger-menu:hover {
            background: rgba(76, 175, 80, 0.1);
            color: var(--primary-color);
        }

        .hamburger-menu:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 32px;
            flex-grow: 1;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            padding: 8px 16px;
            position: relative;
            transition: var(--transition);
            border-radius: var(--border-radius-sm);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--gradient-primary);
            transition: all 0.3s ease-out;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .nav-links a:hover {
            color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
        }

        .nav-links a:hover::after, .nav-links a.active::after {
            width: 80%;
        }

        .nav-icons {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-icons span, .nav-icons button {
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 22px;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
            position: relative;
        }

        .nav-icons span:hover, .nav-icons button:hover {
            color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
            transform: translateY(-2px);
        }

        #cart-icon {
            position: relative;
        }
        
        #cart-count {
            position: absolute;
            top: -8px;
            right: -12px;
            background: var(--gradient-accent);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            border-radius: 50%;
            padding: 4px 8px;
            line-height: 1;
            min-width: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Promo Banner */
        .promo-banner {
            background: var(--gradient-accent);
            color: var(--white);
            text-align: center;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 990;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .promo-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        main {
            flex-grow: 1;
        }

        section {
            padding: 80px 0;
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .hero {
            position: relative;
            text-align: center;
            padding: 120px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 60px;
            background: var(--gradient-hero);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow: hidden;
            height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            align-items: center;
            color: var(--white); /* Text color for hero content */
            animation: heroFadeIn 1s ease-out;
        }
        @keyframes heroFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
        }
        .hero-background-image.active {
            opacity: 1;
        }
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(76,175,80,0.6), rgba(139,195,74,0.6)); /* Green gradient */
            z-index: 2;
        }
        body.dark-mode .hero-overlay {
            background: linear-gradient(to bottom, rgba(102,187,106,0.6), rgba(156,204,101,0.6));
        }

        .hero-content {
            position: relative;
            z-index: 3;
        }

        .hero h1 {
            font-size: 64px;
            color: var(--white);
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            font-weight: 700;
            animation: slideInUp 1s ease-out 0.3s both;
        }

        .hero p {
            font-size: 24px;
            color: var(--white);
            margin-bottom: 48px;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
            animation: slideInUp 1s ease-out 0.6s both;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cta-button {
            background: var(--gradient-accent);
            color: var(--white);
            padding: 20px 40px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: inline-block;
            position: relative;
            overflow: hidden;
            animation: slideInUp 1s ease-out 0.9s both;
        }

        .cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .cta-button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .cta-button:hover::before {
            left: 100%;
        }

        .section-title {
            text-align: center;
            font-size: 48px;
            margin-bottom: 60px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }
        
        /* Category Cards */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 60px;
        }
        
        .category-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 32px 24px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .category-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }
        
        .category-card img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 16px;
            border-radius: 50%;
            background: var(--light-bg);
            padding: 12px;
            transition: var(--transition);
        }
        
        .category-card:hover img {
            transform: scale(1.1);
        }
        
        .category-card h4 {
            font-size: 20px;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .product-grid, .features-grid, .contact-info, .social-links, .about-content, .admin-orders-grid, .testimonial-carousel, .recommended-products-grid {
            display: grid;
            gap: 32px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .product-grid.list-view {
            grid-template-columns: 1fr;
        }

        .product-card, .feature-item, .order-card, .contact-submission-card, .testimonial-card, .loyalty-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 32px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .product-card:hover {
            transform: translateY(-12px);
            box-shadow: var(--shadow-hover);
        }

        .product-grid.list-view .product-card {
            display: flex;
            flex-direction: row; /* Ensure row direction for list view */
            text-align: left;
            gap: 25px;
            align-items: center;
        }
        .product-grid.list-view .product-card img {
            width: 150px; /* Larger image in list view */
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            flex-shrink: 0;
        }
        .product-grid.list-view .product-card .product-info {
            flex-grow: 1;
        }
        .product-grid.list-view .product-card .product-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }

        .product-image-container {
            position: relative;
            width: 100%;
            height: 220px;
            margin-bottom: 24px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
        }
        
        .product-card:hover img {
            transform: scale(1.08);
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            font-size: 14px;
            z-index: 1;
        }

        .product-card img[style*="opacity: 1"] + .image-loading {
            display: none;
        }

        .product-card h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--dark-text);
            font-weight: 600;
        }

        .product-card .price {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .product-card .price del {
            color: #999;
            margin-right: 12px;
            font-size: 0.85em;
        }

        .add-to-cart-btn {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .add-to-cart-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .add-to-cart-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .add-to-cart-btn:hover::before {
            left: 100%;
        }

        .add-to-cart-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Product Icons on Hover */
        .product-card .hover-icons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s;
            z-index: 15;
        }
        .product-card:hover .hover-icons {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        .product-card .hover-icons i {
            font-size: 20px;
            color: var(--text-color);
            background-color: var(--white);
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: color 0.2s, background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .product-card .hover-icons i:hover {
            color: var(--primary-color);
            background-color: var(--light-bg);
            transform: scale(1.1);
        }
        .product-card .hover-icons .fa-heart.fas {
            color: #E91E63; /* Pink for liked heart */
        }
        body.dark-mode .product-card .hover-icons i {
            background-color: var(--dark-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .features-grid .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .features-grid .feature-item i {
            font-size: 60px; /* Larger icons */
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .features-grid .feature-item h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 24px;
        }
        .features-grid .feature-item p {
            font-size: 16px;
            line-height: 1.8;
        }

        .cart-table {
            width: 100%;
            border-collapse: separate; /* For rounded corners on cells */
            border-spacing: 0;
            margin-top: 20px;
            border-radius: var(--border-radius);
            overflow: hidden; /* Ensures rounded corners are visible */
            box-shadow: var(--shadow);
        }

        .cart-table th, .cart-table td {
            text-align: left;
            padding: 18px; /* More padding */
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-text);
        }
        .cart-table th {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
        }
        .cart-table tr:last-child td {
            border-bottom: none;
        }
        .cart-table tbody tr:nth-child(even) {
            background-color: var(--light-bg); /* Zebra striping */
        }
        body.dark-mode .cart-table tbody tr:nth-child(even) {
            background-color: #333;
        }

        .cart-item img {
            width: 70px; /* Larger image */
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--input-bg);
            border-radius: 8px;
            padding: 5px;
            justify-content: center;
        }
        
        .quantity-btn {
            background-color: var(--primary-color);
            border: none;
            width: 35px;
            height: 35px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s, transform 0.2s;
            color: var(--white);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .quantity-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }
        
        .quantity-btn:active {
            transform: scale(0.95);
        }
        
        .quantity-display {
            font-weight: 600;
            color: var(--dark-text);
            min-width: 30px;
            text-align: center;
            padding: 4px 8px;
            background-color: var(--white);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 16px;
        }

        /* Order Items Styling */
        .order-item {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-bg);
        }

        .order-id {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .order-id strong {
            font-size: 18px;
            color: var(--primary-color);
        }

        .order-date {
            font-size: 14px;
            color: var(--muted-text);
        }

        .order-status .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .order-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-items {
            color: var(--text-color);
            line-height: 1.5;
        }

        .order-summary {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .summary-row:last-child {
            margin-bottom: 0;
        }

        .total-row {
            padding-top: 10px;
            margin-top: 10px;
            border-top: 2px solid var(--primary-color);
            font-size: 16px;
        }

        .order-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--muted-text);
            font-size: 14px;
        }

        .order-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .loading-state, .empty-state, .error-state {
            text-align: center;
            padding: 40px 20px;
            border-radius: 12px;
        }

        .loading-state {
            background: var(--light-bg);
            color: var(--text-color);
        }

        .loading-state i {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .empty-state {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--muted-text);
            margin-bottom: 20px;
        }

        .empty-state h4 {
            margin: 10px 0;
            color: var(--text-color);
        }

        .error-state {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .error-state i {
            font-size: 48px;
            color: #dc3545;
            margin-bottom: 20px;
        }

        /* Responsive order items */
        @media (max-width: 768px) {
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .order-meta {
                flex-direction: column;
                gap: 8px;
            }

            .order-item {
                padding: 15px;
            }
        }
        
        .cart-summary-totals {
            text-align: right;
            margin-top: 30px;
            color: var(--dark-text);
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .cart-summary-totals div {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .cart-summary-totals .cart-total-grand {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 20px;
        }

        .checkout-btn {
            display: block;
            margin-top: 30px;
            width: 100%;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 18px; /* Larger padding */
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 700;
            box-shadow: var(--shadow);
        }
        
        .checkout-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .forms-container, .contact-form-container, .admin-panel-login, .auth-modal-content, .newsletter-modal-content {
            max-width: 650px; /* Slightly wider forms */
            margin: 0 auto;
            background-color: var(--white);
            padding: 40px; /* More padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .admin-form input, .admin-form textarea, .contact-form input, .contact-form textarea, .order-track-form input, .admin-panel-login input, .checkout-form input, .payment-form input, .auth-form input, .add-review-form input, .add-review-form textarea, .newsletter-form input, .loyalty-form input {
            width: 100%;
            padding: 15px; /* Larger inputs */
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
            flex-grow: 1; /* Allow input/select to grow */
            min-width: 180px; /* Minimum width for inputs */
        }
        .admin-form input:focus, .admin-form textarea:focus, .contact-form input:focus, .contact-form textarea:focus, .order-track-form input:focus, .admin-panel-login input:focus, .checkout-form input:focus, .payment-form input:focus, .auth-form input:focus, .add-review-form input:focus, .add-review-form textarea:focus, .newsletter-form input:focus, .loyalty-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76,175,80,0.3); /* Focus glow */
        }
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap */
            margin-bottom: 25px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: var(--light-bg);
            padding: 20px; /* Larger touch area */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.2s;
        }
        .payment-option:hover {
            background-color: #e8e8e8;
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .payment-option input[type="radio"] {
            width: 20px; /* Larger radio button */
            height: 20px;
            accent-color: var(--primary-color);
            margin-bottom: 0;
            flex-shrink: 0;
        }

        /* Disabled payment option styling */
        .payment-option.disabled-option {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
            background-color: #f5f5f5;
            border-color: #ddd;
        }

        .payment-option.disabled-option:hover {
            opacity: 0.8;
            background-color: rgba(255, 107, 107, 0.1);
            border-color: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
        }

        .payment-option.disabled-option input[type="radio"] {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .payment-option.disabled-option span {
            cursor: not-allowed;
            color: #666;
        }

        .payment-option.disabled-option span small {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .payment-option.disabled-option {
            background-color: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode .payment-option.disabled-option:hover {
            background-color: rgba(255, 107, 107, 0.2);
        }

        /* Voucher System Styles */
        .order-summary-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .order-summary-section h4 {
            color: var(--primary-color);
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-row.total-row {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            padding-top: 10px;
            margin-top: 10px;
        }

        .voucher-section {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .voucher-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .voucher-input-group input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .voucher-input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .voucher-input-group button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .voucher-input-group button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .voucher-input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voucher-status {
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
        }

        .voucher-status.success {
            background: #e8f5e8;
            color: #4CAF50;
            border: 1px solid #c8e6c9;
            display: block;
        }

        .voucher-status.error {
            background: #ffebee;
            color: #f44336;
            border: 1px solid #ffcdd2;
            display: block;
        }

        .voucher-status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
            display: block;
        }

        .voucher-discount {
            color: #4CAF50;
            font-weight: 600;
        }

        .voucher-discount span:last-child {
            color: #4CAF50;
        }

        /* Dark mode voucher styles */
        body.dark-mode .order-summary-section {
            background: #2d3748;
            border-color: #4a5568;
        }

        body.dark-mode .voucher-section {
            background: #1a202c;
            border-color: #4a5568;
        }

        body.dark-mode .voucher-input-group input {
            background: #444;
            border-color: #4a5568;
            color: var(--text-color);
        }

        body.dark-mode .voucher-input-group input:focus {
            border-color: var(--primary-color);
        }

        /* Enhanced Location Verification Styles */
        .location-verification {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
        }

        .location-info h4 {
            margin: 0 0 12px 0;
            color: #4CAF50;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-details {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .location-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        .detail-value {
            color: #4CAF50;
            font-weight: 500;
        }

        .reverify-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .reverify-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        /* Dark mode location verification */
        body.dark-mode .location-verification {
            background: #1a202c;
            border-color: #4CAF50;
        }

        body.dark-mode .location-info h4 {
            color: #4CAF50;
        }

        body.dark-mode .detail-label {
            color: #e2e8f0;
        }

        body.dark-mode .detail-value {
            color: #4CAF50;
        }

        /* Enhanced Location Section Styling */
        .location-section {
            margin-bottom: 20px;
        }

        /* Make Customer Details Modal scrollable */
        #customer-details-modal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #customer-details-modal .checkout-form {
            max-height: calc(90vh - 120px); /* Account for header and padding */
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px; /* Space for scrollbar */
            scroll-behavior: smooth;
        }

        /* Keep modal header visible */
        #customer-details-modal .modal-content h3 {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Custom scrollbar styling for customer details */
        #customer-details-modal .checkout-form::-webkit-scrollbar {
            width: 6px;
        }

        #customer-details-modal .checkout-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #customer-details-modal .checkout-form::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        #customer-details-modal .checkout-form::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        /* Responsive scrollable design for customer details */
        @media (max-width: 768px) {
            #customer-details-modal .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
                max-height: 95vh;
                overflow-y: auto;
            }

            #customer-details-modal .checkout-form {
                max-height: calc(95vh - 100px);
                padding-right: 5px;
            }
        }

        @media (max-width: 480px) {
            #customer-details-modal .modal-content {
                width: 98%;
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }

            #customer-details-modal .checkout-form {
                max-height: calc(98vh - 80px);
                padding-right: 3px;
            }
        }

        /* Mobile-Optimized Cart Table Styles */
        .cart-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .cart-table th,
        .cart-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--dark-text);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cart-table td {
            color: var(--text-color);
            vertical-align: middle;
        }

        .cart-table img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .cart-item-unit {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .cart-price {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 16px;
        }

        .cart-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cart-quantity-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
        }

        .cart-quantity-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }

        .cart-quantity-display {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--dark-text);
            padding: 8px;
            background: var(--light-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .cart-total {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 18px;
        }

        .cart-remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cart-remove-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        /* Mobile Cart Optimization */
        @media (max-width: 768px) {
            .cart-table {
                font-size: 14px;
            }

            .cart-table,
            .cart-table thead,
            .cart-table tbody,
            .cart-table th,
            .cart-table td,
            .cart-table tr {
                display: block;
            }

            .cart-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .cart-table tr {
                background: var(--white);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-sm);
                margin-bottom: 15px;
                padding: 15px;
                box-shadow: var(--shadow);
                position: relative;
            }

            .cart-table td {
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                padding: 12px 0 12px 40%;
                text-align: left;
                min-height: 50px;
                display: flex;
                align-items: center;
            }

            .cart-table td:last-child {
                border-bottom: none;
            }

            .cart-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 35%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--dark-text);
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .cart-table td[data-label="Product"] {
                padding-left: 0;
                justify-content: flex-start;
            }

            .cart-table td[data-label="Product"]:before {
                display: none;
            }

            .cart-table td[data-label="Product"] img {
                width: 80px;
                height: 80px;
                margin-right: 15px;
            }

            .cart-table td[data-label="Name"] {
                padding-left: 0;
                font-weight: 600;
                font-size: 16px;
            }

            .cart-table td[data-label="Name"]:before {
                display: none;
            }

            .cart-quantity {
                justify-content: flex-start;
            }

            /* Mobile cart summary */
            .cart-summary-totals {
                text-align: center;
                padding: 20px 15px;
            }

            .cart-summary-totals div {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .cart-summary-totals .cart-total-grand {
                font-size: 24px;
            }

            .checkout-btn {
                font-size: 18px;
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            .cart-table tr {
                padding: 12px;
                margin-bottom: 12px;
            }

            .cart-table td {
                padding: 8px 0 8px 40%;
                min-height: 40px;
            }

            .cart-table td:before {
                font-size: 12px;
                width: 38%;
            }

            .cart-table td[data-label="Product"] img {
                width: 70px;
                height: 70px;
                margin-right: 10px;
            }

            .cart-quantity-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .cart-quantity-display {
                min-width: 35px;
                padding: 6px;
                font-size: 14px;
            }

            .cart-remove-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .cart-summary-totals {
                padding: 15px 10px;
            }

            .cart-summary-totals div {
                font-size: 14px;
            }

            .cart-summary-totals .cart-total-grand {
                font-size: 20px;
            }

            .checkout-btn {
                font-size: 16px;
                padding: 14px;
            }
        }

        /* Empty Cart State */
        .cart-empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .cart-empty-state i {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .cart-empty-state h3 {
            color: var(--dark-text);
            margin-bottom: 15px;
            font-size: 24px;
        }

        .cart-empty-state p {
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .cart-empty-state .cta-button {
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .cart-empty-state .cta-button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Dark mode cart styles */
        body.dark-mode .cart-table {
            background: var(--dark-bg);
        }

        body.dark-mode .cart-table th {
            background: #2d3748;
            color: var(--text-color);
        }

        body.dark-mode .cart-table td {
            color: var(--text-color);
            border-color: #4a5568;
        }

        body.dark-mode .cart-table tr {
            background: var(--dark-bg);
            border-color: #4a5568;
        }

        body.dark-mode .cart-quantity-display {
            background: #2d3748;
            border-color: #4a5568;
            color: var(--text-color);
        }

        body.dark-mode .cart-empty-state {
            background: var(--dark-bg);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .location-header label {
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .location-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .location-btn:active {
            transform: translateY(0);
        }

        .location-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .location-btn i {
            font-size: 12px;
        }

        .location-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .location-status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
            display: block;
        }

        .location-status.success {
            background: #e8f5e8;
            color: #4CAF50;
            border: 1px solid #c8e6c9;
            display: block;
        }

        .location-status.error {
            background: #ffebee;
            color: #f44336;
            border: 1px solid #ffcdd2;
            display: block;
        }

        .location-suggestions {
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--white);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .location-suggestions.show {
            display: block;
        }

        .location-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--light-bg);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .location-suggestion:last-child {
            border-bottom: none;
        }

        .location-suggestion:hover {
            background-color: var(--light-bg);
        }

        .location-suggestion i {
            color: var(--primary-color);
            font-size: 14px;
        }

        .location-suggestion .suggestion-text {
            flex: 1;
        }

        .location-suggestion .suggestion-address {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .location-suggestion .suggestion-details {
            font-size: 12px;
            color: var(--muted-text);
        }

        /* Dark mode styles for location section */
        body.dark-mode .location-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        }

        body.dark-mode .location-suggestions {
            background: var(--dark-bg);
            border-color: var(--border-color);
        }

        body.dark-mode .location-suggestion:hover {
            background-color: var(--dark-bg);
        }
        body.dark-mode .payment-option:hover {
            background-color: #444;
        }

        .admin-form button, .contact-form button, .order-track-form button, .admin-panel-login button, .checkout-form button, .payment-form button, .auth-form button, .newsletter-form button, .add-review-form button, .loyalty-form button {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: var(--shadow);
        }

        .admin-form button:hover, .contact-form button:hover, .order-track-form button:hover, .admin-panel-login button:hover, .checkout-form button:hover, .payment-form button:hover, .auth-form button:hover, .newsletter-form button:hover, .add-review-form button:hover, .loyalty-form button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #order-status {
            text-align: center;
            font-size: 22px;
            margin-top: 30px;
            color: var(--dark-text);
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        #order-status strong {
            color: var(--primary-color);
        }

        .map-container {
            height: 450px; /* Taller map */
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        /* START Footer Redesign CSS */
        footer {
            background-color: #111; /* Dark background */
            color: #aaa; /* Light gray text */
            margin-top: auto;
            transition: background-color 0.3s;
            padding: 0; /* Remove padding from footer itself, add to sections */
        }

        body.dark-mode footer {
            background-color: #000; /* Even darker in dark mode for contrast */
            color: #bbb;
        }

        .footer-main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjusted min-width for 3 columns */
            gap: 20px; /* Reduced gap */
            padding: 20px 0; /* Reduced padding */
        }

        .footer-column {
            display: flex; /* For centering content on mobile */
            flex-direction: column; /* For stacking content */
            align-items: flex-start; /* Align left by default */
        }

        .footer-column h4 {
            margin-bottom: 10px; /* Reduced margin */
            color: var(--primary-color);
            font-size: 16px; /* Smaller headings */
        }

        .footer-column p,
        .footer-column a {
            color: #aaa; /* Consistent light gray text for links and paragraphs */
            text-decoration: none;
            display: block;
            margin-bottom: 5px; /* Reduced margin */
            transition: color 0.3s;
            font-size: 14px; /* Smaller text/links */
            line-height: 1.5;
        }
        
        .footer-column a:hover {
            color: var(--primary-color); /* Highlight with brand green */
        }

        .footer-column:nth-child(1) p { /* Brand/About column */
            max-width: 90%; /* Prevent text from being too wide */
        }

        .social-links {
            display: flex;
            gap: 15px; /* Reduced gap */
            margin-top: 10px;
        }
        
        .social-links a {
            font-size: 20px; /* Adjusted icon size */
            color: #aaa; /* Consistent color for social icons */
            transition: color 0.3s, transform 0.2s;
        }

        .social-links a:hover {
            color: var(--primary-color);
            transform: translateY(-2px); /* Subtle lift */
        }

        /* Slim bottom bar with copyright */
        .footer-bottom-bar {
            background-color: #0a0a0a; /* Slightly darker */
            color: #888; /* Slightly darker gray text */
            padding: 10px 0; /* Slim padding */
            text-align: center;
            font-size: 12px; /* Small font size */
            border-top: 1px solid #222; /* Subtle top border */
        }
        body.dark-mode .footer-bottom-bar {
            background-color: #050505;
            border-top-color: #333;
        }
        /* END Footer Redesign CSS */


        .whatsapp-widget {
            position: fixed;
            bottom: 25px; /* Slightly higher */
            right: 25px; /* Slightly more inwards */
            z-index: 1000;
        }
        .whatsapp-widget a {
            background-color: #25D366;
            color: var(--white);
            padding: 18px; /* Larger button */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            font-size: 28px; /* Larger icon */
            text-decoration: none;
            transition: transform 0.3s;
        }
        .whatsapp-widget a:hover {
            transform: scale(1.15); /* More prominent hover */
        }

        /* Custom Message Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* Blurred background */
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%; /* Wider on small screens */
            max-width: 550px; /* Max width */
            text-align: center;
            position: relative;
            transform: translateY(-50px);
            opacity: 0;
            animation: fadeInDown 0.4s forwards;
            color: var(--dark-text);
        }

        @keyframes fadeInDown {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 28px;
        }

        .modal-content p {
            margin-bottom: 25px;
            font-size: 18px;
            line-height: 1.7;
        }

        .modal-content button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
            box-shadow: none; /* Inherit button style, no double shadow */
        }

        .modal-content button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        .close-button:hover {
            color: #f44336; /* Red on hover for close */
            background: rgba(244, 67, 54, 0.1);
            transform: rotate(90deg) scale(1.1);
        }

        /* Mobile close button optimization */
        @media (max-width: 768px) {
            .close-button {
                top: 10px;
                right: 10px;
                font-size: 28px;
                width: 44px;
                height: 44px;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 50%;
            }
            
            .close-button:hover {
                background: rgba(244, 67, 54, 0.2);
                transform: scale(1.1);
            }
            
            .close-button:active {
                transform: scale(0.95);
            }
        }

        @media (max-width: 480px) {
            .close-button {
                top: 8px;
                right: 8px;
                font-size: 24px;
                width: 40px;
                height: 40px;
            }
        }

        /* Newsletter Popup */
        #newsletter-popup.modal .modal-content {
            max-width: 600px;
        }
        #newsletter-popup h3 {
            font-size: 32px;
            color: var(--accent-color-orange);
        }
        #newsletter-popup p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        #newsletter-popup .newsletter-form button {
            background-color: var(--accent-color-orange);
        }
        #newsletter-popup .newsletter-form button:hover {
            background-color: #e68900;
        }


        /* Order Confirmation Page Specific Styling */
        #order-confirmation-page .order-details {
            background-color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            color: var(--dark-text);
        }
        #order-confirmation-page .order-details h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 32px;
        }
        #order-confirmation-page .order-details p {
            margin-bottom: 15px;
            font-size: 18px;
        }
        #order-confirmation-page .order-details strong {
            color: var(--primary-color);
        }
        #order-confirmation-page .order-details ul {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }
        #order-confirmation-page .order-details ul li {
            margin-bottom: 5px;
        }

        /* Enhanced Shop Styling */
        .shop-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .shop-subtitle {
            font-size: 18px;
            color: var(--text-color);
            margin-top: 10px;
            opacity: 0.8;
        }

        /* Enhanced Shop Controls */
        .shop-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            align-items: center;
        }

        .search-section {
            display: flex;
            align-items: center;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }

        .search-input-wrapper i.fa-search {
            position: absolute;
            left: 15px;
            color: var(--text-color);
            opacity: 0.6;
            z-index: 2;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .search-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--white);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .clear-search-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.6;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .clear-search-btn:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-section select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 150px;
        }

        .filter-section select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--white);
        }

        .view-controls {
            display: flex;
            gap: 5px;
            background-color: var(--light-bg);
            padding: 5px;
            border-radius: 8px;
        }

        .view-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-weight: 500;
        }

        .view-btn:hover {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--primary-color);
        }

        .view-btn.active-view {
            background-color: var(--primary-color);
            color: var(--white);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        /* Loading and Empty States */
        .loading-state, .empty-state, .no-results-state {
            text-align: center;
            padding: 60px 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin: 20px 0;
        }

        .loading-spinner {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .empty-icon, .no-results-icon {
            font-size: 64px;
            color: var(--text-color);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .loading-state h3, .empty-state h3, .no-results-state h3 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .loading-state p, .empty-state p, .no-results-state p {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .refresh-btn, .clear-search-btn-large {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover, .clear-search-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Enhanced Product Cards - Compact Design */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .product-grid.list-view {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .product-card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            max-width: 280px;
            margin: 0 auto;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .product-image {
            position: relative;
            overflow: hidden;
            height: 160px;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card:hover .product-overlay {
            opacity: 1;
        }

        .quick-view-btn, .favorite-btn {
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .quick-view-btn:hover, .favorite-btn:hover {
            background: var(--primary-color);
            color: var(--white);
            transform: scale(1.1);
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-description {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 13px;
            margin-bottom: 10px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 6px;
        }

        .product-stock {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .product-stock.in-stock {
            color: var(--primary-color);
        }

        .product-stock.sold-out {
            color: #f44336;
        }

        .add-to-cart-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .add-to-cart-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .add-to-cart-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* List View Styling */
        .product-grid.list-view .product-card {
            display: grid;
            grid-template-columns: 150px 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 20px;
        }

        .product-grid.list-view .product-image {
            height: 120px;
            border-radius: 8px;
        }

        .product-grid.list-view .product-details {
            padding: 0;
        }

        .product-grid.list-view .product-meta {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
        }

        .product-grid.list-view .product-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-grid.list-view .quick-view-btn,
        .product-grid.list-view .favorite-btn {
            width: 40px;
            height: 40px;
        }

        .product-grid.list-view .add-to-cart-btn {
            width: auto;
            padding: 10px 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .shop-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-section select {
                min-width: 100%;
            }
            
            .view-controls {
                justify-content: center;
            }

            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 15px;
            }

            .product-grid.list-view .product-card {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .product-grid.list-view .product-meta {
                justify-content: center;
            }

            .product-grid.list-view .product-actions {
                flex-direction: row;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
            }
            
            .product-card {
                max-width: none;
            }
            
            .product-image {
                height: 140px;
            }
            
            .product-info {
                padding: 12px;
            }
            
            .product-name {
                font-size: 15px;
            }
            
            .product-price {
                font-size: 16px;
            }
        }

        /* Admin Panel - Orders and Products List */
        .admin-section {
            margin-top: 40px;
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            color: var(--dark-text);
        }
        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 28px;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0; /* More padding */
            border-bottom: 1px solid var(--border-color);
        }
        .admin-list-item:last-child {
            border-bottom: none;
        }
        .admin-list-item button {
            padding: 10px 18px; /* Larger buttons */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 15px;
            font-weight: 600;
            box-shadow: none;
        }
        .admin-list-item button:hover {
            transform: translateY(-2px);
        }
        .admin-list-item .delete-btn {
            background-color: #f44336;
            color: var(--white);
            border: none;
        }
        .admin-list-item .delete-btn:hover {
            background-color: #d32f2f;
        }
        .admin-list-item .mark-delivered-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
        }
        .admin-list-item .mark-delivered-btn:hover {
            background-color: var(--secondary-color);
        }
        .admin-list-item .status-delivered {
            color: var(--primary-color);
            font-weight: 700;
        }
        .admin-list-item .order-items-list {
            font-size: 0.95em;
            color: #666;
            margin-top: 5px;
            display: block; /* Ensure it's on a new line */
        }
        body.dark-mode .admin-list-item .order-items-list {
            color: #ccc;
        }

        /* Product Ratings */
        .product-rating {
            color: var(--star-color);
            margin-bottom: 10px;
            font-size: 1.2em; /* Slightly larger stars */
        }
        .product-rating .far { /* Empty star */
            color: #ccc;
        }

        /* Product Badges */
        .product-badge {
            position: absolute;
            top: 15px; /* Slightly more inside */
            left: 15px;
            background-color: var(--primary-color);
            color: var(--white);
            padding: 6px 12px; /* Larger badge */
            border-radius: 6px; /* Less rounded for badges */
            font-size: 0.85em;
            font-weight: 700;
            z-index: 10;
            animation: badgeBounce 0.8s ease-out infinite alternate; /* Subtle bounce */
            transform-origin: bottom;
        }
        @keyframes badgeBounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.03); }
        }
        .product-badge.new { background-color: #2196F3; } /* Blue */
        .product-badge.bestseller { background-color: var(--accent-color-yellow); } /* Amber */
        .product-badge.organic { background-color: #4CAF50; } /* Green */
        .product-badge.discount { background-color: #F44336; animation: none; } /* Red, no bounce for discount */
        .product-badge.discount::before {
            content: '-';
            margin-right: 2px;
        }

        /* Stock Indicator */
        .stock-indicator {
            font-size: 1em;
            margin-top: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .stock-indicator.in-stock { color: var(--primary-color); }
        .stock-indicator.sold-out { color: #f44336; }

        /* Quick View Modal */
        #quick-view-modal .modal-content {
            max-width: 900px; /* Wider modal */
            display: flex;
            flex-direction: column;
            gap: 30px;
            text-align: left;
        }
        #quick-view-modal .modal-content .product-details {
            display: flex;
            gap: 30px;
        }
        #quick-view-modal .modal-content .product-details img {
            width: 50%;
            max-width: 400px;
            height: auto;
            border-radius: var(--border-radius);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #quick-view-modal .modal-content .product-info-qv {
            flex-grow: 1;
        }
        #quick-view-modal .modal-content h3 {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary-color);
        }
        #quick-view-modal .modal-content .price-qv {
            font-size: 26px;
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 20px;
        }
        #quick-view-modal .modal-content .price-qv del {
            color: #999;
            margin-right: 12px;
            font-size: 0.8em;
        }
        #quick-view-modal .modal-content .description-qv {
            margin-bottom: 25px;
            color: var(--dark-text);
            line-height: 1.7;
        }
        #quick-view-modal .modal-content .add-to-cart-btn-qv {
            width: auto;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
        }
        #quick-view-modal .modal-content .product-tags {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #quick-view-modal .modal-content .product-tag {
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .reviews-section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
            text-align: left;
        }
        .reviews-section h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }
        .review-item {
            background-color: var(--light-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .review-item strong {
            color: var(--dark-text);
        }
        .review-item .review-rating {
            color: var(--star-color);
            font-size: 1em;
            margin-left: 10px;
        }
        .add-review-form button {
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
            box-shadow: none;
        }

        /* Recommended Products */
        .recommended-products-grid {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 40px;
        }
        .recommended-products-grid h4 {
            text-align: center;
            font-size: 26px;
            color: var(--primary-color);
            margin-bottom: 30px;
            grid-column: 1 / -1; /* Span all columns */
        }


        /* My Account Page Styling */
        #my-account-page .account-section {
            background-color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            color: var(--dark-text);
        }

        #my-account-page .account-section h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 28px;
        }

        #my-account-page .account-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        #my-account-page .profile-info-card {
            background-color: var(--light-bg);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #my-account-page .profile-info-card p {
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        #my-account-page .profile-info-card strong {
            color: var(--primary-color);
        }

        #my-account-page .account-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
        }

        #my-account-page .account-buttons .cta-button {
            width: auto;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
        }
        #my-account-page .account-buttons .cta-button.logout-btn {
            background-color: #f44336;
        }
        #my-account-page .account-buttons .cta-button.logout-btn:hover {
            background-color: #d32f2f;
        }
        /* Loyalty Program Card */
        .loyalty-card {
            padding: 30px;
            text-align: center;
        }
        .loyalty-card h4 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .loyalty-card .points {
            font-size: 3em;
            font-weight: 700;
            color: var(--accent-color-orange);
            margin-bottom: 10px;
        }
        .loyalty-card p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        .loyalty-card button {
            width: auto;
            padding: 12px 25px;
        }

        /* Enhanced Referral Form Styles */
        .loyalty-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .loyalty-form input,
        .loyalty-form textarea {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            background: var(--input-bg);
            transition: var(--transition);
            font-family: inherit;
        }

        .loyalty-form input:focus,
        .loyalty-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--white);
        }

        .loyalty-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .referral-submit-btn {
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .referral-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .referral-benefits {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(139, 195, 74, 0.1) 100%);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 20px;
        }

        .referral-benefits h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .referral-benefits ul {
            list-style: none;
            padding: 0;
        }

        .referral-benefits li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .referral-benefits li:last-child {
            border-bottom: none;
        }

        .referral-stats {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .referral-stats h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
        }

        .stat-item h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .stat-item p {
            font-size: 12px;
            color: var(--text-color);
            margin: 5px 0 0 0;
        }

        .referral-link-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            margin-top: 20px;
        }

        .referral-link-section h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .referral-code-display {
            background: var(--white);
            padding: 15px;
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .referral-code-display p {
            margin: 0;
            font-size: 16px;
        }

        .referral-code-display span {
            color: var(--primary-color);
            font-weight: 700;
            font-family: monospace;
            font-size: 18px;
        }

        /* Order Display Styles */
        .loading-state, .empty-state, .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color);
        }

        .loading-state i, .empty-state i, .error-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .loading-state i {
            color: var(--primary-color);
        }

        .empty-state i {
            color: #ccc;
        }

        .error-state i {
            color: var(--error-color);
        }

        .loading-state h4, .empty-state h4, .error-state h4 {
            margin: 16px 0 8px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .loading-state p, .empty-state p, .error-state p {
            margin: 8px 0 20px 0;
            color: var(--text-color);
            opacity: 0.8;
        }

        .order-item {
            background: var(--white);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow: hidden;
            transition: var(--transition);
        }

        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--light-bg) 0%, #f0f8f0 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .order-id strong {
            font-size: 18px;
            color: var(--dark-text);
        }

        .order-date {
            display: block;
            font-size: 14px;
            color: var(--text-color);
            margin-top: 4px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-details {
            padding: 20px;
        }

        .order-items {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            line-height: 1.5;
        }

        .order-summary {
            margin-bottom: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .total-row {
            font-size: 16px;
            padding-top: 12px;
            border-top: 2px solid var(--primary-color);
            margin-top: 8px;
        }

        .order-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-color);
        }

        .payment-method, .order-time {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-method i, .order-time i {
            color: var(--primary-color);
            font-size: 14px;
        }

        .referral-link-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .referral-link-container input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            font-size: 14px;
            font-family: monospace;
        }

        .copy-btn {
            padding: 12px 16px;
            background: var(--accent-color-blue);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .copy-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .social-share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .social-share-btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .social-share-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .social-share-btn.facebook {
            background: #1877F2;
            color: white;
        }

        .social-share-btn.twitter {
            background: #1DA1F2;
            color: white;
        }

        .social-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .referral-notifications {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--primary-color);
        }

        .notification-header h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-text {
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Testimonials Carousel */
        .testimonial-carousel-wrapper {
            position: relative;
            padding: 0 20px; /* Space for nav buttons */
            margin-bottom: 60px;
        }
        .testimonial-carousel {
            grid-template-columns: 1fr; /* Only one testimonial visible at a time */
            overflow: hidden;
            scroll-behavior: smooth;
            padding-bottom: 20px; /* Space for indicators */
        }
        .testimonial-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin: 0 10px; /* Space between cards, hidden by overflow */
            flex-shrink: 0; /* Prevent cards from shrinking */
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0; /* Start hidden for JS handling */
            transition: opacity 0.5s ease-in-out;
        }
        .testimonial-card.active {
            opacity: 1;
        }

        .testimonial-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .testimonial-card p {
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--dark-text);
        }
        .testimonial-card strong {
            color: var(--primary-color);
            font-size: 1.2em;
        }

        .carousel-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 15px 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, transform 0.2s;
            z-index: 50;
        }
        .carousel-nav-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-50%) scale(1.05);
        }
        .carousel-nav-btn.left { left: 0; }
        .carousel-nav-btn.right { right: 0; }

        .testimonial-indicators {
            text-align: center;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .testimonial-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .testimonial-indicator.active {
            background-color: var(--primary-color);
        }

        /* Payment Icons */
        .payment-icons {
            text-align: center;
            margin-top: 60px;
            padding: 30px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .payment-icons h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 28px;
        }
        .payment-icons .icon-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        .payment-icons i {
            font-size: 50px; /* Larger icons */
            color: var(--text-color);
            transition: color 0.3s, transform 0.2s;
        }
        .payment-icons i:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        /* Specific colors for some payment methods for visual recognition */
        .payment-icons .fa-cc-visa { color: #1a2c8c; }
        .payment-icons .fa-cc-mastercard { color: #eb001b; }
        .payment-icons .fa-cc-paypal { color: #0070ba; }
        .payment-icons .fa-mobile-alt { color: #25D366; } /* M-Pesa like green */


        /* Enhanced Cart Preview Sidebar */
        .cart-preview-sidebar {
            position: fixed;
            top: 0;
            right: -450px; /* Hidden by default - wider for full functionality */
            width: 420px; /* Wider for better functionality */
            height: 100%;
            background-color: var(--white);
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            z-index: 1500;
            transition: right 0.4s ease-out;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .cart-preview-sidebar.active {
            right: 0;
        }
        
        .cart-preview-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .cart-preview-header h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .cart-preview-header .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: white;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cart-preview-header .close-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .cart-preview-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--white);
        }
        
        .cart-preview-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .cart-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .cart-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .cart-preview-item-info {
            flex-grow: 1;
            text-align: left;
            color: var(--dark-text);
        }
        
        .cart-preview-item-info h4 {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .cart-preview-item-info .item-price {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .cart-preview-item-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .cart-preview-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cart-preview-quantity-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .cart-preview-quantity-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        .cart-preview-quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: var(--dark-text);
            padding: 4px 8px;
            background: var(--white);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .cart-preview-remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .cart-preview-remove-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }
        
        .cart-preview-totals {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--light-bg);
        }
        
        .cart-preview-totals .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .cart-preview-totals .total-row:last-child {
            margin-bottom: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
        }
        
        .cart-preview-actions {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
        }
        
        .cart-preview-actions button {
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .cart-preview-actions .checkout-preview-btn {
            background: var(--primary-color);
            color: white;
        }
        
        .cart-preview-actions .checkout-preview-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .cart-preview-empty {
            text-align: center;
            color: var(--text-color);
            padding: 60px 20px;
        }
        
        .cart-preview-empty i {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .cart-preview-empty h4 {
            color: var(--dark-text);
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .cart-preview-empty p {
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .cart-preview-empty .cta-button {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }
        
        .cart-preview-empty .cta-button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Toast Message System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast-message {
            background: var(--white);
            color: var(--dark-text);
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-hover);
            border-left: 4px solid var(--primary-color);
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .toast-message.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-message.success {
            border-left-color: #4CAF50;
        }

        .toast-message.success .toast-icon {
            color: #4CAF50;
        }

        .toast-message.warning {
            border-left-color: #FF9800;
        }

        .toast-message.warning .toast-icon {
            color: #FF9800;
        }

        .toast-message.error {
            border-left-color: #f44336;
        }

        .toast-message.error .toast-icon {
            color: #f44336;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-message p {
            margin: 0;
            font-size: 13px;
            opacity: 0.8;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .toast-close:hover {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }

        /* Mobile toast adjustments */
        @media (max-width: 768px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast-message {
                min-width: auto;
                max-width: none;
                width: 100%;
            }
        }
        
        /* Flash Sale Timer */
        .flash-sale-banner {
            background-color: var(--flash-sale-bg);
            color: var(--flash-sale-text);
            text-align: center;
            padding: 15px 20px;
            margin-top: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .flash-sale-banner h3 {
            color: var(--flash-sale-text);
            font-size: 28px;
            margin-bottom: 0;
        }
        .flash-sale-banner .countdown {
            display: flex;
            gap: 15px;
            font-size: 2em;
            font-weight: 700;
        }
        .flash-sale-banner .countdown span {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }
        .flash-sale-banner .countdown small {
            font-size: 0.4em;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Sticky Bottom Navigation for Mobile */
        .bottom-nav {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            transition: background-color 0.3s;
        }
        .bottom-nav a {
            flex: 1;
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 14px;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }
        .bottom-nav a i {
            font-size: 22px;
            transition: color 0.3s;
        }
        .bottom-nav a:hover, .bottom-nav a.active {
            color: var(--primary-color);
        }
        .bottom-nav a:hover i, .bottom-nav a.active i {
            color: var(--primary-color);
        }


        /* Mobile Navigation Overlay */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .hamburger-menu {
                display: block;
            }

            .nav-links {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 300px;
                height: 100vh;
                background: var(--white);
                box-shadow: var(--shadow-hover);
                flex-direction: column;
                padding: 80px 0 20px 0;
                gap: 0;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                overflow-y: auto;
            }

            .nav-links.mobile-nav-open {
                display: flex;
                transform: translateX(0);
            }

            .nav-links li {
                width: 100%;
                border-bottom: 1px solid var(--border-color);
            }

            .nav-links li:last-child {
                border-bottom: none;
            }

            .nav-links a {
                display: block;
                width: 100%;
                padding: 16px 24px;
                text-align: left;
                border-radius: 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-color);
                transition: var(--transition);
            }

            .nav-links a:hover, .nav-links a.active {
                background: rgba(76, 175, 80, 0.1);
                color: var(--primary-color);
                padding-left: 32px;
            }

            .nav-links a::after {
                display: none;
            }

            .nav-left {
                flex: 1;
            }

            .logo {
                font-size: 28px;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                width: 280px;
                padding: 70px 0 20px 0;
            }

            .logo {
                font-size: 24px;
            }

            .hamburger-menu {
                font-size: 22px;
            }
            
            .hero {
                padding: 60px 20px;
                height: 350px;
            }
            .hero h1 {
                font-size: 38px;
            }
            .hero p {
                font-size: 18px;
            }
            .section-title {
                font-size: 32px;
            }
            .product-grid, .features-grid, .admin-orders-grid, .recommended-products-grid {
                grid-template-columns: 1fr;
            }
            .footer-main-content {
                grid-template-columns: 1fr; /* Stack columns on mobile */
                text-align: center;
            }
            .footer-column {
                align-items: center; /* Center content in stacked columns */
            }
            .footer-column:nth-child(1) p {
                max-width: 100%; /* Allow full width for text */
            }
            .social-links {
                justify-content: center;
            }
            .shop-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .shop-controls input, .shop-controls select, .shop-controls button {
                width: 100%;
            }
            #quick-view-modal .modal-content .product-details {
                flex-direction: column;
                align-items: center;
            }
            #quick-view-modal .modal-content .product-details img {
                width: 100%;
                max-width: 100%;
            }
            .product-grid.list-view .product-card {
                flex-direction: column;
                text-align: center;
            }
            .product-grid.list-view .product-card .product-actions {
                align-items: center;
            }
            #my-account-page .account-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            #my-account-page .account-section h3 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            #my-account-page .account-details-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }
            
            #my-account-page .profile-info-card {
                padding: 20px;
            }
            
            #my-account-page .profile-info-card p {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            #my-account-page .account-buttons {
                flex-direction: column;
                gap: 15px;
                margin-top: 30px;
            }
            
            #my-account-page .account-buttons .cta-button {
                padding: 16px 24px;
                font-size: 16px;
                width: 100%;
            }
            
            .loyalty-card {
                padding: 20px;
            }
            
            .loyalty-card h4 {
                font-size: 20px;
            }
            
            .loyalty-card .points {
                font-size: 2.5em;
            }
            
            .loyalty-card p {
                font-size: 16px;
            }
            
            .referral-benefits {
                padding: 15px;
            }
            
            .referral-benefits h4 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            .referral-stats {
                padding: 15px;
            }
            
            .referral-stats h4 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .stat-item {
                padding: 12px;
            }
            
            .stat-item h3 {
                font-size: 20px;
            }
            
            .stat-item p {
                font-size: 11px;
            }
            
            .referral-link-section {
                padding: 15px;
            }
            
            .referral-link-section h4 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .referral-code-display {
                padding: 12px;
            }
            
            .referral-code-display p {
                font-size: 14px;
            }
            
            .referral-code-display span {
                font-size: 16px;
            }
            
            .referral-link-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .referral-link-container input {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .copy-btn {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .social-share-buttons {
                gap: 8px;
            }
            
            .social-share-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .referral-notifications {
                padding: 12px;
            }
            
            .notification-header h4 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .notification-item {
                padding: 6px 0;
            }
            
            .notification-text {
                font-size: 13px;
            }
            
            .notification-time {
                font-size: 11px;
            }
            .cart-preview-sidebar {
                width: 100%; /* Full width on mobile */
                right: -100%;
            }
            .cart-preview-sidebar.active {
                right: 0;
            }
            
            .cart-preview-header {
                padding: 15px;
            }
            
            .cart-preview-header h3 {
                font-size: 20px;
            }
            
            .cart-preview-items {
                padding: 15px;
            }
            
            .cart-preview-item {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .cart-preview-item img {
                width: 70px;
                height: 70px;
            }
            
            .cart-preview-item-info h4 {
                font-size: 15px;
            }
            
            .cart-preview-quantity-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .cart-preview-remove-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .cart-preview-totals {
                padding: 15px;
            }
            
            .cart-preview-actions {
                padding: 15px;
            }
            
            .cart-preview-actions button {
                padding: 16px 20px;
                font-size: 18px;
            }
            .bottom-nav {
                display: flex; /* Show on mobile */
            }
            body {
                padding-bottom: 70px; /* Space for sticky bottom nav */
            }
            .promo-banner {
                position: relative; /* Make it flow with content on small screens */
                top: auto;
            }
        }
        @media (max-width: 480px) {
            .logo { font-size: 24px; }
            .nav-icons span, .nav-icons button, .hamburger-menu { font-size: 22px; }
            .hero h1 { font-size: 32px; }
            .hero p { font-size: 16px; }
            .section-title { font-size: 28px; }
            .cta-button { padding: 12px 25px; font-size: 16px; }
            .modal-content { padding: 25px; }
            .modal-content h3 { font-size: 24px; }
            .modal-content p { font-size: 15px; }
            .flash-sale-banner h3 { font-size: 22px; }
            .flash-sale-banner .countdown { font-size: 1.5em; }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.auth = auth;
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.onSnapshot = onSnapshot;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
        
        // Test Firebase connection
        console.log("🔥 Firebase initialized successfully!");
        console.log("Firebase App:", app);
        console.log("Firebase Auth:", auth);
        console.log("Firebase DB:", db);
        
        // Test if we can access the global variables
        console.log("Global window.db:", window.db);
        console.log("Global window.collection:", window.collection);
        
        // Test product loading immediately
        setTimeout(async () => {
            console.log("🧪 Testing product loading...");
            try {
                await loadProductsFromFirestore();
            } catch (error) {
                console.error("❌ Product loading test failed:", error);
            }
        }, 2000);
    </script>
</head>
<body>

    <header>
        <div class="container">
            <nav>
                <div class="nav-left">
                    <button id="mobile-menu-toggle" class="hamburger-menu" aria-label="Toggle mobile menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">Prince Alex Store</div>
                </div>
                
                <ul class="nav-links" id="nav-links">
                    <li><a href="#" class="page-link active" data-page="home">Home</a></li>
                    <li><a href="#" class="page-link" data-page="shop">Shop</a></li>
                    <li><a href="#" class="page-link" data-page="cart">Cart</a></li>
                    <li><a href="#" class="page-link" data-page="track-order">Track Order</a></li>
                    <li><a href="#" class="page-link" data-page="contact">Contact Us</a></li>
                    <li><a href="#" class="page-link" data-page="about">About Us</a></li>
                    <li id="auth-link-container"><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>
                </ul>
                
                <div class="nav-icons">
                    <span id="cart-icon"><i class="fas fa-shopping-cart"></i><span id="cart-count">0</span></span>
                    <button id="dark-mode-toggle"><i class="fas fa-moon"></i></button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div id="mobile-nav-overlay" class="mobile-nav-overlay"></div>

    <div class="promo-banner" id="promo-banner">
        Free Delivery on orders above KES 2,000! Limited Time Offer!
    </div>

    <main class="container">
        
        <!-- Home Page -->
        <section id="home-page" class="active">
            <div class="hero">
                <img src="vegetable1.jpg" alt="Fresh Vegetables 1" class="hero-background-image active">
                <img src="vegetable2.jpg" alt="Fresh Vegetables 2" class="hero-background-image">
                <img src="vegetable3.jpg" alt="Fresh Vegetables 3" class="hero-background-image">
                <div class="hero-overlay"></div>
                <div class="hero-content">
                    <h1>Farm Fresh Vegetables, Delivered to Your Door!</h1>
                    <p>Order fresh veggies today and taste the difference.</p>
                    <a href="#" class="cta-button page-link" data-page="shop">Shop Now</a>
                </div>
            </div>

            <div class="flash-sale-banner" data-aos="fade-up">
                <h3>Flash Sale! 20% Off All Leafy Greens!</h3>
                <div class="countdown" id="flash-sale-countdown">
                    <span><span id="countdown-days">00</span><small>Days</small></span>
                    <span><span id="countdown-hours">00</span><small>Hours</small></span>
                    <span><span id="countdown-minutes">00</span><small>Minutes</small></span>
                    <span><span id="countdown-seconds">00</span><small>Seconds</small></span>
                </div>
            </div>

            <h2 class="section-title" data-aos="fade-up">Why Choose Us?</h2>
            <div class="features-grid">
                <div class="feature-item" data-aos="fade-up" data-aos-delay="100">
                    <i class="fas fa-seedling"></i>
                    <h4>Farm Fresh</h4>
                    <p>Harvested daily to ensure maximum freshness and nutrition.</p>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="200">
                    <i class="fas fa-leaf"></i>
                    <h4>Organic & Healthy</h4>
                    <p>Grown without harmful chemicals, just as nature intended.</p>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="300">
                    <i class="fas fa-truck"></i>
                    <h4>Fast Delivery</h4>
                    <p>Quick and reliable delivery across all major Kenyan counties.</p>
                </div>
            </div>

            <h2 class="section-title" data-aos="fade-up">What Our Customers Say</h2>
            <div class="testimonial-carousel-wrapper" data-aos="fade-up">
                <div class="testimonial-carousel" id="testimonial-carousel">
                    <!-- Testimonials will be dynamically loaded here -->
                </div>
                <button class="carousel-nav-btn left" id="testimonial-prev-btn"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-nav-btn right" id="testimonial-next-btn"><i class="fas fa-chevron-right"></i></button>
                <div class="testimonial-indicators" id="testimonial-indicators"></div>
            </div>

            <div class="payment-icons" data-aos="fade-up">
                <h3>Trusted Payment Methods</h3>
                <div class="icon-list">
                    <i class="fab fa-cc-visa" title="Visa"></i>
                    <i class="fab fa-cc-mastercard" title="MasterCard"></i>
                    <i class="fas fa-mobile-alt" title="M-Pesa"></i> <!-- Using mobile-alt for M-Pesa -->
                    <i class="fab fa-cc-paypal" title="PayPal"></i>
                    <!-- Add more payment icons as needed -->
                </div>
            </div>

        </section>

        <!-- Shop Page -->
        <section id="shop-page">
            <div class="shop-header">
                <h2 class="section-title" data-aos="fade-down">Fresh Vegetables Shop</h2>
                <p class="shop-subtitle" data-aos="fade-up">Farm-fresh vegetables delivered to your doorstep</p>
            </div>
            
            <!-- Enhanced Shop Controls -->
            <div class="shop-controls" data-aos="fade-up">
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Search for vegetables..." onkeyup="filterProducts()">
                        <button onclick="clearSearch()" class="clear-search-btn" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="filter-section">
                    <select id="filter-category" onchange="filterProducts()">
                        <option value="">All Categories</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="leafy greens">Leafy Greens</option>
                        <option value="herbs">Herbs</option>
                        <option value="fruits">Fruits</option>
                        <option value="organic">Organic</option>
                    </select>
                    
                    <select id="sort-products" onchange="sortProducts()">
                        <option value="name">Sort by Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="rating">Rating</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
                
                <div class="view-controls">
                    <button id="grid-view-btn" onclick="toggleView('grid')" class="view-btn active-view" title="Grid View">
                        <i class="fas fa-th"></i>
                        <span>Grid</span>
                    </button>
                    <button id="list-view-btn" onclick="toggleView('list')" class="view-btn" title="List View">
                        <i class="fas fa-list"></i>
                        <span>List</span>
                    </button>
                </div>
            </div>
            
            <!-- Products Display Area -->
            <div id="product-list" class="product-grid" data-aos="fade-up">
                <!-- Products will be dynamically loaded here -->
            </div>
            
            <!-- Loading State -->
            <div id="loading-state" class="loading-state" style="display: none;">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h3>Loading Fresh Products...</h3>
                <p>Please wait while we fetch the latest vegetables for you.</p>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-shopping-basket"></i>
                </div>
                <h3>No Products Found</h3>
                <p>We're currently updating our fresh product selection. Please check back soon!</p>
                <button onclick="refreshProducts()" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh Products
                </button>
            </div>
            
            <!-- No Search Results -->
            <div id="no-results-state" class="no-results-state" style="display: none;">
                <div class="no-results-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3>No Products Match Your Search</h3>
                <p>Try adjusting your search terms or browse all categories.</p>
                <button onclick="clearSearch()" class="clear-search-btn-large">
                    <i class="fas fa-times"></i> Clear Search
                </button>
            </div>
        </section>

        <!-- Cart Page - Removed, using cart preview sidebar instead -->

        <!-- Order Confirmation Page -->
        <section id="order-confirmation-page">
            <h2 class="section-title" data-aos="fade-down">Order Confirmed!</h2>
            <div class="order-details" id="last-order-details" data-aos="fade-up">
                <p>Your order details will appear here.</p>
            </div>
        </section>

        <!-- Order Tracking Page -->
        <section id="track-order-page">
            <h2 class="section-title" data-aos="fade-down">Track Your Order</h2>
            <div class="forms-container" data-aos="fade-up">
                <form class="order-track-form" onsubmit="trackOrder(event)">
                    <input type="text" id="order-id-input" placeholder="Enter your Order ID" required>
                    <button type="submit">Track Order</button>
                </form>
                <div id="order-status"></div>
            </div>
        </section>

        <!-- Contact Us Page -->
        <section id="contact-page">
            <h2 class="section-title" data-aos="fade-down">Get in Touch</h2>
            <div class="contact-form-container" data-aos="fade-up">
                <form class="contact-form" onsubmit="submitContactForm(event)">
                    <input type="text" id="contact-name" placeholder="Your Name" required>
                    <input type="email" id="contact-email" placeholder="Your Email" required>
                    <textarea id="contact-message" rows="5" placeholder="Your Message" required></textarea>
                    <button type="submit">Send Message</button>
                </form>
            </div>
            <div class="map-container" data-aos="fade-up" data-aos-delay="200">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15955.289139260586!2d36.81255535!3d-1.2842426999999998!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x182f1172d84d49a7%3A0xf7cf54a935de98e8!2sNairobi%2C%20Kenya!5e0!3m2!1sen!2ske!4v1700000000000!5m2!1sen!2ske" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </section>
        
        <!-- About Us Page -->
        <section id="about-page">
            <h2 class="section-title" data-aos="fade-down">Our Story</h2>
            <div class="about-content" data-aos="fade-up">
                <p><strong>Prince Alex Online Store</strong> was founded with a simple mission: to bring the freshest, most organic vegetables directly from the farm to your table. We believe that everyone deserves access to healthy, nutritious food without the hassle of a market trip.</p>
                <p>We are currently operating primarily in <strong>Vihiga County</strong>, with our headquarter located at <strong>Tambua Ward</strong>. We are proud to partner with local Kenyan farmers who share our passion for sustainable and ethical farming. We carefully select each product to ensure it meets our high standards of quality and freshness.</p>
                <p>Our vision is to expand our reach to more counties soon, becoming the leading online platform for farm-fresh produce in Kenya, empowering local farmers and providing our customers with a convenient and reliable source of healthy food. Thank you for supporting our mission!</p>
            </div>
        </section>

        <!-- My Account Page -->
        <section id="my-account-page">
            <h2 class="section-title" data-aos="fade-down">My Account</h2>
            <div class="account-section" data-aos="fade-up">
                <p style="text-align: center;">Welcome, <strong id="account-username">Guest</strong>!</p>
                <h3>Your Profile Details</h3>
                <div class="account-details-grid">
                    <div class="profile-info-card">
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
                    </div>
                </div>
                <div class="account-buttons">
                    <button class="cta-button" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="cta-button logout-btn" onclick="window.logoutUser()">Logout</button>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="100">
                <h3>Your Past Orders</h3>
                <div id="user-orders-list">
                    <p style="text-align: center;">No past orders found.</p>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="200">
                <h3>Loyalty & Rewards Program</h3>
                <div class="loyalty-card">
                    <h4>Your Current Points:</h4>
                    <p class="points" id="loyalty-points">0</p>
                    <p>Earn points with every purchase and redeem them for exclusive discounts!</p>
                    <button class="cta-button">Learn More</button>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="300">
                <h3>Refer a Friend & Earn Rewards</h3>
                <div class="loyalty-card">
                    <div class="referral-benefits">
                        <h4>🎁 Referral Benefits</h4>
                        <ul>
                            <li><strong>You earn:</strong> 50 loyalty points when your friend makes their first order</li>
                            <li><strong>Your friend gets:</strong> 15% discount on their first order (code: FRIEND15)</li>
                            <li><strong>Bonus:</strong> 25 points when they sign up</li>
                        </ul>
                    </div>
                    
                    <div class="referral-stats" id="referral-dashboard">
                        <h4>📊 Your Referral Stats</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <h3 id="total-sent">0</h3>
                                <p>Referrals Sent</p>
                            </div>
                            <div class="stat-item">
                                <h3 id="total-accepted">0</h3>
                                <p>Friends Joined</p>
                            </div>
                            <div class="stat-item">
                                <h3 id="total-rewards">0</h3>
                                <p>Points Earned</p>
                            </div>
                        </div>
                    </div>

                    <form class="loyalty-form" onsubmit="submitReferralFormEnhanced(event)">
                        <div class="form-group">
                            <label for="referral-email">Friend's Email Address</label>
                            <input type="email" id="referral-email" placeholder="Enter friend's email address" required>
                        </div>
                        <div class="form-group">
                            <label for="referral-message">Personal Message (Optional)</label>
                            <textarea id="referral-message" placeholder="Add a personal message to your invitation..." rows="3"></textarea>
                        </div>
                        <button type="submit" class="referral-submit-btn">
                            <i class="fas fa-paper-plane"></i> Send Invitation
                        </button>
                    </form>

                    <div class="referral-link-section">
                        <h4>🔗 Your Referral Code & Link</h4>
                        <div class="referral-code-display">
                            <p><strong>Your Referral Code:</strong> <span id="user-referral-code">Loading...</span></p>
                        </div>
                        <p>Share this link with friends via WhatsApp, email, or social media:</p>
                        <div class="referral-link-container">
                            <input type="text" id="referral-link-input" value="princealex.com/refer/YOUR_CODE" readonly>
                            <button onclick="copyReferralLink()" class="copy-btn">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                        </div>
                        
                        <div class="social-share-buttons">
                            <button onclick="shareOnWhatsApp()" class="social-share-btn whatsapp">
                                <i class="fab fa-whatsapp"></i> Share on WhatsApp
                            </button>
                            <button onclick="shareOnFacebook()" class="social-share-btn facebook">
                                <i class="fab fa-facebook"></i> Share on Facebook
                            </button>
                            <button onclick="shareOnTwitter()" class="social-share-btn twitter">
                                <i class="fab fa-twitter"></i> Share on Twitter
                            </button>
                        </div>
                    </div>

                    <div class="referral-notifications" id="referral-notifications">
                        <!-- Real-time referral notifications will appear here -->
                    </div>
                </div>
            </div>

        </section>
    
    <!-- Login / Signup Page (Redirects to Modals) -->
    <section id="login-page">
        <h2 class="section-title" data-aos="fade-down">Access Your Account</h2>
        <div class="forms-container" data-aos="fade-up">
            <p style="text-align: center; margin-bottom: 20px;">Please use the buttons below to Login or Sign Up. Our new authentication system uses pop-up windows for a smoother experience.</p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button class="cta-button" style="width: auto;" onclick="openLoginModal(); return false;">Login</button>
                <button class="cta-button" style="width: auto; background-color: var(--accent-color-orange);" onclick="openSignupModal(); return false;">Sign Up</button>
            </div>
        </div>
    </section>

</main>

    <footer>
        <div class="container footer-main-content">
            <div class="footer-column">
                <h4>About Prince Alex Store</h4>
                <p>Bringing you the freshest, organic vegetables directly from local Kenyan farms to your table. Quality and freshness guaranteed.</p>
            </div>
            <div class="footer-column">
                <h4>Quick Links</h4>
                <a href="#" class="page-link" data-page="home">Home</a>
                <a href="#" class="page-link" data-page="shop">Shop</a>
                <a href="#" class="page-link" data-page="cart">Cart</a>
                <a href="#" class="page-link" data-page="contact">Contact Us</a>
            </div>
            <div class="footer-column">
                <h4>Contact & Follow Us</h4>
                <p><i class="fas fa-phone-alt"></i> 0717384875</p>
                <p><i class="fas fa-envelope"></i> princealexdigital@gmail.com</p>
                <div class="social-links">
                    <a href="https://facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://tiktok.com" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
                    <a href="https://instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom-bar">
            <div class="container">
                &copy; <span id="current-year"></span> Prince Alex Store. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Sticky Bottom Navigation for Mobile -->
    <nav class="bottom-nav" id="bottom-nav">
        <a href="#" class="page-link active" data-page="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="page-link" data-page="shop">
            <i class="fas fa-store"></i>
            <span>Shop</span>
        </a>
        <a href="#" class="page-link" onclick="openCartPreview(); return false;">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="#" class="page-link" data-page="my-account">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <div class="whatsapp-widget">
        <a href="https://wa.me/254717384875" target="_blank" title="Chat on WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <!-- Newsletter Signup Modal -->
    <div id="newsletter-popup" class="modal">
        <div class="modal-content newsletter-modal-content">
            <span class="close-button" onclick="closeNewsletterPopup()">&times;</span>
            <i class="fas fa-envelope-open-text" style="font-size: 60px; color: var(--accent-color-orange); margin-bottom: 20px;"></i>
            <h3>Join Our Fresh Family!</h3>
            <p>Subscribe to our newsletter and get **10% OFF** your first order!</p>
            <form class="newsletter-form" onsubmit="subscribeToNewsletter(event)">
                <input type="email" id="newsletter-email" placeholder="Enter your email address" required>
                <button type="submit">Subscribe & Get Discount</button>
            </form>
        </div>
    </div>


    <!-- Quick View Modal -->
    <div id="quick-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeQuickViewModal()">&times;</span>
            <div class="product-details">
                <img id="qv-image" src="" alt="Product Image">
                <div class="product-info-qv">
                    <h3 id="qv-name"></h3>
                    <div id="qv-rating" class="product-rating"></div>
                    <p id="qv-price" class="price-qv"></p>
                    <p id="qv-description" class="description-qv"></p>
                    <div id="qv-stock" class="stock-indicator"></div>
                    <div id="qv-tags" class="product-tags"></div>
                    <button id="qv-add-to-cart-btn" class="add-to-cart-btn-qv">Add to Cart</button>
                </div>
            </div>
            <div class="reviews-section">
                <h4>Customer Reviews</h4>
                <div id="qv-reviews-list">
                    <!-- Reviews will be loaded here -->
                </div>
                <div id="add-review-container">
                    <!-- Add Review Form will be loaded here if logged in -->
                </div>
            </div>
            <div class="recommended-products-grid">
                <h4>Recommended for You</h4>
                <div id="qv-recommended-list" class="product-grid">
                    <!-- Recommended products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customer-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCustomerDetailsModal()">&times;</span>
            <h3>Your Delivery Details</h3>
            <form id="checkout-form" class="checkout-form">
                <input type="text" id="customer-full-name" placeholder="Full Name" required>
                <input type="text" id="customer-id" placeholder="ID Number (National ID/Passport)" required>
                <input type="tel" id="customer-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                
                <!-- Enhanced Location Section -->
                <div class="location-section">
                    <div class="location-header">
                        <label for="customer-delivery-location">Delivery Location</label>
                        <button type="button" id="get-location-btn" onclick="getCurrentLocation()" class="location-btn">
                            <i class="fas fa-map-marker-alt"></i> Use My Location
                        </button>
                    </div>
                    <input type="text" id="customer-delivery-location" placeholder="Enter your delivery address (e.g., Street, Estate, Town)" required>
                    <div id="location-status" class="location-status"></div>
                    <div id="location-suggestions" class="location-suggestions"></div>
                    
                    <!-- Hidden fields for precise coordinates -->
                    <input type="hidden" id="customer-latitude" name="latitude">
                    <input type="hidden" id="customer-longitude" name="longitude">
                    <input type="hidden" id="customer-accuracy" name="accuracy">
                    <input type="hidden" id="customer-address-components" name="address-components">
                    
                    <!-- Location verification section -->
                    <div id="location-verification" class="location-verification" style="display: none;">
                        <div class="location-info">
                            <h4><i class="fas fa-map-pin"></i> Location Verified</h4>
                            <div class="location-details">
                                <div class="location-detail">
                                    <span class="detail-label">Coordinates:</span>
                                    <span class="detail-value" id="coordinates-display"></span>
                                </div>
                                <div class="location-detail">
                                    <span class="detail-label">Accuracy:</span>
                                    <span class="detail-value" id="accuracy-display"></span>
                                </div>
                                <div class="location-detail">
                                    <span class="detail-label">Address:</span>
                                    <span class="detail-value" id="verified-address"></span>
                                </div>
                            </div>
                            <button type="button" onclick="reverifyLocation()" class="reverify-btn">
                                <i class="fas fa-sync-alt"></i> Re-verify Location
                            </button>
                        </div>
                    </div>
                </div>
                
                <input type="text" id="customer-house-name" placeholder="House Name/Number (Optional)">
                <textarea id="customer-additional-notes" placeholder="Additional delivery instructions (Optional)" rows="3"></textarea>
                <button type="submit">Continue to Payment</button>
            </form>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="payment-method-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentMethodModal()">&times;</span>
            <h3>Complete Your Order</h3>
            
            <!-- Order Summary Section -->
            <div class="order-summary-section">
                <h4>Order Summary</h4>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="payment-subtotal">KES 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee:</span>
                    <span id="payment-delivery-fee">KES 0.00</span>
                </div>
                
                <!-- Voucher Section -->
                <div class="voucher-section">
                    <div class="voucher-input-group">
                        <input type="text" id="voucher-code" placeholder="Enter voucher code" maxlength="20">
                        <button type="button" id="apply-voucher-btn" onclick="applyVoucher()">
                            <i class="fas fa-ticket-alt"></i> Apply
                        </button>
                    </div>
                    <div id="voucher-status" class="voucher-status"></div>
                    <div id="voucher-discount" class="summary-row voucher-discount" style="display: none;">
                        <span>Voucher Discount:</span>
                        <span id="voucher-discount-amount">-KES 0.00</span>
                    </div>
                </div>
                
                <div class="summary-row total-row">
                    <span>Total:</span>
                    <span id="payment-total">KES 0.00</span>
                </div>
            </div>

            <form id="payment-form" class="payment-form" onsubmit="processPayment(event)">
                <h4>Select Payment Method</h4>
                <div class="payment-options">
                    <label class="payment-option disabled-option" onclick="showDevelopmentMessage('M-Pesa')">
                        <input type="radio" name="payment-method" value="mpesa" disabled>
                        <span>M-Pesa <small style="color: #ff6b6b;">(In Development)</small></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="cash" checked>
                        <span>Cash on Delivery <small style="color: #4CAF50;">(Available)</small></span>
                    </label>
                    <label class="payment-option disabled-option" onclick="showDevelopmentMessage('Card Payment')">
                        <input type="radio" name="payment-method" value="card" disabled>
                        <span>Card Payment <small style="color: #ff6b6b;">(In Development)</small></span>
                    </label>
                </div>

                <div id="mpesa-details" class="payment-details-section">
                    <input type="tel" id="mpesa-phone-number" placeholder="Your M-Pesa Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$">
                    <p>Amount to Pay: <strong>KES <span id="mpesa-amount">0.00</span></strong></p>
                </div>

                <div id="card-details" class="payment-details-section" style="display: none;">
                    <input type="text" id="card-number" placeholder="Card Number" pattern="[0-9]{16}" maxlength="16">
                    <input type="text" id="card-expiry" placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\/?([0-9]{2})" maxlength="5">
                    <input type="text" id="card-cvv" placeholder="CVV" pattern="[0-9]{3,4}" maxlength="4">
                </div>

                <button type="submit">Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Login/Signup Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeLoginModal()">&times;</span>
            <h3>Login to Your Account</h3>
            <form id="login-form-modal" class="auth-form">
                <input type="email" id="login-email-modal" placeholder="Email" required>
                <input type="password" id="login-password-modal" placeholder="Password" required>
                <button type="submit">Login</button>
                <p style="margin-top: 15px;">Don't have an account? <a href="#" onclick="openSignupModal(); return false;">Sign Up</a></p>
                <p><a href="#" onclick="openForgotPasswordModal(); return false;">Forgot Password?</a></p>
            </form>
        </div>
    </div>

    <div id="signup-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeSignupModal()">&times;</span>
            <h3>Create an Account</h3>
            <form id="signup-form-modal" class="auth-form">
                <input type="text" id="signup-fullname-modal" placeholder="Full Name" required>
                <input type="email" id="signup-email-modal" placeholder="Email" required>
                <input type="tel" id="signup-phone-modal" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="signup-password-modal" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p style="margin-top: 15px;">Already have an account? <a href="#" onclick="openLoginModal(); return false;">Login</a></p>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeForgotPasswordModal()">&times;</span>
            <h3>Reset Password</h3>
            <form id="forgot-password-form" class="auth-form">
                <p>Enter your email address to receive a password reset link.</p>
                <input type="email" id="reset-email" placeholder="Your Email" required>
                <button type="submit">Send Reset Link</button>
                <p style="margin-top: 15px;"><a href="#" onclick="closeForgotPasswordModal(); openLoginModal(); return false;">Back to Login</a></p>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeEditProfileModal()">&times;</span>
            <h3>Edit Your Profile</h3>
            <form id="edit-profile-form" class="auth-form">
                <input type="text" id="edit-fullname" placeholder="Full Name" required>
                <input type="email" id="edit-email" placeholder="Email" required readonly> <!-- Email usually not editable -->
                <input type="tel" id="edit-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="edit-password" placeholder="New Password (leave blank to keep current)">
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Enhanced Cart Preview Sidebar -->
    <div id="cart-preview-sidebar" class="cart-preview-sidebar">
        <div class="cart-preview-header">
            <h3><i class="fas fa-shopping-cart"></i> Your Cart</h3>
            <span class="close-button" onclick="closeCartPreview()">&times;</span>
        </div>
        <div class="cart-preview-items" id="cart-preview-items">
            <!-- Items dynamically loaded here -->
        </div>
        <div class="cart-preview-totals">
            <div class="total-row">
                <span>Subtotal:</span>
                <span>KES <span id="cart-preview-subtotal">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Delivery:</span>
                <span>KES <span id="cart-preview-delivery">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Total:</span>
                <span>KES <span id="cart-preview-total">0.00</span></span>
            </div>
        </div>
        <div class="cart-preview-actions">
            <button class="checkout-preview-btn" onclick="openCustomerDetailsModal(); closeCartPreview();">
                <i class="fas fa-credit-card"></i> Checkout Now
            </button>
        </div>
    </div>

    <!-- Toast Message Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({
                duration: 800,
                easing: 'ease-out-quad',
                once: true, // Only animate once
            });
            // Set the current year in the copyright
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });

        const pages = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.page-link');
        const shopPage = document.getElementById('shop-page');
        const cartCountSpan = document.getElementById('cart-count');
        const cartItemsBody = document.getElementById('cart-items');
        const cartSubtotalPriceSpan = document.getElementById('cart-subtotal-price');
        const cartTransportFeeSpan = document.getElementById('cart-transport-fee');
        const cartGrandTotalPriceSpan = document.getElementById('cart-grand-total-price');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const mobileNavLinks = document.getElementById('nav-links');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const quickViewModal = document.getElementById('quick-view-modal');
        const productListDiv = document.getElementById('product-list');

        const customerDetailsModal = document.getElementById('customer-details-modal');
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const mpesaDetailsDiv = document.getElementById('mpesa-details');
        const cardDetailsDiv = document.getElementById('card-details');
        const mpesaAmountSpan = document.getElementById('mpesa-amount');

        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const forgotPasswordModal = document.getElementById('forgot-password-modal'); // New
        const editProfileModal = document.getElementById('edit-profile-modal'); // New

        const authLinkContainer = document.getElementById('auth-link-container');
        const accountUsernameSpan = document.getElementById('account-username');
        const profileEmailSpan = document.getElementById('profile-email');     // New
        const profilePhoneSpan = document.getElementById('profile-phone'); // New
        const loyaltyPointsSpan = document.getElementById('loyalty-points');

        const cartPreviewSidebar = document.getElementById('cart-preview-sidebar');
        const cartPreviewItemsDiv = document.getElementById('cart-preview-items');
        const cartPreviewSubtotalSpan = document.getElementById('cart-preview-subtotal');
        const cartPreviewDeliverySpan = document.getElementById('cart-preview-delivery');
        const cartPreviewTotalSpan = document.getElementById('cart-preview-total');
        
        const newsletterPopup = document.getElementById('newsletter-popup'); // Newsletter popup

        const testimonialCarousel = document.getElementById('testimonial-carousel');
        const testimonialPrevBtn = document.getElementById('testimonial-prev-btn');
        const testimonialNextBtn = document.getElementById('testimonial-next-btn');
        const testimonialIndicatorsContainer = document.getElementById('testimonial-indicators');

        const flashSaleCountdownDiv = document.getElementById('flash-sale-countdown');
        const countdownDaysSpan = document.getElementById('countdown-days');
        const countdownHoursSpan = document.getElementById('countdown-hours');
        const countdownMinutesSpan = document.getElementById('countdown-minutes');
        const countdownSecondsSpan = document.getElementById('countdown-seconds');

        const recommendedProductsList = document.getElementById('qv-recommended-list');


        const TRANSPORT_FEE = 100.00; // Fixed transportation fee for Vihiga County
        const MIN_ORDER_VALUE = 600.00; // Minimum order value for checkout

        let currentView = 'grid'; // Default view
        let firebaseUser = null; // Stores the currently logged in Firebase user object
        let allProducts = []; // Array to store products fetched from Firestore
        let userLoyaltyPoints = 0; // User's loyalty points
        
        // Initialize with some basic products to ensure something always shows
        console.log("🚀 Initializing product system...");
        
        // Simple initialization function
        window.initializeProducts = async function() {
            console.log("🔄 Initializing products...");
            
            // Try to load from Firebase first
            try {
                await loadProductsFromFirestore();
            } catch (error) {
                console.error("❌ Firebase loading failed:", error);
                
                // If Firebase fails, add test products
                console.log("🧪 Adding test products as fallback...");
                window.addTestProducts();
            }
        };
        
        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log("📄 DOM loaded, initializing products...");
            
            // Load products immediately without waiting
            setTimeout(() => {
                console.log("🚀 Starting product initialization...");
                
                // Try Firebase first, but don't wait for it
                loadProductsFromFirestore().catch(error => {
                    console.log("🔄 Firebase failed, using test products:", error);
                    window.addTestProducts();
                });
            }, 500);
        });

        // --- Utility Functions for Local Storage (will be replaced by Firestore for most data) ---
        function getFromLocalStorage(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Error parsing localStorage item "${key}":`, e);
                return defaultValue;
            }
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving to localStorage item "${key}":`, e);
            }
        }

        // --- Message Modal Functions ---
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML for strong tags
            messageModal.style.display = 'flex';
        }

        function closeModal() {
            messageModal.style.display = 'none';
        }

        // --- Newsletter Popup Functions ---
        function openNewsletterPopup() {
            newsletterPopup.style.display = 'flex';
        }

        function closeNewsletterPopup() {
            newsletterPopup.style.display = 'none';
        }

        // --- Product Quick View Functions ---
        function openQuickViewModal(productId) {
            const product = allProducts.find(p => p.id === productId);

            if (!product) return;

            const qvImage = document.getElementById('qv-image');
            qvImage.src = product.image || `https://placehold.co/400x300/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`;
            qvImage.alt = product.name;
            qvImage.onerror = function() {
                this.onerror = null;
                this.src = 'https://placehold.co/400x300/cccccc/333333?text=No+Image';
            };
            document.getElementById('qv-name').textContent = product.name;
            
            let qvPriceHtml = `KES ${product.price.toFixed(2)} ${product.unit}`;
            if (product.originalPrice && product.originalPrice > product.price) {
                qvPriceHtml = `<del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}`;
            }
            document.getElementById('qv-price').innerHTML = qvPriceHtml;

            document.getElementById('qv-description').textContent = product.description;

            // Render rating stars
            const qvRatingDiv = document.getElementById('qv-rating');
            qvRatingDiv.innerHTML = generateStarRating(product.rating);

            // Render stock indicator
            const qvStockDiv = document.getElementById('qv-stock');
            qvStockDiv.className = `stock-indicator ${product.stock > 0 ? 'in-stock' : 'sold-out'}`;
            qvStockDiv.textContent = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';

            // Render tags
            const qvTagsDiv = document.getElementById('qv-tags');
            qvTagsDiv.innerHTML = '';
            if (product.tags && product.tags.length > 0) {
                product.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'product-tag';
                    tagSpan.textContent = tag;
                    qvTagsDiv.appendChild(tagSpan);
                });
            }

            // Set Add to Cart button for quick view
            const qvAddToCartBtn = document.getElementById('qv-add-to-cart-btn');
            qvAddToCartBtn.onclick = () => {
                addToCart(product.id);
                // No automatic close, user can browse recommended or add multiple
                // closeQuickViewModal(); 
            };
            qvAddToCartBtn.disabled = product.stock <= 0;
            qvAddToCartBtn.textContent = product.stock <= 0 ? 'Sold Out' : 'Add to Cart';

            // Render reviews and add review form
            renderProductReviews(productId);
            renderRecommendedProducts(productId); // Render recommended products

            quickViewModal.style.display = 'flex';
            AOS.refresh(); // Refresh AOS for modal content
        }

        function closeQuickViewModal() {
            quickViewModal.style.display = 'none';
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            // Update desktop nav links
            navLinks.forEach(link => link.classList.remove('active'));
            const activeDesktopLink = document.querySelector(`.page-link[data-page="${pageId.replace('-page', '')}"]`);
            if (activeDesktopLink) {
                activeDesktopLink.classList.add('active');
            }
            // Update mobile bottom nav links
            const bottomNavLinks = document.querySelectorAll('.bottom-nav a');
            bottomNavLinks.forEach(link => link.classList.remove('active'));
            const activeBottomLink = document.querySelector(`.bottom-nav a[data-page="${pageId.replace('-page', '')}"]`);
            if (activeBottomLink) {
                activeBottomLink.classList.add('active');
            }

            // Close mobile menu if open
            if (navLinksMenu && navLinksMenu.classList.contains('mobile-nav-open')) {
                closeMobileMenu();
            }

            // Specific page rendering/updates
            if (pageId === 'cart-page') {
                renderCart();
            } else if (pageId === 'shop-page') {
                // Initialize the fresh shop system
                console.log("🛒 Navigating to shop page, initializing fresh shop...");
                window.initFreshShop();
            } else if (pageId === 'order-confirmation-page') {
                displayLastOrderConfirmation();
            } else if (pageId === 'my-account-page') {
                updateAccountPage();
                renderUserOrders(); // Render user's past orders
            } else if (pageId === 'login-page') { // Handle direct navigation to login
                // For the redesigned site, we prefer modals for auth
                openLoginModal();
                // Prevent login-page itself from being visible if only modals are used
                document.getElementById('login-page').classList.remove('active'); 
            }
            // Ensure AOS is refreshed for new content
            AOS.refreshHard();
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'login') {
                    openLoginModal();
                } else if (pageData === 'my-account') {
                    showPage('my-account-page');
                } else {
                    showPage(pageData + '-page');
                }
            });
        });

        // Event listeners for bottom navigation
        document.querySelectorAll('.bottom-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'my-account' && !firebaseUser) {
                    showModal('Login Required', 'Please log in to view your account details.');
                    openLoginModal();
                } else {
                    showPage(pageData + '-page');
                }
            });
        });

        document.getElementById('cart-icon').addEventListener('click', () => {
            openCartPreview(); // Open sidebar cart instead of full page
        });

        // --- Professional Mobile Hamburger Menu ---
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const navLinksMenu = document.getElementById('nav-links');

        // Toggle mobile menu
        function toggleMobileMenu() {
            const isOpen = navLinksMenu.classList.contains('mobile-nav-open');
            
            if (isOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        // Open mobile menu
        function openMobileMenu() {
            navLinksMenu.classList.add('mobile-nav-open');
            mobileNavOverlay.style.display = 'block';
            setTimeout(() => {
                mobileNavOverlay.classList.add('active');
            }, 10);
            
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
            
            // Update hamburger icon
            const icon = mobileMenuToggle.querySelector('i');
            icon.className = 'fas fa-times';
        }

        // Close mobile menu
        function closeMobileMenu() {
            navLinksMenu.classList.remove('mobile-nav-open');
            mobileNavOverlay.classList.remove('active');
            
            setTimeout(() => {
                mobileNavOverlay.style.display = 'none';
            }, 300);
            
            // Restore body scrolling
            document.body.style.overflow = 'auto';
            
            // Update hamburger icon
            const icon = mobileMenuToggle.querySelector('i');
            icon.className = 'fas fa-bars';
        }

        // Event listeners
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        mobileNavOverlay.addEventListener('click', closeMobileMenu);

        // Close menu when clicking on nav links
        navLinksMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('page-link')) {
                closeMobileMenu();
            }
        });

        // Close menu on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && navLinksMenu.classList.contains('mobile-nav-open')) {
                closeMobileMenu();
            }
        });

        // Close menu on window resize to desktop size
        window.addEventListener('resize', () => {
            if (window.innerWidth > 1024 && navLinksMenu.classList.contains('mobile-nav-open')) {
                closeMobileMenu();
            }
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Save preference to localStorage
            const isDarkMode = document.body.classList.contains('dark-mode');
            saveToLocalStorage('darkMode', isDarkMode);
            // Update icon
            darkModeToggle.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        });

        function applyDarkModePreference() {
            const isDarkMode = getFromLocalStorage('darkMode', false); // Default to light mode
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // --- Generate Star Rating HTML ---
        function generateStarRating(rating) {
            let starsHtml = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                starsHtml += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < (5 - fullStars - (hasHalfStar ? 1 : 0)); i++) {
                starsHtml += '<i class="far fa-star"></i>';
            }
            return starsHtml;
        }

        // --- Product Reviews (Firestore) ---
        async function getProductReviews(productId) {
            try {
                const reviewsRef = window.collection(window.db, "products", productId, "reviews");
                const q = window.query(reviewsRef, window.orderBy("date", "desc"));
                const querySnapshot = await window.getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error getting product reviews:", error);
                return [];
            }
        }

        async function saveProductReview(productId, review) {
            try {
                const reviewsRef = window.collection(window.db, "products", productId, "reviews");
                await window.addDoc(reviewsRef, review);
                return true;
            } catch (error) {
                console.error("Error saving product review:", error);
                return false;
            }
        }

        async function renderProductReviews(productId) {
            const qvReviewsList = document.getElementById('qv-reviews-list');
            const addReviewContainer = document.getElementById('add-review-container');
            const reviews = await getProductReviews(productId);

            qvReviewsList.innerHTML = '';
            if (reviews.length === 0) {
                qvReviewsList.innerHTML = '<p>No reviews yet. Be the first to review this product!</p>';
            } else {
                reviews.forEach(review => {
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-item';
                    reviewItem.innerHTML = `
                        <p><strong>${review.username}</strong> <span class="review-rating">${generateStarRating(review.rating)}</span></p>
                        <p>${review.comment}</p>
                        <small>${new Date(review.date).toLocaleString()}</small>
                    `;
                    qvReviewsList.appendChild(reviewItem);
                });
            }

            // Show add review form if logged in
            if (firebaseUser) {
                addReviewContainer.innerHTML = `
                    <h4>Add Your Review</h4>
                    <form class="add-review-form" onsubmit="submitProductReview(event, '${productId}')">
                        <input type="number" id="review-rating-input" placeholder="Rating (1-5)" min="1" max="5" step="0.5" required>
                        <textarea id="review-comment-input" rows="3" placeholder="Your comment..." required></textarea>
                        <button type="submit">Submit Review</button>
                    </form>
                `;
            } else {
                addReviewContainer.innerHTML = '<p>Please <a href="#" onclick="openLoginModal(); closeQuickViewModal(); return false;">log in</a> to add a review.</p>';
            }
        }

        async function submitProductReview(event, productId) {
            event.preventDefault();
            const rating = parseFloat(document.getElementById('review-rating-input').value);
            const comment = document.getElementById('review-comment-input').value;

            if (rating < 1 || rating > 5 || !comment) {
                showModal('Error', 'Please provide a rating between 1 and 5 and a comment.');
                return;
            }

            const newReview = {
                username: firebaseUser.displayName || firebaseUser.email, // Use Firebase user info
                rating: rating,
                comment: comment,
                date: new Date().toISOString()
            };
            const success = await saveProductReview(productId, newReview);
            if (success) {
                showModal('Review Submitted', 'Thank you for your review!');
                document.querySelector('.add-review-form').reset();
                renderProductReviews(productId); // Re-render reviews
            } else {
                showModal('Error', 'Failed to submit review. Please try again.');
            }
        }

        // --- Fresh Product Management System ---
        
        // Global variables for the new shop system
        let shopProducts = [];
        let currentShopView = 'grid';
        let currentCategory = '';
        let currentSort = 'name';
        let currentSearch = '';
        
        // Initialize the fresh shop system
        window.initFreshShop = async function() {
            console.log("🛒 Initializing Fresh Shop System...");
            
            // Show loading state
            showShopLoadingState();
            
            try {
                // Try to load from Firebase first
                await loadShopProductsFromFirestore();
            } catch (error) {
                console.log("🔄 Firebase failed, loading sample products:", error);
                loadSampleProducts();
            }
        };
        
        // Load products from Firestore
        async function loadShopProductsFromFirestore() {
            try {
                if (!window.db || !window.collection) {
                    throw new Error("Firebase not initialized");
                }
                
                const productsCol = window.collection(window.db, "products");
                const querySnapshot = await window.getDocs(window.query(productsCol));
                
                if (querySnapshot.docs.length > 0) {
                    shopProducts = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log("✅ Loaded", shopProducts.length, "products from Firestore");
                } else {
                    throw new Error("No products found in Firestore");
                }
                
                renderShopProducts();
            } catch (error) {
                console.error("❌ Error loading from Firestore:", error);
                throw error;
            }
        }
        
        // Load sample products as fallback
        function loadSampleProducts() {
            shopProducts = [
                {
                    id: 'sample-1',
                    name: 'Fresh Tomatoes',
                    image: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=400&h=300&fit=crop',
                    description: 'Fresh, juicy tomatoes perfect for salads and cooking',
                    price: 150,
                    unit: 'per kg',
                    stock: 50,
                    rating: 4.5,
                    category: 'vegetables',
                    tags: ['fresh', 'organic'],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'sample-2',
                    name: 'Green Spinach',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop',
                    description: 'Nutritious leafy greens rich in iron and vitamins',
                    price: 80,
                    unit: 'per bunch',
                    stock: 30,
                    rating: 4.2,
                    category: 'leafy greens',
                    tags: ['healthy', 'nutritious'],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'sample-3',
                    name: 'Carrots',
                    image: 'https://images.unsplash.com/photo-1566385101042-1a0aa0c1268c?w=400&h=300&fit=crop',
                    description: 'Sweet and crunchy carrots perfect for snacking',
                    price: 120,
                    unit: 'per kg',
                    stock: 40,
                    rating: 4.3,
                    category: 'vegetables',
                    tags: ['sweet', 'crunchy'],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'sample-4',
                    name: 'Fresh Lettuce',
                    image: 'https://images.unsplash.com/photo-1622206151226-18ca2c9ab4a1?w=400&h=300&fit=crop',
                    description: 'Crisp and fresh lettuce for your salads',
                    price: 60,
                    unit: 'per head',
                    stock: 25,
                    rating: 4.0,
                    category: 'leafy greens',
                    tags: ['crisp', 'fresh'],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'sample-5',
                    name: 'Bell Peppers',
                    image: 'https://images.unsplash.com/photo-1563565375-f3fdfdbefa83?w=400&h=300&fit=crop',
                    description: 'Colorful bell peppers for cooking and salads',
                    price: 200,
                    unit: 'per kg',
                    stock: 20,
                    rating: 4.4,
                    category: 'vegetables',
                    tags: ['colorful', 'versatile'],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'sample-6',
                    name: 'Fresh Basil',
                    image: 'https://images.unsplash.com/photo-1615485500704-9b931d3b0a4a?w=400&h=300&fit=crop',
                    description: 'Aromatic fresh basil for cooking and garnishing',
                    price: 40,
                    unit: 'per bunch',
                    stock: 15,
                    rating: 4.6,
                    category: 'herbs',
                    tags: ['aromatic', 'fresh'],
                    createdAt: new Date().toISOString()
                }
            ];
            
            console.log("✅ Loaded", shopProducts.length, "sample products");
            renderShopProducts();
        }
        
        // Manual refresh function
        window.refreshProducts = async function() {
            console.log("🔄 Refreshing products...");
            await window.initFreshShop();
        };
        
        // Check products collection
        window.checkProductsCollection = async function() {
            try {
                if (!window.db) {
                    console.error("❌ Firebase DB not initialized");
                    return false;
                }
                
                const productsCol = window.collection(window.db, "products");
                const querySnapshot = await window.getDocs(window.query(productsCol));
                
                console.log("📊 Products collection status:");
                console.log("- Collection exists:", !!productsCol);
                console.log("- Number of documents:", querySnapshot.docs.length);
                
                return querySnapshot.docs.length > 0;
            } catch (error) {
                console.error("❌ Error checking products collection:", error);
                return false;
            }
        };
        
        // Show loading state
        function showShopLoadingState() {
            document.getElementById('product-list').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('no-results-state').style.display = 'none';
            document.getElementById('loading-state').style.display = 'block';
        }
        
        // Show empty state
        function showShopEmptyState() {
            document.getElementById('product-list').style.display = 'none';
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('no-results-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
        }
        
        // Show no results state
        function showShopNoResultsState() {
            document.getElementById('product-list').style.display = 'none';
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('no-results-state').style.display = 'block';
        }
        
        // Show products
        function showShopProducts() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('no-results-state').style.display = 'none';
            document.getElementById('product-list').style.display = 'grid';
        }
        
        // Render shop products
        function renderShopProducts() {
            console.log("🎨 Rendering shop products...");
            
            // Filter products based on current filters
            let filteredProducts = [...shopProducts];
            
            // Apply search filter
            if (currentSearch) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    (product.description && product.description.toLowerCase().includes(currentSearch.toLowerCase())) ||
                    (product.tags && product.tags.some(tag => tag.toLowerCase().includes(currentSearch.toLowerCase())))
                );
            }
            
            // Apply category filter
            if (currentCategory) {
                filteredProducts = filteredProducts.filter(product => 
                    product.category === currentCategory
                );
            }
            
            // Apply sorting
            filteredProducts.sort((a, b) => {
                switch (currentSort) {
                    case 'price-low':
                        return a.price - b.price;
                    case 'price-high':
                        return b.price - a.price;
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'newest':
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });
            
            // Show appropriate state
            if (filteredProducts.length === 0) {
                if (currentSearch || currentCategory) {
                    showShopNoResultsState();
                } else {
                    showShopEmptyState();
                }
                return;
            }
            
            showShopProducts();
            
            // Render products
            const productListDiv = document.getElementById('product-list');
            productListDiv.innerHTML = '';
            productListDiv.className = `product-grid ${currentShopView}-view`;
            
            filteredProducts.forEach((product, index) => {
                const productCard = createProductCard(product, index);
                productListDiv.appendChild(productCard);
            });
            
            console.log("✅ Rendered", filteredProducts.length, "products");
        }
        
        // Create product card
        function createProductCard(product, index) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('data-aos', 'fade-up');
            card.setAttribute('data-aos-delay', (index * 100).toString());
            
            const isInStock = (product.stock || 0) > 0;
            const stockClass = isInStock ? 'in-stock' : 'sold-out';
            const stockText = isInStock ? `In Stock (${product.stock})` : 'Sold Out';
            
            const rating = product.rating || 0;
            const stars = generateStarRating(rating);
            
            const imageUrl = product.image || `https://placehold.co/300x200/cccccc/333333?text=${encodeURIComponent(product.name)}`;
            
            if (currentShopView === 'grid') {
                card.innerHTML = `
                    <div class="product-image">
                        <img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=No+Image';">
                        <div class="product-overlay">
                            <button class="quick-view-btn" onclick="openQuickViewModal('${product.id}')" title="Quick View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="favorite-btn" onclick="toggleFavorite('${product.id}', this)" title="Add to Favorites">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-rating">${stars}</div>
                        <p class="product-description">${product.description || 'Fresh and healthy product'}</p>
                        <div class="product-price">KES ${product.price.toFixed(2)} ${product.unit || ''}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${!isInStock ? 'disabled' : ''}>
                            <i class="fas fa-cart-plus"></i>
                            ${isInStock ? 'Add to Cart' : 'Out of Stock'}
                        </button>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="product-image">
                        <img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/333333?text=No+Image';">
                    </div>
                    <div class="product-details">
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-rating">${stars}</div>
                        <p class="product-description">${product.description || 'Fresh and healthy product'}</p>
                        <div class="product-meta">
                            <div class="product-price">KES ${product.price.toFixed(2)} ${product.unit || ''}</div>
                            <div class="product-stock ${stockClass}">${stockText}</div>
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="quick-view-btn" onclick="openQuickViewModal('${product.id}')" title="Quick View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="favorite-btn" onclick="toggleFavorite('${product.id}', this)" title="Add to Favorites">
                            <i class="far fa-heart"></i>
                        </button>
                        <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${!isInStock ? 'disabled' : ''}>
                            <i class="fas fa-cart-plus"></i>
                            ${isInStock ? 'Add to Cart' : 'Out of Stock'}
                        </button>
                    </div>
                `;
            }
            
            return card;
        }
        
        // Shop interaction functions
        window.filterProducts = function() {
            currentSearch = document.getElementById('search-input').value;
            currentCategory = document.getElementById('filter-category').value;
            renderShopProducts();
        };
        
        window.sortProducts = function() {
            currentSort = document.getElementById('sort-products').value;
            renderShopProducts();
        };
        
        window.toggleView = function(view) {
            currentShopView = view;
            
            // Update button states
            document.getElementById('grid-view-btn').classList.toggle('active-view', view === 'grid');
            document.getElementById('list-view-btn').classList.toggle('active-view', view === 'list');
            
            renderShopProducts();
        };
        
        window.clearSearch = function() {
            document.getElementById('search-input').value = '';
            currentSearch = '';
            renderShopProducts();
        };
        
        // Toast Message System
        function showToastMessage(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle'
            };
            
            toast.innerHTML = `
                <i class="toast-icon ${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <p>${message}</p>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => removeToast(toast), duration);
        }
        
        function removeToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Enhanced Add to Cart function for the new shop system
        window.addToCart = async function(productId) {
            console.log("🛒 Adding product to cart:", productId);
            
            // Find the product in our shop products
            const product = shopProducts.find(p => p.id === productId);
            
            if (!product) {
                console.error("❌ Product not found:", productId);
                showToastMessage('Product not found. Please try again.', 'error');
                return;
            }
            
            if (product.stock <= 0) {
                showToastMessage(`${product.name} is currently out of stock.`, 'warning');
                return;
            }
            
            try {
                // Get current cart
                const cart = await getCart();
                
                // Check if product already exists in cart
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    // Check stock limit
                    if (existingItem.quantity >= product.stock) {
                        showToastMessage(`Cannot add more ${product.name}. Only ${product.stock} available.`, 'warning');
                        return;
                    }
                    // Increase quantity
                    existingItem.quantity += 1;
                } else {
                    // Add new item to cart
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        unit: product.unit || '',
                        image: product.image,
                        quantity: 1,
                        stock: product.stock
                    });
                }
                
                // Save cart
                await saveCart(cart);
                
                // Update cart count
                updateCartCount();
                
                // Show success message instead of modal
                showToastMessage(`${product.name} added to cart!`, 'success');
                
                // Don't auto-open cart preview on mobile - let user continue shopping
                // Only open cart preview on desktop
                if (window.innerWidth > 768) {
                    openCartPreview();
                }
                
                console.log("✅ Product added to cart successfully");
                
            } catch (error) {
                console.error("❌ Error adding to cart:", error);
                showToastMessage('Failed to add product to cart. Please try again.', 'error');
            }
        };
        
        // Test function to add dummy products if none exist
        window.addTestProducts = function() {
            console.log("🧪 Adding test products...");
            allProducts = [
                {
                    id: 'test-1',
                    name: 'Fresh Tomatoes',
                    image: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=400&h=300&fit=crop',
                    description: 'Fresh, juicy tomatoes perfect for salads and cooking',
                    price: 150,
                    unit: 'per kg',
                    stock: 50,
                    rating: 4.5,
                    category: 'vegetables',
                    tags: ['fresh', 'organic']
                },
                {
                    id: 'test-2',
                    name: 'Green Spinach',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop',
                    description: 'Nutritious leafy greens rich in iron and vitamins',
                    price: 80,
                    unit: 'per bunch',
                    stock: 30,
                    rating: 4.2,
                    category: 'leafy greens',
                    tags: ['healthy', 'nutritious']
                },
                {
                    id: 'test-3',
                    name: 'Carrots',
                    image: 'https://images.unsplash.com/photo-1566385101042-1a0aa0c1268c?w=400&h=300&fit=crop',
                    description: 'Sweet and crunchy carrots perfect for snacking',
                    price: 120,
                    unit: 'per kg',
                    stock: 40,
                    rating: 4.3,
                    category: 'vegetables',
                    tags: ['sweet', 'crunchy']
                }
            ];
            console.log("✅ Test products added:", allProducts.length);
            renderProducts();
        };
        
        // Debug function to check system status
        window.debugSystem = async function() {
            console.log("🔍 System Debug Info:");
            console.log("- Firebase DB:", window.db);
            console.log("- Firebase Auth:", window.auth);
            console.log("- Current products:", allProducts.length);
            console.log("- Product list div:", document.getElementById('product-list'));
            console.log("- Current view:", currentView);
            console.log("- Firebase user:", firebaseUser);
            
            // Check products collection
            const hasProducts = await window.checkProductsCollection();
            console.log("- Products collection has data:", hasProducts);
            
            if (allProducts.length === 0) {
                console.log("⚠️ No products loaded, adding test products...");
                window.addTestProducts();
            } else {
                console.log("✅ Products are loaded, rendering...");
                renderProducts();
            }
        };
        
        async function loadProductsFromFirestore() {
            // Show loading state
            productListDiv.innerHTML = `
                <div style="text-align: center; width: 100%; padding: 40px 20px; background: var(--light-bg); border-radius: var(--border-radius); margin: 20px 0;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--text-color); margin-bottom: 10px;">Loading Fresh Products...</h3>
                    <p style="color: var(--text-color);">Please wait while we fetch the latest products for you.</p>
                </div>
            `;
            
            try {
                console.log("🔄 Loading products from Firestore...");
                
                // Check if Firebase is properly initialized
                if (!window.db) {
                    console.error("❌ Firebase DB not initialized");
                    throw new Error("Firebase database not initialized");
                }
                
                if (!window.collection) {
                    console.error("❌ Firebase collection function not available");
                    throw new Error("Firebase collection function not available");
                }
                
                console.log("Firebase DB:", window.db);
                console.log("Collection function:", window.collection);
                
                const productsCol = window.collection(window.db, "products");
                console.log("Products collection:", productsCol);
                
                // Try without orderBy first to see if there are any products at all
                const simpleQuery = window.query(productsCol);
                console.log("Simple query:", simpleQuery);
                
                const querySnapshot = await window.getDocs(simpleQuery);
                console.log("Query snapshot:", querySnapshot);
                console.log("Number of docs:", querySnapshot.docs.length);
                
                const firestoreProducts = querySnapshot.docs.map(doc => {
                    const productData = { id: doc.id, ...doc.data() };
                    console.log("Product data:", productData);
                    return productData;
                });
                
                console.log("All Firestore products:", firestoreProducts);
                
                // Only replace if Firestore actually returns products
                if (firestoreProducts.length > 0) {
                    allProducts = firestoreProducts;
                    console.log("✅ Products loaded from Firestore:", allProducts.length, "products");
                } else {
                    console.log("⚠️ No products from Firestore. Using test products.");
                    window.addTestProducts();
                    return; // Exit early since addTestProducts calls renderProducts
                }
                renderProducts(); // Render products once loaded (either dummy or firestore)
            } catch (error) {
                console.error("❌ Error loading products from Firestore:", error);
                console.error("Error details:", {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Instead of showing error, automatically use test products
                console.log("🔄 Firebase failed, loading test products instead...");
                window.addTestProducts();
            }
        }

        // --- Render Products on Shop Page ---
        function renderProducts() {
            console.log("🎨 Rendering products...");
            console.log("Total products available:", allProducts.length);
            console.log("Products data:", allProducts);
            
            productListDiv.innerHTML = '';
            let productsToDisplay = [...allProducts]; // Create a mutable copy
            const favorites = getFavorites(); 

            // Check if we have any products at all
            if (allProducts.length === 0) {
                console.log("❌ No products available to display");
                productListDiv.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 40px 20px; background: var(--light-bg); border-radius: var(--border-radius); margin: 20px 0;">
                        <i class="fas fa-shopping-basket" style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 10px;">No Products Available</h3>
                        <p style="color: var(--text-color); margin-bottom: 20px;">We're currently updating our fresh product selection. Please check back soon!</p>
                        <button onclick="window.refreshProducts()" style="background: var(--gradient-primary); color: white; border: none; padding: 12px 24px; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sync-alt"></i> Refresh Products
                        </button>
                    </div>
                `;
                return;
            }

            // Apply simple search filter only
            const query = document.getElementById('search-input').value.toLowerCase();
            if (query) {
                productsToDisplay = productsToDisplay.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    (p.description && p.description.toLowerCase().includes(query))
                );
            }
            
            // Check if search resulted in no products
            if (productsToDisplay.length === 0 && query) {
                productListDiv.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 40px 20px; background: var(--light-bg); border-radius: var(--border-radius); margin: 20px 0;">
                        <i class="fas fa-search" style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 10px;">No Products Found</h3>
                        <p style="color: var(--text-color); margin-bottom: 20px;">No products match your search for "${query}". Try a different search term.</p>
                        <button onclick="clearSearch()" style="background: var(--gradient-primary); color: white; border: none; padding: 12px 24px; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times"></i> Clear Search
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log("✅ Products to display:", productsToDisplay.length);

            // Update view buttons
            document.getElementById('grid-view-btn').classList.toggle('active-view', currentView === 'grid');
            document.getElementById('list-view-btn').classList.toggle('active-view', currentView === 'list');

            // Apply view mode
            productListDiv.classList.remove('product-grid'); // Remove grid view by default
            productListDiv.classList.remove('list-view'); // Remove list view by default
            productListDiv.classList.add('product-grid'); // Add grid view for base styling
            productListDiv.classList.add(`${currentView}-view`); // Add specific view

            productsToDisplay.forEach((product, index) => {
                console.log(`Creating product card ${index + 1}:`, product.name);
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-aos', 'zoom-in');
                productCard.setAttribute('data-aos-delay', (index * 50).toString());

                // Simple product data
                const isFavorite = favorites.includes(product.id);
                const favoriteIconClass = isFavorite ? 'fas' : 'far';
                const stockStatusClass = (product.stock || 0) > 0 ? 'in-stock' : 'sold-out';
                const stockText = (product.stock || 0) > 0 ? `In Stock (${product.stock || 0})` : 'Sold Out';
                const addToCartDisabled = (product.stock || 0) <= 0 ? 'disabled' : '';
                const addToCartText = (product.stock || 0) <= 0 ? 'Out of Stock' : 'Add to Cart';

                // Safe price formatting
                const price = parseFloat(product.price) || 0;
                const unit = product.unit || 'per kg';
                const priceHtml = `<p class="price">KES ${price.toFixed(2)} ${unit}</p>`;

                // Safe image URL
                const imageUrl = product.image || `https://placehold.co/300x180/cccccc/333333?text=${encodeURIComponent(product.name)}`;
                
                // Safe rating
                const rating = parseFloat(product.rating) || 0;
                const ratingHtml = rating > 0 ? `<div class="product-rating">${generateStarRating(rating)}</div>` : '';

                if (currentView === 'grid') {
                    productCard.innerHTML = `
                        <div class="hover-icons">
                            <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                            <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                            <i class="fas fa-cart-plus" onclick="addToCart('${product.id}')"></i>
                        </div>
                        <img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x180/cccccc/333333?text=No+Image';">
                        <h3>${product.name}</h3>
                        ${ratingHtml}
                        ${priceHtml}
                        <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                        <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                    `;
                } else { // List view
                    productCard.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/333333?text=No+Image';">
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            ${ratingHtml}
                            ${priceHtml}
                            <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                            <p>${product.description || 'Fresh and healthy product'}</p>
                        </div>
                        <div class="product-actions">
                            <div class="hover-icons" style="position: static; opacity: 1; visibility: visible; transform: none; flex-direction: row; gap: 10px; margin-bottom: 15px;">
                                <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                                <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                        </div>
                    `;
                }
                
                productListDiv.appendChild(productCard);
                console.log(`✅ Product card created for: ${product.name}`);
            });
            AOS.refresh(); // Refresh AOS for newly added elements
        }
        
        function filterProducts() {
            renderProducts(); // Re-render with current search input and category filter
        }

        function filterProductsByCategory(category) {
            document.getElementById('filter-category').value = category;
            renderProducts(); // Re-render with selected category filter
        }

        function sortProducts() {
            renderProducts(); // Re-render with current sort selection
        }

        function toggleView(view) {
            currentView = view;
            renderProducts();
        }
        
        // Clear search only
        window.clearSearch = function() {
            document.getElementById('search-input').value = '';
            renderProducts();
        };
        
        // --- Shopping Cart functionality (Firestore) ---
        async function getCart() {
            if (!firebaseUser) {
                return getFromLocalStorage('guestCart', []); // Use local storage for guest cart
            }
            try {
                const cartDocRef = window.doc(window.db, "carts", firebaseUser.uid);
                const cartDocSnap = await window.getDoc(cartDocRef);
                return cartDocSnap.exists() ? cartDocSnap.data().items : [];
            } catch (error) {
                console.error("Error getting cart from Firestore:", error);
                return [];
            }
        }

        async function saveCart(cart) {
            if (!firebaseUser) {
                saveToLocalStorage('guestCart', cart); // Save to local storage for guests
            } else {
                try {
                    const cartDocRef = window.doc(window.db, "carts", firebaseUser.uid);
                    await window.setDoc(cartDocRef, { items: cart });
                } catch (error) {
                    console.error("Error saving cart to Firestore:", error);
                }
            }
            updateCartCount();
            updateCartPreview(); // Update sidebar cart
        }

        async function updateCartCount() {
            const cart = await getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        async function addToCart(productId) {
            const cart = await getCart();
            const productToAdd = allProducts.find(p => p.id === productId);

            if (!productToAdd) return;
            if (productToAdd.stock <= 0) {
                showModal('Out of Stock', `${productToAdd.name} is currently out of stock.`);
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity >= productToAdd.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${productToAdd.name}. Only ${productToAdd.stock} available.`);
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({ ...productToAdd, quantity: 1, price: productToAdd.price, unit: productToAdd.unit || '' });
            }
            await saveCart(cart);
            showModal('Success!', `${productToAdd.name} added to cart!`);
            openCartPreview(); // Show the cart preview after adding
        }

        async function renderCart() {
            const cart = await getCart();
            const cartContainer = document.getElementById('cart-container');
            let subTotal = 0;

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="cart-empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your Cart is Empty</h3>
                        <p>Looks like you haven't added any items to your cart yet. Start shopping to fill it up!</p>
                        <a href="#" class="cta-button" onclick="showPage('shop-page')">Start Shopping</a>
                    </div>
                `;
                return;
            }

            // Create mobile-optimized cart table
            let cartHTML = `
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                cartHTML += `
                    <tr>
                        <td data-label="Product">
                            <img src="${item.image || `https://placehold.co/70x70/cccccc/333333?text=${item.name.replace(/\s/g, '+')}`}" 
                                 alt="${item.name}" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/70x70/cccccc/333333?text=No+Image';">
                        </td>
                        <td data-label="Name">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-unit">${item.unit || ''}</div>
                        </td>
                        <td data-label="Price">
                            <span class="cart-price">KES ${item.price.toFixed(2)}</span>
                        </td>
                        <td data-label="Quantity">
                            <div class="cart-quantity">
                                <button onclick="updateQuantity('${item.id}', -1)" class="cart-quantity-btn" title="Decrease quantity">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="cart-quantity-display">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.id}', 1)" class="cart-quantity-btn" title="Increase quantity">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td data-label="Total">
                            <span class="cart-total">KES ${itemTotal.toFixed(2)}</span>
                        </td>
                        <td data-label="Action">
                            <button onclick="confirmRemoveFromCart('${item.id}')" class="cart-remove-btn" title="Remove item">
                                <i class="fas fa-trash-alt"></i>
                                <span>Remove</span>
                            </button>
                        </td>
                    </tr>
                `;
            });

            const grandTotal = subTotal + TRANSPORT_FEE;
            
            cartHTML += `
                    </tbody>
                </table>
                <div id="cart-summary">
                    <div class="cart-summary-totals">
                        <div>Subtotal: KES <span id="cart-subtotal-price">${subTotal.toFixed(2)}</span></div>
                        <div>Transportation Fee: KES <span id="cart-transport-fee">${TRANSPORT_FEE.toFixed(2)}</span></div>
                        <div class="cart-total-grand">Grand Total: KES <span id="cart-grand-total-price">${grandTotal.toFixed(2)}</span></div>
                    </div>
                    <button class="checkout-btn" onclick="openCustomerDetailsModal()">
                        <i class="fas fa-shopping-cart"></i> Place Order
                    </button>
                </div>
            `;

            cartContainer.innerHTML = cartHTML;

            // Update global variables for backward compatibility
            if (typeof cartSubtotalPriceSpan !== 'undefined') {
                cartSubtotalPriceSpan.textContent = subTotal.toFixed(2);
                cartTransportFeeSpan.textContent = TRANSPORT_FEE.toFixed(2);
                cartGrandTotalPriceSpan.textContent = grandTotal.toFixed(2);
            }
        }

        async function updateQuantity(productId, change) {
            const cart = await getCart();
            const productInStore = allProducts.find(p => p.id === productId);
            const item = cart.find(i => i.id === productId);

            if (item) {
                if (change > 0 && item.quantity >= productInStore.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${item.name}. Only ${productInStore.stock} available.`);
                    return;
                }
                
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    showModal('Remove Item', `Are you sure you want to remove ${item.name} from your cart? <br><br><button onclick="confirmRemoveFromCart('${productId}')" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">Yes, Remove</button> <button onclick="closeModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>`);
                } else {
                    item.quantity = newQuantity;
                    await saveCart(cart);
                    renderCart();
                    updateCartCount();
                    updateCartPreview();
                    
                    // Show success feedback
                    const successMessage = change > 0 ? 
                        `Added 1 more ${item.name} to cart!` : 
                        `Removed 1 ${item.name} from cart!`;
                    showModal('Cart Updated! 🛒', successMessage);
                }
            }
        }

        async function removeFromCart(productId) {
            let cart = await getCart();
            cart = cart.filter(item => item.id !== productId);
            await saveCart(cart);
            renderCart();
            updateCartPreview(); // Also update sidebar
            showModal('Removed!', 'Item removed from cart.');
        }

        async function confirmRemoveFromCart(productId) {
            closeModal(); // Close the confirmation modal
            let cart = await getCart();
            cart = cart.filter(item => item.id !== productId);
            await saveCart(cart);
            renderCart();
            updateCartPreview(); // Also update sidebar
            showModal('Removed!', 'Item removed from cart.');
        }

        // --- Slide-in Cart Preview Functions ---
        async function openCartPreview() {
            cartPreviewSidebar.classList.add('active');
            await updateCartPreview();
        }

        function closeCartPreview() {
            cartPreviewSidebar.classList.remove('active');
        }

        async function updateCartPreview() {
            const cart = await getCart();
            const cartPreviewItemsDiv = document.getElementById('cart-preview-items');
            let subTotal = 0;

            if (cart.length === 0) {
                cartPreviewItemsDiv.innerHTML = `
                    <div class="cart-preview-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <h4>Your Cart is Empty</h4>
                        <p>Looks like you haven't added any items to your cart yet. Start shopping to fill it up!</p>
                        <button class="cta-button" onclick="closeCartPreview(); showPage('shop-page')">Start Shopping</button>
                    </div>
                `;
                document.getElementById('cart-preview-subtotal').textContent = '0.00';
                document.getElementById('cart-preview-delivery').textContent = '0.00';
                document.getElementById('cart-preview-total').textContent = '0.00';
                return;
            }

            cartPreviewItemsDiv.innerHTML = '';

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-preview-item';
                itemDiv.innerHTML = `
                    <img src="${item.image || `https://placehold.co/80x80/cccccc/333333?text=${item.name.replace(/\s/g, '+')}`}" 
                         alt="${item.name}" 
                         onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/333333?text=No+Image';">
                    <div class="cart-preview-item-info">
                        <h4>${item.name}</h4>
                        <div class="item-price">KES ${item.price.toFixed(2)} ${item.unit || ''}</div>
                        <div class="cart-preview-item-controls">
                            <div class="cart-preview-quantity">
                                <button onclick="updateCartPreviewQuantity('${item.id}', -1)" class="cart-preview-quantity-btn" title="Decrease quantity">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="cart-preview-quantity-display">${item.quantity}</span>
                                <button onclick="updateCartPreviewQuantity('${item.id}', 1)" class="cart-preview-quantity-btn" title="Increase quantity">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <button onclick="removeFromCartPreview('${item.id}')" class="cart-preview-remove-btn" title="Remove item">
                                <i class="fas fa-trash-alt"></i>
                                <span>Remove</span>
                            </button>
                        </div>
                    </div>
                `;
                cartPreviewItemsDiv.appendChild(itemDiv);
            });

            const grandTotal = subTotal + TRANSPORT_FEE;
            document.getElementById('cart-preview-subtotal').textContent = subTotal.toFixed(2);
            document.getElementById('cart-preview-delivery').textContent = TRANSPORT_FEE.toFixed(2);
            document.getElementById('cart-preview-total').textContent = grandTotal.toFixed(2);
        }

        // Enhanced cart preview functions
        async function updateCartPreviewQuantity(productId, change) {
            const cart = await getCart();
            const productInStore = allProducts.find(p => p.id === productId);
            const item = cart.find(i => i.id === productId);

            if (item) {
                if (change > 0 && item.quantity >= productInStore.stock) {
                    showToastMessage(`Cannot add more ${item.name}. Only ${productInStore.stock} available.`, 'warning');
                    return;
                }
                
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    await removeFromCartPreview(productId);
                } else {
                    item.quantity = newQuantity;
                    await saveCart(cart);
                    await updateCartPreview();
                    updateCartCount();
                    
                    // Show success feedback
                    const successMessage = change > 0 ? 
                        `Added 1 more ${item.name} to cart!` : 
                        `Removed 1 ${item.name} from cart!`;
                    showToastMessage(successMessage, 'success');
                }
            }
        }

        async function removeFromCartPreview(productId) {
            let cart = await getCart();
            const item = cart.find(i => i.id === productId);
            cart = cart.filter(item => item.id !== productId);
            await saveCart(cart);
            await updateCartPreview();
            updateCartCount();
            showToastMessage(`${item.name} removed from cart.`, 'success');
        }

        // --- Checkout Flow Functions ---
        async function openCustomerDetailsModal() {
            const cart = await getCart();
            const cartSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (cart.length === 0) {
                showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                return;
            }
            if (cartSubtotal < MIN_ORDER_VALUE) {
                showModal('Minimum Order Required', `The minimum order value is KES ${MIN_ORDER_VALUE.toFixed(2)}. Your current subtotal is KES ${cartSubtotal.toFixed(2)}.`);
                return;
            }

            if (!firebaseUser) {
                showModal('Login Required', 'Please log in or sign up to continue with your order.');
                openLoginModal();
                saveToLocalStorage('pendingCheckout', true); // Set flag to resume checkout after login
                return;
            }

            // Fetch customer details from customers collection
            let customerData = null;
            try {
                console.log("🔍 Fetching customer details from Firestore...");
                const customerRef = window.doc(window.db, "customers", firebaseUser.uid);
                const customerSnap = await window.getDoc(customerRef);
                
                if (customerSnap.exists()) {
                    customerData = customerSnap.data();
                    console.log("✅ Customer data found in Firestore:", customerData);
                } else {
                    console.log("ℹ️ No customer data found in Firestore, will create new record");
                }
            } catch (error) {
                console.error("❌ Error fetching customer data:", error);
            }

            // Pre-fill form with customer data (priority: Firestore > User Profile > localStorage)
            const userProfile = await getUserProfile(firebaseUser.uid);
            
            // Full Name
            document.getElementById('customer-full-name').value = 
                customerData?.fullName || 
                userProfile.fullname || 
                firebaseUser.displayName || 
                '';
            
            // Phone Number
            document.getElementById('customer-phone').value = 
                customerData?.phoneNumber || 
                userProfile.phoneNumber || 
                firebaseUser.phoneNumber || 
                '';
            
            // ID Number
            document.getElementById('customer-id').value = 
                customerData?.idNumber || 
                '';
            
            // Delivery Location
            document.getElementById('customer-delivery-location').value = 
                customerData?.deliveryLocation || 
                '';
            
            // House Name
            document.getElementById('customer-house-name').value = 
                customerData?.houseName || 
                '';
            
            // Additional Notes
            document.getElementById('customer-additional-notes').value = 
                customerData?.additionalNotes || 
                '';
            
            // Save current data to localStorage for immediate use
            const currentDetails = {
                fullName: document.getElementById('customer-full-name').value,
                phoneNumber: document.getElementById('customer-phone').value,
                idNumber: document.getElementById('customer-id').value,
                deliveryLocation: document.getElementById('customer-delivery-location').value,
                houseName: document.getElementById('customer-house-name').value,
                additionalNotes: document.getElementById('customer-additional-notes').value
            };
            saveToLocalStorage('lastCustomerDetails', currentDetails);
            console.log("✅ Customer details pre-filled and saved to localStorage:", currentDetails);

            // Initialize location input functionality
            initializeLocationInput();

            customerDetailsModal.style.display = 'flex';
        }

        function closeCustomerDetailsModal() {
            customerDetailsModal.style.display = 'none';
            document.getElementById('checkout-form').reset(); // Clear form on close
        }

        // Enhanced location handling functions
        let currentLocation = null;
        let locationWatchId = null;

        // Get current location using browser geolocation API
        async function getCurrentLocation() {
            const locationBtn = document.getElementById('get-location-btn');
            const locationStatus = document.getElementById('location-status');
            const locationInput = document.getElementById('customer-delivery-location');
            const suggestionsDiv = document.getElementById('location-suggestions');

            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showLocationError('Geolocation is not supported by this browser.');
                return;
            }

            // Update UI to show loading state
            locationBtn.disabled = true;
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            locationStatus.className = 'location-status loading';
            locationStatus.textContent = 'Getting your current location...';
            suggestionsDiv.classList.remove('show');

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    });
                });

                const { latitude, longitude } = position.coords;
                currentLocation = { lat: latitude, lng: longitude };

                console.log('📍 Location obtained:', currentLocation);

                // Get address from coordinates using reverse geocoding
                await getAddressFromCoordinates(latitude, longitude);

            } catch (error) {
                console.error('❌ Location error:', error);
                handleLocationError(error);
            } finally {
                // Reset button state
                locationBtn.disabled = false;
                locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use My Location';
            }
        }

        // Get address from coordinates using reverse geocoding
        async function getAddressFromCoordinates(lat, lng) {
            const locationStatus = document.getElementById('location-status');
            const locationInput = document.getElementById('customer-delivery-location');

            try {
                locationStatus.className = 'location-status loading';
                locationStatus.textContent = 'Getting address details...';

                // Use a free reverse geocoding service
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                
                if (!response.ok) {
                    throw new Error('Failed to get address details');
                }

                const data = await response.json();
                console.log('🏠 Address data:', data);

                if (data.localityInfo && data.localityInfo.administrative) {
                    const admin = data.localityInfo.administrative;
                    const locality = data.localityInfo.locality;
                    
                    // Build address string
                    let addressParts = [];
                    if (data.city) addressParts.push(data.city);
                    if (data.principalSubdivision) addressParts.push(data.principalSubdivision);
                    if (data.countryName) addressParts.push(data.countryName);

                    const fullAddress = addressParts.join(', ');
                    
                    // Update the input field
                    locationInput.value = fullAddress;
                    
                    // Show success status
                    locationStatus.className = 'location-status success';
                    locationStatus.textContent = `✅ Location found: ${fullAddress}`;
                    
                    // Validate the address
                    validateDeliveryAddress(fullAddress);
                    
                } else {
                    throw new Error('Unable to determine address from coordinates');
                }

            } catch (error) {
                console.error('❌ Reverse geocoding error:', error);
                locationStatus.className = 'location-status error';
                locationStatus.textContent = '❌ Could not determine address. Please enter manually.';
            }
        }

        // Handle location errors
        function handleLocationError(error) {
            const locationStatus = document.getElementById('location-status');
            
            let errorMessage = 'Unable to get your location. ';
            
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please allow location access and try again.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out.';
                    break;
                default:
                    errorMessage += 'An unknown error occurred.';
                    break;
            }
            
            showLocationError(errorMessage);
        }

        // Show location error
        function showLocationError(message) {
            const locationStatus = document.getElementById('location-status');
            locationStatus.className = 'location-status error';
            locationStatus.textContent = `❌ ${message}`;
        }

        // Validate delivery address
        function validateDeliveryAddress(address) {
            const locationStatus = document.getElementById('location-status');
            
            if (!address || address.trim().length < 5) {
                locationStatus.className = 'location-status error';
                locationStatus.textContent = '❌ Please enter a more specific address';
                return false;
            }

            // Check if address contains Kenya-specific terms
            const kenyaTerms = ['kenya', 'nairobi', 'mombasa', 'kisumu', 'nakuru', 'eldoret', 'thika', 'malindi', 'kitale', 'garissa'];
            const hasKenyaTerm = kenyaTerms.some(term => address.toLowerCase().includes(term));
            
            if (!hasKenyaTerm) {
                locationStatus.className = 'location-status error';
                locationStatus.textContent = '⚠️ Please ensure your address is in Kenya';
                return false;
            }

            locationStatus.className = 'location-status success';
            locationStatus.textContent = '✅ Address looks good!';
            return true;
        }

        // Address suggestions (mock data for Kenya)
        function showAddressSuggestions(query) {
            const suggestionsDiv = document.getElementById('location-suggestions');
            
            if (!query || query.length < 3) {
                suggestionsDiv.classList.remove('show');
                return;
            }

            // Mock suggestions for Kenya locations
            const suggestions = [
                { address: 'Nairobi CBD, Nairobi, Kenya', details: 'Central Business District' },
                { address: 'Westlands, Nairobi, Kenya', details: 'Commercial area' },
                { address: 'Karen, Nairobi, Kenya', details: 'Residential area' },
                { address: 'Runda, Nairobi, Kenya', details: 'Upscale residential' },
                { address: 'Kilimani, Nairobi, Kenya', details: 'Residential area' },
                { address: 'Kileleshwa, Nairobi, Kenya', details: 'Residential area' },
                { address: 'Lavington, Nairobi, Kenya', details: 'Residential area' },
                { address: 'Mombasa CBD, Mombasa, Kenya', details: 'Coastal city center' },
                { address: 'Kisumu CBD, Kisumu, Kenya', details: 'Western Kenya' },
                { address: 'Nakuru CBD, Nakuru, Kenya', details: 'Rift Valley' }
            ];

            const filteredSuggestions = suggestions.filter(suggestion => 
                suggestion.address.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredSuggestions.length > 0) {
                suggestionsDiv.innerHTML = filteredSuggestions.map(suggestion => `
                    <div class="location-suggestion" onclick="selectAddressSuggestion('${suggestion.address}')">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="suggestion-text">
                            <div class="suggestion-address">${suggestion.address}</div>
                            <div class="suggestion-details">${suggestion.details}</div>
                        </div>
                    </div>
                `).join('');
                suggestionsDiv.classList.add('show');
            } else {
                suggestionsDiv.classList.remove('show');
            }
        }

        // Select address suggestion
        function selectAddressSuggestion(address) {
            const locationInput = document.getElementById('customer-delivery-location');
            const suggestionsDiv = document.getElementById('location-suggestions');
            
            locationInput.value = address;
            suggestionsDiv.classList.remove('show');
            validateDeliveryAddress(address);
        }

        // Initialize location input event listeners
        function initializeLocationInput() {
            const locationInput = document.getElementById('customer-delivery-location');
            
            if (locationInput) {
                // Add input event listener for suggestions
                locationInput.addEventListener('input', (e) => {
                    showAddressSuggestions(e.target.value);
                });

                // Add blur event listener to hide suggestions
                locationInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        const suggestionsDiv = document.getElementById('location-suggestions');
                        suggestionsDiv.classList.remove('show');
                    }, 200);
                });

                // Add focus event listener to show suggestions if there's text
                locationInput.addEventListener('focus', (e) => {
                    if (e.target.value.length >= 3) {
                        showAddressSuggestions(e.target.value);
                    }
                });
            }
        }

        // Enhanced location functions with precise GPS coordinates
        let currentLocationData = null;

        // Get current location with high accuracy
        async function getCurrentLocation() {
            const locationBtn = document.getElementById('get-location-btn');
            const statusDiv = document.getElementById('location-status');
            
            if (!navigator.geolocation) {
                showLocationStatus('error', 'Geolocation is not supported by this browser.');
                return;
            }

            // Show loading state
            locationBtn.disabled = true;
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            showLocationStatus('loading', 'Getting your precise location...');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            };

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });

                const { latitude, longitude, accuracy } = position.coords;
                
                // Store location data
                currentLocationData = {
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: accuracy,
                    timestamp: new Date().toISOString()
                };

                // Update hidden fields
                document.getElementById('customer-latitude').value = latitude;
                document.getElementById('customer-longitude').value = longitude;
                document.getElementById('customer-accuracy').value = accuracy;

                // Get address from coordinates using reverse geocoding
                await getAddressFromCoordinates(latitude, longitude);

                // Show verification section
                showLocationVerification(latitude, longitude, accuracy);

                showLocationStatus('success', 'Location captured successfully!');
                
            } catch (error) {
                console.error('Location error:', error);
                let errorMessage = 'Unable to get your location. ';
                
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'An unknown error occurred.';
                        break;
                }
                
                showLocationStatus('error', errorMessage);
            } finally {
                // Reset button
                locationBtn.disabled = false;
                locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use My Location';
            }
        }

        // Get address from coordinates using reverse geocoding
        async function getAddressFromCoordinates(latitude, longitude) {
            try {
                // Use BigDataCloud API for reverse geocoding
                const response = await fetch(
                    `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`
                );
                
                if (!response.ok) {
                    throw new Error('Reverse geocoding failed');
                }
                
                const data = await response.json();
                
                if (data.locality && data.city && data.countryName) {
                    const address = `${data.locality}, ${data.city}, ${data.countryName}`;
                    document.getElementById('customer-delivery-location').value = address;
                    
                    // Store address components
                    const addressComponents = {
                        locality: data.locality,
                        city: data.city,
                        country: data.countryName,
                        countryCode: data.countryCode,
                        formattedAddress: address
                    };
                    
                    document.getElementById('customer-address-components').value = JSON.stringify(addressComponents);
                    
                    return address;
                } else {
                    throw new Error('Invalid address data');
                }
                
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                // Fallback to manual entry
                showLocationStatus('warning', 'Location captured but address needs manual entry.');
            }
        }

        // Show location verification section
        function showLocationVerification(latitude, longitude, accuracy) {
            const verificationDiv = document.getElementById('location-verification');
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const accuracyDisplay = document.getElementById('accuracy-display');
            const verifiedAddress = document.getElementById('verified-address');
            
            coordinatesDisplay.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            accuracyDisplay.textContent = `±${Math.round(accuracy)} meters`;
            verifiedAddress.textContent = document.getElementById('customer-delivery-location').value;
            
            verificationDiv.style.display = 'block';
        }

        // Re-verify location
        async function reverifyLocation() {
            await getCurrentLocation();
        }

        // Show location status
        function showLocationStatus(type, message) {
            const statusDiv = document.getElementById('location-status');
            statusDiv.className = `location-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        async function collectCustomerDetails(event) {
            event.preventDefault();
            const fullName = document.getElementById('customer-full-name').value;
            const idNumber = document.getElementById('customer-id').value;
            const phoneNumber = document.getElementById('customer-phone').value;
            const deliveryLocation = document.getElementById('customer-delivery-location').value;
            const houseName = document.getElementById('customer-house-name').value;
            const additionalNotes = document.getElementById('customer-additional-notes').value;

            // Get precise location data
            const latitude = document.getElementById('customer-latitude').value;
            const longitude = document.getElementById('customer-longitude').value;
            const accuracy = document.getElementById('customer-accuracy').value;
            const addressComponents = document.getElementById('customer-address-components').value;

            if (!fullName || !idNumber || !phoneNumber || !deliveryLocation) {
                showModal('Missing Information', 'Please fill in all required customer details.');
                return;
            }

            // Validate delivery address
            if (!validateDeliveryAddress(deliveryLocation)) {
                showModal('Invalid Address', 'Please enter a valid delivery address in Kenya.');
                return;
            }

            // Basic phone number validation (Kenyan format 07XXXXXXXX)
            const phoneRegex = /^07[0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            // Enhanced customer details with precise location
            const customerDetails = { 
                fullName, 
                idNumber, 
                phoneNumber, 
                deliveryLocation, 
                houseName, 
                additionalNotes,
                // Precise location data
                location: {
                    latitude: latitude ? parseFloat(latitude) : null,
                    longitude: longitude ? parseFloat(longitude) : null,
                    accuracy: accuracy ? parseFloat(accuracy) : null,
                    addressComponents: addressComponents ? JSON.parse(addressComponents) : null,
                    capturedAt: currentLocationData ? currentLocationData.timestamp : new Date().toISOString()
                }
            };
            
            // Validate customer details before saving
            if (!customerDetails.fullName || !customerDetails.phoneNumber || !customerDetails.deliveryLocation) {
                console.error("❌ Customer details validation failed:", customerDetails);
                showModal('Validation Error', 'Please fill in all required fields (Name, Phone, Delivery Location).');
                return;
            }
            
            console.log("✅ Customer details validated and saving:", customerDetails);
            
            // Save to localStorage for immediate use
            saveToLocalStorage('lastCustomerDetails', customerDetails);
            
            // Save to Firestore customers collection for future use
            if (firebaseUser) {
                try {
                    console.log("💾 Saving customer details to Firestore customers collection...");
                    const customerRef = window.doc(window.db, "customers", firebaseUser.uid);
                    const customerData = {
                        ...customerDetails,
                        email: firebaseUser.email,
                        userId: firebaseUser.uid,
                        lastUpdated: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    
                    await window.setDoc(customerRef, customerData, { merge: true });
                    console.log("✅ Customer details saved to Firestore:", customerData);
                } catch (error) {
                    console.error("❌ Error saving customer details to Firestore:", error);
                    // Continue with order even if Firestore save fails
                }
            }
            
            // Verify data was saved to localStorage
            const savedData = getFromLocalStorage('lastCustomerDetails', {});
            console.log("✅ Customer details saved to localStorage:", savedData);
            
            closeCustomerDetailsModal();
            openPaymentMethodModal(customerDetails); // Pass customerDetails to the next step
        }

        async function openPaymentMethodModal(customerDetails) {
            const currentCartSubtotal = (await getCart()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            
            // Update order summary
            document.getElementById('payment-subtotal').textContent = `KES ${currentCartSubtotal.toFixed(2)}`;
            document.getElementById('payment-delivery-fee').textContent = `KES ${TRANSPORT_FEE.toFixed(2)}`;
            document.getElementById('payment-total').textContent = `KES ${grandTotal.toFixed(2)}`;
            mpesaAmountSpan.textContent = grandTotal.toFixed(2); // Auto-fill Mpesa amount
            
            // Reset voucher state
            resetVoucherState();
            
            // Reset payment method selection to Cash on Delivery by default
            document.querySelector('input[name="payment-method"][value="cash"]').checked = true;
            mpesaDetailsDiv.style.display = 'none';
            cardDetailsDiv.style.display = 'none';

            // Add event listener for radio button changes
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'mpesa') {
                        mpesaDetailsDiv.style.display = 'block';
                        cardDetailsDiv.style.display = 'none';
                    } else if (event.target.value === 'card') {
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'block';
                    } else { // Cash on Delivery
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'none';
                    }
                });
            });

            paymentMethodModal.style.display = 'flex';
        }

        function closePaymentMethodModal() {
            paymentMethodModal.style.display = 'none';
            document.getElementById('payment-form').reset(); // Clear form on close
            resetVoucherState(); // Reset voucher state when closing modal
        }

        // --- Voucher System Functions ---
        let currentVoucher = null; // Store current applied voucher

        function resetVoucherState() {
            currentVoucher = null;
            document.getElementById('voucher-code').value = '';
            document.getElementById('voucher-status').className = 'voucher-status';
            document.getElementById('voucher-status').style.display = 'none';
            document.getElementById('voucher-discount').style.display = 'none';
            document.getElementById('apply-voucher-btn').disabled = false;
            updateOrderTotal();
        }

        async function applyVoucher() {
            const voucherCode = document.getElementById('voucher-code').value.trim().toUpperCase();
            const statusDiv = document.getElementById('voucher-status');
            const applyBtn = document.getElementById('apply-voucher-btn');
            
            if (!voucherCode) {
                showVoucherStatus('error', 'Please enter a voucher code');
                return;
            }

            // Show loading state
            applyBtn.disabled = true;
            applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
            showVoucherStatus('loading', 'Validating voucher code...');

            try {
                // Validate voucher with Firestore
                const voucher = await validateVoucher(voucherCode);
                
                if (voucher) {
                    // Check if voucher is already used by this user
                    if (firebaseUser) {
                        const isUsed = await checkVoucherUsage(voucherCode, firebaseUser.uid);
                        if (isUsed) {
                            showVoucherStatus('error', 'This voucher has already been used by you');
                            resetApplyButton();
                            return;
                        }
                    }

                    // Apply voucher
                    currentVoucher = voucher;
                    showVoucherStatus('success', `Voucher applied! ${voucher.description}`);
                    updateOrderTotal();
                    
                    // Show discount in summary
                    document.getElementById('voucher-discount').style.display = 'flex';
                    document.getElementById('voucher-discount-amount').textContent = `-KES ${voucher.discountAmount.toFixed(2)}`;
                    
                } else {
                    showVoucherStatus('error', 'Invalid or expired voucher code');
                }
            } catch (error) {
                console.error('Voucher validation error:', error);
                showVoucherStatus('error', 'Error validating voucher. Please try again.');
            } finally {
                resetApplyButton();
            }
        }

        function resetApplyButton() {
            const applyBtn = document.getElementById('apply-voucher-btn');
            applyBtn.disabled = false;
            applyBtn.innerHTML = '<i class="fas fa-ticket-alt"></i> Apply';
        }

        function showVoucherStatus(type, message) {
            const statusDiv = document.getElementById('voucher-status');
            statusDiv.className = `voucher-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        async function validateVoucher(voucherCode) {
            try {
                const voucherRef = window.doc(window.db, "vouchers", voucherCode);
                const voucherDoc = await window.getDoc(voucherRef);
                
                if (!voucherDoc.exists()) {
                    return null;
                }
                
                const voucher = voucherDoc.data();
                
                // Check if voucher is active
                if (!voucher.isActive) {
                    return null;
                }
                
                // Check expiration date
                if (voucher.expiryDate && new Date(voucher.expiryDate) < new Date()) {
                    return null;
                }
                
                // Check usage limit
                if (voucher.usageLimit && voucher.usageCount >= voucher.usageLimit) {
                    return null;
                }
                
                return {
                    id: voucherDoc.id,
                    code: voucherCode,
                    description: voucher.description,
                    discountAmount: voucher.discountAmount,
                    discountType: voucher.discountType, // 'fixed' or 'percentage'
                    minOrderAmount: voucher.minOrderAmount || 0
                };
            } catch (error) {
                console.error('Error validating voucher:', error);
                return null;
            }
        }

        async function checkVoucherUsage(voucherCode, userId) {
            try {
                const usageRef = window.collection(window.db, "voucherUsage");
                const q = window.query(usageRef, 
                    window.where("voucherCode", "==", voucherCode),
                    window.where("userId", "==", userId)
                );
                const querySnapshot = await window.getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error checking voucher usage:', error);
                return false;
            }
        }

        async function updateOrderTotal() {
            const currentCartSubtotal = (await getCart()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let total = currentCartSubtotal + TRANSPORT_FEE;
            
            // Apply voucher discount if available
            if (currentVoucher) {
                const discountAmount = currentVoucher.discountType === 'percentage' 
                    ? (currentCartSubtotal * currentVoucher.discountAmount / 100)
                    : currentVoucher.discountAmount;
                
                total = Math.max(0, total - discountAmount);
            }
            
            // Update display
            document.getElementById('payment-total').textContent = `KES ${total.toFixed(2)}`;
            document.getElementById('mpesa-amount').textContent = total.toFixed(2);
        }

        // Function to show development message for disabled payment methods
        function showDevelopmentMessage(paymentMethod) {
            showModal('Payment Method in Development', `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🚧</div>
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">${paymentMethod} Coming Soon!</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        We're currently working on implementing ${paymentMethod} payment integration. 
                        This feature will be available in a future update.
                    </p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p style="margin: 0; color: #4CAF50; font-weight: 600;">
                            ✅ Cash on Delivery is currently available
                        </p>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                            You can complete your order using Cash on Delivery for now.
                        </p>
                    </div>
                    <p style="color: #999; font-size: 14px; margin-top: 20px;">
                        Thank you for your patience! 🙏
                    </p>
                </div>
            `);
        }

        async function processPayment(event) {
            event.preventDefault();
            const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;
            const currentCartSubtotal = (await getCart()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            const customerDetails = getFromLocalStorage('lastCustomerDetails', {});

            // Apply voucher discount if available
            let voucherDiscount = 0;
            if (currentVoucher) {
                voucherDiscount = currentVoucher.discountType === 'percentage' 
                    ? (currentCartSubtotal * currentVoucher.discountAmount / 100)
                    : currentVoucher.discountAmount;
                grandTotal = Math.max(0, grandTotal - voucherDiscount);
            }

            // Validate customer details before proceeding
            if (!customerDetails || !customerDetails.fullName || !customerDetails.phoneNumber || !customerDetails.deliveryLocation) {
                console.error("❌ Customer details missing or incomplete:", customerDetails);
                showModal('Missing Customer Details', 'Customer details are missing or incomplete. Please fill in your delivery information again.');
                closePaymentMethodModal();
                openCustomerDetailsModal();
                return;
            }

            console.log("✅ Customer details validated in processPayment:", customerDetails);

            // Only process Cash on Delivery - other methods are disabled
            if (selectedMethod === 'cash') {
                let confirmationMessage = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">💰</div>
                        <h3 style="color: #4CAF50; margin-bottom: 15px;">Cash on Delivery Selected</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Your order will be processed and payment will be collected upon delivery.
                        </p>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0; color: #4CAF50; font-weight: 600;">
                                Total Amount: KES ${grandTotal.toFixed(2)}
                            </p>`;

                if (currentVoucher) {
                    confirmationMessage += `
                            <p style="margin: 5px 0; color: #4CAF50; font-size: 14px;">
                                Voucher Applied: ${currentVoucher.code} (-KES ${voucherDiscount.toFixed(2)})
                            </p>`;
                }

                confirmationMessage += `
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                Please have the exact amount ready for our delivery team.
                            </p>
                        </div>
                        <p style="color: #999; font-size: 14px; margin-top: 20px;">
                            Thank you for choosing Prince Alex Store! 🥬
                        </p>
                    </div>`;

                showModal('Cash on Delivery Confirmed', confirmationMessage);
                await placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal, currentVoucher);
            } else {
                // This should not happen since other options are disabled, but just in case
                showDevelopmentMessage(selectedMethod === 'mpesa' ? 'M-Pesa' : 'Card Payment');
                return;
            }
            closePaymentMethodModal();
        }

        // Completely rebuilt order placement function with better error handling
        async function placeOrderFinal(paymentMethod, customerDetails, transportationFee, grandTotal, appliedVoucher = null) {
            console.log("🚀 Starting order placement process...");
            console.log("📋 Received parameters:", { paymentMethod, customerDetails, transportationFee, grandTotal, appliedVoucher });
            
            try {
                // Step 0: Ensure customer details are available (fallback to localStorage)
                if (!customerDetails || typeof customerDetails !== 'object') {
                    console.log("⚠️ Customer details missing, attempting to retrieve from localStorage...");
                    const savedDetails = getFromLocalStorage('lastCustomerDetails', {});
                    if (savedDetails && savedDetails.fullName) {
                        customerDetails = savedDetails;
                        console.log("✅ Customer details retrieved from localStorage:", customerDetails);
                    } else {
                        console.error("❌ No customer details available in localStorage either");
                        showModal('Customer Details Missing', 'Customer details are missing. Please fill in your delivery information again.');
                        return;
                    }
                }
                // Step 1: Validate cart
                const cart = await getCart();
                if (!cart || cart.length === 0) {
                    console.error("❌ Cart is empty");
                    showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                    return;
                }
                
                console.log(`📦 Processing ${cart.length} items in cart`);
                
                // Step 2: Validate Firebase connection
                if (!window.db || !window.collection || !window.doc || !window.getDoc || !window.setDoc || !window.updateDoc) {
                    console.error("❌ Firebase functions not available");
                    showModal('System Error', 'Database connection not available. Please refresh the page and try again.');
                    return;
                }
                
                console.log("✅ Firebase connection verified");
                
                // Step 3: Generate unique order ID
                const orderId = "PA-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).substring(2, 6).toUpperCase();
                console.log(`🆔 Generated Order ID: ${orderId}`);
                
                // Step 4: Validate stock and prepare order data
                const orderItems = [];
                const stockUpdates = [];
                
                for (const cartItem of cart) {
                    try {
                        console.log(`🔍 Checking stock for: ${cartItem.name}`);
                        
                        const productRef = window.doc(window.db, "products", cartItem.id);
                        const productSnap = await window.getDoc(productRef);
                        
                        if (!productSnap.exists()) {
                            console.error(`❌ Product not found: ${cartItem.name}`);
                            showModal('Product Error', `Product "${cartItem.name}" is no longer available. Please remove it from your cart and try again.`);
                            return;
                        }
                        
                        const productData = productSnap.data();
                        const currentStock = productData.stock || 0;
                        
                        if (currentStock < cartItem.quantity) {
                            console.error(`❌ Insufficient stock for ${cartItem.name}: ${currentStock} < ${cartItem.quantity}`);
                            showModal('Stock Error', `Not enough "${cartItem.name}" in stock. Available: ${currentStock}, Requested: ${cartItem.quantity}`);
                            return;
                        }
                        
                        // Prepare order item data
                        orderItems.push({
                            id: cartItem.id,
                            name: cartItem.name,
                            price: cartItem.price,
                            unit: cartItem.unit || '',
                            quantity: cartItem.quantity,
                            image: cartItem.image || '',
                            totalPrice: cartItem.price * cartItem.quantity,
                            stockAtTimeOfOrder: currentStock
                        });
                        
                        // Prepare stock update
                        stockUpdates.push({
                            ref: productRef,
                            newStock: currentStock - cartItem.quantity,
                            productName: cartItem.name
                        });
                        
                        console.log(`✅ Stock validated for ${cartItem.name}: ${currentStock} -> ${currentStock - cartItem.quantity}`);
                        
                    } catch (error) {
                        console.error(`❌ Error processing ${cartItem.name}:`, error);
                        showModal('Processing Error', `Error processing "${cartItem.name}". Please try again.`);
                        return;
                    }
                }
                
                console.log(`✅ All ${orderItems.length} items validated successfully`);
                
                // Step 5: Validate customer details
                if (!customerDetails || typeof customerDetails !== 'object') {
                    console.error("❌ Customer details are missing or invalid:", customerDetails);
                    showModal('Customer Details Error', 'Customer details are missing. Please fill in your delivery information again.');
                    return;
                }
                
                if (!customerDetails.fullName || !customerDetails.phoneNumber || !customerDetails.deliveryLocation) {
                    console.error("❌ Required customer details missing:", customerDetails);
                    showModal('Missing Information', 'Required customer information is missing. Please fill in all required fields.');
                    return;
                }
                
                console.log("✅ Customer details validated:", customerDetails);
                
                // Step 6: Create comprehensive order data
                const orderData = { 
                    // Order identification
                    orderId: orderId,
                    status: 'Pending',
                    date: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    
                    // Financial details
                    subtotal: grandTotal - transportationFee,
                    transportationFee: transportationFee,
                    total: grandTotal,
                    paymentMethod: paymentMethod,
                    
                    // Voucher information
                    voucher: appliedVoucher ? {
                        code: appliedVoucher.code,
                        description: appliedVoucher.description,
                        discountAmount: appliedVoucher.discountType === 'percentage' 
                            ? ((grandTotal - transportationFee) * appliedVoucher.discountAmount / 100)
                            : appliedVoucher.discountAmount,
                        discountType: appliedVoucher.discountType,
                        originalTotal: grandTotal + (appliedVoucher.discountType === 'percentage' 
                            ? ((grandTotal - transportationFee) * appliedVoucher.discountAmount / 100)
                            : appliedVoucher.discountAmount)
                    } : null,
                    
                    // Customer information (complete details)
                    customer: {
                        fullName: customerDetails.fullName,
                        phoneNumber: customerDetails.phoneNumber,
                        idNumber: customerDetails.idNumber || null,
                        deliveryLocation: customerDetails.deliveryLocation,
                        houseName: customerDetails.houseName || null,
                        additionalNotes: customerDetails.additionalNotes || null
                    },
                    
                    // User account information
                    userEmail: firebaseUser ? firebaseUser.email : null,
                    userId: firebaseUser ? firebaseUser.uid : null,
                    userDisplayName: firebaseUser ? firebaseUser.displayName : null,
                    
                    // Order items with detailed information
                    items: orderItems,
                    
                    // Delivery information
                    deliveryInfo: {
                        estimatedDelivery: '30 minutes',
                        deliveryStatus: 'Pending',
                        deliveryNotes: customerDetails.additionalNotes || 'No special instructions'
                    },
                    
                    // System metadata
                    orderSource: 'Web Store',
                    version: '2.0',
                    processedAt: new Date().toISOString()
                };
                
                console.log("📋 Order data prepared:", orderData);
                
                // Step 6: Save order to Firestore
                console.log("💾 Saving order to Firestore...");
                const ordersCol = window.collection(window.db, "orders");
                await window.setDoc(window.doc(ordersCol, orderId), orderData);
                console.log(`✅ Order saved successfully to Firestore: ${orderId}`);
                
                // Step 6.5: Track voucher usage if voucher was applied
                if (appliedVoucher && firebaseUser) {
                    try {
                        console.log("🎫 Tracking voucher usage...");
                        
                        // Save voucher usage record
                        const voucherUsageData = {
                            voucherCode: appliedVoucher.code,
                            voucherId: appliedVoucher.id,
                            userId: firebaseUser.uid,
                            userEmail: firebaseUser.email,
                            orderId: orderId,
                            discountAmount: orderData.voucher.discountAmount,
                            usedAt: new Date().toISOString(),
                            orderTotal: grandTotal,
                            customerName: customerDetails.fullName
                        };
                        
                        const voucherUsageCol = window.collection(window.db, "voucherUsage");
                        await window.addDoc(voucherUsageCol, voucherUsageData);
                        console.log(`✅ Voucher usage tracked: ${appliedVoucher.code}`);
                        
                        // Update voucher usage count
                        const voucherRef = window.doc(window.db, "vouchers", appliedVoucher.code);
                        await window.updateDoc(voucherRef, {
                            usageCount: (appliedVoucher.usageCount || 0) + 1,
                            lastUsed: new Date().toISOString(),
                            lastUsedBy: firebaseUser.uid
                        });
                        console.log(`✅ Voucher usage count updated: ${appliedVoucher.code}`);
                        
                    } catch (error) {
                        console.error("❌ Error tracking voucher usage:", error);
                        // Continue even if voucher tracking fails
                    }
                }
                
                // Step 7: Update stock levels
                console.log("📦 Updating stock levels...");
                for (const stockUpdate of stockUpdates) {
                    try {
                        await window.updateDoc(stockUpdate.ref, { 
                            stock: stockUpdate.newStock,
                            lastUpdated: new Date().toISOString()
                        });
                        console.log(`✅ Stock updated for ${stockUpdate.productName}: ${stockUpdate.newStock}`);
                    } catch (error) {
                        console.error(`❌ Failed to update stock for ${stockUpdate.productName}:`, error);
                        // Continue with other stock updates even if one fails
                    }
                }
                
                console.log("✅ All stock levels updated successfully");

                // Step 8: Handle loyalty points and email notifications
                let pointsEarned = 0;
                if (firebaseUser) {
                    try {
                        pointsEarned = Math.floor(grandTotal / 100) * 5; // 5 points per 100 KES spent
                        userLoyaltyPoints += pointsEarned;
                        await saveLoyaltyPoints(firebaseUser.uid, userLoyaltyPoints);
                        console.log(`✅ Loyalty points awarded: ${pointsEarned} (Total: ${userLoyaltyPoints})`);
                    } catch (error) {
                        console.error("❌ Error awarding loyalty points:", error);
                        // Continue even if loyalty points fail
                    }
                    
                    // Step 9: Send order confirmation email
                    try {
                        console.log("📧 Preparing order confirmation email...");
                        const emailData = {
                            orderId: orderId,
                            customerName: customerDetails.fullName,
                            customerEmail: firebaseUser.email,
                            customerPhone: customerDetails.phoneNumber,
                            items: orderItems.map(item => ({
                                name: item.name,
                                quantity: item.quantity,
                                price: item.totalPrice.toFixed(2),
                                unit: item.unit
                            })),
                            subtotal: (grandTotal - transportationFee).toFixed(2),
                            deliveryFee: transportationFee.toFixed(2),
                            total: grandTotal.toFixed(2),
                            deliveryAddress: `${customerDetails.deliveryLocation}, ${customerDetails.houseName || 'N/A'}`,
                            estimatedDelivery: '30 minutes',
                            paymentMethod: paymentMethod,
                            orderDate: new Date().toLocaleString()
                        };
                        
                        // Save email to mail collection
                        const mailCol = window.collection(window.db, "mail");
                        const emailDoc = await window.addDoc(mailCol, {
                            to: firebaseUser.email,
                            message: {
                                subject: `Order Confirmation - ${orderId}`,
                                html: `
                                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                        <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                            <h1 style="margin: 0; font-size: 28px;">🥬 Order Confirmed!</h1>
                                            <p style="margin: 10px 0 0 0; font-size: 16px;">Thank you for your order with Prince Alex Store</p>
                                        </div>
                                        
                                        <div style="padding: 30px; background: white;">
                                            <p style="font-size: 16px; color: #333;">Hello ${emailData.customerName},</p>
                                            <p style="font-size: 16px; color: #333;">Your order has been confirmed and is being prepared for delivery!</p>
                                            
                                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                                <h3 style="color: #4CAF50; margin: 0 0 15px 0;">📋 Order Details</h3>
                                                <p style="margin: 5px 0;"><strong>Order ID:</strong> ${emailData.orderId}</p>
                                                <p style="margin: 5px 0;"><strong>Order Date:</strong> ${emailData.orderDate}</p>
                                                <p style="margin: 5px 0;"><strong>Payment Method:</strong> ${emailData.paymentMethod}</p>
                                                <p style="margin: 5px 0;"><strong>Delivery Address:</strong> ${emailData.deliveryAddress}</p>
                                                <p style="margin: 5px 0;"><strong>Estimated Delivery:</strong> ${emailData.estimatedDelivery}</p>
                                            </div>
                                            
                                            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                                <h3 style="color: #4CAF50; margin: 0 0 15px 0;">🛒 Order Items</h3>
                                                ${emailData.items.map(item => `
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                                                        <span>${item.name} (${item.quantity} ${item.unit})</span>
                                                        <span><strong>KES ${item.price}</strong></span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            
                                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                                <h3 style="color: #856404; margin: 0 0 15px 0;">💰 Order Summary</h3>
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                                    <span>Subtotal:</span>
                                                    <span>KES ${emailData.subtotal}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                                    <span>Delivery Fee:</span>
                                                    <span>KES ${emailData.deliveryFee}</span>
                                                </div>
                                                ${appliedVoucher ? `
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #4CAF50;">
                                                    <span>Voucher Discount (${appliedVoucher.code}):</span>
                                                    <span>-KES ${orderData.voucher.discountAmount.toFixed(2)}</span>
                                                </div>
                                                ` : ''}
                                                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #4CAF50; border-top: 2px solid #4CAF50; padding-top: 10px;">
                                                    <span>Total:</span>
                                                    <span>KES ${emailData.total}</span>
                                                </div>
                                            </div>
                                            
                                            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                                <h3 style="color: #0c5460; margin: 0 0 15px 0;">🚚 Delivery Information</h3>
                                                <p style="margin: 5px 0; color: #0c5460;">Your order will be delivered within 30 minutes to:</p>
                                                <p style="margin: 5px 0; color: #0c5460;"><strong>${emailData.deliveryAddress}</strong></p>
                                                <p style="margin: 5px 0; color: #0c5460;">Please ensure someone is available to receive the order.</p>
                                            </div>
                                            
                                            <p style="font-size: 16px; color: #333;">Thank you for choosing Prince Alex Store for your fresh vegetable needs!</p>
                                            <p style="font-size: 16px; color: #333; margin-bottom: 0;"><strong>The Prince Alex Store Team</strong> 🥬🍅🥕</p>
                                        </div>
                                    </div>
                                `
                            },
                            emailType: 'order_confirmation',
                            orderId: orderId,
                            customerEmail: firebaseUser.email,
                            customerName: customerDetails.fullName,
                            createdAt: new Date().toISOString(),
                            status: 'pending',
                            priority: 'high'
                        });
                        
                        console.log(`✅ Order confirmation email saved to mail collection: ${emailDoc.id}`);
                        
                    } catch (emailError) {
                        console.error("❌ Error saving email to mail collection:", emailError);
                        // Continue even if email fails
                    }
                }
                
                // Step 10: Clear cart and update UI
                console.log("🧹 Clearing cart and updating UI...");
                await saveCart([]); // Clear user's cart in Firestore
                updateCartCount();
                updateCartPreview();
                
                // Step 11: Save last order for confirmation page
                saveToLocalStorage('lastOrder', { 
                    id: orderId,
                    items: orderItems, 
                    status: 'Pending', 
                    date: new Date().toISOString(),
                    subtotal: grandTotal - transportationFee,
                    transportationFee: transportationFee,
                    total: grandTotal,
                    customer: customerDetails,
                    paymentMethod: paymentMethod,
                    userEmail: firebaseUser ? firebaseUser.email : null,
                    userId: firebaseUser ? firebaseUser.uid : null
                });
                
                // Step 12: Refresh user orders if logged in
                if (firebaseUser) {
                    console.log("🔄 Refreshing user orders after successful order placement...");
                    setTimeout(() => {
                        window.refreshUserOrders();
                    }, 1000); // Small delay to ensure order is fully saved
                }
                
                // Step 13: Show success message and navigate
                const successMessage = firebaseUser ? 
                    `Your order has been placed successfully! Your Order ID is: <strong>${orderId}</strong>.<br><br>You earned ${pointsEarned} loyalty points! Total points: ${userLoyaltyPoints}.<br><br>Check your email for order confirmation!<br><br>Delivery will be done in the next 30 minutes to your pinned location!` :
                    `Your order has been placed successfully! Your Order ID is: <strong>${orderId}</strong>.<br><br>Delivery will be done in the next 30 minutes to your pinned location!`;
                
                showModal('Order Placed Successfully! 🎉', successMessage);
                
                // Navigate to confirmation page after a short delay
                setTimeout(() => {
                    showPage('order-confirmation-page');
                }, 2000);
                
                console.log("🎉 Order placement completed successfully!");
                
            } catch (error) {
                console.error("❌ Critical error in order placement:", error);
                console.error("Error details:", {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                showModal('Order Failed', `There was an error placing your order. Please try again.<br><br><strong>Error:</strong> ${error.message}`);
            }
        }

        // --- Order Confirmation Page ---
        function displayLastOrderConfirmation() {
            const lastOrder = getFromLocalStorage('lastOrder', null);
            const lastOrderDetailsDiv = document.getElementById('last-order-details');
            if (lastOrder) {
                let itemsHtml = lastOrder.items.map(item => `<li>${item.name} (x${item.quantity}) - KES ${item.price.toFixed(2)} ${item.unit || ''}</li>`).join('');
                lastOrderDetailsDiv.innerHTML = `
                    <h3>Thank You for Your Order!</h3>
                    <p>Order ID: <strong>${lastOrder.id}</strong></p>
                    <p>Status: <strong>${lastOrder.status}</strong></p>
                    <p>Date Placed: ${new Date(lastOrder.date).toLocaleString()}</p>
                    <p>Subtotal: <strong>KES ${lastOrder.subtotal.toFixed(2)}</strong></p>
                    <p>Transportation Fee: <strong>KES ${lastOrder.transportationFee.toFixed(2)}</strong></p>
                    <p>Grand Total: <strong>KES ${lastOrder.total.toFixed(2)}</strong></p>
                    <p>Payment Method: <strong>${lastOrder.paymentMethod}</strong></p>
                    <h4>Customer Details:</h4>
                    <ul>
                        <li>Name: ${lastOrder.customer.fullName}</li>
                        <li>Phone: ${lastOrder.customer.phoneNumber}</li>
                        <li>Delivery: ${lastOrder.customer.deliveryLocation}, ${lastOrder.customer.houseName || 'N/A'}</li>
                    </ul>
                    <h4>Items Ordered:</h4>
                    <ul>${itemsHtml}</ul>
                    <p>Delivery will be done in the next 30 minutes to your pinned location. Please be available to meet our rider!</p>
                    <button class="cta-button" onclick="showPage('track-order-page')">Track My Order</button>
                `;
            } else {
                lastOrderDetailsDiv.innerHTML = '<p>No recent order found. Please place an order first.</p>';
            }
        }

        // --- Order Tracking Simulation (Firestore) ---
        async function trackOrder(event) {
            if (event) event.preventDefault();
            const orderIdInput = document.getElementById('order-id-input').value.trim();
            const statusDiv = document.getElementById('order-status');
            const idToTrack = orderIdInput;

            if (!idToTrack) {
                statusDiv.innerHTML = '<p style="color: red;">Please enter a valid Order ID.</p>';
                return;
            }

            try {
                const orderDocRef = window.doc(window.db, "orders", idToTrack);
                const orderDocSnap = await window.getDoc(orderDocRef);

                if (orderDocSnap.exists()) {
                    const order = orderDocSnap.data();
                    let itemsHtml = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    statusDiv.innerHTML = `
                        <p>Order ID: <strong>${orderDocSnap.id}</strong></p>
                        <p>Status: <strong>${order.status}</strong></p>
                        <p>Date Placed: ${new Date(order.date).toLocaleString()}</p>
                        <p>Subtotal: KES ${order.subtotal.toFixed(2)}</p>
                        <p>Transportation Fee: KES ${order.transportationFee.toFixed(2)}</p>
                        <p>Grand Total: KES ${order.total.toFixed(2)}</p>
                        <p>Payment Method: ${order.paymentMethod}</p>
                        <p>Delivery to: ${order.customer.fullName}, ${order.customer.deliveryLocation}, ${order.customer.houseName || 'N/A'}</p>
                        <h4>Items:</h4>
                        <ul>${itemsHtml}</ul>
                        <p>Your order is currently being processed and will be shipped soon. Thank you for your patience!</p>
                    `;
                } else {
                    statusDiv.innerHTML = '<p style="color: red;">Order not found. Please check your Order ID.</p>';
                }
            } catch (error) {
                console.error("Error tracking order:", error);
                statusDiv.innerHTML = '<p style="color: red;">Error tracking order. Please try again.</p>';
            }
        }
        
        // --- Contact Form (Firestore + Email) ---
        async function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            
            // Basic validation
            if (name && email && message) {
                try {
                    // Save to Firestore
                    await window.addDoc(window.collection(window.db, "contactSubmissions"), { 
                        name, 
                        email, 
                        message, 
                        date: new Date().toISOString() 
                    });

                    // ✅ Send email notification to admin
                    const emailSent = await sendContactFormEmail({ name, email, message });
                    
                    if (emailSent) {
                        showModal('Message Sent!', `Thank you, ${name}! Your message has been sent and we've been notified. We will get back to you shortly.`);
                    } else {
                        showModal('Message Sent!', `Thank you, ${name}! Your message has been saved. We will get back to you shortly.`);
                    }
                    
                    document.querySelector('.contact-form').reset();
                } catch (error) {
                    console.error("Error submitting contact form:", error);
                    showModal('Error', 'Failed to send message. Please try again.');
                }
            } else {
                showModal('Error', 'Please fill out all fields.');
            }
        }

        // --- Newsletter Subscription (Firestore + Email) ---
        async function subscribeToNewsletter(event) {
            event.preventDefault();
            const email = document.getElementById('newsletter-email').value;
            if (email) {
                try {
                    // Check if email already exists
                    const q = window.query(window.collection(window.db, "newsletterSubscriptions"), window.where("email", "==", email));
                    const querySnapshot = await window.getDocs(q);
                    if (!querySnapshot.empty) {
                        showModal('Already Subscribed', 'This email is already subscribed to our newsletter.');
                        return;
                    }

                    // Save to Firestore
                    await window.addDoc(window.collection(window.db, "newsletterSubscriptions"), { 
                        email, 
                        subscribedAt: new Date().toISOString() 
                    });

                    // ✅ Send welcome newsletter email
                    const emailSent = await sendNewsletterSubscriptionEmail(email);
                    
                    if (emailSent) {
                        showModal('Subscribed!', `Thank you for subscribing! Check your email for your welcome message and 10% discount code.`);
                    } else {
                        showModal('Subscribed!', `Thank you for subscribing! Your subscription has been confirmed.`);
                    }
                    
                    document.querySelector('.newsletter-form').reset();
                    closeNewsletterPopup(); // Close the popup after successful subscription
                } catch (error) {
                    console.error("Error subscribing to newsletter:", error);
                    showModal('Error', 'Failed to subscribe. Please try again.');
                }
            } else {
                showModal('Error', 'Please enter a valid email address.');
            }
        }

        // --- Real-time Referral Program ---
        let referralStats = {
            totalSent: 0,
            totalAccepted: 0,
            totalRewards: 0,
            pendingReferrals: []
        };

        // Real-time referral tracking
        async function startReferralTracking() {
            try {
                if (!firebaseUser) return;
                
                // Listen for real-time updates to referrals
                const referralsQuery = window.query(
                    window.collection(window.db, "referrals"),
                    window.where("referrerEmail", "==", firebaseUser.email)
                );
                
                window.onSnapshot(referralsQuery, (snapshot) => {
                    try {
                        referralStats.totalSent = snapshot.size;
                        referralStats.totalAccepted = 0;
                        referralStats.totalRewards = 0;
                        referralStats.pendingReferrals = [];
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.status === 'accepted' || data.status === 'completed') {
                                referralStats.totalAccepted++;
                            }
                            referralStats.totalRewards += data.rewardEarned || 0;
                            
                            referralStats.pendingReferrals.push({
                                id: doc.id,
                                refereeEmail: data.refereeEmail,
                                date: data.date,
                                status: data.status || 'pending',
                                rewardEarned: data.rewardEarned || 0
                            });
                        });
                        
                        updateReferralDashboard();
                        updateReferralNotifications();
                        // Only update referral link if we're on the account page
                        if (document.getElementById('referral-link-input')) {
                            updateReferralLink(); // Update the referral link
                        }
                    } catch (error) {
                        console.error("Error processing referral snapshot:", error);
                    }
                });
            } catch (error) {
                console.error("Error starting referral tracking:", error);
            }
        }

        // Update referral dashboard with real-time data
        async function updateReferralDashboard() {
            try {
                const totalSentElement = document.getElementById('total-sent');
                const totalAcceptedElement = document.getElementById('total-accepted');
                const totalRewardsElement = document.getElementById('total-rewards');
                
                if (totalSentElement) totalSentElement.textContent = referralStats.totalSent || 0;
                if (totalAcceptedElement) totalAcceptedElement.textContent = referralStats.totalAccepted || 0;
                if (totalRewardsElement) totalRewardsElement.textContent = referralStats.totalRewards || 0;
                
                // Save referral stats to customer profile
                await saveReferralStatsToCustomer();
            } catch (error) {
                console.error("Error updating referral dashboard:", error);
            }
        }

        // Save referral stats to customer profile in Firestore
        async function saveReferralStatsToCustomer() {
            try {
                if (!firebaseUser) return;
                
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                await window.updateDoc(userDocRef, {
                    referralStats: {
                        totalSent: referralStats.totalSent || 0,
                        totalAccepted: referralStats.totalAccepted || 0,
                        totalRewards: referralStats.totalRewards || 0,
                        lastUpdated: new Date().toISOString()
                    }
                });
            } catch (error) {
                console.error("Error saving referral stats to customer:", error);
            }
        }

        // Load referral stats from customer profile
        async function loadReferralStatsFromCustomer() {
            try {
                if (!firebaseUser) return;
                
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                const userDocSnap = await window.getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.referralStats) {
                        referralStats.totalSent = userData.referralStats.totalSent || 0;
                        referralStats.totalAccepted = userData.referralStats.totalAccepted || 0;
                        referralStats.totalRewards = userData.referralStats.totalRewards || 0;
                        
                        // Update UI if on account page
                        const totalSentElement = document.getElementById('total-sent');
                        const totalAcceptedElement = document.getElementById('total-accepted');
                        const totalRewardsElement = document.getElementById('total-rewards');
                        
                        if (totalSentElement) totalSentElement.textContent = referralStats.totalSent;
                        if (totalAcceptedElement) totalAcceptedElement.textContent = referralStats.totalAccepted;
                        if (totalRewardsElement) totalRewardsElement.textContent = referralStats.totalRewards;
                    }
                }
            } catch (error) {
                console.error("Error loading referral stats from customer:", error);
            }
        }

        // Real-time referral notifications
        function updateReferralNotifications() {
            try {
                const notificationContainer = document.getElementById('referral-notifications');
                if (!notificationContainer) return;
            
            const recentReferrals = referralStats.pendingReferrals
                .filter(ref => new Date(ref.date) > new Date(Date.now() - 24 * 60 * 60 * 1000))
                .slice(0, 3);
            
            if (recentReferrals.length > 0) {
                notificationContainer.innerHTML = `
                    <div class="notification-header">
                        <h4>🎉 Recent Referral Activity</h4>
                    </div>
                    ${recentReferrals.map(ref => `
                        <div class="notification-item">
                            <span class="notification-text">
                                ${ref.status === 'accepted' ? '✅' : '📧'} 
                                ${ref.refereeEmail} ${ref.status === 'accepted' ? 'joined!' : 'invited'}
                            </span>
                            <span class="notification-time">${getTimeAgo(ref.date)}</span>
                        </div>
                    `).join('')}
                `;
            }
            } catch (error) {
                console.error("Error updating referral notifications:", error);
            }
        }

        // Enhanced referral form with real-time features
        async function submitReferralForm(event) {
            event.preventDefault();
            const refereeEmail = document.getElementById('referral-email').value;
            const referralMessage = document.getElementById('referral-message').value || '';
            
            if (!firebaseUser) {
                showModal('Login Required', 'Please log in to send referral invitations.');
                return;
            }

            if (!refereeEmail) {
                showModal('Error', 'Please enter your friend\'s email address.');
                return;
            }

            // Check if already referred
            const existingQuery = window.query(
                window.collection(window.db, "referrals"),
                window.where("referrerEmail", "==", firebaseUser.email),
                window.where("refereeEmail", "==", refereeEmail)
            );
            const existingSnapshot = await window.getDocs(existingQuery);
            
            if (!existingSnapshot.empty) {
                showModal('Already Referred', 'You have already sent a referral invitation to this email address.');
                return;
            }

            try {
                const userProfile = await getUserProfile(firebaseUser.uid);
                const referrerName = userProfile.fullname || firebaseUser.displayName || firebaseUser.email || 'Your Friend';
                const referrerEmail = firebaseUser.email;
                const referralId = `REF_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                // Save referral to Firestore with real-time tracking
                await window.addDoc(window.collection(window.db, "referrals"), {
                    referralId,
                    referrerEmail,
                    referrerName,
                    refereeEmail,
                    referralMessage,
                    status: 'sent',
                    date: new Date().toISOString(),
                    rewardEarned: 0,
                    refereeJoined: false,
                    refereeFirstOrder: false
                });

                // Generate unique referral link
                const referralLink = `https://store.princealex.pro?ref=${referralId}`;

                // ✅ Send email to friend with invite
                await addDoc(collection(db, "mail"), {
                    to: refereeEmail,
                    message: {
                        subject: "You've Been Invited to Prince Alex Store! 🎉",
                        html: `
                            <h2>You've Been Invited! 🎉</h2>
                            <p>Hello!</p>
                            <p><strong>${referrerName}</strong> has invited you to try Prince Alex Store - your one-stop shop for the freshest vegetables delivered right to your doorstep!</p>
                            ${referralMessage ? `<p><em>"${referralMessage}"</em></p>` : ''}
                            <div style="background: #FF6B35; color: white; padding: 20px; text-align: center; margin: 20px 0;">
                                <h3>🎁 Special Friend Discount!</h3>
                                <p>Use this exclusive discount code:</p>
                                <div style="font-size: 24px; font-weight: 700;">FRIEND15</div>
                                <p>Get 15% off your first order!</p>
                            </div>
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="${referralLink}" style="display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">🛒 Join with Referral Link</a>
                            </div>
                            <p>Why Choose Prince Alex Store?</p>
                            <ul>
                                <li>Fresh vegetables delivered within 30 minutes</li>
                                <li>Farm-to-table quality guaranteed</li>
                                <li>Competitive prices and great value</li>
                                <li>Easy online ordering</li>
                            </ul>
                            <p>Welcome to the Prince Alex Store family!</p>
                            <p><strong>The Prince Alex Store Team</strong></p>
                        `
                    }
                });

                // ✅ Send confirmation to user
                await addDoc(collection(db, "mail"), {
                    to: referrerEmail,
                    message: {
                        subject: "Referral Invitation Sent Successfully! 🎉",
                        html: `
                            <h2>Referral Sent! 🎉</h2>
                            <p>Hi ${referrerName},</p>
                            <p>Your referral invitation has been successfully sent to <strong>${refereeEmail}</strong>!</p>
                            <p>Your friend will receive a special 15% discount code (FRIEND15) for their first order.</p>
                            <p>When they make their first purchase, you'll earn 50 loyalty points as a thank you for spreading the word about Prince Alex Store!</p>
                            <p><strong>Your Referral Link:</strong> ${referralLink}</p>
                            <p>Share this link with more friends to earn more rewards!</p>
                            <p>Thank you for helping us grow our community of fresh vegetable lovers!</p>
                            <p><strong>The Prince Alex Store Team</strong></p>
                        `
                    }
                });
                
                // Show success with real-time update
                showModal('Invitation Sent!', `Referral invitation sent to ${refereeEmail}! Your friend will receive a special discount code. You'll earn 50 points when they make their first order!`);
                
                // Clear the form
                document.getElementById('referral-email').value = '';
                document.getElementById('referral-message').value = '';
                
                // Update referral stats in real-time
                referralStats.totalSent++;
                updateReferralDashboard();
                
            } catch (error) {
                console.error("Error sending referral:", error);
                showModal('Error', 'Failed to send referral invitation. Please try again.');
            }
        }

        // Track referral link clicks and conversions
        async function trackReferralConversion(referralId, action) {
            try {
                const referralQuery = window.query(
                    window.collection(window.db, "referrals"),
                    window.where("referralId", "==", referralId)
                );
                const referralSnapshot = await window.getDocs(referralQuery);
                
                if (!referralSnapshot.empty) {
                    const referralDoc = referralSnapshot.docs[0];
                    const referralData = referralDoc.data();
                    
                    if (action === 'clicked') {
                        await window.updateDoc(referralDoc.ref, {
                            status: 'clicked',
                            clickedAt: new Date().toISOString()
                        });
                    } else if (action === 'registered') {
                        await window.updateDoc(referralDoc.ref, {
                            status: 'accepted',
                            refereeJoined: true,
                            acceptedAt: new Date().toISOString()
                        });
                        
                        // Award referral bonus
                        await awardReferralBonus(referralData.referrerEmail, 25);
                    } else if (action === 'first_order') {
                        await window.updateDoc(referralDoc.ref, {
                            status: 'completed',
                            refereeFirstOrder: true,
                            rewardEarned: 50,
                            completedAt: new Date().toISOString()
                        });
                        
                        // Award referral completion bonus
                        await awardReferralBonus(referralData.referrerEmail, 50);
                    }
                }
            } catch (error) {
                console.error("Error tracking referral conversion:", error);
            }
        }

        // Award referral bonus points
        async function awardReferralBonus(referrerEmail, points) {
            try {
                const userQuery = window.query(
                    window.collection(window.db, "customers"),
                    window.where("email", "==", referrerEmail)
                );
                const userSnapshot = await window.getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    const newPoints = (userData.loyaltyPoints || 0) + points;
                    
                    await window.updateDoc(userDoc.ref, {
                        loyaltyPoints: newPoints
                    });
                    
                    // Send bonus notification email via Firestore mail collection
                    await window.addDoc(window.collection(window.db, "mail"), {
                        to: referrerEmail,
                        message: {
                            subject: "🎉 Referral Bonus Earned!",
                            html: `
                                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                        <h1 style="margin: 0; font-size: 28px;">🎉 Referral Bonus Earned!</h1>
                                    </div>
                                    
                                    <div style="padding: 30px; background: white;">
                                        <p style="font-size: 16px; color: #333;">Congratulations! You've earned <strong>${points} loyalty points</strong> for your referral!</p>
                                        <p style="font-size: 16px; color: #333;">Your total loyalty points: <strong>${newPoints}</strong></p>        
                                        <p style="font-size: 16px; color: #333;">Keep referring friends to earn more rewards!</p>
                                        
                                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">🎁 Referral Rewards</h4>
                                            <ul style="margin: 0; padding-left: 20px; color: #333;">
                                                <li style="margin-bottom: 5px;">25 points when friend signs up</li>
                                                <li style="margin-bottom: 5px;">50 points when friend makes first order</li>
                                                <li style="margin-bottom: 5px;">Unlimited referrals = unlimited rewards!</li>
                                            </ul>
                                        </div>
                                        
                                        <div style="text-align: center; margin: 30px 0;">
                                            <a href="https://store.princealex.pro" style="display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">🛒 Shop Now</a>
                                        </div>
                                        
                                        <p style="font-size: 16px; color: #333; margin-bottom: 0;"><strong>The Prince Alex Store Team</strong></p>
                                    </div>
                                </div>
                            `
                        },
                        // Add email metadata for tracking
                        emailType: 'referral_bonus',
                        pointsAwarded: points,
                        totalPoints: newPoints,
                        referrerEmail: referrerEmail,
                        createdAt: new Date().toISOString(),
                        status: 'pending'
                    });
                }
            } catch (error) {
                console.error("Error awarding referral bonus:", error);
            }
        }

        // Utility function for time ago
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Enhanced referral functions
        async function copyReferralLink() {
            const referralLinkInput = document.getElementById('referral-link-input');
            
            // Ensure we have the latest referral link
            const referralLink = await generateReferralLink();
            referralLinkInput.value = referralLink;
            
            referralLinkInput.select();
            referralLinkInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showModal('Copied!', 'Referral link copied to clipboard!');
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(referralLink).then(() => {
                    showModal('Copied!', 'Referral link copied to clipboard!');
                }).catch(() => {
                    showModal('Error', 'Could not copy link. Please copy manually.');
                });
            }
        }

        async function shareOnWhatsApp() {
            const referralLink = await generateReferralLink();
            const message = `Hey! I found this amazing online store for fresh vegetables - Prince Alex Store! 🥬🍅🥕\n\nUse my referral link to get 15% off your first order: ${referralLink}\n\nThey deliver fresh, organic vegetables right to your doorstep! Check it out! 😊`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function shareOnFacebook() {
            const referralLink = await generateReferralLink();
            const message = `Check out Prince Alex Store for the freshest vegetables delivered to your door! Use my referral link for 15% off your first order!`;
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}&quote=${encodeURIComponent(message)}`;
            window.open(facebookUrl, '_blank', 'width=600,height=400');
        }

        async function shareOnTwitter() {
            const referralLink = await generateReferralLink();
            const message = `🥬🍅🥕 Check out Prince Alex Store for fresh vegetables delivered to your door! Get 15% off your first order with my referral link: ${referralLink}`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
        }

        // Generate unique referral code for user
        function generateReferralCode() {
            if (!firebaseUser) return null;
            
            // Create a unique code based on user ID and timestamp
            const userId = firebaseUser.uid;
            const timestamp = Date.now().toString(36);
            const randomSuffix = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // Format: PRINCE + first 4 chars of UID + random suffix
            const code = `PRINCE${userId.substring(0, 4).toUpperCase()}${randomSuffix}`;
            return code;
        }

        // Ensure user has a referral code (create if doesn't exist)
        async function ensureUserReferralCode() {
            if (!firebaseUser) return null;
            
            try {
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                const userDocSnap = await window.getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    
                    // If user already has a referral code, return it
                    if (userData.referralCode) {
                        return userData.referralCode;
                    }
                    
                    // Generate new referral code
                    const referralCode = generateReferralCode();
                    
                    // Save the referral code to user's profile
                    await window.updateDoc(userDocRef, {
                        referralCode: referralCode,
                        referralCodeCreatedAt: new Date().toISOString()
                    });
                    
                    return referralCode;
                }
            } catch (error) {
                console.error("Error ensuring referral code:", error);
                return null;
            }
        }

        // Enhanced referral link generation with proper referral codes
        async function generateReferralLink() {
            if (!firebaseUser) return 'princealex.com/refer/YOUR_CODE';
            
            const referralCode = await ensureUserReferralCode();
            if (!referralCode) return 'princealex.com/refer/YOUR_CODE';
            
            return `https://store.princealex.pro?ref=${referralCode}`;
        }

        // Update referral link when user logs in
        async function updateReferralLink() {
            const referralLinkInput = document.getElementById('referral-link-input');
            const referralCodeDisplay = document.getElementById('user-referral-code');
            
            if (referralLinkInput) {
                const referralLink = await generateReferralLink();
                referralLinkInput.value = referralLink;
            }
            
            if (referralCodeDisplay) {
                const referralCode = await ensureUserReferralCode();
                referralCodeDisplay.textContent = referralCode || 'Not available';
            }
        }

        // Enhanced referral validation
        function validateReferralEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return 'Please enter a valid email address.';
            }
            
            // Check if it's the same as user's email
            if (firebaseUser && email === firebaseUser.email) {
                return 'You cannot refer yourself!';
            }
            
            return null; // Valid
        }

        // Handle referral code from URL parameters
        function handleReferralCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const referralCode = urlParams.get('ref');
            
            if (referralCode) {
                // Store referral code in localStorage for later use
                localStorage.setItem('referralCode', referralCode);
                
                // Show notification about referral
                showModal('Welcome! 🎉', `You've been referred by a friend! You'll get 15% off your first order with code FRIEND15.`);
                
                // Track referral visit
                trackReferralVisit(referralCode);
            }
        }

        // Track referral visit
        async function trackReferralVisit(referralCode) {
            try {
                // Find the referrer by their referral code
                const referrerQuery = window.query(
                    window.collection(window.db, "customers"),
                    window.where("referralCode", "==", referralCode)
                );
                const referrerSnapshot = await window.getDocs(referrerQuery);
                
                if (!referrerSnapshot.empty) {
                    const referrerDoc = referrerSnapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    
                    // Create referral visit record
                    await window.addDoc(window.collection(window.db, "referralVisits"), {
                        referralCode: referralCode,
                        referrerEmail: referrerData.email,
                        referrerUid: referrerDoc.id,
                        visitDate: new Date().toISOString(),
                        visitorIP: 'unknown', // Could be enhanced with IP tracking
                        userAgent: navigator.userAgent,
                        status: 'visited'
                    });
                }
            } catch (error) {
                console.error("Error tracking referral visit:", error);
            }
        }

        // Track email delivery status
        async function updateEmailStatus(emailId, status, error = null) {
            try {
                const emailDocRef = window.doc(window.db, "mail", emailId);
                await window.updateDoc(emailDocRef, {
                    status: status,
                    updatedAt: new Date().toISOString(),
                    ...(error && { error: error })
                });
            } catch (error) {
                console.error("Error updating email status:", error);
            }
        }

        // Monitor email delivery status
        function startEmailStatusMonitoring() {
            try {
                if (!firebaseUser) return;
                
                // Listen for email status updates
                const emailQuery = window.query(
                    window.collection(window.db, "mail"),
                    window.where("referrerEmail", "==", firebaseUser.email),
                    window.where("emailType", "in", ["referral_invitation", "referral_confirmation", "referral_bonus"])
                );
                
                window.onSnapshot(emailQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const emailData = change.doc.data();
                            if (emailData.status === 'delivered') {
                                console.log(`Email delivered: ${emailData.message.subject}`);
                            } else if (emailData.status === 'failed') {
                                console.error(`Email failed: ${emailData.message.subject}`, emailData.error);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Error starting email status monitoring:", error);
            }
        }

        // Apply referral code when user registers
        async function applyReferralCodeOnRegistration(userUid) {
            const referralCode = localStorage.getItem('referralCode');
            
            if (referralCode) {
                try {
                    // Find the referrer
                    const referrerQuery = window.query(
                        window.collection(window.db, "customers"),
                        window.where("referralCode", "==", referralCode)
                    );
                    const referrerSnapshot = await window.getDocs(referrerQuery);
                    
                    if (!referrerSnapshot.empty) {
                        const referrerDoc = referrerSnapshot.docs[0];
                        const referrerData = referrerDoc.data();
                        
                        // Create referral record
                        await window.addDoc(window.collection(window.db, "referrals"), {
                            referralCode: referralCode,
                            referrerEmail: referrerData.email,
                            referrerUid: referrerDoc.id,
                            refereeUid: userUid,
                            status: 'registered',
                            date: new Date().toISOString(),
                            rewardEarned: 25,
                            source: 'url_parameter'
                        });
                        
                        // Award referral bonus to referrer
                        await awardReferralBonus(referrerData.email, 25);
                        
                        // Clear the referral code from localStorage
                        localStorage.removeItem('referralCode');
                        
                        showModal('Referral Applied! 🎉', 'You\'ve successfully used your friend\'s referral! You both earned rewards!');
                    }
                } catch (error) {
                    console.error("Error applying referral code:", error);
                }
            }
        }

        // Enhanced referral form submission with better validation
        async function submitReferralFormEnhanced(event) {
            event.preventDefault();
            
            const refereeEmail = document.getElementById('referral-email').value.trim();
            const referralMessage = document.getElementById('referral-message').value.trim();
            
            // Enhanced validation
            if (!firebaseUser) {
                showModal('Login Required', 'Please log in to send referral invitations.');
                return;
            }

            const emailValidation = validateReferralEmail(refereeEmail);
            if (emailValidation) {
                showModal('Invalid Email', emailValidation);
                return;
            }

            // Check if already referred
            try {
                const existingQuery = window.query(
                    window.collection(window.db, "referrals"),
                    window.where("referrerEmail", "==", firebaseUser.email),
                    window.where("refereeEmail", "==", refereeEmail)
                );
                const existingSnapshot = await window.getDocs(existingQuery);
                
                if (!existingSnapshot.empty) {
                    showModal('Already Referred', 'You have already sent a referral invitation to this email address.');
                    return;
                }

                // Show loading state
                const submitButton = event.target.querySelector('.referral-submit-btn');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                submitButton.disabled = true;

                const userProfile = await getUserProfile(firebaseUser.uid);
                const referrerName = userProfile.fullname || firebaseUser.displayName || firebaseUser.email || 'Your Friend';
                const referrerEmail = firebaseUser.email;
                const referralId = `REF_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                // Save referral to Firestore with enhanced tracking
                await window.addDoc(window.collection(window.db, "referrals"), {
                    referralId,
                    referrerEmail,
                    referrerName,
                    refereeEmail,
                    referralMessage,
                    status: 'sent',
                    date: new Date().toISOString(),
                    rewardEarned: 0,
                    refereeJoined: false,
                    refereeFirstOrder: false,
                    referrerUid: firebaseUser.uid,
                    source: 'website_form'
                });

                // Generate unique referral link
                const referralLink = generateReferralLink();

                // Send enhanced email to friend via Firestore mail collection
                const friendEmailDoc = await window.addDoc(window.collection(window.db, "mail"), {
                    to: refereeEmail,
                    message: {
                        subject: "🎉 You've Been Invited to Prince Alex Store!",
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                    <h1 style="margin: 0; font-size: 28px;">🥬 Fresh Vegetables Await!</h1>
                                    <p style="margin: 10px 0 0 0; font-size: 16px;">Your friend has invited you to try Prince Alex Store</p>
                                </div>
                                
                                <div style="padding: 30px; background: white;">
                                    <p style="font-size: 16px; color: #333;">Hello!</p>
                                    <p style="font-size: 16px; color: #333;"><strong>${referrerName}</strong> has invited you to try Prince Alex Store - your one-stop shop for the freshest vegetables delivered right to your doorstep!</p>
                                    
                                    ${referralMessage ? `<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #4CAF50; margin: 20px 0;"><p style="margin: 0; font-style: italic; color: #666;">"${referralMessage}"</p></div>` : ''}
                                    
                                    <div style="background: #FF6B35; color: white; padding: 25px; text-align: center; margin: 25px 0; border-radius: 10px;">
                                        <h3 style="margin: 0 0 15px 0; font-size: 24px;">🎁 Special Friend Discount!</h3>
                                        <p style="margin: 0 0 10px 0; font-size: 16px;">Use this exclusive discount code:</p>
                                        <div style="font-size: 28px; font-weight: 700; background: white; color: #FF6B35; padding: 10px; border-radius: 5px; display: inline-block;">FRIEND15</div>
                                        <p style="margin: 15px 0 0 0; font-size: 16px;">Get 15% off your first order!</p>
                                    </div>
                                    
                                    <div style="text-align: center; margin: 30px 0;">
                                        <a href="${referralLink}" style="display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">🛒 Start Shopping Now</a>
                                    </div>
                                    
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 25px 0;">
                                        <h4 style="color: #4CAF50; margin: 0 0 15px 0;">Why Choose Prince Alex Store?</h4>
                                        <ul style="margin: 0; padding-left: 20px; color: #333;">
                                            <li style="margin-bottom: 8px;">🥬 Fresh vegetables delivered within 30 minutes</li>
                                            <li style="margin-bottom: 8px;">🌱 Farm-to-table quality guaranteed</li>
                                            <li style="margin-bottom: 8px;">💰 Competitive prices and great value</li>
                                            <li style="margin-bottom: 8px;">📱 Easy online ordering</li>
                                            <li style="margin-bottom: 8px;">🚚 Free delivery on orders over KES 500</li>
                                        </ul>
                                    </div>
                                    
                                    <p style="font-size: 16px; color: #333;">Welcome to the Prince Alex Store family!</p>
                                    <p style="font-size: 16px; color: #333; margin-bottom: 0;"><strong>The Prince Alex Store Team</strong> 🥬🍅🥕</p>
                                </div>
                            </div>
                        `
                    },
                    // Add email metadata for tracking
                    emailType: 'referral_invitation',
                    referralId: referralId,
                    referrerEmail: referrerEmail,
                    refereeEmail: refereeEmail,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                });

                // Send confirmation to user via Firestore mail collection
                const confirmationEmailDoc = await window.addDoc(window.collection(window.db, "mail"), {
                    to: referrerEmail,
                    message: {
                        subject: "✅ Referral Invitation Sent Successfully!",
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                    <h1 style="margin: 0; font-size: 28px;">🎉 Referral Sent!</h1>
                                </div>
                                
                                <div style="padding: 30px; background: white;">
                                    <p style="font-size: 16px; color: #333;">Hi ${referrerName},</p>
                                    <p style="font-size: 16px; color: #333;">Your referral invitation has been successfully sent to <strong>${refereeEmail}</strong>!</p>
                                    
                                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">🎁 What happens next?</h4>
                                        <ul style="margin: 0; padding-left: 20px; color: #333;">
                                            <li style="margin-bottom: 5px;">Your friend receives a 15% discount code (FRIEND15)</li>
                                            <li style="margin-bottom: 5px;">You earn 25 points when they sign up</li>
                                            <li style="margin-bottom: 5px;">You earn 50 points when they make their first order</li>
                                        </ul>
                                    </div>
                                    
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">🔗 Your Referral Link</h4>
                                        <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Share this link with more friends:</p>
                                        <div style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 14px; word-break: break-all;">${referralLink}</div>
                                    </div>
                                    
                                    <p style="font-size: 16px; color: #333;">Thank you for helping us grow our community of fresh vegetable lovers!</p>
                                    <p style="font-size: 16px; color: #333; margin-bottom: 0;"><strong>The Prince Alex Store Team</strong></p>
                                </div>
                            </div>
                        `
                    },
                    // Add email metadata for tracking
                    emailType: 'referral_confirmation',
                    referralId: referralId,
                    referrerEmail: referrerEmail,
                    refereeEmail: refereeEmail,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                });

                // Log email creation for tracking
                console.log(`Referral emails created:`, {
                    friendEmailId: friendEmailDoc.id,
                    confirmationEmailId: confirmationEmailDoc.id,
                    refereeEmail: refereeEmail,
                    referrerEmail: referrerEmail
                });
                
                // Show success with enhanced message
                showModal('Invitation Sent! 🎉', `Referral invitation sent to ${refereeEmail}! Your friend will receive a special discount code. You'll earn 25 points when they sign up and 50 points when they make their first order!`);
                
                // Clear the form
                document.getElementById('referral-email').value = '';
                document.getElementById('referral-message').value = '';
                
                // Update referral stats in real-time
                referralStats.totalSent++;
                updateReferralDashboard();
                
            } catch (error) {
                console.error("Error sending referral:", error);
                showModal('Error', 'Failed to send referral invitation. Please try again.');
            } finally {
                // Reset button state
                if (submitButton) {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            }
        }

        // --- User Authentication UI Update & Profile Management (Firestore) ---
        async function getUserProfile(uid) {
            try {
                const userDocRef = window.doc(window.db, "customers", uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() ? userDocSnap.data() : {};
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return {};
            }
        }

        async function updateAuthUI() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                // Update the main navigation link
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="my-account">My Account (${firebaseUser.email})</a></li>`;
                // Update the account page username
                accountUsernameSpan.textContent = userProfile.fullname || firebaseUser.displayName || firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
                profilePhoneSpan.textContent = userProfile.phoneNumber || 'N/A';
                userLoyaltyPoints = userProfile.loyaltyPoints || 0; // Load loyalty points
                loyaltyPointsSpan.textContent = userLoyaltyPoints;
                
                // Load referral stats from customer profile
                await loadReferralStatsFromCustomer();
                
                // Start referral tracking for logged-in users
                startReferralTracking();
                
                // Start email status monitoring
                startEmailStatusMonitoring();
            } else {
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>`;
                accountUsernameSpan.textContent = 'Guest';
                profileEmailSpan.textContent = '';
                profilePhoneSpan.textContent = '';
                loyaltyPointsSpan.textContent = '0'; // Reset loyalty points for guests
            }
            // Re-attach event listener for the new link
            const newAuthLink = authLinkContainer.querySelector('.page-link');
            if (newAuthLink) {
                newAuthLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageData = newAuthLink.dataset.page;
                    if (pageData === 'login') {
                        openLoginModal();
                    } else if (pageData === 'my-account') {
                        showPage('my-account-page');
                    }
                });
            }
        }

        function openLoginModal() {
            closeSignupModal(); // Ensure signup modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            loginModal.style.display = 'flex';
            document.getElementById('login-form-modal').reset();
        }

        function closeLoginModal() {
            loginModal.style.display = 'none';
        }

        function openSignupModal() {
            closeLoginModal(); // Ensure login modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            signupModal.style.display = 'flex';
            document.getElementById('signup-form-modal').reset();
        }

        function closeSignupModal() {
            signupModal.style.display = 'none';
        }

        function openForgotPasswordModal() {
            closeLoginModal();
            forgotPasswordModal.style.display = 'flex';
            document.getElementById('forgot-password-form').reset();
        }

        function closeForgotPasswordModal() {
            forgotPasswordModal.style.display = 'none';
        }

        async function openEditProfileModal() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                document.getElementById('edit-fullname').value = userProfile.fullname || firebaseUser.displayName || '';
                document.getElementById('edit-email').value = firebaseUser.email || '';
                document.getElementById('edit-phone').value = userProfile.phoneNumber || '';
                document.getElementById('edit-password').value = ''; // Password changes are separate in Firebase
                editProfileModal.style.display = 'flex';
            } else {
                showModal('Error', 'You must be logged in to edit your profile.');
            }
        }

        function closeEditProfileModal() {
            editProfileModal.style.display = 'none';
        }

        async function saveProfileDetails(event) {
            event.preventDefault();
            if (!firebaseUser) {
                showModal('Error', 'No user logged in.');
                return;
            }

            const newDisplayName = document.getElementById('edit-fullname').value;
            const newPhoneNumber = document.getElementById('edit-phone').value;
            const newPassword = document.getElementById('edit-password').value; // For password change

            const phoneRegex = /^07[0-9]{8}$/;
            if (newPhoneNumber && !phoneRegex.test(newPhoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            try {
                const updatePromises = [];
                // Update Firebase Auth profile
                if (newDisplayName !== (firebaseUser.displayName || '')) {
                    updatePromises.push(window.updateProfile(firebaseUser, { displayName: newDisplayName }));
                }
                if (newPassword) {
                    updatePromises.push(window.updatePassword(firebaseUser, newPassword));
                }

                // Update Firestore customer profile document
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                await window.setDoc(userDocRef, {
                    fullname: newDisplayName,
                    phoneNumber: newPhoneNumber,
                    email: firebaseUser.email // Keep email in Firestore for consistency
                }, { merge: true }); // Use merge to only update specified fields

                await Promise.all(updatePromises);
                showModal('Profile Updated', 'Your profile details have been saved.');
                closeEditProfileModal();
                // onAuthStateChanged will re-trigger and update UI
            } catch (error) {
                showModal('Update Failed', 'Failed to update profile: ' + error.message);
                console.error("Profile update error:", error);
            }
        }

        async function updateAccountPage() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                accountUsernameSpan.textContent = userProfile.fullname || firebaseUser.displayName || firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
                profilePhoneSpan.textContent = userProfile.phoneNumber || 'N/A';
                loyaltyPointsSpan.textContent = userProfile.loyaltyPoints || 0;
                
                // Refresh user orders to show the most up-to-date data
                console.log("🔄 Refreshing user orders on account page update...");
                renderUserOrders();
            } else {
                showModal('Access Denied', 'Please log in to view your account details.');
                showPage('home-page');
            }
        }

        // Global function to refresh user orders
        window.refreshUserOrders = async function() {
            console.log("🔄 Refreshing user orders globally...");
            if (firebaseUser) {
                await renderUserOrders();
            } else {
                console.log("⚠️ Cannot refresh orders - user not logged in");
            }
        };

        // Render user's past orders on My Account page (Firestore)
        async function renderUserOrders() {
            const userOrdersListDiv = document.getElementById('user-orders-list');
            userOrdersListDiv.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading your orders...</div>';
            
            if (!firebaseUser) {
                userOrdersListDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-lock"></i>
                        <h4>Login Required</h4>
                        <p>Please log in to view your past orders.</p>
                        <button onclick="openLoginModal()" class="cta-button">Login Now</button>
                    </div>
                `;
                return;
            }

            try {
                console.log("Loading orders for user:", firebaseUser.uid, "email:", firebaseUser.email);
                
                const ordersCol = window.collection(window.db, "orders");
                let userOrders = [];
                
                try {
                    // Try the optimized query first
                    const userOrdersQuery = window.query(ordersCol, window.where("userId", "==", firebaseUser.uid), window.orderBy("date", "desc"));
                    const userOrdersSnapshot = await window.getDocs(userOrdersQuery);
                    
                    console.log("Direct query orders found:", userOrdersSnapshot.size);
                    
                    userOrdersSnapshot.forEach(doc => {
                        userOrders.push({ id: doc.id, ...doc.data() });
                    });
                    
                } catch (queryError) {
                    console.log("Direct query failed, trying fallback method:", queryError.message);
                    
                    // Fallback: Get all orders and filter client-side
                    const allOrdersQuery = window.query(ordersCol, window.orderBy("date", "desc"));
                    const allOrdersSnapshot = await window.getDocs(allOrdersQuery);
                    
                    console.log("Total orders found:", allOrdersSnapshot.size);
                    
                    // Filter orders by userId or userEmail
                    allOrdersSnapshot.forEach(doc => {
                        const orderData = doc.data();
                        console.log("Checking order:", doc.id, "userId:", orderData.userId, "userEmail:", orderData.userEmail);
                        
                        // Check both userId and userEmail for compatibility
                        if (orderData.userId === firebaseUser.uid || orderData.userEmail === firebaseUser.email) {
                            userOrders.push({ id: doc.id, ...orderData });
                        }
                    });
                }
                
                console.log("Final user orders found:", userOrders.length);

                if (userOrders.length === 0) {
                    userOrdersListDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-bag"></i>
                            <h4>No Orders Yet</h4>
                            <p>You haven't placed any orders yet. Start shopping to see your order history here!</p>
                            <button onclick="showPage('shop-page')" class="cta-button">Start Shopping</button>
                        </div>
                    `;
                    return;
                }

                userOrdersListDiv.innerHTML = ''; // Clear loading message
                userOrders.forEach(order => {
                    const listItem = document.createElement('div');
                    listItem.className = 'order-item';
                    
                    const itemsSummary = order.items ? order.items.map(item => `${item.name} (x${item.quantity})`).join(', ') : 'No items';
                    const statusClass = order.status === 'Delivered' ? 'status-delivered' : 
                                     order.status === 'Pending' ? 'status-pending' : 'status-processing';
                    
                    listItem.innerHTML = `
                        <div class="order-header">
                            <div class="order-id">
                                <strong>Order #${order.id}</strong>
                                <span class="order-date">${new Date(order.date).toLocaleDateString()}</span>
                            </div>
                            <div class="order-status">
                                <span class="status-badge ${statusClass}">${order.status || 'Unknown'}</span>
                            </div>
                        </div>
                        <div class="order-details">
                            <div class="order-items">
                                <strong>Items:</strong> ${itemsSummary}
                            </div>
                            <div class="order-summary">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>KES ${(order.subtotal || 0).toFixed(2)}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Delivery Fee:</span>
                                    <span>KES ${(order.transportationFee || 0).toFixed(2)}</span>
                                </div>
                                <div class="summary-row total-row">
                                    <span><strong>Total:</strong></span>
                                    <span><strong>KES ${(order.total || 0).toFixed(2)}</strong></span>
                                </div>
                            </div>
                            <div class="order-meta">
                                <span class="payment-method"><i class="fas fa-credit-card"></i> ${order.paymentMethod || 'Unknown'}</span>
                                <span class="order-time"><i class="fas fa-clock"></i> ${new Date(order.date).toLocaleTimeString()}</span>
                            </div>
                        </div>
                    `;
                    userOrdersListDiv.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error fetching user orders:", error);
                console.error("Error details:", {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                userOrdersListDiv.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Error Loading Orders</h4>
                        <p>There was an error loading your orders. Please try again later.</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">Error: ${error.message}</p>
                        <button onclick="renderUserOrders()" class="cta-button">Retry</button>
                    </div>
                `;
            }
        }

        // --- Loyalty Points (Firestore) ---
        async function getLoyaltyPoints(uid) {
            try {
                const userDocRef = window.doc(window.db, "customers", uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() && userDocSnap.data().loyaltyPoints ? userDocSnap.data().loyaltyPoints : 0;
            } catch (error) {
                console.error("Error getting loyalty points:", error);
                return 0;
            }
        }

        async function saveLoyaltyPoints(uid, points) {
            try {
                const userDocRef = window.doc(window.db, "customers", uid);
                await window.setDoc(userDocRef, { loyaltyPoints: points }, { merge: true });
                loyaltyPointsSpan.textContent = points; // Update UI
            } catch (error) {
                console.error("Error saving loyalty points:", error);
            }
        }


        // --- Favorite Products (Firestore) ---
        async function getFavorites() {
            if (!firebaseUser) return []; // No favorites for guests
            try {
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() && userDocSnap.data().favorites ? userDocSnap.data().favorites : [];
            } catch (error) {
                console.error("Error getting favorites:", error);
                return [];
            }
        }

        async function saveFavorites(favorites) {
            if (!firebaseUser) return; // Cannot save favorites for guests to Firestore
            try {
                const userDocRef = window.doc(window.db, "customers", firebaseUser.uid);
                await window.setDoc(userDocRef, { favorites: favorites }, { merge: true });
            } catch (error) {
                console.error("Error saving favorites:", error);
            }
        }

        async function toggleFavorite(productId, iconElement) {
            if (!firebaseUser) {
                showModal('Login Required', 'Please log in to manage your favorite products.');
                openLoginModal();
                return;
            }
            let favorites = await getFavorites();
            if (favorites.includes(productId)) {
                favorites = favorites.filter(id => id !== productId);
                iconElement.classList.remove('fas');
                iconElement.classList.add('far');
            } else {
                favorites.push(productId);
                iconElement.classList.remove('far');
                iconElement.classList.add('fas');
            }
            await saveFavorites(favorites);
        }

        // --- Image Carousel Logic ---
        const heroImages = document.querySelectorAll('.hero-background-image');
        let currentImageIndex = 0;

        function changeHeroImage() {
            heroImages.forEach((img, index) => {
                if (index === currentImageIndex) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            currentImageIndex = (currentImageIndex + 1) % heroImages.length;
        }

        // --- Testimonial Carousel Logic ---
        const testimonialsData = [
            {
                name: "Mercy Wanjiku",
                photo: "https://placehold.co/100x100/A0D9B1/333333?text=MW",
                quote: "Prince Alex Store has transformed my cooking! The vegetables are incredibly fresh, and the delivery is always on time. Highly recommend for anyone in Vihiga!"
            },
            {
                name: "John Kamau",
                photo: "https://placehold.co/100x100/98C1D9/333333?text=JK",
                quote: "I've tried many online stores, but Prince Alex's produce stands out. It truly feels farm-fresh, and the convenience is unmatched. Their organic options are fantastic."
            },
            {
                name: "Amina Hassan",
                photo: "https://placehold.co/100x100/FFD1AA/333333?text=AH",
                quote: "Finally, a reliable source for healthy veggies! The quality is consistently excellent, and their customer service is top-notch. My family loves the variety."
            }
        ];
        let currentTestimonialIndex = 0;
        let testimonialInterval;

        function renderTestimonials() {
            testimonialCarousel.innerHTML = '';
            testimonialIndicatorsContainer.innerHTML = '';

            testimonialsData.forEach((testimonial, index) => {
                const card = document.createElement('div');
                card.className = 'testimonial-card';
                card.setAttribute('data-index', index);
                card.innerHTML = `
                    <img src="${testimonial.photo}" alt="${testimonial.name}">
                    <p>"${testimonial.quote}"</p>
                    <strong>- ${testimonial.name}</strong>
                `;
                testimonialCarousel.appendChild(card);

                const indicator = document.createElement('div');
                indicator.className = 'testimonial-indicator';
                indicator.setAttribute('data-index', index);
                indicator.addEventListener('click', () => showTestimonial(index));
                testimonialIndicatorsContainer.appendChild(indicator);
            });
            showTestimonial(0); // Show the first testimonial
        }

        function showTestimonial(index) {
            const cards = testimonialCarousel.querySelectorAll('.testimonial-card');
            const indicators = testimonialIndicatorsContainer.querySelectorAll('.testimonial-indicator');

            cards.forEach((card, i) => {
                card.classList.remove('active');
                card.style.display = 'none'; // Hide all initially
            });
            indicators.forEach(indicator => indicator.classList.remove('active'));

            cards[index].classList.add('active');
            cards[index].style.display = 'flex'; // Show only the active one
            indicators[index].classList.add('active');
            currentTestimonialIndex = index;
            resetTestimonialInterval();
        }

        function nextTestimonial() {
            let nextIndex = (currentTestimonialIndex + 1) % testimonialsData.length;
            showTestimonial(nextIndex);
        }

        function prevTestimonial() {
            let prevIndex = (currentTestimonialIndex - 1 + testimonialsData.length) % testimonialsData.length;
            showTestimonial(prevIndex);
        }

        testimonialNextBtn.addEventListener('click', nextTestimonial);
        testimonialPrevBtn.addEventListener('click', prevTestimonial);

        function startTestimonialCarousel() {
            testimonialInterval = setInterval(nextTestimonial, 7000); // Change every 7 seconds
        }

        function resetTestimonialInterval() {
            clearInterval(testimonialInterval);
            startTestimonialCarousel();
        }

        // --- Contact Form (Firestore + Email) ---
        async function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            
            // Basic validation
            if (name && email && message) {
                try {
                    // Save to Firestore
                    await window.addDoc(window.collection(window.db, "contactSubmissions"), { 
                        name, 
                        email, 
                        message, 
                        date: new Date().toISOString() 
                    });

                    // ✅ Add document to mail collection to trigger Firestore Email extension
                    await addDoc(collection(db, "mail"), {
                        to: "info@princealex.pro",
                        message: {
                            subject: "New Contact Form Submission - Prince Alex Store",
                            html: `
                                <h2>New Contact Form Submission</h2>
                                <p><strong>Name:</strong> ${name}</p>
                                <p><strong>Email:</strong> ${email}</p>
                                <p><strong>Message:</strong></p>
                                <p>${message}</p>
                                <p><strong>Submitted:</strong> ${new Date().toLocaleString()}</p>
                            `
                        }
                    });
                    
                    showModal('Message Sent!', `Thank you, ${name}! Your message has been sent and we've been notified. We will get back to you shortly.`);
                    
                    document.querySelector('.contact-form').reset();
                } catch (error) {
                    console.error("Error submitting contact form:", error);
                    showModal('Error', 'Failed to send message. Please try again.');
                }
            } else {
                showModal('Error', 'Please fill out all fields.');
            }
        }

        // --- Newsletter Subscription (Firestore + Email) ---
        async function subscribeToNewsletter(event) {
            event.preventDefault();
            const email = document.getElementById('newsletter-email').value;
            if (email) {
                try {
                    // Check if email already exists
                    const q = window.query(window.collection(window.db, "newsletterSubscriptions"), window.where("email", "==", email));
                    const querySnapshot = await window.getDocs(q);
                    if (!querySnapshot.empty) {
                        showModal('Already Subscribed', 'This email is already subscribed to our newsletter.');
                        return;
                    }

                    // Save to Firestore
                    await window.addDoc(window.collection(window.db, "newsletterSubscriptions"), { 
                        email, 
                        subscribedAt: new Date().toISOString() 
                    });

                    // ✅ Add document to mail collection to trigger Firestore Email extension
                    await addDoc(collection(db, "mail"), {
                        to: email,
                        message: {
                            subject: "🎉 Welcome to Our Newsletter - Exclusive Benefits Await!",
                            html: `
                                <h2>Welcome to Our Newsletter! 🎊</h2>
                                <p>Dear Newsletter Subscriber,</p>
                                <p>Congratulations! You've successfully joined our exclusive newsletter community.</p>
                                <p>As a welcome gift, use this exclusive discount code for your next order:</p>
                                <div style="background: #FF6B35; color: white; padding: 20px; text-align: center; margin: 20px 0;">
                                    <h3>🎁 Welcome Gift!</h3>
                                    <div style="font-size: 32px; font-weight: 700;">WELCOME10</div>
                                    <p>Get 10% off your first order!</p>
                                </div>
                                <div style="text-align: center; margin: 30px 0;">
                                    <a href="https://store.princealex.pro" style="display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">🛒 Start Shopping Now</a>
                                </div>
                                <p>Thank you for choosing Prince Alex Store!</p>
                            `
                        }
                    });
                    
                    showModal('Subscribed!', `Thank you for subscribing! Check your email for your welcome message and 10% discount code.`);
                    
                    document.querySelector('.newsletter-form').reset();
                } catch (error) {
                    console.error("Error subscribing to newsletter:", error);
                    showModal('Error', 'Failed to subscribe. Please try again.');
                }
            } else {
                showModal('Error', 'Please enter a valid email address.');
            }
        }

        // --- Flash Sale Countdown Timer ---
        function updateCountdown() {
            const now = new Date().getTime();
            // Set your target end date/time for the flash sale (e.g., 2 days from now)
            const endDate = new Date(now + (2 * 24 * 60 * 60 * 1000) + (10 * 60 * 1000)).getTime(); // 2 days and 10 mins from now
            
            const distance = endDate - now;

            if (distance < 0) {
                flashSaleCountdownDiv.innerHTML = "SALE ENDED!";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownDaysSpan.textContent = String(days).padStart(2, '0');
            countdownHoursSpan.textContent = String(hours).padStart(2, '0');
            countdownMinutesSpan.textContent = String(minutes).padStart(2, '0');
            countdownSecondsSpan.textContent = String(seconds).padStart(2, '0');
        }

        // --- Recommended Products ---
        function renderRecommendedProducts(currentProductId) {
            recommendedProductsList.innerHTML = '';
            
            // Filter out the current product from the list of all products
            const otherProducts = allProducts.filter(p => p.id !== currentProductId);

            // Shuffle the remaining products and pick a few (e.g., 3)
            const shuffled = [...otherProducts].sort(() => 0.5 - Math.random());
            const selectedRecommendations = shuffled.slice(0, 3);

            if (selectedRecommendations.length === 0) {
                recommendedProductsList.innerHTML = '<p style="text-align: center; width: 100%;">No recommendations available.</p>';
                return;
            }

            selectedRecommendations.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                // Remove AOS animation from these small cards to avoid clutter
                // productCard.setAttribute('data-aos', 'zoom-in');
                // productCard.setAttribute('data-aos-delay', '50');

                const isFavorite = getFavorites().includes(product.id);
                const favoriteIconClass = isFavorite ? 'fas' : 'far';
                const stockStatusClass = product.stock > 0 ? 'in-stock' : 'sold-out';
                const stockText = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';
                const addToCartDisabled = product.stock <= 0 ? 'disabled' : '';
                const addToCartText = product.stock <= 0 ? 'Add to Cart' : 'Add to Cart';

                let badgeHtml = '';
                if (product.badge) {
                    const badgeClass = product.badge.toLowerCase().replace(/\s/g, '');
                    badgeHtml = `<span class="product-badge ${badgeClass}">${product.badge}</span>`;
                }

                let priceHtml = `<p class="price">KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                if (product.originalPrice && product.originalPrice > product.price) {
                    priceHtml = `<p class="price"><del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                }

                productCard.innerHTML = `
                    ${badgeHtml}
                    <div class="hover-icons">
                        <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                        <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                        <i class="fas fa-cart-plus" onclick="addToCart('${product.id}')"></i>
                    </div>
                    <div class="product-image-container">
                        <img src="${product.image || `https://placehold.co/300x180/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`}" 
                             alt="${product.name}" 
                             loading="lazy"
                             onload="this.style.opacity='1'"
                             onerror="this.onerror=null;this.src='https://placehold.co/300x180/cccccc/333333?text=No+Image';this.style.opacity='1'"
                             style="opacity: 0; transition: opacity 0.3s ease;">
                        <div class="image-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; font-size: 14px;">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                    <h3>${product.name}</h3>
                    <div class="product-rating">${generateStarRating(product.rating)}</div>
                    ${priceHtml}
                    <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                    <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                `;
                recommendedProductsList.appendChild(productCard);
            });
            AOS.refresh();
        }

        // --- Google Maps Autocomplete Initialization ---
        // This function will be called by the Google Maps API script once it's loaded
        function initAutocomplete() {
            const deliveryLocationInput = document.getElementById('customer-delivery-location');
            if (deliveryLocationInput) {
                // Bias the search results towards Kenya (Nairobi coordinates for a general Kenya bias)
                const defaultBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(-4.8, 33.9), // Southwest corner of Kenya
                    new google.maps.LatLng(4.6, 41.9)  // Northeast corner of Kenya
                );

                const autocomplete = new google.maps.places.Autocomplete(deliveryLocationInput, {
                    bounds: defaultBounds,
                    componentRestrictions: { country: 'ke' }, // Restrict to Kenya
                    types: ['geocode', 'establishment'] // Suggest addresses and businesses
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        // User entered the name of a Place that was not suggested and pressed the Enter key.
                        console.log("No details available for input: '" + place.name + "'");
                        return;
                    }
                    // Set the input field's value to the selected place's formatted address
                    deliveryLocationInput.value = place.formatted_address;
                });
            }
        }

        // Debug function to test Firestore connection
        window.testFirestoreConnection = async function() {
            try {
                console.log("Testing Firestore connection...");
                console.log("Current user:", firebaseUser ? firebaseUser.email : "No user");
                console.log("Database:", window.db);
                
                if (!firebaseUser) {
                    console.log("No user logged in");
                    return;
                }
                
                // Test basic collection access
                const ordersCol = window.collection(window.db, "orders");
                const testQuery = window.query(ordersCol, window.limit(5));
                const testSnapshot = await window.getDocs(testQuery);
                
                console.log("Firestore connection successful!");
                console.log("Orders collection accessible, found", testSnapshot.size, "orders");
                
                // Test user-specific query
                const userQuery = window.query(ordersCol, window.where("userId", "==", firebaseUser.uid));
                const userSnapshot = await window.getDocs(userQuery);
                console.log("User-specific query found", userSnapshot.size, "orders");
                
                return true;
            } catch (error) {
                console.error("Firestore connection test failed:", error);
                return false;
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            applyDarkModePreference();
            
            // Handle referral codes from URL
            handleReferralCodeFromURL();
            
            // Dummy product data (will be overridden by Firestore if available)
            allProducts = [
                {
                    id: 'veg001',
                    name: 'Organic Spinach',
                    description: 'Freshly harvested organic spinach, rich in iron and vitamins. Perfect for smoothies or sautéing.',
                    image: 'https://images.unsplash.com/photo-1579613832147-380d19f6a72e?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 150.00,
                    originalPrice: 180.00,
                    unit: 'per bunch',
                    category: 'Leafy Greens',
                    stock: 50,
                    rating: 4.8,
                    badge: 'Organic',
                    tags: ['healthy', 'green', 'iron-rich']
                },
                {
                    id: 'veg002',
                    name: 'Sweet Carrots',
                    description: 'Crunchy and naturally sweet carrots, excellent for juicing, salads, or cooking.',
                    image: 'https://images.unsplash.com/photo-1590005517865-c34b8c9d81d2?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 120.00,
                    unit: 'per kg',
                    category: 'Roots',
                    stock: 75,
                    rating: 4.5,
                    badge: 'Bestseller',
                    tags: ['vitamins', 'snack', 'juicing']
                },
                {
                    id: 'veg003',
                    name: 'Ripe Tomatoes',
                    description: 'Juicy and flavorful red tomatoes, ideal for sauces, salads, or just snacking.',
                    image: 'https://images.unsplash.com/photo-1607371531038-f9b282470f1a?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 90.00,
                    unit: 'per kg',
                    category: 'Fruits',
                    stock: 120,
                    rating: 4.7,
                    badge: 'New',
                    tags: ['versatile', 'sauce', 'salad']
                },
                {
                    id: 'veg004',
                    name: 'Broccoli Florets',
                    description: 'Nutrient-packed broccoli florets, great for steaming, roasting, or stir-fries.',
                    image: 'https://images.unsplash.com/photo-1587393798418-f6280b18f6f5?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 200.00,
                    originalPrice: 240.00,
                    unit: 'per head',
                    category: 'Cruciferous',
                    stock: 40,
                    rating: 4.6,
                    badge: 'Discount',
                    tags: ['superfood', 'antioxidant', 'stir-fry']
                },
                {
                    id: 'veg005',
                    name: 'Fresh Coriander',
                    description: 'Aromatic and fresh coriander, perfect for garnishing or adding flavor to various dishes.',
                    image: 'https://images.unsplash.com/photo-1595150827289-58b98b9a117f?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 50.00,
                    unit: 'per bunch',
                    category: 'Herbs',
                    stock: 60,
                    rating: 4.9,
                    badge: 'Organic',
                    tags: ['flavor', 'garnish', 'aromatic']
                },
                {
                    id: 'veg006',
                    name: 'Red Onions',
                    description: 'Sweet and pungent red onions, adding a vibrant touch to salads and cooked meals.',
                    image: 'https://images.unsplash.com/photo-1627348574136-189f7831d45c?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 80.00,
                    unit: 'per kg',
                    category: 'Roots',
                    stock: 90,
                    rating: 4.3,
                    badge: '',
                    tags: ['aromatic', 'cooking', 'salad']
                },
                {
                    id: 'veg007',
                    name: 'Green Capsicum',
                    description: 'Crisp and sweet green capsicum, versatile for stir-fries, fajitas, or raw in salads.',
                    image: 'https://images.unsplash.com/photo-1588698944123-dc19d880486c?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 130.00,
                    unit: 'per kg',
                    category: 'Fruits',
                    stock: 55,
                    rating: 4.4,
                    badge: '',
                    tags: ['stir-fry', 'crisp', 'sweet']
                },
                {
                    id: 'veg008',
                    name: 'Fresh Ginger',
                    description: 'Zesty and fragrant ginger root, essential for culinary and medicinal uses.',
                    image: 'https://images.unsplash.com/photo-1621251994801-447094d4d142?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 180.00,
                    originalPrice: 200.00,
                    unit: 'per kg',
                    category: 'Roots',
                    stock: 35,
                    rating: 4.7,
                    badge: 'Discount',
                    tags: ['spice', 'medicinal', 'fragrant']
                },
                {
                    id: 'veg009',
                    name: 'Cucumber',
                    description: 'Cool and refreshing cucumbers, perfect for salads, snacks, or detox water.',
                    image: 'https://images.unsplash.com/photo-1621877478051-4d1a520f9226?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 70.00,
                    unit: 'per piece',
                    category: 'Fruits',
                    stock: 100,
                    rating: 4.6,
                    badge: 'Bestseller',
                    tags: ['refreshing', 'salad', 'hydration']
                },
                {
                    id: 'veg010',
                    name: 'Potatoes (Red)',
                    description: 'Versatile red potatoes, firm texture ideal for roasting, mashing, or boiling.',
                    image: 'https://images.unsplash.com/photo-1587393798418-f6280b18f6f5?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
                    price: 100.00,
                    unit: 'per kg',
                    category: 'Roots',
                    stock: 150,
                    rating: 4.2,
                    badge: '',
                    tags: ['staple', 'versatile', 'comfort-food']
                }
            ];


            // Check if there's a last order to display on confirmation page on load
            if (getFromLocalStorage('lastOrder', null)) {
                displayLastOrderConfirmation();
            }

            // Start hero image carousel
            changeHeroImage(); // Show first image immediately
            setInterval(changeHeroImage, 5000); // Change image every 5 seconds

            // Render and start testimonial carousel
            renderTestimonials();
            startTestimonialCarousel();

            // Start flash sale countdown
            updateCountdown();
            setInterval(updateCountdown, 1000);

            // Attach form submission listeners for modals
            document.getElementById('login-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email-modal').value;
                const password = document.getElementById('login-password-modal').value;

                // Basic validation
                if (!email || !password) {
                    showModal('Error', 'Please enter both email and password.');
                    return;
                }

                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
                submitButton.disabled = true;

                try {
                    await window.loginUser(email, password); // Call global Firebase login
                } catch (error) {
                    console.error('Login error:', error);
                } finally {
                    // Reset button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });

            document.getElementById('signup-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullname = document.getElementById('signup-fullname-modal').value;
                const email = document.getElementById('signup-email-modal').value;
                const phoneNumber = document.getElementById('signup-phone-modal').value;
                const password = document.getElementById('signup-password-modal').value;

                // Basic validation
                if (!fullname || !email || !phoneNumber || !password) {
                    showModal('Error', 'Please fill in all required fields.');
                    return;
                }

                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                submitButton.disabled = true;

                try {
                    await window.registerUser(email, password, fullname, phoneNumber); // Call global Firebase register
                } catch (error) {
                    console.error('Registration error:', error);
                } finally {
                    // Reset button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });
            
            document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                // Basic validation
                if (!email) {
                    showModal('Error', 'Please enter your email address.');
                    return;
                }

                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Reset Email...';
                submitButton.disabled = true;

                try {
                    await window.resetPassword(email);
                } catch (error) {
                    console.error('Password reset error:', error);
                } finally {
                    // Reset button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });

            document.getElementById('edit-profile-form').addEventListener('submit', saveProfileDetails);
            document.getElementById('checkout-form').addEventListener('submit', collectCustomerDetails);

            // Show newsletter popup after 5 seconds if not already shown/subscribed
            const hasSubscribedToNewsletter = getFromLocalStorage('newsletterSubscribed', false);
            if (!hasSubscribedToNewsletter) {
                setTimeout(() => {
                    openNewsletterPopup();
                }, 5000); // Show after 5 seconds
            }

            // Set a flag to remember if the newsletter popup has been shown
            newsletterPopup.addEventListener('click', (event) => {
                if (event.target === newsletterPopup || event.target.classList.contains('close-button')) {
                    saveToLocalStorage('newsletterSubscribed', true); // Treat closing as opting out for this session
                }
            });

            // Initial rendering of products with dummy data
            renderProducts();

        });
    </script>
    <!-- Google Maps API Script -->
    <!-- IMPORTANT: Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API Key -->
    <!-- You can get one from the Google Cloud Console: https://console.cloud.google.com/apis/credentials -->
    <!-- Note: API key removed for security - configure with your own key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initAutocomplete"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, addDoc, updateDoc, deleteDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, updatePassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  // Import getStorage and ref for storage functionality (though not directly used for upload in this code)
  // import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

  // Global variables provided by Canvas environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      // Default config for local testing if __firebase_config is not available
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  // const storage = getStorage(app); // Initialize storage if image uploads were implemented

  // Expose Firebase functions globally for use in inline scripts and event listeners
  window.auth = auth; // Make auth object accessible
  window.db = db;     // Make db object accessible
  window.doc = doc;
  window.setDoc = setDoc;
  window.addDoc = addDoc;
  window.updateDoc = updateDoc;
  window.deleteDoc = deleteDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
  window.where = where;
  window.getDoc = getDoc;
  window.updateProfile = updateProfile; // Expose updateProfile
  window.updatePassword = updatePassword; // Expose updatePassword


  // ✅ Simple Secure Email Configuration
  // Note: API key should be stored securely on the server side, not in client-side code
  const BREVO_API_KEY = ""; // API key removed for security - configure on server side
  const senderInfo = { name: "Prince Alex Store - Fresh Vegetables", email: "noreply@princealex.pro" };

  // ✅ Simple email sending function
  async function sendEmail(emailData) {
      try {
          // Check if API key is configured
          if (!BREVO_API_KEY || BREVO_API_KEY.trim() === "") {
              console.warn("⚠️ Email API key not configured. Email functionality disabled for security.");
              console.log("📧 Email would have been sent to:", emailData.to[0].email);
              console.log("📧 Subject:", emailData.subject);
              return false; // Return false to indicate email was not sent
          }

          const response = await fetch("https://api.brevo.com/v3/smtp/email", {
              method: "POST",
              headers: {
                  "accept": "application/json",
                  "api-key": BREVO_API_KEY,
                  "content-type": "application/json"
              },
              body: JSON.stringify(emailData)
          });

          if (response.ok) {
              console.log("✅ Email sent successfully to " + emailData.to[0].email);
              return true;
          } else {
              console.error("❌ Failed to send email", await response.text());
              return false;
          }
      } catch (error) {
          console.error("❌ Error sending email:", error);
          return false;
      }
  }

  // ✅ Function to send welcome email via secure proxy
  async function sendWelcomeEmail(userData) {
      return await sendEmail('welcome', userData);
  }

  // ✅ Function to send contact form email via secure proxy
  async function sendContactFormEmail(contactData) {
      return await sendEmail('contact', contactData);
  }

  // ✅ Function to send newsletter subscription email via secure proxy
  async function sendNewsletterSubscriptionEmail(email) {
      return await sendEmail('newsletter', { email: email });
  }

  // ✅ Function to send order confirmation email via secure proxy
  async function sendOrderConfirmationEmail(orderData) {
      try {
          // ✅ Add document to mail collection to trigger Firestore Email extension
          await addDoc(collection(db, "mail"), {
              to: orderData.customerEmail,
              message: {
                  subject: "Your Order Confirmation 🛒",
                  html: `
                      <h2>Order Confirmed! 🎉</h2>
                      <p>Dear <strong>${orderData.customerName}</strong>,</p>
                      <p>Thank you for your order! We've received your request and our team is already preparing your fresh vegetables for delivery.</p>
                      
                      <div style="background: #2196F3; color: white; padding: 20px; text-align: center; margin: 20px 0;">
                          <h3>✅ Order Processing</h3>
                          <p>Your fresh vegetables are being carefully selected and prepared</p>
                          <p><strong>Order ID: ${orderData.orderId}</strong></p>
                      </div>
                      
                      <h3>📋 Order Details</h3>
                      <p><strong>Order ID:</strong> ${orderData.orderId}</p>
                      <p><strong>Order Date:</strong> ${new Date().toLocaleDateString()}</p>
                      <p><strong>Total Amount:</strong> KES ${orderData.total}</p>
                      
                      <h3>🛒 Items Ordered</h3>
                      <ul>
                          ${orderData.items.map(item => `<li>${item.name} (x${item.quantity}) - KES ${item.price}</li>`).join('')}
                      </ul>
                      
                      <h3>📍 Delivery Details</h3>
                      <p><strong>Delivery Address:</strong> ${orderData.deliveryAddress}</p>
                      <p><strong>Estimated Delivery:</strong> ${orderData.estimatedDelivery}</p>
                      
                      <h3>💰 Payment Summary</h3>
                      <p><strong>Subtotal:</strong> KES ${orderData.subtotal}</p>
                      <p><strong>Delivery Fee:</strong> KES ${orderData.deliveryFee}</p>
                      <p><strong>Total:</strong> KES ${orderData.total}</p>
                      
                      <div style="text-align: center; margin: 30px 0;">
                          <a href="https://store.princealex.pro" style="display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">🛒 Continue Shopping</a>
                      </div>
                      <p>Thank you for choosing Prince Alex Store. We can't wait to serve you with the freshest vegetables in Kenya!</p>
                      <p><strong>The Prince Alex Store Team</strong> 🥬🍅🥕</p>
                  `
              }
          });
          return true;
      } catch (error) {
          console.error("Error sending order confirmation email:", error);
          return false;
      }
  }

  // Firebase Authentication Functions exposed globally
  window.registerUser = async function (email, password, fullname, phoneNumber) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      // Update Firebase Auth profile
      await updateProfile(userCredential.user, {
        displayName: fullname
      });

      // Generate referral code for new user
      const referralCode = generateReferralCode();

      // Save additional user details to Firestore 'customers' collection
      await setDoc(doc(db, "customers", userCredential.user.uid), {
        email: email,
        fullname: fullname,
        phoneNumber: phoneNumber,
        createdAt: new Date().toISOString(),
        loyaltyPoints: 0, // Initialize loyalty points
        favorites: [], // Initialize favorites
        referralCode: referralCode, // Assign unique referral code
        referralCodeCreatedAt: new Date().toISOString(),
        referralStats: {
          totalSent: 0,
          totalAccepted: 0,
          totalRewards: 0
        }
      });

      // Apply referral code if user came from a referral link
      await applyReferralCodeOnRegistration(userCredential.user.uid);

      // ✅ Trigger welcome email after successful registration
      const emailSent = await sendWelcomeEmail({ 
        email: email, 
        fullname: fullname 
      });

      if (emailSent) {
        showModal('Registration Successful!', `Welcome, ${fullname || email}! Your account has been created and a welcome email has been sent to your inbox.`);
      } else {
        showModal('Registration Successful!', `Welcome, ${fullname || email}! Your account has been created successfully.`);
      }
      
      closeSignupModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      let errorMessage = 'Registration failed. Please try again.';
      if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'The email address is already in use by another account.';
      } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'The email address is not valid.';
      } else if (error.code === 'auth/weak-password') {
          errorMessage = 'The password is too weak. Please choose a stronger password.';
      }
      showModal('Registration Failed', 'Error: ' + errorMessage);
      console.error("Registration error:", error);
    }
  };

  window.loginUser = async function (email, password) {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      showModal('Login Successful!', `Welcome back, ${auth.currentUser.displayName || auth.currentUser.email}!`);
      closeLoginModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      let errorMessage = 'Login failed. Please try again.';
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = 'Invalid email or password. Please check your credentials.';
      } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email format.';
      } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Too many login attempts. Please try again later.';
      }
      showModal('Login Failed', 'Error: ' + errorMessage);
      console.error("Login error:", error);
    }
  };

  window.logoutUser = async function () {
    try {
      await signOut(auth);
      showModal('Logged Out', 'You have been successfully logged out.');
      showPage('home-page'); // Redirect to home after logout
    } catch (error) {
      showModal('Logout Failed', 'Error logging out: ' + error.message);
      console.error("Logout error:", error);
    }
  };

  window.resetPassword = async function(email) {
    try {
        await sendPasswordResetEmail(auth, email);
        showModal('Password Reset', `A password reset link has been sent to ${email}. Please check your inbox.`);
        closeForgotPasswordModal();
        openLoginModal();
    } catch (error) {
        showModal('Password Reset Failed', 'Error sending reset email: ' + error.message);
        console.error("Password reset error:", error);
    }
  };

  // Load products immediately - don't wait for authentication
  console.log("🚀 Loading products immediately...");
  setTimeout(async () => {
    try {
      await loadProductsFromFirestore();
    } catch (error) {
      console.error("❌ Product loading failed, using fallback:", error);
      window.addTestProducts();
    }
  }, 1000);

  // Firebase Auth State Listener
  onAuthStateChanged(auth, async (user) => {
    firebaseUser = user; // Update the global firebaseUser variable
    await updateAuthUI(); // Update UI based on auth state

    // Authenticate with custom token if available, otherwise sign in anonymously
    if (initialAuthToken) {
        try {
            await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
            console.error("Error signing in with custom token:", error);
            // Fallback to anonymous if custom token fails (e.g., expired)
            await signInAnonymously(auth);
        }
    } else {
        await signInAnonymously(auth);
    }

    // Update cart count after authentication (products already loaded above)
    await updateCartCount();

    // Handle pending checkout after Firebase login
    if (user && getFromLocalStorage('pendingCheckout', false)) {
        localStorage.removeItem('pendingCheckout');
        openCustomerDetailsModal(); // Resume checkout
    }
    // If a guest logs in, merge their local cart with their Firestore cart
    if (user) {
        const guestCart = getFromLocalStorage('guestCart', []);
        if (guestCart.length > 0) {
            let userCart = await getCart();
            // Merge logic: add guest items to user cart, handling duplicates
            guestCart.forEach(guestItem => {
                const existingUserItem = userCart.find(item => item.id === guestItem.id);
                if (existingUserItem) {
                    existingUserItem.quantity += guestItem.quantity;
                } else {
                    userCart.push(guestItem);
                }
            });
            await saveCart(userCart);
            localStorage.removeItem('guestCart'); // Clear guest cart after merge
            await updateCartCount();
        }
    }
  });

  // --- 🔒 Customer Status Management ---
  
  // Check if customer account is active
  async function checkCustomerStatus() {
    if (!firebaseUser) {
      return { isActive: true, status: 'guest' }; // Guests can always place orders
    }
    
    try {
      const customerRef = window.doc(window.db, "customers", firebaseUser.uid);
      const customerSnap = await window.getDoc(customerRef);
      
      if (customerSnap.exists()) {
        const customerData = customerSnap.data();
        return { 
          isActive: customerData.status === 'active', 
          status: customerData.status || 'active',
          customerData: customerData
        };
      } else {
        // If no customer record exists, create one with active status
        await window.setDoc(customerRef, {
          email: firebaseUser.email,
          fullname: firebaseUser.displayName || '',
          phoneNumber: '',
          idNumber: '',
          deliveryLocation: '',
          houseName: '',
          loyaltyPoints: 0,
          status: 'active',
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString()
        });
        return { isActive: true, status: 'active' };
      }
    } catch (error) {
      console.error("Error checking customer status:", error);
      return { isActive: true, status: 'error' }; // Default to active on error
    }
  }

  // Block order placement for inactive customers
  async function blockInactiveCustomerOrder() {
    const statusCheck = await checkCustomerStatus();
    
    if (!statusCheck.isActive) {
      const blockModalHtml = `
        <div style="text-align: center; max-width: 500px;">
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h2 style="color: #856404; margin: 0 0 10px 0;">⚠️ Account Temporarily Suspended</h2>
          </div>
          
          <p>Dear ${firebaseUser.displayName || firebaseUser.email},</p>
          
          <p>We're sorry, but your account has been temporarily suspended by our administration team.</p>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #dc3545; margin-top: 0;">What this means:</h3>
            <ul style="color: #6c757d; text-align: left;">
              <li>You cannot place new orders at this time</li>
              <li>You cannot access certain account features</li>
              <li>Your existing orders remain unaffected</li>
              <li>Your loyalty points are preserved</li>
            </ul>
          </div>
          
          <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0c5460; margin-top: 0;">What you can do:</h3>
            <ul style="color: #0c5460; text-align: left;">
              <li>Contact our customer support for more information</li>
              <li>Check your email for any outstanding issues</li>
              <li>Ensure all pending orders are completed</li>
            </ul>
          </div>
          
          <p>If you have any questions or concerns about this suspension, please contact our customer support team immediately.</p>
          
          <p>We apologize for any inconvenience this may cause.</p>
          
          <div style="margin-top: 30px;">
            <button onclick="closeModal()" class="cta-button" style="background: #6c757d;">Close</button>
          </div>
        </div>
      `;
      
      showModal('Account Suspended', blockModalHtml);
      return true; // Order is blocked
    }
    
    return false; // Order is not blocked
  }

  // Override the openCustomerDetailsModal function to check customer status
  const originalOpenCustomerDetailsModal = window.openCustomerDetailsModal;
  window.openCustomerDetailsModal = async function() {
    // Check if customer is active before allowing checkout
    const isBlocked = await blockInactiveCustomerOrder();
    if (isBlocked) {
      return; // Don't proceed with checkout
    }
    
    // If customer is active, proceed with original function
    if (originalOpenCustomerDetailsModal) {
      originalOpenCustomerDetailsModal();
    }
  };

  // Override the placeOrderFinal function to check customer status
  const originalPlaceOrderFinal = window.placeOrderFinal;
  window.placeOrderFinal = async function(paymentMethod, customerDetails, transportationFee, grandTotal) {
    // Check if customer is active before placing order
    const isBlocked = await blockInactiveCustomerOrder();
    if (isBlocked) {
      return; // Don't proceed with order placement
    }
    
    // If customer is active, proceed with original function with all parameters
    if (originalPlaceOrderFinal) {
      return await originalPlaceOrderFinal(paymentMethod, customerDetails, transportationFee, grandTotal);
    }
  };

  // Add status check to cart operations
  async function addToCartWithStatusCheck(productId) {
    const statusCheck = await checkCustomerStatus();
    
    if (!statusCheck.isActive) {
      showModal('Account Suspended', 'Your account has been temporarily suspended. You cannot add items to cart or place orders. Please contact customer support for assistance.');
      return;
    }
    
    // If customer is active, proceed with adding to cart
    await addToCart(productId);
  }

  // Override addToCart function to include status check
  const originalAddToCart = window.addToCart;
  window.addToCart = async function(productId) {
    if (firebaseUser) {
      // Only check status for logged-in users
      const statusCheck = await checkCustomerStatus();
      
      if (!statusCheck.isActive) {
        showModal('Account Suspended', 'Your account has been temporarily suspended. You cannot add items to cart or place orders. Please contact customer support for assistance.');
        return;
      }
    }
    
    // If customer is active or guest, proceed with original function
    if (originalAddToCart) {
      originalAddToCart(productId);
    }
  };

  // Add status indicator to user interface
  async function updateCustomerStatusIndicator() {
    if (!firebaseUser) return;
    
    const statusCheck = await checkCustomerStatus();
    const statusIndicator = document.getElementById('customer-status-indicator');
    
    if (statusIndicator) {
      if (statusCheck.isActive) {
        statusIndicator.innerHTML = '<span style="color: #28a745;">✅ Account Active</span>';
        statusIndicator.style.display = 'block';
      } else {
        statusIndicator.innerHTML = '<span style="color: #dc3545;">⚠️ Account Suspended</span>';
        statusIndicator.style.display = 'block';
      }
    }
  }

  // Call status check when user logs in
  const originalUpdateAuthUI = window.updateAuthUI;
  window.updateAuthUI = async function() {
    if (originalUpdateAuthUI) {
      originalUpdateAuthUI();
    }
    
    // Update customer status indicator
    await updateCustomerStatusIndicator();
  };

  // Listen for messages from admin page to refresh products
  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'PRODUCT_ADDED') {
      console.log('Product added notification received, refreshing products...');
      loadProductsFromFirestore(); // Reload products from Firestore
    }
  });

  // Debug function to check localStorage and customer details
  window.debugCustomerDetails = function() {
    console.log("🔍 Debugging Customer Details:");
    console.log("localStorage keys:", Object.keys(localStorage));
    console.log("lastCustomerDetails:", localStorage.getItem('lastCustomerDetails'));
    console.log("Parsed lastCustomerDetails:", JSON.parse(localStorage.getItem('lastCustomerDetails') || '{}'));
  };

</script>

</body>
</html>


