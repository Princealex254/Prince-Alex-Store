<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Online Store - Fresh Veggies from Kenya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; /* A fresh green */
            --secondary-color: #8BC34A; /* Lighter green */
            --text-color: #333;
            --light-bg: #f9f9f9;
            --white: #fff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --border-color: #ddd;
            --dark-text: #222;
            --star-color: #FFD700; /* Gold for stars */
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #66BB6A;
            --secondary-color: #9CCC65;
            --text-color: #E0E0E0;
            --light-bg: #2C2C2C;
            --white: #3A3A3A;
            --shadow: 0 4px 8px rgba(0,0,0,0.4);
            --border-color: #555;
            --dark-text: #F0F0F0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary-color);
        }

        .nav-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-icons span, .nav-icons button {
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            transition: color 0.3s;
        }
        .nav-icons span:hover, .nav-icons button:hover {
            color: var(--primary-color);
        }

        .hamburger-menu {
            display: none; /* Hidden on desktop */
            font-size: 24px;
            cursor: pointer;
        }

        main {
            flex-grow: 1;
        }

        section {
            padding: 60px 0;
            display: none; /* Hide all pages by default */
        }
        
        section.active {
            display: block; /* Show active page */
        }

        .hero {
            position: relative; /* For image carousel */
            text-align: center;
            padding: 100px 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            overflow: hidden; /* Hide overflowing images */
            height: 400px; /* Fixed height for hero section */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .hero-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
        }
        .hero-background-image.active {
            opacity: 1;
        }
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 2;
        }
        body.dark-mode .hero-overlay {
            background: rgba(0,0,0,0.6);
        }

        .hero-content {
            position: relative;
            z-index: 3;
        }

        .hero h1 {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .hero p {
            font-size: 20px;
            color: var(--dark-text);
            margin-bottom: 30px;
        }

        .cta-button {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .cta-button:hover {
            background-color: var(--secondary-color);
        }

        .section-title {
            text-align: center;
            font-size: 36px;
            margin-bottom: 40px;
            color: var(--primary-color);
        }

        .product-grid, .features-grid, .contact-info, .social-links, .about-content, .admin-orders-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .product-grid.list-view {
            grid-template-columns: 1fr;
        }

        .product-card, .feature-item, .order-card, .contact-submission-card {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            position: relative; /* For badges */
        }
        .product-grid.list-view .product-card {
            display: flex;
            text-align: left;
            gap: 20px;
            align-items: center;
        }
        .product-grid.list-view .product-card img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .product-grid.list-view .product-card .product-info {
            flex-grow: 1;
        }
        .product-grid.list-view .product-card .product-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .product-card h3 {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--dark-text);
        }

        .product-card .price {
            font-size: 18px;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .product-card .price del {
            color: #999;
            margin-right: 8px;
            font-size: 0.9em;
        }

        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-cart-btn:hover {
            background-color: var(--secondary-color);
        }
        .add-to-cart-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .features-grid .feature-item h4 {
            color: var(--primary-color);
            margin-top: 10px;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .cart-table th, .cart-table td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-text);
        }

        .cart-table th {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quantity-controls button {
            background-color: var(--border-color);
            border: none;
            width: 30px;
            height: 30px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            color: var(--dark-text);
        }
        .quantity-controls button:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .cart-summary-totals {
            text-align: right;
            margin-top: 20px;
            color: var(--dark-text);
        }
        .cart-summary-totals div {
            font-size: 18px;
            margin-bottom: 5px;
        }
        .cart-summary-totals .cart-total-grand {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 10px;
        }

        .checkout-btn {
            display: block;
            margin-top: 20px;
            width: 100%;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 15px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: var(--secondary-color);
        }

        .forms-container, .contact-form-container, .admin-panel-login, .auth-modal-content {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .admin-form input, .admin-form textarea, .contact-form input, .contact-form textarea, .order-track-form input, .admin-panel-login input, .checkout-form input, .payment-form input, .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: inherit;
            background-color: var(--light-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .admin-form input:focus, .admin-form textarea:focus, .contact-form input:focus, .contact-form textarea:focus, .order-track-form input:focus, .admin-panel-login input:focus, .checkout-form input:focus, .payment-form input:focus, .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .payment-option:hover {
            background-color: #e0e0e0;
            border-color: var(--primary-color);
        }
        .payment-option input[type="radio"] {
            width: auto;
            margin-bottom: 0;
        }
        body.dark-mode .payment-option:hover {
            background-color: #444;
        }

        .admin-form button, .contact-form button, .order-track-form button, .admin-panel-login button, .checkout-form button, .payment-form button, .auth-form button, .newsletter-form button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s;
        }

        .admin-form button:hover, .contact-form button:hover, .order-track-form button:hover, .admin-panel-login button:hover, .checkout-form button:hover, .payment-form button:hover, .auth-form button:hover, .newsletter-form button:hover {
            background-color: var(--secondary-color);
        }

        #order-status {
            text-align: center;
            font-size: 20px;
            margin-top: 20px;
            color: var(--dark-text);
        }
        #order-status strong {
            color: var(--primary-color);
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        footer {
            background-color: var(--dark-text);
            color: var(--white);
            padding: 40px 0;
            margin-top: auto;
            transition: background-color 0.3s;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .footer-column h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .footer-column a {
            color: var(--white);
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
            transition: color 0.3s;
        }
        
        .footer-column a:hover {
            color: var(--primary-color);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .social-links a {
            font-size: 24px;
            color: var(--white);
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--primary-color);
        }

        .whatsapp-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .whatsapp-widget a {
            background-color: #25D366;
            color: var(--white);
            padding: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 24px;
            text-decoration: none;
            transition: transform 0.3s;
        }
        .whatsapp-widget a:hover {
            transform: scale(1.1);
        }

        /* Success/Error Message Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 80%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: translateY(-50px);
            opacity: 0;
            animation: fadeInDown 0.3s forwards;
            color: var(--dark-text);
        }

        @keyframes fadeInDown {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-content button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-content button:hover {
            background-color: var(--secondary-color);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
        }
        .close-button:hover {
            color: var(--primary-color);
        }

        /* Order Confirmation Page Specific Styling */
        #order-confirmation-page .order-details {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            text-align: center;
            color: var(--dark-text);
        }
        #order-confirmation-page .order-details h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        #order-confirmation-page .order-details p {
            margin-bottom: 10px;
            font-size: 18px;
        }
        #order-confirmation-page .order-details strong {
            color: var(--primary-color);
        }

        /* Product Sorting and Filter Bar */
        .shop-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            justify-content: center;
        }
        .shop-controls input, .shop-controls select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: inherit;
            background-color: var(--light-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .shop-controls button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .shop-controls button:hover {
            background-color: var(--secondary-color);
        }

        /* Admin Panel - Orders and Products List */
        .admin-section {
            margin-top: 40px;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            color: var(--dark-text);
        }
        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-list-item:last-child {
            border-bottom: none;
        }
        .admin-list-item button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        .admin-list-item .delete-btn {
            background-color: #f44336;
            color: var(--white);
            border: none;
        }
        .admin-list-item .delete-btn:hover {
            background-color: #d32f2f;
        }
        .admin-list-item .mark-delivered-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
        }
        .admin-list-item .mark-delivered-btn:hover {
            background-color: var(--secondary-color);
        }
        .admin-list-item .status-delivered {
            color: var(--primary-color);
            font-weight: 600;
        }
        .admin-list-item .order-items-list {
            font-size: 0.9em;
            color: #666;
        }
        body.dark-mode .admin-list-item .order-items-list {
            color: #ccc;
        }

        /* Product Ratings */
        .product-rating {
            color: var(--star-color);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .product-rating .far { /* Empty star */
            color: #ccc;
        }

        /* Product Badges */
        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--primary-color);
            color: var(--white);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 10;
        }
        .product-badge.new { background-color: #2196F3; } /* Blue */
        .product-badge.bestseller { background-color: #FFC107; } /* Amber */
        .product-badge.organic { background-color: #4CAF50; } /* Green */
        .product-badge.discount { background-color: #F44336; } /* Red */

        /* Stock Indicator */
        .stock-indicator {
            font-size: 0.9em;
            margin-top: 5px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .stock-indicator.in-stock { color: var(--primary-color); }
        .stock-indicator.sold-out { color: #f44336; }

        /* Favorite Icon */
        .favorite-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.3em;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .favorite-icon.fas { /* Filled heart */
            color: #E91E63; /* Pink */
        }
        .favorite-icon:hover {
            color: #E91E63;
        }

        /* Quick View Modal */
        #quick-view-modal .modal-content {
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            text-align: left;
        }
        #quick-view-modal .modal-content .product-details {
            display: flex;
            gap: 20px;
        }
        #quick-view-modal .modal-content .product-details img {
            width: 50%;
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        #quick-view-modal .modal-content .product-info-qv {
            flex-grow: 1;
        }
        #quick-view-modal .modal-content h3 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        #quick-view-modal .modal-content .price-qv {
            font-size: 22px;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }
        #quick-view-modal .modal-content .price-qv del {
            color: #999;
            margin-right: 10px;
            font-size: 0.8em;
        }
        #quick-view-modal .modal-content .description-qv {
            margin-bottom: 20px;
            color: var(--dark-text);
        }
        #quick-view-modal .modal-content .add-to-cart-btn-qv {
            width: auto;
            padding: 12px 25px;
            font-size: 16px;
        }
        #quick-view-modal .modal-content .product-tags {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        #quick-view-modal .modal-content .product-tag {
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .reviews-section {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            text-align: left;
        }
        .reviews-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .review-item {
            background-color: var(--light-bg);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .review-item strong {
            color: var(--dark-text);
        }
        .review-item .review-rating {
            color: var(--star-color);
            font-size: 0.9em;
        }
        .add-review-form input, .add-review-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: inherit;
        }
        .add-review-form button {
            width: auto;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* My Account Page Styling */
        #my-account-page .account-section {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            color: var(--dark-text);
        }

        #my-account-page .account-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        #my-account-page .account-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        #my-account-page .profile-info-card {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #my-account-page .profile-info-card p {
            margin-bottom: 10px;
        }

        #my-account-page .profile-info-card strong {
            color: var(--primary-color);
        }

        #my-account-page .account-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        #my-account-page .account-buttons .cta-button {
            width: auto;
            padding: 12px 25px;
            font-size: 16px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .nav-links {
                display: none; /* Hide by default on mobile */
                flex-direction: column;
                width: 100%;
                background-color: var(--white);
                position: absolute;
                top: 70px; /* Adjust based on header height */
                left: 0;
                box-shadow: var(--shadow);
                padding: 20px 0;
                text-align: center;
            }
            .nav-links.active {
                display: flex; /* Show when active */
            }
            .nav-links li {
                margin-bottom: 10px;
            }
            .hamburger-menu {
                display: block; /* Show hamburger on mobile */
            }
            nav {
                flex-wrap: wrap;
            }
            .nav-icons {
                order: 1; /* Place icons first on small screens */
            }
            .logo {
                order: 2;
                flex-grow: 1;
                text-align: center;
            }
            .hamburger-menu {
                order: 3;
            }
            .hero h1 {
                font-size: 36px;
            }
            .product-grid, .features-grid, .admin-orders-grid {
                grid-template-columns: 1fr;
            }
            .footer-grid {
                grid-template-columns: 1fr;
            }
            .shop-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .shop-controls input, .shop-controls select, .shop-controls button {
                width: 100%;
            }
            #quick-view-modal .modal-content .product-details {
                flex-direction: column;
                align-items: center;
            }
            #quick-view-modal .modal-content .product-details img {
                width: 100%;
                max-width: 100%;
            }
            .product-grid.list-view .product-card {
                flex-direction: column;
                text-align: center;
            }
            .product-grid.list-view .product-card .product-actions {
                align-items: center;
            }
            #my-account-page .account-details-grid {
                grid-template-columns: 1fr;
            }
            #my-account-page .account-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">Prince Alex Store</div>
                <ul class="nav-links" id="nav-links">
                    <li><a href="#" class="page-link active" data-page="home">Home</a></li>
                    <li><a href="#" class="page-link" data-page="shop">Shop</a></li>
                    <li><a href="#" class="page-link" data-page="cart">Cart</a></li>
                    <li><a href="#" class="page-link" data-page="track-order">Track Order</a></li>
                    <li><a href="#" class="page-link" data-page="contact">Contact Us</a></li>
                    <li><a href="#" class="page-link" data-page="about">About Us</a></li>
                    <li id="auth-link-container"><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>
                </ul>
                <div class="nav-icons">
                    <span id="cart-icon"><i class="fas fa-shopping-cart"></i><span id="cart-count">0</span></span>
                    <button id="dark-mode-toggle"><i class="fas fa-moon"></i></button>
                    <span class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></span>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        
        <!-- Home Page -->
        <section id="home-page" class="active">
            <div class="hero">
                <img src="vegetable1.jpg" alt="Fresh Vegetables 1" class="hero-background-image active">
                <img src="vegetable2.jpg" alt="Fresh Vegetables 2" class="hero-background-image">
                <img src="vegetable3.jpg" alt="Fresh Vegetables 3" class="hero-background-image">
                <div class="hero-overlay"></div>
                <div class="hero-content">
                    <h1>Farm Fresh Vegetables, Delivered to Your Door!</h1>
                    <p>Order fresh veggies today and taste the difference.</p>
                    <a href="#" class="cta-button page-link" data-page="shop">Shop Now</a>
                </div>
            </div>

            <h2 class="section-title">Why Choose Us?</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <i class="fas fa-seedling fa-3x" style="color: var(--primary-color);"></i>
                    <h4>Farm Fresh</h4>
                    <p>Harvested daily to ensure maximum freshness and nutrition.</p>
                </div>
                <div class="feature-item">
                    <i class="fas fa-leaf fa-3x" style="color: var(--primary-color);"></i>
                    <h4>Organic & Healthy</h4>
                    <p>Grown without harmful chemicals, just as nature intended.</p>
                </div>
                <div class="feature-item">
                    <i class="fas fa-truck fa-3x" style="color: var(--primary-color);"></i>
                    <h4>Fast Delivery</h4>
                    <p>Quick and reliable delivery across all major Kenyan counties.</p>
                </div>
            </div>
        </section>

        <!-- Shop Page -->
        <section id="shop-page">
            <h2 class="section-title">Our Fresh Products</h2>
            <div class="shop-controls">
                <input type="text" id="search-input" placeholder="Search for veggies...">
                <button onclick="filterProducts()">Search</button>
                <select id="sort-by" onchange="sortProducts()">
                    <option value="">Sort By</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="price-asc">Price (Low to High)</option>
                    <option value="price-desc">Price (High to Low)</option>
                </select>
                <select id="filter-category" onchange="filterProducts()">
                    <option value="">All Categories</option>
                    <option value="leafy greens">Leafy Greens</option>
                    <option value="fruits">Fruits</option>
                    <option value="roots">Roots</option>
                    <option value="cruciferous">Cruciferous</option>
                    <option value="herbs">Herbs</option>
                </select>
                <button onclick="toggleView('grid')" id="grid-view-btn"><i class="fas fa-th-large"></i> Grid View</button>
                <button onclick="toggleView('list')" id="list-view-btn"><i class="fas fa-list"></i> List View</button>
            </div>
            <div class="product-grid" id="product-list">
                <!-- Products will be dynamically loaded here -->
            </div>
        </section>

        <!-- Cart Page -->
        <section id="cart-page">
            <h2 class="section-title">Your Shopping Cart</h2>
            <div id="cart-container">
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        <!-- Cart items will be dynamically loaded here -->
                    </tbody>
                </table>
                <div id="cart-summary">
                    <div class="cart-summary-totals">
                        <div>Subtotal: KES <span id="cart-subtotal-price">0.00</span></div>
                        <div>Transportation Fee: KES <span id="cart-transport-fee">0.00</span></div>
                        <div class="cart-total-grand">Grand Total: KES <span id="cart-grand-total-price">0.00</span></div>
                    </div>
                    <button class="checkout-btn" onclick="openCustomerDetailsModal()">Place Order</button>
                </div>
            </div>
        </section>

        <!-- Order Confirmation Page -->
        <section id="order-confirmation-page">
            <h2 class="section-title">Order Confirmed!</h2>
            <div class="order-details" id="last-order-details">
                <p>Your order details will appear here.</p>
            </div>
        </section>

        <!-- Order Tracking Page -->
        <section id="track-order-page">
            <h2 class="section-title">Track Your Order</h2>
            <div class="forms-container">
                <form class="order-track-form" onsubmit="trackOrder(event)">
                    <input type="text" id="order-id-input" placeholder="Enter your Order ID" required>
                    <button type="submit">Track Order</button>
                </form>
                <div id="order-status"></div>
            </div>
        </section>

        <!-- Contact Us Page -->
        <section id="contact-page">
            <h2 class="section-title">Get in Touch</h2>
            <div class="contact-form-container">
                <form class="contact-form" onsubmit="submitContactForm(event)">
                    <input type="text" id="contact-name" placeholder="Your Name" required>
                    <input type="email" id="contact-email" placeholder="Your Email" required>
                    <textarea id="contact-message" rows="5" placeholder="Your Message" required></textarea>
                    <button type="submit">Send Message</button>
                </form>
            </div>
            <div class="map-container">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15955.289139260586!2d36.81255535!3d-1.2842426999999998!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x182f1172d84d49a7%3A0xf7cf54a935de98e8!2sNairobi%2C%20Kenya!5e0!3m2!1sen!2ske!4v1700000000000!5m2!1sen!2ske" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </section>
        
        <!-- About Us Page -->
        <section id="about-page">
            <h2 class="section-title">Our Story</h2>
            <div class="about-content">
                <p><strong>Prince Alex Online Store</strong> was founded with a simple mission: to bring the freshest, most organic vegetables directly from the farm to your table. We believe that everyone deserves access to healthy, nutritious food without the hassle of a market trip.</p>
                <p>We are currently operating primarily in <strong>Vihiga County</strong>, with our headquarter located at <strong>Tambua Ward</strong>. We are proud to partner with local Kenyan farmers who share our passion for sustainable and ethical farming. We carefully select each product to ensure it meets our high standards of quality and freshness.</p>
                <p>Our vision is to expand our reach to more counties soon, becoming the leading online platform for farm-fresh produce in Kenya, empowering local farmers and providing our customers with a convenient and reliable source of healthy food. Thank you for supporting our mission!</p>
            </div>
        </section>

        <!-- My Account Page -->
        <section id="my-account-page">
            <h2 class="section-title">My Account</h2>
            <div class="account-section">
                <p style="text-align: center;">Welcome, <strong id="account-username">Guest</strong>!</p>
                <h3>Your Profile Details</h3>
                <div class="account-details-grid">
                    <div class="profile-info-card">
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                    </div>
                    <!-- Add other profile details here if needed -->
                </div>
                <div class="account-buttons">
                    <button class="cta-button" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="cta-button" style="background-color: #f44336;" onclick="window.logoutUser()">Logout</button>
                </div>
            </div>

            <div class="account-section">
                <h3>Your Past Orders</h3>
                <div id="user-orders-list">
                    <!-- User's past orders will be loaded here -->
                    <p style="text-align: center;">No past orders found.</p>
                </div>
            </div>
        </section>

        <!-- Admin Product Upload & Management Page -->
        <section id="upload-product-page">
            <h2 class="section-title">Admin Panel</h2>
            <div id="admin-login" class="admin-panel-login">
                <p>Please enter admin password to continue.</p>
                <input type="email" id="admin-email" placeholder="Admin Email" value="admin@princealex.com">
                <input type="password" id="admin-password" placeholder="Password">
                <button onclick="window.loginAdmin()">Login</button>
            </div>
            <div id="admin-content" style="display: none;">
                <div id="product-upload-form" class="forms-container">
                    <h3>Add a New Product</h3>
                    <form class="admin-form" onsubmit="addProduct(event)">
                        <input type="text" id="product-name" placeholder="Product Name" required>
                        <input type="text" id="product-image" placeholder="Image URL (e.g., https://...)" required>
                        <textarea id="product-description" rows="3" placeholder="Description" required></textarea>
                        <input type="number" id="product-price" placeholder="Price (KES)" required step="0.01">
                        <input type="text" id="product-unit" placeholder="Unit (e.g., per kg, per bunch)" required>
                        <input type="number" id="product-rating" placeholder="Rating (1-5)" min="1" max="5" step="0.1" value="4.5">
                        <input type="text" id="product-badge" placeholder="Badge (New, Best Seller, Organic, Discount, or leave empty)">
                        <input type="number" id="product-stock" placeholder="Stock (quantity)" required min="0" value="100">
                        <input type="text" id="product-tags" placeholder="Tags (comma-separated, e.g., Vitamin A-rich, Low calories)">
                        <button type="submit">Upload Product</button>
                    </form>
                </div>

                <div class="admin-section">
                    <h3>Manage Products</h3>
                    <div id="admin-product-list">
                        <!-- Admin products will be loaded here -->
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Manage Orders</h3>
                    <div id="admin-order-list">
                        <!-- Admin orders will be loaded here -->
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Contact Submissions</h3>
                    <div id="admin-contact-submissions">
                        <!-- Contact submissions will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    
<!-- Login / Signup Page -->
<section id="login-page">
  <h2 class="section-title">Login or Sign Up</h2>
  <div class="forms-container">
    <h3>Sign Up</h3>
    <form id="signup-form" class="auth-form">
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="password" id="signup-password" placeholder="Password" required>
        <button type="submit">Sign Up</button>
    </form>
    <hr>
    <h3>Login</h3>
    <form id="login-form" class="auth-form">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
  </div>
</section>

</main>

    <footer>
        <div class="container footer-grid">
            <div class="footer-column">
                <h4>Quick Links</h4>
                <a href="#" class="page-link" data-page="home">Home</a>
                <a href="#" class="page-link" data-page="shop">Shop</a>
                <a href="#" class="page-link" data-page="track-order">Track Order</a>
                <a href="#" class="page-link" data-page="contact">Contact Us</a>
            </div>
            <div class="footer-column">
                <h4>Contact Info</h4>
                <p><i class="fas fa-phone-alt"></i> 0717384875</p>
                <p><i class="fas fa-envelope"></i> princealexdigital@gmail.com</p>
                <p><i class="fab fa-whatsapp"></i> 0717384875</p>
            </div>
            <div class="footer-column">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://tiktok.com" target="_blank"><i class="fab fa-tiktok"></i></a>
                    <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-column">
                <h4>Newsletter</h4>
                <p>Subscribe to our newsletter for fresh updates and offers!</p>
                <form class="newsletter-form" onsubmit="subscribeToNewsletter(event)">
                    <input type="email" id="newsletter-email" placeholder="Your Email" required>
                    <button type="submit">Subscribe</button>
                </form>
            </div>
        </div>
    </footer>

    <div class="whatsapp-widget">
        <a href="https://wa.me/254717384875" target="_blank" title="Chat on WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quick-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeQuickViewModal()">&times;</span>
            <div class="product-details">
                <img id="qv-image" src="" alt="Product Image">
                <div class="product-info-qv">
                    <h3 id="qv-name"></h3>
                    <div id="qv-rating" class="product-rating"></div>
                    <p id="qv-price" class="price-qv"></p>
                    <p id="qv-description" class="description-qv"></p>
                    <div id="qv-stock" class="stock-indicator"></div>
                    <div id="qv-tags" class="product-tags"></div>
                    <button id="qv-add-to-cart-btn" class="add-to-cart-btn-qv">Add to Cart</button>
                </div>
            </div>
            <div class="reviews-section">
                <h4>Customer Reviews</h4>
                <div id="qv-reviews-list">
                    <!-- Reviews will be loaded here -->
                </div>
                <div id="add-review-container">
                    <!-- Add Review Form will be loaded here if logged in -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customer-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCustomerDetailsModal()">&times;</span>
            <h3>Your Delivery Details</h3>
            <form id="checkout-form" class="checkout-form">
                <input type="text" id="customer-full-name" placeholder="Full Name" required>
                <input type="text" id="customer-id" placeholder="ID Number (National ID/Passport)" required>
                <input type="tel" id="customer-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="text" id="customer-delivery-location" placeholder="Delivery Location (e.g., Street, Estate, Town)" required>
                <input type="text" id="customer-house-name" placeholder="House Name/Number (Optional)">
                <button type="submit">Continue to Payment</button>
            </form>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="payment-method-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentMethodModal()">&times;</span>
            <h3>Select Payment Method</h3>
            <form id="payment-form" class="payment-form" onsubmit="processPayment(event)">
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="mpesa" checked>
                        <span>M-Pesa</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="cash">
                        <span>Cash on Delivery</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="card">
                        <span>Card Payment</span>
                    </label>
                </div>

                <div id="mpesa-details" class="payment-details-section">
                    <input type="tel" id="mpesa-phone-number" placeholder="Your M-Pesa Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$">
                    <p>Amount to Pay: <strong>KES <span id="mpesa-amount">0.00</span></strong></p>
                </div>

                <div id="card-details" class="payment-details-section" style="display: none;">
                    <input type="text" id="card-number" placeholder="Card Number" pattern="[0-9]{16}" maxlength="16">
                    <input type="text" id="card-expiry" placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\/?([0-9]{2})" maxlength="5">
                    <input type="text" id="card-cvv" placeholder="CVV" pattern="[0-9]{3,4}" maxlength="4">
                </div>

                <button type="submit">Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Login/Signup Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeLoginModal()">&times;</span>
            <h3>Login to Your Account</h3>
            <form id="login-form-modal" class="auth-form">
                <input type="email" id="login-email-modal" placeholder="Email" required>
                <input type="password" id="login-password-modal" placeholder="Password" required>
                <button type="submit">Login</button>
                <p style="margin-top: 15px;">Don't have an account? <a href="#" onclick="openSignupModal(); return false;">Sign Up</a></p>
                <p><a href="#" onclick="openForgotPasswordModal(); return false;">Forgot Password?</a></p>
            </form>
        </div>
    </div>

    <div id="signup-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeSignupModal()">&times;</span>
            <h3>Create an Account</h3>
            <form id="signup-form-modal" class="auth-form">
                <input type="text" id="signup-fullname-modal" placeholder="Full Name" required>
                <input type="email" id="signup-email-modal" placeholder="Email" required>
                <input type="tel" id="signup-phone-modal" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="signup-password-modal" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p style="margin-top: 15px;">Already have an account? <a href="#" onclick="openLoginModal(); return false;">Login</a></p>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeForgotPasswordModal()">&times;</span>
            <h3>Reset Password</h3>
            <form id="forgot-password-form" class="auth-form">
                <p>Enter your email address to receive a password reset link.</p>
                <input type="email" id="reset-email" placeholder="Your Email" required>
                <button type="submit">Send Reset Link</button>
                <p style="margin-top: 15px;"><a href="#" onclick="closeForgotPasswordModal(); openLoginModal(); return false;">Back to Login</a></p>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeEditProfileModal()">&times;</span>
            <h3>Edit Your Profile</h3>
            <form id="edit-profile-form" class="auth-form">
                <input type="text" id="edit-fullname" placeholder="Full Name" required>
                <input type="email" id="edit-email" placeholder="Email" required readonly> <!-- Email usually not editable -->
                <input type="tel" id="edit-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="edit-password" placeholder="New Password (leave blank to keep current)">
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>


    <script>
        const pages = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.page-link');
        const shopPage = document.getElementById('shop-page');
        const cartCountSpan = document.getElementById('cart-count');
        const cartItemsBody = document.getElementById('cart-items');
        const cartSubtotalPriceSpan = document.getElementById('cart-subtotal-price');
        const cartTransportFeeSpan = document.getElementById('cart-transport-fee');
        const cartGrandTotalPriceSpan = document.getElementById('cart-grand-total-price');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const mobileNavLinks = document.getElementById('nav-links');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const quickViewModal = document.getElementById('quick-view-modal');
        const productListDiv = document.getElementById('product-list');

        const customerDetailsModal = document.getElementById('customer-details-modal');
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const mpesaDetailsDiv = document.getElementById('mpesa-details');
        const cardDetailsDiv = document.getElementById('card-details');
        const mpesaAmountSpan = document.getElementById('mpesa-amount');

        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const forgotPasswordModal = document.getElementById('forgot-password-modal'); // New
        const editProfileModal = document.getElementById('edit-profile-modal'); // New

        const authLinkContainer = document.getElementById('auth-link-container');
        const accountUsernameSpan = document.getElementById('account-username');
        const profileEmailSpan = document.getElementById('profile-email');     // New

        const TRANSPORT_FEE = 100.00; // Fixed transportation fee for Vihiga County
        const MIN_ORDER_VALUE = 600.00; // Minimum order value for checkout

        let currentView = 'grid'; // Default view
        let firebaseUser = null; // Stores the currently logged in Firebase user object

        const defaultProducts = [
            { id: 1, name: 'Sukuma Wiki', price: 40.00, originalPrice: 50.00, unit: 'per bunch', image: 'https://images.unsplash.com/photo-1601007790325-1033b006c459?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Freshly harvested collard greens, perfect for a healthy meal.', category: 'leafy greens', rating: 4.5, badge: 'Organic', stock: 50, tags: ['Vitamin K-rich', 'Iron source'] },
            { id: 2, name: 'Tomatoes', price: 100.00, originalPrice: 120.00, unit: 'per kg', image: 'https://images.unsplash.com/photo-1596489370605-e41c484f23c7?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Juicy and ripe red tomatoes, ideal for salads and cooking.', category: 'fruits', rating: 4.8, badge: 'Best Seller', stock: 120, tags: ['Vitamin C-rich', 'Antioxidant'] },
            { id: 3, name: 'Onions', price: 80.00, originalPrice: 90.00, unit: 'per kg', image: 'https://images.unsplash.com/photo-1577793444053-29f95738d821?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Pungent and flavorful onions, a staple for any kitchen.', category: 'roots', rating: 4.2, badge: '', stock: 80, tags: ['Immunity booster'] },
            { id: 4, name: 'Potatoes', price: 150.00, unit: 'per kg', image: 'https://images.unsplash.com/photo-1563795325732-c1285e683701?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Starchy and versatile potatoes, great for mashing, frying, or roasting.', category: 'roots', rating: 4.0, badge: '', stock: 200, tags: ['Energy source'] },
            { id: 5, name: 'Spinach', price: 60.00, unit: 'per bunch', image: 'https://images.unsplash.com/photo-1596280455088-e215d2698944?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Nutrient-rich green spinach, excellent for stews and smoothies.', category: 'leafy greens', rating: 4.7, badge: 'Organic', stock: 40, tags: ['Vitamin A-rich', 'Folate source'] },
            { id: 6, name: 'Cabbage', price: 75.00, unit: 'per head', image: 'https://images.unsplash.com/photo-1628178168273-057d38ae859b?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Crisp and fresh green cabbage, perfect for salads or cooking.', category: 'leafy greens', rating: 4.1, badge: '', stock: 60, tags: ['Fiber-rich', 'Low calories'] },
            { id: 7, name: 'Carrots', price: 80.00, unit: 'per kg', image: 'https://images.unsplash.com/photo-1502741525547-511674482d8c?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Sweet and crunchy carrots, great for snacking or adding to dishes.', category: 'roots', rating: 4.6, badge: 'New', stock: 90, tags: ['Vitamin A-rich', 'Good for eyes'] },
            { id: 8, name: 'Green Pepper', price: 55.00, unit: 'per piece', image: 'https://images.unsplash.com/photo-1627883908868-b7c7b28d576a?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Bell pepper with a mild flavor, adds color and crunch to meals.', category: 'fruits', rating: 4.3, badge: '', stock: 70, tags: ['Vitamin C-rich'] },
            { id: 9, name: 'Garlic', price: 40.00, unit: 'per head', image: 'https://images.unsplash.com/photo-1555541673-f93504107e3a?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Adds a pungent flavor to dishes, known for its health benefits.', category: 'roots', rating: 4.4, badge: '', stock: 110, tags: ['Immunity booster', 'Antimicrobial'] },
            { id: 10, name: 'Ginger', price: 65.00, unit: 'per 100g', image: 'https://images.unsplash.com/photo-1624831631557-0b1a03e1e912?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Aromatic and zesty ginger root, great for teas and cooking.', category: 'roots', rating: 4.6, badge: 'New', stock: 55, tags: ['Digestive aid', 'Anti-inflammatory'] },
            { id: 11, name: 'Broccoli', price: 180.00, unit: 'per head', image: 'https://images.unsplash.com/photo-1628042453448-433a042e61a6?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Nutrient-packed broccoli, perfect for steaming or stir-frying.', category: 'cruciferous', rating: 4.7, badge: 'Organic', stock: 30, tags: ['Vitamin C-rich', 'Fiber-rich'] },
            { id: 12, name: 'Cucumber', price: 70.00, unit: 'per piece', image: 'https://images.unsplash.com/photo-1589139158020-e204c3d8e5e8?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGV DufDB8fHx8fA%3D%3D', description: 'Cool and crisp cucumber, excellent for salads and refreshing drinks.', category: 'fruits', rating: 4.3, badge: '', stock: 95, tags: ['Hydrating', 'Low calories'] },
            { id: 13, name: 'Capsicum (Red)', price: 90.00, originalPrice: 100.00, unit: 'per piece', image: 'https://images.unsplash.com/photo-1596489370605-e41c484f23c7?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Sweet and vibrant red capsicum, adds color and flavor to any dish.', category: 'fruits', rating: 4.5, badge: 'Discount -10%', stock: 20, tags: ['Vitamin C-rich'] },
            { id: 14, name: 'Eggplant', price: 85.00, unit: 'per piece', image: 'https://images.unsplash.com/photo-1597843846660-84a1d4b6b27e?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Versatile eggplant, great for grilling, baking, or stews.', category: 'fruits', rating: 3.9, badge: '', stock: 45, tags: ['Fiber-rich', 'Antioxidant'] },
            { id: 15, name: 'Dhania (Coriander)', price: 30.00, unit: 'per bunch', image: 'https://images.unsplash.com/photo-1620241091515-b4d4b14d8b5a?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', description: 'Fresh coriander, essential for adding a fresh aroma to your meals.', category: 'herbs', rating: 4.8, badge: 'Best Seller', stock: 75, tags: ['Aromatic', 'Digestive aid'] },
        ];

        // --- Utility Functions for Local Storage ---
        function getFromLocalStorage(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Error parsing localStorage item "${key}":`, e);
                return defaultValue;
            }
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving to localStorage item "${key}":`, e);
            }
        }

        // --- Message Modal Functions ---
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML for strong tags
            messageModal.style.display = 'flex';
        }

        function closeModal() {
            messageModal.style.display = 'none';
        }

        // --- Quick View Modal Functions ---
        function openQuickViewModal(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);

            if (!product) return;

            document.getElementById('qv-image').src = product.image;
            document.getElementById('qv-image').alt = product.name;
            document.getElementById('qv-name').textContent = product.name;
            
            let qvPriceHtml = `KES ${product.price.toFixed(2)} ${product.unit}`;
            if (product.originalPrice && product.originalPrice > product.price) {
                qvPriceHtml = `<del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}`;
            }
            document.getElementById('qv-price').innerHTML = qvPriceHtml;

            document.getElementById('qv-description').textContent = product.description;

            // Render rating stars
            const qvRatingDiv = document.getElementById('qv-rating');
            qvRatingDiv.innerHTML = generateStarRating(product.rating);

            // Render stock indicator
            const qvStockDiv = document.getElementById('qv-stock');
            qvStockDiv.className = `stock-indicator ${product.stock > 0 ? 'in-stock' : 'sold-out'}`;
            qvStockDiv.textContent = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';

            // Render tags
            const qvTagsDiv = document.getElementById('qv-tags');
            qvTagsDiv.innerHTML = '';
            if (product.tags && product.tags.length > 0) {
                product.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'product-tag';
                    tagSpan.textContent = tag;
                    qvTagsDiv.appendChild(tagSpan);
                });
            }

            // Set Add to Cart button for quick view
            const qvAddToCartBtn = document.getElementById('qv-add-to-cart-btn');
            qvAddToCartBtn.onclick = () => {
                addToCart(product.id);
                closeQuickViewModal();
            };
            qvAddToCartBtn.disabled = product.stock <= 0;
            qvAddToCartBtn.textContent = product.stock <= 0 ? 'Sold Out' : 'Add to Cart';

            // Render reviews and add review form
            renderProductReviews(productId);

            quickViewModal.style.display = 'flex';
        }

        function closeQuickViewModal() {
            quickViewModal.style.display = 'none';
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            navLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.page-link[data-page="${pageId.replace('-page', '')}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            // Close mobile menu if open
            mobileNavLinks.classList.remove('active');

            // Specific page rendering/updates
            if (pageId === 'cart-page') {
                renderCart();
            } else if (pageId === 'shop-page') {
                renderProducts();
            } else if (pageId === 'upload-product-page') {
                // Admin panel logic is handled in admin.html, this page is mostly for display here
                // For this file, we assume admin login is separate or handled differently
                // If you want to enable admin functions here, you'd need to integrate Firebase Admin SDK securely
            } else if (pageId === 'order-confirmation-page') {
                displayLastOrderConfirmation();
            } else if (pageId === 'my-account-page') {
                updateAccountPage();
                renderUserOrders(); // Render user's past orders
            } else if (pageId === 'login-page') { // Handle direct navigation to login
                openLoginModal();
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'login') {
                    openLoginModal();
                } else if (pageData === 'my-account') {
                    showPage('my-account-page');
                } else {
                    showPage(pageData + '-page');
                }
            });
        });
        
        document.getElementById('cart-icon').addEventListener('click', () => {
            showPage('cart-page');
        });

        // --- Mobile Hamburger Menu ---
        hamburgerMenu.addEventListener('click', () => {
            mobileNavLinks.classList.toggle('active');
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Save preference to localStorage
            const isDarkMode = document.body.classList.contains('dark-mode');
            saveToLocalStorage('darkMode', isDarkMode);
            // Update icon
            darkModeToggle.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        });

        function applyDarkModePreference() {
            const isDarkMode = getFromLocalStorage('darkMode', false); // Default to light mode
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // --- Product Data Management ---
        function getProducts() {
            let products = getFromLocalStorage('products', defaultProducts);
            // Ensure IDs are unique and consecutive if default products are used initially
            // This is a simple check; a more robust solution might involve merging or versioning
            if (products.length === defaultProducts.length && products.every((p, i) => p.id === defaultProducts[i].id)) {
                return defaultProducts; // Use default if no custom products added
            }
            return products;
        }
        function saveProducts(products) {
            saveToLocalStorage('products', products);
        }

        // --- Favorite Products ---
        function getFavorites() {
            return getFromLocalStorage('favorites', []);
        }

        function saveFavorites(favorites) {
            saveToLocalStorage('favorites', favorites);
        }

        function toggleFavorite(productId, iconElement) {
            let favorites = getFavorites();
            if (favorites.includes(productId)) {
                favorites = favorites.filter(id => id !== productId);
                iconElement.classList.remove('fas');
                iconElement.classList.add('far');
            } else {
                favorites.push(productId);
                iconElement.classList.remove('far');
                iconElement.classList.add('fas');
            }
            saveFavorites(favorites);
        }

        // --- Generate Star Rating HTML ---
        function generateStarRating(rating) {
            let starsHtml = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                starsHtml += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < (5 - fullStars - (hasHalfStar ? 1 : 0)); i++) {
                starsHtml += '<i class="far fa-star"></i>';
            }
            return starsHtml;
        }

        // --- Product Reviews ---
        function getProductReviews(productId) {
            const allReviews = getFromLocalStorage('productReviews', {});
            return allReviews[productId] || [];
        }

        function saveProductReview(productId, review) {
            const allReviews = getFromLocalStorage('productReviews', {});
            if (!allReviews[productId]) {
                allReviews[productId] = [];
            }
            allReviews[productId].push(review);
            saveToLocalStorage('productReviews', allReviews);
        }

        function renderProductReviews(productId) {
            const qvReviewsList = document.getElementById('qv-reviews-list');
            const addReviewContainer = document.getElementById('add-review-container');
            const reviews = getProductReviews(productId);

            qvReviewsList.innerHTML = '';
            if (reviews.length === 0) {
                qvReviewsList.innerHTML = '<p>No reviews yet. Be the first to review this product!</p>';
            } else {
                reviews.forEach(review => {
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-item';
                    reviewItem.innerHTML = `
                        <p><strong>${review.username}</strong> <span class="review-rating">${generateStarRating(review.rating)}</span></p>
                        <p>${review.comment}</p>
                        <small>${new Date(review.date).toLocaleString()}</small>
                    `;
                    qvReviewsList.appendChild(reviewItem);
                });
            }

            // Show add review form if logged in
            if (firebaseUser) {
                addReviewContainer.innerHTML = `
                    <h4>Add Your Review</h4>
                    <form class="add-review-form" onsubmit="submitProductReview(event, ${productId})">
                        <input type="number" id="review-rating-input" placeholder="Rating (1-5)" min="1" max="5" step="0.5" required>
                        <textarea id="review-comment-input" rows="3" placeholder="Your comment..." required></textarea>
                        <button type="submit">Submit Review</button>
                    </form>
                `;
            } else {
                addReviewContainer.innerHTML = '<p>Please <a href="#" onclick="openLoginModal(); closeQuickViewModal(); return false;">log in</a> to add a review.</p>';
            }
        }

        function submitProductReview(event, productId) {
            event.preventDefault();
            const rating = parseFloat(document.getElementById('review-rating-input').value);
            const comment = document.getElementById('review-comment-input').value;

            if (rating < 1 || rating > 5 || !comment) {
                showModal('Error', 'Please provide a rating between 1 and 5 and a comment.');
                return;
            }

            const newReview = {
                username: firebaseUser.displayName || firebaseUser.email, // Use Firebase user info
                rating: rating,
                comment: comment,
                date: new Date().toISOString()
            };
            saveProductReview(productId, newReview);
            showModal('Review Submitted', 'Thank you for your review!');
            document.querySelector('.add-review-form').reset();
            renderProductReviews(productId); // Re-render reviews
        }


        // --- Render Products on Shop Page ---
        function renderProducts() {
            productListDiv.innerHTML = '';
            let products = getProducts();
            const favorites = getFavorites();
            
            // Apply search filter
            const query = document.getElementById('search-input').value.toLowerCase();
            if (query) {
                products = products.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.description.toLowerCase().includes(query) ||
                    (p.tags && p.tags.some(tag => tag.toLowerCase().includes(query)))
                );
            }

            // Apply category filter
            const categoryFilter = document.getElementById('filter-category').value;
            if (categoryFilter) {
                products = products.filter(p => p.category === categoryFilter);
            }

            // Apply sorting
            const sortBy = document.getElementById('sort-by').value;
            if (sortBy) {
                products.sort((a, b) => {
                    if (sortBy === 'name-asc') return a.name.localeCompare(b.name);
                    if (sortBy === 'name-desc') return b.name.localeCompare(a.name);
                    if (sortBy === 'price-asc') return a.price - b.price;
                    if (sortBy === 'price-desc') return b.price - a.price;
                    return 0;
                });
            }
            
            if (products.length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">No products found matching your criteria.</p>';
                return;
            }

            // Apply view mode
            productListDiv.classList.remove('grid-view', 'list-view');
            productListDiv.classList.add(`${currentView}-view`);

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                const isFavorite = favorites.includes(product.id);
                const favoriteIconClass = isFavorite ? 'fas' : 'far';
                const stockStatusClass = product.stock > 0 ? 'in-stock' : 'sold-out';
                const stockText = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';
                const addToCartDisabled = product.stock <= 0 ? 'disabled' : '';
                const addToCartText = product.stock <= 0 ? 'Sold Out' : 'Add to Cart';

                let badgeHtml = '';
                if (product.badge) {
                    const badgeClass = product.badge.toLowerCase().replace(/\s/g, '');
                    badgeHtml = `<span class="product-badge ${badgeClass}">${product.badge}</span>`;
                }

                let tagsHtml = '';
                if (product.tags && product.tags.length > 0) {
                    tagsHtml = `<div class="product-tags">${product.tags.map(tag => `<span class="product-tag">${tag}</span>`).join('')}</div>`;
                }

                let priceHtml = `<p class="price">KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                if (product.originalPrice && product.originalPrice > product.price) {
                    priceHtml = `<p class="price"><del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                }


                if (currentView === 'grid') {
                    productCard.innerHTML = `
                        ${badgeHtml}
                        <i class="${favoriteIconClass} fa-heart favorite-icon" onclick="toggleFavorite(${product.id}, this)"></i>
                        <img src="${product.image}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/333333?text=No+Image';">
                        <h3>${product.name}</h3>
                        <div class="product-rating">${generateStarRating(product.rating)}</div>
                        ${priceHtml}
                        <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                        ${tagsHtml}
                        <button class="add-to-cart-btn" onclick="addToCart(${product.id})" ${addToCartDisabled}>${addToCartText}</button>
                        <button class="add-to-cart-btn" style="background-color: #03A9F4; margin-top: 10px;" onclick="openQuickViewModal(${product.id})">Quick View</button>
                    `;
                } else { // List view
                    productCard.innerHTML = `
                        ${badgeHtml}
                        <i class="${favoriteIconClass} fa-heart favorite-icon" onclick="toggleFavorite(${product.id}, this)"></i>
                        <img src="${product.image}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/120x120/cccccc/333333?text=No+Image';">
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-rating">${generateStarRating(product.rating)}</div>
                            ${priceHtml}
                            <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                            <p>${product.description}</p>
                            ${tagsHtml}
                        </div>
                        <div class="product-actions">
                            <button class="add-to-cart-btn" onclick="addToCart(${product.id})" ${addToCartDisabled}>${addToCartText}</button>
                            <button class="add-to-cart-btn" style="background-color: #03A9F4;" onclick="openQuickViewModal(${product.id})">Quick View</button>
                        </div>
                    `;
                }
                
                productListDiv.appendChild(productCard);
            });
        }
        
        function filterProducts() {
            renderProducts(); // Re-render with current search input and category filter
        }

        function sortProducts() {
            renderProducts(); // Re-render with current sort selection
        }

        function toggleView(view) {
            currentView = view;
            renderProducts();
        }
        
        // --- Shopping Cart functionality ---
        function getCart() {
            return getFromLocalStorage('cart', []);
        }

        function saveCart(cart) {
            saveToLocalStorage('cart', cart);
            updateCartCount();
        }

        function updateCartCount() {
            const cart = getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        function addToCart(productId) {
            const cart = getCart();
            const products = getProducts();
            const productToAdd = products.find(p => p.id === productId);

            if (!productToAdd) return;
            if (productToAdd.stock <= 0) {
                showModal('Out of Stock', `${productToAdd.name} is currently out of stock.`);
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity >= productToAdd.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${productToAdd.name}. Only ${productToAdd.stock} available.`);
                    return;
                }
                existingItem.quantity += 1;
            } else {
                // Store the current price when adding to cart, not originalPrice
                cart.push({ ...productToAdd, quantity: 1, price: productToAdd.price });
            }
            saveCart(cart);
            showModal('Success!', `${productToAdd.name} added to cart!`);
        }

        function renderCart() {
            const cart = getCart();
            cartItemsBody.innerHTML = '';
            let subTotal = 0;

            if (cart.length === 0) {
                cartItemsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Your cart is empty.</td></tr>';
                cartSubtotalPriceSpan.textContent = '0.00';
                cartTransportFeeSpan.textContent = '0.00';
                cartGrandTotalPriceSpan.textContent = '0.00';
                return;
            }

            cart.forEach(item => {
                const row = document.createElement('tr');
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                row.innerHTML = `
                    <td class="cart-item-image"><img src="${item.image}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=No+Image';"></td>
                    <td>${item.name}</td>
                    <td>KES ${item.price.toFixed(2)} ${item.unit}</td>
                    <td>
                        <div class="quantity-controls">
                            <button onclick="updateQuantity(${item.id}, -1)"><i class="fas fa-minus"></i></button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </td>
                    <td>KES ${itemTotal.toFixed(2)}</td>
                    <td><button onclick="removeFromCart(${item.id})" style="color: red; border: none; background: transparent; cursor: pointer;"><i class="fas fa-trash-alt"></i></button></td>
                `;
                cartItemsBody.appendChild(row);
            });
            
            const grandTotal = subTotal + TRANSPORT_FEE;
            cartSubtotalPriceSpan.textContent = subTotal.toFixed(2);
            cartTransportFeeSpan.textContent = TRANSPORT_FEE.toFixed(2);
            cartGrandTotalPriceSpan.textContent = grandTotal.toFixed(2);
        }

        function updateQuantity(productId, change) {
            const cart = getCart();
            const products = getProducts();
            const productInStore = products.find(p => p.id === productId);
            const item = cart.find(i => i.id === productId);

            if (item) {
                if (change > 0 && item.quantity >= productInStore.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${item.name}. Only ${productInStore.stock} available.`);
                    return;
                }
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    saveCart(cart);
                    renderCart();
                }
            }
        }

        function removeFromCart(productId) {
            let cart = getCart();
            cart = cart.filter(item => item.id !== productId);
            saveCart(cart);
            renderCart();
            showModal('Removed!', 'Item removed from cart.');
        }
        
        // --- Checkout Flow Functions ---
        function openCustomerDetailsModal() {
            const cart = getCart();
            const cartSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (cart.length === 0) {
                showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                return;
            }
            if (cartSubtotal < MIN_ORDER_VALUE) {
                showModal('Minimum Order Required', `The minimum order value is KES ${MIN_ORDER_VALUE.toFixed(2)}. Your current subtotal is KES ${cartSubtotal.toFixed(2)}.`);
                return;
            }

            if (!firebaseUser) {
                showModal('Login Required', 'Please log in or sign up to continue with your order.');
                openLoginModal();
                saveToLocalStorage('pendingCheckout', true); // Set flag to resume checkout after login
                return;
            }

            // Pre-fill customer details if logged in (Firebase user might not have all these details)
            // You might need to fetch custom user data from Firestore if you store phone/address there.
            document.getElementById('customer-full-name').value = firebaseUser.displayName || '';
            document.getElementById('customer-phone').value = firebaseUser.phoneNumber || '';
            // ID number and delivery location might not be stored in user profile by default,
            // so they remain empty for user to fill.

            customerDetailsModal.style.display = 'flex';
        }

        function closeCustomerDetailsModal() {
            customerDetailsModal.style.display = 'none';
            document.getElementById('checkout-form').reset(); // Clear form on close
        }

        function collectCustomerDetails(event) {
            event.preventDefault();
            const fullName = document.getElementById('customer-full-name').value;
            const idNumber = document.getElementById('customer-id').value;
            const phoneNumber = document.getElementById('customer-phone').value;
            const deliveryLocation = document.getElementById('customer-delivery-location').value;
            const houseName = document.getElementById('customer-house-name').value;

            if (!fullName || !idNumber || !phoneNumber || !deliveryLocation) {
                showModal('Missing Information', 'Please fill in all required customer details.');
                return;
            }

            // Basic phone number validation (Kenyan format 07XXXXXXXX)
            const phoneRegex = /^07[0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            const customerDetails = { fullName, idNumber, phoneNumber, deliveryLocation, houseName };
            saveToLocalStorage('lastCustomerDetails', customerDetails);
            
            closeCustomerDetailsModal();
            openPaymentMethodModal(customerDetails); // Pass customerDetails to the next step
        }

        function openPaymentMethodModal(customerDetails) {
            const currentCartSubtotal = getCart().reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            mpesaAmountSpan.textContent = grandTotal.toFixed(2); // Auto-fill Mpesa amount
            
            // Reset payment method selection to Mpesa by default
            document.querySelector('input[name="payment-method"][value="mpesa"]').checked = true;
            mpesaDetailsDiv.style.display = 'block';
            cardDetailsDiv.style.display = 'none';

            // Add event listener for radio button changes
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'mpesa') {
                        mpesaDetailsDiv.style.display = 'block';
                        cardDetailsDiv.style.display = 'none';
                    } else if (event.target.value === 'card') {
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'block';
                    } else { // Cash on Delivery
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'none';
                    }
                });
            });

            paymentMethodModal.style.display = 'flex';
        }

        function closePaymentMethodModal() {
            paymentMethodModal.style.display = 'none';
            document.getElementById('payment-form').reset(); // Clear form on close
        }

        function processPayment(event) {
            event.preventDefault();
            const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;
            const currentCartSubtotal = getCart().reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            const customerDetails = getFromLocalStorage('lastCustomerDetails', {});

            if (selectedMethod === 'mpesa') {
                const mpesaPhoneNumber = document.getElementById('mpesa-phone-number').value;
                const phoneRegex = /^07[0-9]{8}$/;
                if (!phoneRegex.test(mpesaPhoneNumber)) {
                    showModal('Invalid M-Pesa Number', 'Please enter a valid M-Pesa phone number starting with 07.');
                    return;
                }
                // Updated message for M-Pesa payment
                showModal('M-Pesa Payment', `Prompt successful! Check your phone (${mpesaPhoneNumber}) and enter your M-Pesa PIN to complete the payment of KES ${grandTotal.toFixed(2)}.`);
                // Simulate payment completion after a short delay
                setTimeout(() => {
                    placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
                }, 3000); // Simulate network delay
            } else if (selectedMethod === 'cash') {
                showModal('Cash on Delivery', 'Your order will be processed, and payment will be collected upon delivery. Thank you!');
                placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
            } else if (selectedMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;

                if (!cardNumber || !cardExpiry || !cardCvv) {
                    showModal('Missing Card Details', 'Please enter all card details.');
                    return;
                }
                // Basic mock validation for card details
                if (!/^[0-9]{16}$/.test(cardNumber) || !/^(0[1-9]|1[0-2])\/?([0-9]{2})$/.test(cardExpiry) || !/^[0-9]{3,4}$/.test(cardCvv)) {
                    showModal('Invalid Card Details', 'Please enter valid card number (16 digits), expiry (MM/YY), and CVV (3-4 digits).');
                    return;
                }

                showModal('Card Payment', `Processing your card payment of KES ${grandTotal.toFixed(2)}. This is a simulated transaction.`);
                // Simulate payment completion after a short delay
                setTimeout(() => {
                    placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
                }, 3000); // Simulate network delay
            }
            closePaymentMethodModal();
        }

        function placeOrderFinal(paymentMethod, customerDetails, transportationFee, grandTotal) {
            const cart = getCart();
            if (cart.length === 0) {
                showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                return;
            }
            
            // Deduct stock
            let products = getProducts();
            let stockProblem = false;
            cart.forEach(cartItem => {
                const productIndex = products.findIndex(p => p.id === cartItem.id);
                if (productIndex !== -1) {
                    if (products[productIndex].stock < cartItem.quantity) {
                        stockProblem = true;
                        showModal('Stock Error', `Not enough ${products[productIndex].name} in stock. Available: ${products[productIndex].stock}`);
                        return;
                    }
                    products[productIndex].stock -= cartItem.quantity;
                }
            });

            if (stockProblem) {
                return; // Stop order placement if stock is insufficient
            }
            saveProducts(products); // Save updated stock levels

            const orderId = 'PA' + Date.now().toString().slice(-6); // Simple unique ID
            const orders = getFromLocalStorage('orders', []);

            const newOrder = { 
                id: orderId, 
                items: cart, 
                status: 'Pending', 
                date: new Date().toLocaleString(),
                subtotal: grandTotal - transportationFee, // Store subtotal
                transportationFee: transportationFee,
                total: grandTotal, // Store grand total
                customer: customerDetails,
                paymentMethod: paymentMethod,
                userEmail: firebaseUser ? firebaseUser.email : null // Associate order with logged-in user
            };
            orders.push(newOrder);
            saveToLocalStorage('orders', orders);
            saveToLocalStorage('lastOrder', newOrder); // Save for confirmation page
            localStorage.removeItem('cart'); // Clear cart after order
            updateCartCount();
            showModal('Order Placed!', `Your order has been placed successfully! Your Order ID is: <strong>${orderId}</strong>.<br><br>Delivery will be done in the next 30 minutes to your pinned location!`);
            showPage('order-confirmation-page');
        }

        // --- Order Confirmation Page ---
        function displayLastOrderConfirmation() {
            const lastOrder = getFromLocalStorage('lastOrder', null);
            const lastOrderDetailsDiv = document.getElementById('last-order-details');
            if (lastOrder) {
                let itemsHtml = lastOrder.items.map(item => `<li>${item.name} (x${item.quantity}) - KES ${item.price.toFixed(2)} ${item.unit}</li>`).join('');
                lastOrderDetailsDiv.innerHTML = `
                    <h3>Thank You for Your Order!</h3>
                    <p>Order ID: <strong>${lastOrder.id}</strong></p>
                    <p>Status: <strong>${lastOrder.status}</strong></p>
                    <p>Date Placed: ${lastOrder.date}</p>
                    <p>Subtotal: <strong>KES ${lastOrder.subtotal.toFixed(2)}</strong></p>
                    <p>Transportation Fee: <strong>KES ${lastOrder.transportationFee.toFixed(2)}</strong></p>
                    <p>Grand Total: <strong>KES ${lastOrder.total.toFixed(2)}</strong></p>
                    <p>Payment Method: <strong>${lastOrder.paymentMethod}</strong></p>
                    <h4>Customer Details:</h4>
                    <ul>
                        <li>Name: ${lastOrder.customer.fullName}</li>
                        <li>Phone: ${lastOrder.customer.phoneNumber}</li>
                        <li>Delivery: ${lastOrder.customer.deliveryLocation}, ${lastOrder.customer.houseName || 'N/A'}</li>
                    </ul>
                    <h4>Items Ordered:</h4>
                    <ul>${itemsHtml}</ul>
                    <p>Delivery will be done in the next 30 minutes to your pinned location. Please be available to meet our rider!</p>
                    <button class="cta-button" onclick="showPage('track-order-page')">Track My Order</button>
                `;
            } else {
                lastOrderDetailsDiv.innerHTML = '<p>No recent order found. Please place an order first.</p>';
            }
        }

        // --- Order Tracking Simulation ---
        function trackOrder(event, orderId) {
            if (event) event.preventDefault();
            const orderIdInput = document.getElementById('order-id-input').value.trim();
            const statusDiv = document.getElementById('order-status');
            const idToTrack = orderId || orderIdInput;

            if (!idToTrack) {
                statusDiv.innerHTML = '<p style="color: red;">Please enter a valid Order ID.</p>';
                return;
            }

            const orders = getFromLocalStorage('orders', []);
            const order = orders.find(o => o.id === idToTrack);

            if (order) {
                statusDiv.innerHTML = `
                    <p>Order ID: <strong>${order.id}</strong></p>
                    <p>Status: <strong>${order.status}</strong></p>
                    <p>Date Placed: ${order.date}</p>
                    <p>Subtotal: KES ${order.subtotal.toFixed(2)}</p>
                    <p>Transportation Fee: KES ${order.transportationFee.toFixed(2)}</p>
                    <p>Grand Total: KES ${order.total.toFixed(2)}</p>
                    <p>Payment Method: ${order.paymentMethod}</p>
                    <p>Delivery to: ${order.customer.fullName}, ${order.customer.deliveryLocation}, ${order.customer.houseName || 'N/A'}</p>
                    <p>Your order is currently being processed and will be shipped soon. Thank you for your patience!</p>
                `;
            } else {
                statusDiv.innerHTML = '<p style="color: red;">Order not found. Please check your Order ID.</p>';
            }
        }
        
        // --- Contact Form ---
        function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            
            // Basic validation
            if (name && email && message) {
                const submissions = getFromLocalStorage('contactSubmissions', []);
                submissions.push({ name, email, message, date: new Date().toLocaleString() });
                saveToLocalStorage('contactSubmissions', submissions);
                showModal('Message Sent!', `Thank you, ${name}! Your message has been sent. We will get back to you shortly.`);
                document.querySelector('.contact-form').reset();
            } else {
                showModal('Error', 'Please fill out all fields.');
            }
        }

        // --- Newsletter Subscription ---
        function subscribeToNewsletter(event) {
            event.preventDefault();
            const email = document.getElementById('newsletter-email').value;
            if (email) {
                let subscriptions = getFromLocalStorage('newsletterSubscriptions', []);
                if (!subscriptions.includes(email)) {
                    subscriptions.push(email);
                    saveToLocalStorage('newsletterSubscriptions', subscriptions);
                    showModal('Subscribed!', `Thank you for subscribing, ${email}! You'll receive fresh updates.`);
                    document.querySelector('.newsletter-form').reset();
                } else {
                    showModal('Already Subscribed', 'This email is already subscribed to our newsletter.');
                }
            } else {
                showModal('Error', 'Please enter a valid email address.');
            }
        }

        // --- User Authentication UI Update ---
        function updateAuthUI() {
            if (firebaseUser) {
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="my-account">My Account (${firebaseUser.email})</a></li>`;
                accountUsernameSpan.textContent = firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
            } else {
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>`;
                accountUsernameSpan.textContent = 'Guest';
                profileEmailSpan.textContent = '';
            }
            // Re-attach event listener for the new link
            const newAuthLink = authLinkContainer.querySelector('.page-link');
            if (newAuthLink) {
                newAuthLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageData = newAuthLink.dataset.page;
                    if (pageData === 'login') {
                        openLoginModal();
                    } else if (pageData === 'my-account') {
                        showPage('my-account-page');
                    }
                });
            }
        }

        function openLoginModal() {
            closeSignupModal(); // Ensure signup modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            loginModal.style.display = 'flex';
            document.getElementById('login-form-modal').reset();
        }

        function closeLoginModal() {
            loginModal.style.display = 'none';
        }

        function openSignupModal() {
            closeLoginModal(); // Ensure login modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            signupModal.style.display = 'flex';
            document.getElementById('signup-form-modal').reset();
        }

        function closeSignupModal() {
            signupModal.style.display = 'none';
        }

        function openForgotPasswordModal() {
            closeLoginModal();
            forgotPasswordModal.style.display = 'flex';
            document.getElementById('forgot-password-form').reset();
        }

        function closeForgotPasswordModal() {
            forgotPasswordModal.style.display = 'none';
        }

        // This function would be for updating Firebase user profile (e.g., displayName, phoneNumber)
        // For simplicity, this mock only updates display name, not actual Firebase user data.
        // For real profile updates, use Firebase's updateProfile or updateEmail.
        function openEditProfileModal() {
            if (firebaseUser) {
                document.getElementById('edit-fullname').value = firebaseUser.displayName || '';
                document.getElementById('edit-email').value = firebaseUser.email || '';
                document.getElementById('edit-phone').value = firebaseUser.phoneNumber || ''; // Firebase phone number
                document.getElementById('edit-password').value = ''; // Password changes are separate in Firebase
                editProfileModal.style.display = 'flex';
            } else {
                showModal('Error', 'You must be logged in to edit your profile.');
            }
        }

        function closeEditProfileModal() {
            editProfileModal.style.display = 'none';
        }

        async function saveProfileDetails(event) {
            event.preventDefault();
            if (!firebaseUser) {
                showModal('Error', 'No user logged in.');
                return;
            }

            const newDisplayName = document.getElementById('edit-fullname').value;
            const newPhoneNumber = document.getElementById('edit-phone').value;
            const newPassword = document.getElementById('edit-password').value; // For password change

            const phoneRegex = /^07[0-9]{8}$/;
            if (newPhoneNumber && !phoneRegex.test(newPhoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            try {
                const updatePromises = [];
                if (newDisplayName !== (firebaseUser.displayName || '')) {
                    updatePromises.push(firebaseUser.updateProfile({ displayName: newDisplayName }));
                }
                // Firebase does not have a direct updatePhoneNumber method for the user object.
                // You'd typically store this in a Firestore user profile document.
                // For this mock, we'll just show a message.
                if (newPhoneNumber !== (firebaseUser.phoneNumber || '')) {
                    // This is a placeholder. In a real app, you'd update this in Firestore.
                    console.log("Phone number update requested:", newPhoneNumber);
                }
                if (newPassword) {
                    updatePromises.push(firebaseUser.updatePassword(newPassword));
                }

                await Promise.all(updatePromises);
                showModal('Profile Updated', 'Your profile details have been saved.');
                closeEditProfileModal();
                // onAuthStateChanged will re-trigger and update UI
            } catch (error) {
                showModal('Update Failed', 'Failed to update profile: ' + error.message);
                console.error("Profile update error:", error);
            }
        }

        function updateAccountPage() {
            if (firebaseUser) {
                accountUsernameSpan.textContent = firebaseUser.displayName || firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
            } else {
                showModal('Access Denied', 'Please log in to view your account details.');
                showPage('home-page');
            }
        }

        // Render user's past orders on My Account page
        function renderUserOrders() {
            const userOrdersListDiv = document.getElementById('user-orders-list');
            userOrdersListDiv.innerHTML = '';
            const allOrders = getFromLocalStorage('orders', []);

            if (!firebaseUser) {
                userOrdersListDiv.innerHTML = '<p style="text-align: center;">Please log in to view your past orders.</p>';
                return;
            }

            // Filter orders by the current Firebase user's email
            const userOrders = allOrders.filter(order => order.userEmail === firebaseUser.email);

            if (userOrders.length === 0) {
                userOrdersListDiv.innerHTML = '<p style="text-align: center;">You have no past orders.</p>';
                return;
            }

            // Sort orders by date, newest first
            userOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

            userOrders.forEach(order => {
                const listItem = document.createElement('div');
                listItem.className = 'admin-list-item'; // Reusing admin-list-item style
                const itemsSummary = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                listItem.innerHTML = `
                    <div>
                        <strong>Order ID: ${order.id}</strong><br>
                        Status: <span class="${order.status === 'Delivered' ? 'status-delivered' : ''}">${order.status}</span><br>
                        Date: ${order.date}<br>
                        Subtotal: KES ${order.subtotal.toFixed(2)}<br>
                        Transport Fee: KES ${order.transportationFee.toFixed(2)}<br>
                        Grand Total: KES ${order.total.toFixed(2)}<br>
                        Payment: ${order.paymentMethod}<br>
                        <span class="order-items-list">Items: ${itemsSummary}</span>
                    </div>
                `;
                userOrdersListDiv.appendChild(listItem);
            });
        }


        // --- Admin Panel (Simplified for this file) ---
        // Note: Admin login here is still a simple mock password.
        // For a real application, admin authentication should be handled securely,
        // e.g., by checking user roles in Firestore after Firebase login.
        const ADMIN_PASSWORD = 'admin'; 
        function loginAdmin() {
            const email = document.getElementById('admin-email')?.value; // Get email from input
            const password = document.getElementById('admin-password').value;

            // Simple mock check for admin, not using Firebase auth for this specific admin form
            if (email === 'admin@princealex.com' && password === ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                showModal('Admin Login', 'Welcome to the Admin Panel!');
                // These functions are not defined in this file, they would be in admin.html
                // renderAdminProducts();
                // renderAdminOrders();
                // renderAdminContactSubmissions();
            } else {
                showModal('Login Failed', 'Incorrect email or password.');
            }
        }

        // Admin: Add Product (mock, would ideally use Firestore)
        function addProduct(event) {
            event.preventDefault();
            const name = document.getElementById('product-name').value;
            const image = document.getElementById('product-image').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const unit = document.getElementById('product-unit').value;
            const rating = parseFloat(document.getElementById('product-rating').value);
            const badge = document.getElementById('product-badge').value;
            const stock = parseInt(document.getElementById('product-stock').value);
            const tagsInput = document.getElementById('product-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : [];
            const category = defaultProducts.find(p => p.name === name)?.category || 'misc'; // Simple category assignment

            if (name && image && description && price > 0 && unit && rating >= 1 && rating <= 5 && stock >= 0) {
                const products = getProducts();
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                // Admin can optionally set an originalPrice for offers
                const originalPrice = prompt("Enter original price if this is an offer (leave blank otherwise):");
                const newProduct = { 
                    id: newId, 
                    name, 
                    image, 
                    description, 
                    price, 
                    unit, 
                    rating, 
                    badge, 
                    stock, 
                    tags, 
                    category,
                    originalPrice: originalPrice ? parseFloat(originalPrice) : undefined
                };
                products.push(newProduct);
                saveProducts(products);
                showModal('Product Added', `Product "${name}" added successfully!`);
                document.querySelector('.admin-form').reset();
                renderProducts(); // Refresh the shop page with the new product
                // renderAdminProducts(); // This would be in admin.html
            } else {
                showModal('Error', 'Please fill out all fields correctly, including valid rating (1-5) and stock (>=0).');
            }
        }

        // Admin: Render Products for Management (mock, would be in admin.html)
        function renderAdminProducts() {
            const adminProductList = document.getElementById('admin-product-list');
            adminProductList.innerHTML = '<p style="text-align: center;">Product management functions are typically handled in the dedicated admin panel (admin.html).</p>';
        }

        // Admin: Delete Product (mock, would be in admin.html)
        function deleteProduct(productId) {
            showModal('Action Blocked', 'Product deletion is handled in the dedicated admin panel (admin.html).');
        }

        // Admin: Render Orders for Management (mock, would be in admin.html)
        function renderAdminOrders() {
            const adminOrderList = document.getElementById('admin-order-list');
            adminOrderList.innerHTML = '<p style="text-align: center;">Order management functions are typically handled in the dedicated admin panel (admin.html).</p>';
        }

        // Admin: Mark Order as Delivered (mock, would be in admin.html)
        function markOrderDelivered(orderId) {
            showModal('Action Blocked', 'Order status updates are handled in the dedicated admin panel (admin.html).');
        }

        // Admin: Render Contact Form Submissions (mock, would be in admin.html)
        function renderAdminContactSubmissions() {
            const adminContactSubmissions = document.getElementById('admin-contact-submissions');
            adminContactSubmissions.innerHTML = '<p style="text-align: center;">Contact submissions are managed in the dedicated admin panel (admin.html).</p>';
        }

        // Admin: Delete Contact Submission (mock, would be in admin.html)
        function deleteContactSubmission(index) {
            showModal('Action Blocked', 'Contact submission deletion is handled in the dedicated admin panel (admin.html).');
        }


        // --- Image Carousel Logic ---
        const heroImages = ['vegetable1.jpg', 'vegetable2.jpg', 'vegetable3.jpg'];
        let currentImageIndex = 0;

        function changeHeroImage() {
            const images = document.querySelectorAll('.hero-background-image');
            images.forEach((img, index) => {
                if (index === currentImageIndex) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            currentImageIndex = (currentImageIndex + 1) % heroImages.length;
        }

        // --- Google Maps Autocomplete Initialization ---
        // This function will be called by the Google Maps API script once it's loaded
        function initAutocomplete() {
            const deliveryLocationInput = document.getElementById('customer-delivery-location');
            if (deliveryLocationInput) {
                // Bias the search results towards Kenya (Nairobi coordinates for a general Kenya bias)
                const defaultBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(-4.8, 33.9), // Southwest corner of Kenya
                    new google.maps.LatLng(4.6, 41.9)  // Northeast corner of Kenya
                );

                const autocomplete = new google.maps.places.Autocomplete(deliveryLocationInput, {
                    bounds: defaultBounds,
                    componentRestrictions: { country: 'ke' }, // Restrict to Kenya
                    types: ['geocode', 'establishment'] // Suggest addresses and businesses
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        // User entered the name of a Place that was not suggested and pressed the Enter key.
                        console.log("No details available for input: '" + place.name + "'");
                        return;
                    }
                    // Set the input field's value to the selected place's formatted address
                    deliveryLocationInput.value = place.formatted_address;
                });
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            applyDarkModePreference();
            renderProducts();
            updateCartCount();
            // Check if there's a last order to display on confirmation page on load
            if (getFromLocalStorage('lastOrder', null)) {
                displayLastOrderConfirmation();
            }

            // Start image carousel
            changeHeroImage(); // Show first image immediately
            setInterval(changeHeroImage, 5000); // Change image every 5 seconds

            // Attach form submission listeners for modals
            document.getElementById('login-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email-modal').value;
                const password = document.getElementById('login-password-modal').value;
                await window.loginUser(email, password); // Call global Firebase login
            });

            document.getElementById('signup-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullname = document.getElementById('signup-fullname-modal').value;
                const email = document.getElementById('signup-email-modal').value;
                const phoneNumber = document.getElementById('signup-phone-modal').value;
                const password = document.getElementById('signup-password-modal').value;
                await window.registerUser(email, password, fullname, phoneNumber); // Call global Firebase register
            });
            
            document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                await window.resetPassword(email);
            });

            document.getElementById('edit-profile-form').addEventListener('submit', saveProfileDetails);
            document.getElementById('checkout-form').addEventListener('submit', collectCustomerDetails);

        });
    </script>
    <!-- Google Maps API Script -->
    <!-- IMPORTANT: Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API Key -->
    <!-- You can get one from the Google Cloud Console: https://console.cloud.google.com/apis/credentials -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initAutocomplete"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlS1nqRKolwc-7mySezN6XBcwk5p2Al4U",
    authDomain: "prince-alex-store.firebaseapp.com",
    projectId: "prince-alex-store",
    storageBucket: "prince-alex-store.firebasestorage.app",
    messagingSenderId: "266163776280",
    appId: "1:266163776280:web:fdd89c30f84ed03540cc6d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Expose Firebase functions globally for use in inline scripts and event listeners
  window.auth = auth; // Make auth object accessible
  window.db = db;     // Make db object accessible

  // Load products from Firestore (if you intend to use Firestore for products)
  // Currently, the main script uses localStorage for products.
  // If you want to use Firestore, you'd integrate this with renderProducts()
  async function loadProductsFromFirestore() {
    // This function is currently not called by the main script, as it uses localStorage.
    // If you enable it, ensure product data is consistent.
    const productList = document.getElementById("product-list");
    // productList.innerHTML = ""; // Uncomment if you want Firestore to control product display
    try {
        const querySnapshot = await getDocs(collection(db, "products"));
        querySnapshot.forEach((doc) => {
            const product = doc.data();
            // Example: Add product to a global array or render directly
            // This would replace/merge with your defaultProducts array
            console.log("Product from Firestore:", product.name);
        });
    } catch (error) {
        console.error("Error loading products from Firestore:", error);
    }
  }
  // loadProductsFromFirestore(); // Uncomment to enable Firestore product loading


  // Firebase Authentication Functions exposed globally
  window.registerUser = async function (email, password, fullname, phoneNumber) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      // Update user profile with display name and phone number
      await updateProfile(userCredential.user, {
        displayName: fullname,
        phoneNumber: phoneNumber // Note: Firebase Auth user object only stores email/displayName/photoURL directly. Phone number is typically stored in Firestore.
      });

      // Optional: Save additional user details to Firestore
      // await setDoc(doc(db, "users", userCredential.user.uid), {
      //   email: email,
      //   fullname: fullname,
      //   phoneNumber: phoneNumber,
      //   createdAt: new Date()
      // });

      showModal('Registration Successful!', `Welcome, ${fullname || email}! You are now logged in.`);
      closeSignupModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      showModal('Registration Failed', 'Error: ' + error.message);
      console.error("Registration error:", error);
    }
  };

  window.loginUser = async function (email, password) {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      showModal('Login Successful!', `Welcome back, ${auth.currentUser.displayName || auth.currentUser.email}!`);
      closeLoginModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      showModal('Login Failed', 'Login failed: ' + error.message);
      console.error("Login error:", error);
    }
  };

  window.logoutUser = async function () {
    try {
      await signOut(auth);
      showModal('Logged Out', 'You have been successfully logged out.');
      showPage('home-page'); // Redirect to home after logout
    } catch (error) {
      showModal('Logout Failed', 'Error logging out: ' + error.message);
      console.error("Logout error:", error);
    }
  };

  window.resetPassword = async function(email) {
    try {
        await sendPasswordResetEmail(auth, email);
        showModal('Password Reset', `A password reset link has been sent to ${email}. Please check your inbox.`);
        closeForgotPasswordModal();
        openLoginModal();
    } catch (error) {
        showModal('Password Reset Failed', 'Error sending reset email: ' + error.message);
        console.error("Password reset error:", error);
    }
  };

  // Admin login is a separate function, still using the hardcoded email for now.
  // For a production app, you'd manage admin roles within Firebase/Firestore.
  window.loginAdmin = async function () {
    const email = document.getElementById('admin-email')?.value || 'admin@princealex.com';
    const password = document.getElementById('admin-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      // You would add logic here to check if the logged-in user has admin privileges
      // For now, it simply hides the login and shows content
      document.getElementById('admin-login').style.display = 'none';
      document.getElementById('admin-content').style.display = 'block';
      showModal('Admin Login', 'Welcome to the Admin Panel!');
    } catch (error) {
      showModal('Admin Login Failed', 'Login failed: ' + error.message);
    }
  };


  // Firebase Auth State Listener
  onAuthStateChanged(auth, (user) => {
    firebaseUser = user; // Update the global firebaseUser variable
    updateAuthUI(); // Update UI based on auth state

    // Handle pending checkout after Firebase login
    if (user && getFromLocalStorage('pendingCheckout', false)) {
        localStorage.removeItem('pendingCheckout');
        openCustomerDetailsModal(); // Resume checkout
    }
  });

</script>

</body>
</html>
