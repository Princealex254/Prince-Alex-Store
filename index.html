<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Online Store - Farm Fresh Veggies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- AOS Animate On Scroll Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Fresh Green */
            --secondary-color: #8BC34A; /* Lighter Green */
            --accent-color-orange: #FF9800; /* Vibrant Orange */
            --accent-color-yellow: #FFC107; /* Sunny Yellow */
            --text-color: #333;
            --light-bg: #f9f9f9;
            --white: #fff;
            --shadow: 0 8px 16px rgba(0,0,0,0.1); /* Softer, larger shadow */
            --border-color: #e0e0e0; /* Lighter border */
            --dark-text: #222;
            --star-color: #FFD700; /* Gold for stars */
            --border-radius: 12px; /* Increased rounded corners */
            --input-bg: #f0f0f0;
            --promo-banner-bg: #FFEB3B; /* Yellow for promo */
            --promo-banner-text: #333;
            --flash-sale-bg: #F44336; /* Red for flash sale */
            --flash-sale-text: #fff;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #66BB6A;
            --secondary-color: #9CCC65;
            --accent-color-orange: #FFB74D;
            --accent-color-yellow: #FFEB3B;
            --text-color: #E0E0E0;
            --light-bg: #2C2C2C;
            --white: #3A3A3A;
            --shadow: 0 8px 20px rgba(0,0,0,0.6);
            --border-color: #555;
            --dark-text: #F0F0F0;
            --input-bg: #444;
            --promo-banner-bg: #FFB74D;
            --promo-banner-text: #222;
            --flash-sale-bg: #D32F2F;
            --flash-sale-text: #eee;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.4s, color 0.4s;
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            flex-shrink: 0; /* Prevent logo from shrinking */
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 30px; /* Increased gap */
            flex-grow: 1; /* Allow links to take available space */
            justify-content: center; /* Center links */
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            padding: 5px 0; /* Padding for underline effect */
            position: relative;
            transition: color 0.3s;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background-color: var(--primary-color);
            transition: width 0.3s ease-out;
        }

        .nav-links a:hover::after, .nav-links a.active::after {
            width: 100%;
        }

        .nav-icons {
            display: flex;
            gap: 20px; /* Increased gap */
            align-items: center;
        }

        .nav-icons span, .nav-icons button {
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px; /* Larger icons */
            transition: color 0.3s, transform 0.2s;
            padding: 5px; /* Added padding for touch targets */
        }
        .nav-icons span:hover, .nav-icons button:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        #cart-icon {
            position: relative;
        }
        #cart-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: var(--accent-color-orange);
            color: var(--white);
            font-size: 12px;
            border-radius: 50%;
            padding: 3px 7px;
            line-height: 1;
        }

        .hamburger-menu {
            display: none; /* Hidden on desktop */
            font-size: 28px;
            cursor: pointer;
            margin-left: 15px; /* Space between icons and hamburger */
        }

        /* Promo Banner */
        .promo-banner {
            background-color: var(--promo-banner-bg);
            color: var(--promo-banner-text);
            text-align: center;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 990; /* Below header, above main content */
            transition: background-color 0.3s, color 0.3s;
        }

        main {
            flex-grow: 1;
        }

        section {
            padding: 60px 0;
            display: none; /* Hide all pages by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        
        section.active {
            display: block; /* Show active page */
            opacity: 1;
            transform: translateY(0);
        }

        .hero {
            position: relative;
            text-align: center;
            padding: 100px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            overflow: hidden;
            height: 450px; /* Slightly taller hero */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--white); /* Text color for hero content */
            animation: heroFadeIn 1s ease-out;
        }
        @keyframes heroFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
        }
        .hero-background-image.active {
            opacity: 1;
        }
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(76,175,80,0.6), rgba(139,195,74,0.6)); /* Green gradient */
            z-index: 2;
        }
        body.dark-mode .hero-overlay {
            background: linear-gradient(to bottom, rgba(102,187,106,0.6), rgba(156,204,101,0.6));
        }

        .hero-content {
            position: relative;
            z-index: 3;
        }

        .hero h1 {
            font-size: 56px; /* Larger headline */
            color: var(--white);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero p {
            font-size: 22px;
            color: var(--white);
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .cta-button {
            background-color: var(--accent-color-orange); /* Orange CTA */
            color: var(--white);
            padding: 18px 35px; /* Larger padding */
            text-decoration: none;
            border-radius: 50px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: var(--shadow);
            display: inline-block; /* For transform */
        }

        .cta-button:hover {
            background-color: #e68900; /* Darker orange */
            transform: translateY(-3px);
        }

        .section-title {
            text-align: center;
            font-size: 42px; /* Larger titles */
            margin-bottom: 50px;
            color: var(--primary-color);
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -10px;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }
        
        /* Category Cards */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }
        .category-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .category-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 50%;
            background-color: var(--light-bg);
            padding: 5px;
        }
        .category-card h4 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .product-grid, .features-grid, .contact-info, .social-links, .about-content, .admin-orders-grid, .testimonial-carousel, .recommended-products-grid {
            display: grid;
            gap: 30px; /* Increased gap */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Min width increased */
        }
        .product-grid.list-view {
            grid-template-columns: 1fr;
        }

        .product-card, .feature-item, .order-card, .contact-submission-card, .testimonial-card, .loyalty-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px; /* Increased padding */
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
            position: relative; /* For badges */
            overflow: hidden; /* For image zoom effect */
        }
        .product-card:hover {
            transform: translateY(-8px); /* Deeper lift */
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }

        .product-grid.list-view .product-card {
            display: flex;
            flex-direction: row; /* Ensure row direction for list view */
            text-align: left;
            gap: 25px;
            align-items: center;
        }
        .product-grid.list-view .product-card img {
            width: 150px; /* Larger image in list view */
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            flex-shrink: 0;
        }
        .product-grid.list-view .product-card .product-info {
            flex-grow: 1;
        }
        .product-grid.list-view .product-card .product-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }

        .product-card img {
            width: 100%;
            height: 180px; /* Taller images */
            object-fit: cover;
            border-radius: calc(var(--border-radius) - 4px); /* Slightly smaller border radius */
            margin-bottom: 20px;
            transition: transform 0.3s ease-in-out; /* For zoom effect */
        }
        .product-card:hover img {
            transform: scale(1.05); /* Image zoom on hover */
        }

        .product-card h3 {
            font-size: 22px;
            margin-bottom: 8px;
            color: var(--dark-text);
        }

        .product-card .price {
            font-size: 20px;
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 12px;
        }
        .product-card .price del {
            color: #999;
            margin-right: 10px;
            font-size: 0.85em;
        }

        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: 8px; /* Slightly less rounded than card */
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
        }

        .add-to-cart-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .add-to-cart-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Product Icons on Hover */
        .product-card .hover-icons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s;
            z-index: 15;
        }
        .product-card:hover .hover-icons {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        .product-card .hover-icons i {
            font-size: 20px;
            color: var(--text-color);
            background-color: var(--white);
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: color 0.2s, background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .product-card .hover-icons i:hover {
            color: var(--primary-color);
            background-color: var(--light-bg);
            transform: scale(1.1);
        }
        .product-card .hover-icons .fa-heart.fas {
            color: #E91E63; /* Pink for liked heart */
        }
        body.dark-mode .product-card .hover-icons i {
            background-color: var(--dark-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .features-grid .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .features-grid .feature-item i {
            font-size: 60px; /* Larger icons */
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .features-grid .feature-item h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 24px;
        }
        .features-grid .feature-item p {
            font-size: 16px;
            line-height: 1.8;
        }

        .cart-table {
            width: 100%;
            border-collapse: separate; /* For rounded corners on cells */
            border-spacing: 0;
            margin-top: 20px;
            border-radius: var(--border-radius);
            overflow: hidden; /* Ensures rounded corners are visible */
            box-shadow: var(--shadow);
        }

        .cart-table th, .cart-table td {
            text-align: left;
            padding: 18px; /* More padding */
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-text);
        }
        .cart-table th {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
        }
        .cart-table tr:last-child td {
            border-bottom: none;
        }
        .cart-table tbody tr:nth-child(even) {
            background-color: var(--light-bg); /* Zebra striping */
        }
        body.dark-mode .cart-table tbody tr:nth-child(even) {
            background-color: #333;
        }

        .cart-item img {
            width: 70px; /* Larger image */
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px; /* Increased gap */
            background-color: var(--input-bg);
            border-radius: 8px;
            padding: 5px;
        }
        
        .quantity-controls button {
            background-color: var(--primary-color);
            border: none;
            width: 35px; /* Larger buttons */
            height: 35px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s, transform 0.2s;
            color: var(--white);
            font-size: 18px;
        }
        .quantity-controls button:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }
        .quantity-controls span {
            font-weight: 600;
            color: var(--dark-text);
            min-width: 25px; /* Ensure space for quantity numbers */
            text-align: center;
        }
        
        .cart-summary-totals {
            text-align: right;
            margin-top: 30px;
            color: var(--dark-text);
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .cart-summary-totals div {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .cart-summary-totals .cart-total-grand {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 20px;
        }

        .checkout-btn {
            display: block;
            margin-top: 30px;
            width: 100%;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 18px; /* Larger padding */
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 700;
            box-shadow: var(--shadow);
        }
        
        .checkout-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .forms-container, .contact-form-container, .admin-panel-login, .auth-modal-content, .newsletter-modal-content {
            max-width: 650px; /* Slightly wider forms */
            margin: 0 auto;
            background-color: var(--white);
            padding: 40px; /* More padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .admin-form input, .admin-form textarea, .contact-form input, .contact-form textarea, .order-track-form input, .admin-panel-login input, .checkout-form input, .payment-form input, .auth-form input, .add-review-form input, .add-review-form textarea, .newsletter-form input, .loyalty-form input {
            width: 100%;
            padding: 15px; /* Larger inputs */
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .admin-form input:focus, .admin-form textarea:focus, .contact-form input:focus, .contact-form textarea:focus, .order-track-form input:focus, .admin-panel-login input:focus, .checkout-form input:focus, .payment-form input:focus, .auth-form input:focus, .add-review-form input:focus, .add-review-form textarea:focus, .newsletter-form input:focus, .loyalty-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76,175,80,0.3); /* Focus glow */
        }
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap */
            margin-bottom: 25px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: var(--light-bg);
            padding: 20px; /* Larger touch area */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.2s;
        }
        .payment-option:hover {
            background-color: #e8e8e8;
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .payment-option input[type="radio"] {
            width: 20px; /* Larger radio button */
            height: 20px;
            accent-color: var(--primary-color);
            margin-bottom: 0;
            flex-shrink: 0;
        }
        body.dark-mode .payment-option:hover {
            background-color: #444;
        }

        .admin-form button, .contact-form button, .order-track-form button, .admin-panel-login button, .checkout-form button, .payment-form button, .auth-form button, .newsletter-form button, .add-review-form button, .loyalty-form button {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: var(--shadow);
        }

        .admin-form button:hover, .contact-form button:hover, .order-track-form button:hover, .admin-panel-login button:hover, .checkout-form button:hover, .payment-form button:hover, .auth-form button:hover, .newsletter-form button:hover, .add-review-form button:hover, .loyalty-form button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #order-status {
            text-align: center;
            font-size: 22px;
            margin-top: 30px;
            color: var(--dark-text);
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        #order-status strong {
            color: var(--primary-color);
        }

        .map-container {
            height: 450px; /* Taller map */
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        /* START Footer Redesign CSS */
        footer {
            background-color: #111; /* Dark background */
            color: #aaa; /* Light gray text */
            margin-top: auto;
            transition: background-color 0.3s;
            padding: 0; /* Remove padding from footer itself, add to sections */
        }

        body.dark-mode footer {
            background-color: #000; /* Even darker in dark mode for contrast */
            color: #bbb;
        }

        .footer-main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjusted min-width for 3 columns */
            gap: 20px; /* Reduced gap */
            padding: 20px 0; /* Reduced padding */
        }

        .footer-column {
            display: flex; /* For centering content on mobile */
            flex-direction: column; /* For stacking content */
            align-items: flex-start; /* Align left by default */
        }

        .footer-column h4 {
            margin-bottom: 10px; /* Reduced margin */
            color: var(--primary-color);
            font-size: 16px; /* Smaller headings */
        }

        .footer-column p,
        .footer-column a {
            color: #aaa; /* Consistent light gray text for links and paragraphs */
            text-decoration: none;
            display: block;
            margin-bottom: 5px; /* Reduced margin */
            transition: color 0.3s;
            font-size: 14px; /* Smaller text/links */
            line-height: 1.5;
        }
        
        .footer-column a:hover {
            color: var(--primary-color); /* Highlight with brand green */
        }

        .footer-column:nth-child(1) p { /* Brand/About column */
            max-width: 90%; /* Prevent text from being too wide */
        }

        .social-links {
            display: flex;
            gap: 15px; /* Reduced gap */
            margin-top: 10px;
        }
        
        .social-links a {
            font-size: 20px; /* Adjusted icon size */
            color: #aaa; /* Consistent color for social icons */
            transition: color 0.3s, transform 0.2s;
        }

        .social-links a:hover {
            color: var(--primary-color);
            transform: translateY(-2px); /* Subtle lift */
        }

        /* Slim bottom bar with copyright */
        .footer-bottom-bar {
            background-color: #0a0a0a; /* Slightly darker */
            color: #888; /* Slightly darker gray text */
            padding: 10px 0; /* Slim padding */
            text-align: center;
            font-size: 12px; /* Small font size */
            border-top: 1px solid #222; /* Subtle top border */
        }
        body.dark-mode .footer-bottom-bar {
            background-color: #050505;
            border-top-color: #333;
        }
        /* END Footer Redesign CSS */


        .whatsapp-widget {
            position: fixed;
            bottom: 25px; /* Slightly higher */
            right: 25px; /* Slightly more inwards */
            z-index: 1000;
        }
        .whatsapp-widget a {
            background-color: #25D366;
            color: var(--white);
            padding: 18px; /* Larger button */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            font-size: 28px; /* Larger icon */
            text-decoration: none;
            transition: transform 0.3s;
        }
        .whatsapp-widget a:hover {
            transform: scale(1.15); /* More prominent hover */
        }

        /* Custom Message Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* Blurred background */
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%; /* Wider on small screens */
            max-width: 550px; /* Max width */
            text-align: center;
            position: relative;
            transform: translateY(-50px);
            opacity: 0;
            animation: fadeInDown 0.4s forwards;
            color: var(--dark-text);
        }

        @keyframes fadeInDown {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 28px;
        }

        .modal-content p {
            margin-bottom: 25px;
            font-size: 18px;
            line-height: 1.7;
        }

        .modal-content button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
            box-shadow: none; /* Inherit button style, no double shadow */
        }

        .modal-content button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.3s;
        }
        .close-button:hover {
            color: #f44336; /* Red on hover for close */
            transform: rotate(90deg);
        }

        /* Newsletter Popup */
        #newsletter-popup.modal .modal-content {
            max-width: 600px;
        }
        #newsletter-popup h3 {
            font-size: 32px;
            color: var(--accent-color-orange);
        }
        #newsletter-popup p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        #newsletter-popup .newsletter-form button {
            background-color: var(--accent-color-orange);
        }
        #newsletter-popup .newsletter-form button:hover {
            background-color: #e68900;
        }


        /* Order Confirmation Page Specific Styling */
        #order-confirmation-page .order-details {
            background-color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            color: var(--dark-text);
        }
        #order-confirmation-page .order-details h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 32px;
        }
        #order-confirmation-page .order-details p {
            margin-bottom: 15px;
            font-size: 18px;
        }
        #order-confirmation-page .order-details strong {
            color: var(--primary-color);
        }
        #order-confirmation-page .order-details ul {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }
        #order-confirmation-page .order-details ul li {
            margin-bottom: 5px;
        }

        /* Product Sorting and Filter Bar */
        .shop-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* Increased gap */
            margin-bottom: 40px;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .shop-controls input, .shop-controls select {
            padding: 12px; /* Larger controls */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
            flex-grow: 1; /* Allow input/select to grow */
            min-width: 180px; /* Minimum width for inputs */
        }
        .shop-controls button {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
            box-shadow: none; /* No extra shadow on buttons in filter bar */
        }
        .shop-controls button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .shop-controls button.active-view {
            background-color: var(--accent-color-orange); /* Highlight active view button */
        }

        /* Admin Panel - Orders and Products List */
        .admin-section {
            margin-top: 40px;
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            color: var(--dark-text);
        }
        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 28px;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0; /* More padding */
            border-bottom: 1px solid var(--border-color);
        }
        .admin-list-item:last-child {
            border-bottom: none;
        }
        .admin-list-item button {
            padding: 10px 18px; /* Larger buttons */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 15px;
            font-weight: 600;
            box-shadow: none;
        }
        .admin-list-item button:hover {
            transform: translateY(-2px);
        }
        .admin-list-item .delete-btn {
            background-color: #f44336;
            color: var(--white);
            border: none;
        }
        .admin-list-item .delete-btn:hover {
            background-color: #d32f2f;
        }
        .admin-list-item .mark-delivered-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
        }
        .admin-list-item .mark-delivered-btn:hover {
            background-color: var(--secondary-color);
        }
        .admin-list-item .status-delivered {
            color: var(--primary-color);
            font-weight: 700;
        }
        .admin-list-item .order-items-list {
            font-size: 0.95em;
            color: #666;
            margin-top: 5px;
            display: block; /* Ensure it's on a new line */
        }
        body.dark-mode .admin-list-item .order-items-list {
            color: #ccc;
        }

        /* Product Ratings */
        .product-rating {
            color: var(--star-color);
            margin-bottom: 10px;
            font-size: 1.2em; /* Slightly larger stars */
        }
        .product-rating .far { /* Empty star */
            color: #ccc;
        }

        /* Product Badges */
        .product-badge {
            position: absolute;
            top: 15px; /* Slightly more inside */
            left: 15px;
            background-color: var(--primary-color);
            color: var(--white);
            padding: 6px 12px; /* Larger badge */
            border-radius: 6px; /* Less rounded for badges */
            font-size: 0.85em;
            font-weight: 700;
            z-index: 10;
            animation: badgeBounce 0.8s ease-out infinite alternate; /* Subtle bounce */
            transform-origin: bottom;
        }
        @keyframes badgeBounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.03); }
        }
        .product-badge.new { background-color: #2196F3; } /* Blue */
        .product-badge.bestseller { background-color: var(--accent-color-yellow); } /* Amber */
        .product-badge.organic { background-color: #4CAF50; } /* Green */
        .product-badge.discount { background-color: #F44336; animation: none; } /* Red, no bounce for discount */
        .product-badge.discount::before {
            content: '-';
            margin-right: 2px;
        }

        /* Stock Indicator */
        .stock-indicator {
            font-size: 1em;
            margin-top: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .stock-indicator.in-stock { color: var(--primary-color); }
        .stock-indicator.sold-out { color: #f44336; }

        /* Quick View Modal */
        #quick-view-modal .modal-content {
            max-width: 900px; /* Wider modal */
            display: flex;
            flex-direction: column;
            gap: 30px;
            text-align: left;
        }
        #quick-view-modal .modal-content .product-details {
            display: flex;
            gap: 30px;
        }
        #quick-view-modal .modal-content .product-details img {
            width: 50%;
            max-width: 400px;
            height: auto;
            border-radius: var(--border-radius);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #quick-view-modal .modal-content .product-info-qv {
            flex-grow: 1;
        }
        #quick-view-modal .modal-content h3 {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary-color);
        }
        #quick-view-modal .modal-content .price-qv {
            font-size: 26px;
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 20px;
        }
        #quick-view-modal .modal-content .price-qv del {
            color: #999;
            margin-right: 12px;
            font-size: 0.8em;
        }
        #quick-view-modal .modal-content .description-qv {
            margin-bottom: 25px;
            color: var(--dark-text);
            line-height: 1.7;
        }
        #quick-view-modal .modal-content .add-to-cart-btn-qv {
            width: auto;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
        }
        #quick-view-modal .modal-content .product-tags {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #quick-view-modal .modal-content .product-tag {
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .reviews-section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
            text-align: left;
        }
        .reviews-section h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }
        .review-item {
            background-color: var(--light-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .review-item strong {
            color: var(--dark-text);
        }
        .review-item .review-rating {
            color: var(--star-color);
            font-size: 1em;
            margin-left: 10px;
        }
        .add-review-form button {
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
            box-shadow: none;
        }

        /* Recommended Products */
        .recommended-products-grid {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 40px;
        }
        .recommended-products-grid h4 {
            text-align: center;
            font-size: 26px;
            color: var(--primary-color);
            margin-bottom: 30px;
            grid-column: 1 / -1; /* Span all columns */
        }


        /* My Account Page Styling */
        #my-account-page .account-section {
            background-color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            color: var(--dark-text);
        }

        #my-account-page .account-section h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 28px;
        }

        #my-account-page .account-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        #my-account-page .profile-info-card {
            background-color: var(--light-bg);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #my-account-page .profile-info-card p {
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        #my-account-page .profile-info-card strong {
            color: var(--primary-color);
        }

        #my-account-page .account-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
        }

        #my-account-page .account-buttons .cta-button {
            width: auto;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
        }
        #my-account-page .account-buttons .cta-button.logout-btn {
            background-color: #f44336;
        }
        #my-account-page .account-buttons .cta-button.logout-btn:hover {
            background-color: #d32f2f;
        }
        /* Loyalty Program Card */
        .loyalty-card {
            padding: 30px;
            text-align: center;
        }
        .loyalty-card h4 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .loyalty-card .points {
            font-size: 3em;
            font-weight: 700;
            color: var(--accent-color-orange);
            margin-bottom: 10px;
        }
        .loyalty-card p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        .loyalty-card button {
            width: auto;
            padding: 12px 25px;
        }

        /* Testimonials Carousel */
        .testimonial-carousel-wrapper {
            position: relative;
            padding: 0 20px; /* Space for nav buttons */
            margin-bottom: 60px;
        }
        .testimonial-carousel {
            grid-template-columns: 1fr; /* Only one testimonial visible at a time */
            overflow: hidden;
            scroll-behavior: smooth;
            padding-bottom: 20px; /* Space for indicators */
        }
        .testimonial-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin: 0 10px; /* Space between cards, hidden by overflow */
            flex-shrink: 0; /* Prevent cards from shrinking */
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0; /* Start hidden for JS handling */
            transition: opacity 0.5s ease-in-out;
        }
        .testimonial-card.active {
            opacity: 1;
        }

        .testimonial-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .testimonial-card p {
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--dark-text);
        }
        .testimonial-card strong {
            color: var(--primary-color);
            font-size: 1.2em;
        }

        .carousel-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 15px 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, transform 0.2s;
            z-index: 50;
        }
        .carousel-nav-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-50%) scale(1.05);
        }
        .carousel-nav-btn.left { left: 0; }
        .carousel-nav-btn.right { right: 0; }

        .testimonial-indicators {
            text-align: center;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .testimonial-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .testimonial-indicator.active {
            background-color: var(--primary-color);
        }

        /* Payment Icons */
        .payment-icons {
            text-align: center;
            margin-top: 60px;
            padding: 30px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .payment-icons h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 28px;
        }
        .payment-icons .icon-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        .payment-icons i {
            font-size: 50px; /* Larger icons */
            color: var(--text-color);
            transition: color 0.3s, transform 0.2s;
        }
        .payment-icons i:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        /* Specific colors for some payment methods for visual recognition */
        .payment-icons .fa-cc-visa { color: #1a2c8c; }
        .payment-icons .fa-cc-mastercard { color: #eb001b; }
        .payment-icons .fa-cc-paypal { color: #0070ba; }
        .payment-icons .fa-mobile-alt { color: #25D366; } /* M-Pesa like green */


        /* Slide-in Cart Preview */
        .cart-preview-sidebar {
            position: fixed;
            top: 0;
            right: -400px; /* Hidden by default */
            width: 380px; /* Width of the sidebar */
            height: 100%;
            background-color: var(--white);
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            z-index: 1500;
            transition: right 0.4s ease-out;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .cart-preview-sidebar.active {
            right: 0;
        }
        .cart-preview-sidebar h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        .cart-preview-sidebar .close-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 28px;
            padding: 5px;
            color: var(--text-color);
            background: none;
            box-shadow: none;
        }
        .cart-preview-sidebar .cart-preview-items {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar */
        }
        .cart-preview-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .cart-preview-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .cart-preview-item img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .cart-preview-item-info {
            flex-grow: 1;
            text-align: left;
            color: var(--dark-text);
        }
        .cart-preview-item-info h4 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .cart-preview-item-info p {
            font-size: 0.9em;
            color: #666;
        }
        .cart-preview-totals {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: right;
            color: var(--dark-text);
        }
        .cart-preview-totals p {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .cart-preview-totals .total {
            font-weight: 700;
            font-size: 1.3em;
            color: var(--primary-color);
        }
        .cart-preview-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .cart-preview-actions button {
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: none;
            width: 100%;
        }
        .cart-preview-actions .view-cart-btn {
            background-color: var(--accent-color-orange);
        }
        .cart-preview-actions .view-cart-btn:hover {
            background-color: #e68900;
        }
        .cart-preview-actions .checkout-preview-btn {
            background-color: var(--primary-color);
        }
        .cart-preview-actions .checkout-preview-btn:hover {
            background-color: var(--secondary-color);
        }
        .cart-preview-empty {
            text-align: center;
            color: #666;
            margin-top: 50px;
        }
        
        /* Flash Sale Timer */
        .flash-sale-banner {
            background-color: var(--flash-sale-bg);
            color: var(--flash-sale-text);
            text-align: center;
            padding: 15px 20px;
            margin-top: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .flash-sale-banner h3 {
            color: var(--flash-sale-text);
            font-size: 28px;
            margin-bottom: 0;
        }
        .flash-sale-banner .countdown {
            display: flex;
            gap: 15px;
            font-size: 2em;
            font-weight: 700;
        }
        .flash-sale-banner .countdown span {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }
        .flash-sale-banner .countdown span small {
            font-size: 0.4em;
            font-weight: 400;
            opacity: 0.8;
        }

        /* Sticky Bottom Navigation for Mobile */
        .bottom-nav {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            transition: background-color 0.3s;
        }
        .bottom-nav a {
            flex: 1;
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 14px;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }
        .bottom-nav a i {
            font-size: 22px;
            transition: color 0.3s;
        }
        .bottom-nav a:hover, .bottom-nav a.active {
            color: var(--primary-color);
        }
        .bottom-nav a:hover i, .bottom-nav a.active i {
            color: var(--primary-color);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .nav-links {
                display: none; /* Hide by default on mobile */
                flex-direction: column;
                width: 100%;
                background-color: var(--white);
                position: absolute;
                top: 65px; /* Adjust based on header height */
                left: 0;
                box-shadow: var(--shadow);
                padding: 20px 0;
                text-align: center;
                transition: transform 0.3s ease-out;
                transform: translateY(-100%); /* Slide up when inactive */
                z-index: 999;
            }
            .nav-links.active {
                display: flex; /* Show when active */
                transform: translateY(0%); /* Slide down */
            }
            .nav-links li {
                margin-bottom: 15px;
            }
            .hamburger-menu {
                display: block; /* Show hamburger on mobile */
            }
            nav {
                flex-wrap: nowrap; /* Prevent wrapping in mobile nav */
                justify-content: space-between;
            }
            .nav-icons {
                margin-left: auto; /* Push icons to right */
            }
            .logo {
                margin-right: auto; /* Push logo to left */
            }
            
            .hero {
                padding: 60px 20px;
                height: 350px;
            }
            .hero h1 {
                font-size: 38px;
            }
            .hero p {
                font-size: 18px;
            }
            .section-title {
                font-size: 32px;
            }
            .product-grid, .features-grid, .admin-orders-grid, .recommended-products-grid {
                grid-template-columns: 1fr;
            }
            .footer-main-content {
                grid-template-columns: 1fr; /* Stack columns on mobile */
                text-align: center;
            }
            .footer-column {
                align-items: center; /* Center content in stacked columns */
            }
            .footer-column:nth-child(1) p {
                max-width: 100%; /* Allow full width for text */
            }
            .social-links {
                justify-content: center;
            }
            .shop-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .shop-controls input, .shop-controls select, .shop-controls button {
                width: 100%;
            }
            #quick-view-modal .modal-content .product-details {
                flex-direction: column;
                align-items: center;
            }
            #quick-view-modal .modal-content .product-details img {
                width: 100%;
                max-width: 100%;
            }
            .product-grid.list-view .product-card {
                flex-direction: column;
                text-align: center;
            }
            .product-grid.list-view .product-card .product-actions {
                align-items: center;
            }
            #my-account-page .account-details-grid {
                grid-template-columns: 1fr;
            }
            #my-account-page .account-buttons {
                flex-direction: column;
                gap: 15px;
            }
            .cart-preview-sidebar {
                width: 100%; /* Full width on mobile */
                right: -100%;
            }
            .cart-preview-sidebar.active {
                right: 0;
            }
            .bottom-nav {
                display: flex; /* Show on mobile */
            }
            body {
                padding-bottom: 70px; /* Space for sticky bottom nav */
            }
            .promo-banner {
                position: relative; /* Make it flow with content on small screens */
                top: auto;
            }
        }
        @media (max-width: 480px) {
            .logo { font-size: 24px; }
            .nav-icons span, .nav-icons button, .hamburger-menu { font-size: 22px; }
            .hero h1 { font-size: 32px; }
            .hero p { font-size: 16px; }
            .section-title { font-size: 28px; }
            .cta-button { padding: 12px 25px; font-size: 16px; }
            .modal-content { padding: 25px; }
            .modal-content h3 { font-size: 24px; }
            .modal-content p { font-size: 15px; }
            .flash-sale-banner h3 { font-size: 22px; }
            .flash-sale-banner .countdown { font-size: 1.5em; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">Prince Alex Store</div>
                <ul class="nav-links" id="nav-links">
                    <li><a href="#" class="page-link active" data-page="home">Home</a></li>
                    <li><a href="#" class="page-link" data-page="shop">Shop</a></li>
                    <li><a href="#" class="page-link" data-page="cart">Cart</a></li>
                    <li><a href="#" class="page-link" data-page="track-order">Track Order</a></li>
                    <li><a href="#" class="page-link" data-page="contact">Contact Us</a></li>
                    <li><a href="#" class="page-link" data-page="about">About Us</a></li>
                    <li id="auth-link-container"><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>
                </ul>
                <div class="nav-icons">
                    <span id="cart-icon"><i class="fas fa-shopping-cart"></i><span id="cart-count">0</span></span>
                    <button id="dark-mode-toggle"><i class="fas fa-moon"></i></button>
                    <span class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></span>
                </div>
            </nav>
        </div>
    </header>

    <div class="promo-banner" id="promo-banner">
        Free Delivery on orders above KES 2,000! Limited Time Offer!
    </div>

    <main class="container">
        
        <!-- Home Page -->
        <section id="home-page" class="active">
            <div class="hero">
                <img src="https://placehold.co/1200x450/4CAF50/ffffff?text=Fresh+Veggies+1" alt="Fresh Vegetables 1" class="hero-background-image active">
                <img src="https://placehold.co/1200x450/8BC34A/ffffff?text=Healthy+Farm+Produce" alt="Fresh Vegetables 2" class="hero-background-image">
                <img src="https://placehold.co/1200x450/4CAF50/ffffff?text=Delivered+to+Your+Door" alt="Fresh Vegetables 3" class="hero-background-image">
                <div class="hero-overlay"></div>
                <div class="hero-content">
                    <h1>Farm Fresh Vegetables, Delivered to Your Door!</h1>
                    <p>Order fresh veggies today and taste the difference.</p>
                    <a href="#" class="cta-button page-link" data-page="shop">Shop Now</a>
                </div>
            </div>

            <div class="flash-sale-banner" data-aos="fade-up">
                <h3>Flash Sale! 20% Off All Leafy Greens!</h3>
                <div class="countdown" id="flash-sale-countdown">
                    <span><span id="countdown-days">00</span><small>Days</small></span>
                    <span><span id="countdown-hours">00</span><small>Hours</small></span>
                    <span><span id="countdown-minutes">00</span><small>Minutes</small></span>
                    <span><span id="countdown-seconds">00</span><small>Seconds</small></span>
                </div>
            </div>

            <h2 class="section-title" data-aos="fade-up">Why Choose Us?</h2>
            <div class="features-grid">
                <div class="feature-item" data-aos="fade-up" data-aos-delay="100">
                    <i class="fas fa-seedling"></i>
                    <h4>Farm Fresh</h4>
                    <p>Harvested daily to ensure maximum freshness and nutrition.</p>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="200">
                    <i class="fas fa-leaf"></i>
                    <h4>Organic & Healthy</h4>
                    <p>Grown without harmful chemicals, just as nature intended.</p>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="300">
                    <i class="fas fa-truck"></i>
                    <h4>Fast Delivery</h4>
                    <p>Quick and reliable delivery across all major Kenyan counties.</p>
                </div>
            </div>

            <h2 class="section-title" data-aos="fade-up">What Our Customers Say</h2>
            <div class="testimonial-carousel-wrapper" data-aos="fade-up">
                <div class="testimonial-carousel" id="testimonial-carousel">
                    <!-- Testimonials will be dynamically loaded here -->
                </div>
                <button class="carousel-nav-btn left" id="testimonial-prev-btn"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-nav-btn right" id="testimonial-next-btn"><i class="fas fa-chevron-right"></i></button>
                <div class="testimonial-indicators" id="testimonial-indicators"></div>
            </div>

            <div class="payment-icons" data-aos="fade-up">
                <h3>Trusted Payment Methods</h3>
                <div class="icon-list">
                    <i class="fab fa-cc-visa" title="Visa"></i>
                    <i class="fab fa-cc-mastercard" title="MasterCard"></i>
                    <i class="fas fa-mobile-alt" title="M-Pesa"></i> <!-- Using mobile-alt for M-Pesa -->
                    <i class="fab fa-cc-paypal" title="PayPal"></i>
                    <!-- Add more payment icons as needed -->
                </div>
            </div>

        </section>

        <!-- Shop Page -->
        <section id="shop-page">
            <h2 class="section-title" data-aos="fade-down">Our Fresh Products</h2>
            
            <h3 class="section-title" style="font-size: 28px; margin-bottom: 30px;">Shop by Category</h3>
            <div class="category-grid" data-aos="fade-up">
                <div class="category-card" onclick="filterProductsByCategory('Leafy Greens')">
                    <img src="https://placehold.co/80x80/9CCC65/ffffff?text=Leaf" alt="Leafy Greens">
                    <h4>Leafy Greens</h4>
                </div>
                <div class="category-card" onclick="filterProductsByCategory('Fruits')">
                    <img src="https://placehold.co/80x80/FFB74D/ffffff?text=Fruit" alt="Fruits">
                    <h4>Fruits</h4>
                </div>
                <div class="category-card" onclick="filterProductsByCategory('Roots')">
                    <img src="https://placehold.co/80x80/B0BEC5/ffffff?text=Root" alt="Roots">
                    <h4>Roots</h4>
                </div>
                <div class="category-card" onclick="filterProductsByCategory('Cruciferous')">
                    <img src="https://placehold.co/80x80/81C784/ffffff?text=Cabbage" alt="Cruciferous">
                    <h4>Cruciferous</h4>
                </div>
                <div class="category-card" onclick="filterProductsByCategory('Herbs')">
                    <img src="https://placehold.co/80x80/AED581/ffffff?text=Herb" alt="Herbs">
                    <h4>Herbs</h4>
                </div>
                <div class="category-card" onclick="filterProductsByCategory('')">
                    <img src="https://placehold.co/80x80/cccccc/333333?text=All" alt="All Products">
                    <h4>All Products</h4>
                </div>
            </div>

            <div class="shop-controls" data-aos="fade-up">
                <input type="text" id="search-input" placeholder="Search for veggies...">
                <button onclick="filterProducts()">Search</button>
                <select id="sort-by" onchange="sortProducts()">
                    <option value="">Sort By</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="price-asc">Price (Low to High)</option>
                    <option value="price-desc">Price (High to Low)</option>
                </select>
                <select id="filter-category" onchange="filterProducts()">
                    <option value="">All Categories</option>
                    <option value="leafy greens">Leafy Greens</option>
                    <option value="fruits">Fruits</option>
                    <option value="roots">Roots</option>
                    <option value="cruciferous">Cruciferous</option>
                    <option value="herbs">Herbs</option>
                </select>
                <button onclick="toggleView('grid')" id="grid-view-btn" class="active-view"><i class="fas fa-th-large"></i> Grid View</button>
                <button onclick="toggleView('list')" id="list-view-btn"><i class="fas fa-list"></i> List View</button>
            </div>
            <div class="product-grid" id="product-list" data-aos="fade-up">
                <!-- Products will be dynamically loaded here -->
                <p style="text-align: center; width: 100%;">Loading products...</p>
            </div>
        </section>

        <!-- Cart Page -->
        <section id="cart-page">
            <h2 class="section-title" data-aos="fade-down">Your Shopping Cart</h2>
            <div id="cart-container" data-aos="fade-up">
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        <!-- Cart items will be dynamically loaded here -->
                    </tbody>
                </table>
                <div id="cart-summary">
                    <div class="cart-summary-totals">
                        <div>Subtotal: KES <span id="cart-subtotal-price">0.00</span></div>
                        <div>Transportation Fee: KES <span id="cart-transport-fee">0.00</span></div>
                        <div class="cart-total-grand">Grand Total: KES <span id="cart-grand-total-price">0.00</span></div>
                    </div>
                    <button class="checkout-btn" onclick="openCustomerDetailsModal()">Place Order</button>
                </div>
            </div>
        </section>

        <!-- Order Confirmation Page -->
        <section id="order-confirmation-page">
            <h2 class="section-title" data-aos="fade-down">Order Confirmed!</h2>
            <div class="order-details" id="last-order-details" data-aos="fade-up">
                <p>Your order details will appear here.</p>
            </div>
        </section>

        <!-- Order Tracking Page -->
        <section id="track-order-page">
            <h2 class="section-title" data-aos="fade-down">Track Your Order</h2>
            <div class="forms-container" data-aos="fade-up">
                <form class="order-track-form" onsubmit="trackOrder(event)">
                    <input type="text" id="order-id-input" placeholder="Enter your Order ID" required>
                    <button type="submit">Track Order</button>
                </form>
                <div id="order-status"></div>
            </div>
        </section>

        <!-- Contact Us Page -->
        <section id="contact-page">
            <h2 class="section-title" data-aos="fade-down">Get in Touch</h2>
            <div class="contact-form-container" data-aos="fade-up">
                <form class="contact-form" onsubmit="submitContactForm(event)">
                    <input type="text" id="contact-name" placeholder="Your Name" required>
                    <input type="email" id="contact-email" placeholder="Your Email" required>
                    <textarea id="contact-message" rows="5" placeholder="Your Message" required></textarea>
                    <button type="submit">Send Message</button>
                </form>
            </div>
            <div class="map-container" data-aos="fade-up" data-aos-delay="200">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15955.289139260586!2d36.81255535!3d-1.2842426999999998!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x182f1172d84d49a7%3A0xf7cf54a935de98e8!2sNairobi%2C%20Kenya!5e0!3m2!1sen!2ske!4v1700000000000!5m2!1sen!2ske" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </section>
        
        <!-- About Us Page -->
        <section id="about-page">
            <h2 class="section-title" data-aos="fade-down">Our Story</h2>
            <div class="about-content" data-aos="fade-up">
                <p><strong>Prince Alex Online Store</strong> was founded with a simple mission: to bring the freshest, most organic vegetables directly from the farm to your table. We believe that everyone deserves access to healthy, nutritious food without the hassle of a market trip.</p>
                <p>We are currently operating primarily in <strong>Vihiga County</strong>, with our headquarter located at <strong>Tambua Ward</strong>. We are proud to partner with local Kenyan farmers who share our passion for sustainable and ethical farming. We carefully select each product to ensure it meets our high standards of quality and freshness.</p>
                <p>Our vision is to expand our reach to more counties soon, becoming the leading online platform for farm-fresh produce in Kenya, empowering local farmers and providing our customers with a convenient and reliable source of healthy food. Thank you for supporting our mission!</p>
            </div>
        </section>

        <!-- My Account Page -->
        <section id="my-account-page">
            <h2 class="section-title" data-aos="fade-down">My Account</h2>
            <div class="account-section" data-aos="fade-up">
                <p style="text-align: center;">Welcome, <strong id="account-username">Guest</strong>!</p>
                <h3>Your Profile Details</h3>
                <div class="account-details-grid">
                    <div class="profile-info-card">
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
                    </div>
                </div>
                <div class="account-buttons">
                    <button class="cta-button" onclick="openEditProfileModal()">Edit Profile</button>
                    <button class="cta-button logout-btn" onclick="window.logoutUser()">Logout</button>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="100">
                <h3>Your Past Orders</h3>
                <div id="user-orders-list">
                    <p style="text-align: center;">No past orders found.</p>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="200">
                <h3>Loyalty & Rewards Program</h3>
                <div class="loyalty-card">
                    <h4>Your Current Points:</h4>
                    <p class="points" id="loyalty-points">0</p>
                    <p>Earn points with every purchase and redeem them for exclusive discounts!</p>
                    <button class="cta-button">Learn More</button>
                </div>
            </div>

            <div class="account-section" data-aos="fade-up" data-aos-delay="300">
                <h3>Refer a Friend</h3>
                <div class="loyalty-card">
                    <p>Refer your friends to Prince Alex Store and both of you get a discount on your next order!</p>
                    <form class="loyalty-form" onsubmit="event.preventDefault(); showModal('Referral Program', 'Referral program coming soon! Share your unique link below.');">
                        <input type="text" value="princealex.com/refer/YOUR_CODE" readonly style="text-align: center; cursor: pointer;" onclick="this.select(); document.execCommand('copy'); showModal('Copied!', 'Referral link copied to clipboard!');">
                        <button type="submit">Share Now</button>
                    </form>
                </div>
            </div>

        </section>
    
    <!-- Login / Signup Page (Redirects to Modals) -->
    <section id="login-page">
        <h2 class="section-title" data-aos="fade-down">Access Your Account</h2>
        <div class="forms-container" data-aos="fade-up">
            <p style="text-align: center; margin-bottom: 20px;">Please use the buttons below to Login or Sign Up. Our new authentication system uses pop-up windows for a smoother experience.</p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button class="cta-button" style="width: auto;" onclick="openLoginModal(); return false;">Login</button>
                <button class="cta-button" style="width: auto; background-color: var(--accent-color-orange);" onclick="openSignupModal(); return false;">Sign Up</button>
            </div>
        </div>
    </section>

</main>

    <footer>
        <div class="container footer-main-content">
            <div class="footer-column">
                <h4>About Prince Alex Store</h4>
                <p>Bringing you the freshest, organic vegetables directly from local Kenyan farms to your table. Quality and freshness guaranteed.</p>
            </div>
            <div class="footer-column">
                <h4>Quick Links</h4>
                <a href="#" class="page-link" data-page="home">Home</a>
                <a href="#" class="page-link" data-page="shop">Shop</a>
                <a href="#" class="page-link" data-page="cart">Cart</a>
                <a href="#" class="page-link" data-page="contact">Contact Us</a>
            </div>
            <div class="footer-column">
                <h4>Contact & Follow Us</h4>
                <p><i class="fas fa-phone-alt"></i> 0717384875</p>
                <p><i class="fas fa-envelope"></i> princealexdigital@gmail.com</p>
                <div class="social-links">
                    <a href="https://facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://tiktok.com" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
                    <a href="https://instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom-bar">
            <div class="container">
                &copy; <span id="current-year"></span> Prince Alex Store. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Sticky Bottom Navigation for Mobile -->
    <nav class="bottom-nav" id="bottom-nav">
        <a href="#" class="page-link active" data-page="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="page-link" data-page="shop">
            <i class="fas fa-store"></i>
            <span>Shop</span>
        </a>
        <a href="#" class="page-link" data-page="cart">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="#" class="page-link" data-page="my-account">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <div class="whatsapp-widget">
        <a href="https://wa.me/254717384875" target="_blank" title="Chat on WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <!-- Newsletter Signup Modal -->
    <div id="newsletter-popup" class="modal">
        <div class="modal-content newsletter-modal-content">
            <span class="close-button" onclick="closeNewsletterPopup()">&times;</span>
            <i class="fas fa-envelope-open-text" style="font-size: 60px; color: var(--accent-color-orange); margin-bottom: 20px;"></i>
            <h3>Join Our Fresh Family!</h3>
            <p>Subscribe to our newsletter and get **10% OFF** your first order!</p>
            <form class="newsletter-form" onsubmit="subscribeToNewsletter(event)">
                <input type="email" id="newsletter-email" placeholder="Enter your email address" required>
                <button type="submit">Subscribe & Get Discount</button>
            </form>
        </div>
    </div>


    <!-- Quick View Modal -->
    <div id="quick-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeQuickViewModal()">&times;</span>
            <div class="product-details">
                <img id="qv-image" src="" alt="Product Image">
                <div class="product-info-qv">
                    <h3 id="qv-name"></h3>
                    <div id="qv-rating" class="product-rating"></div>
                    <p id="qv-price" class="price-qv"></p>
                    <p id="qv-description" class="description-qv"></p>
                    <div id="qv-stock" class="stock-indicator"></div>
                    <div id="qv-tags" class="product-tags"></div>
                    <button id="qv-add-to-cart-btn" class="add-to-cart-btn-qv">Add to Cart</button>
                </div>
            </div>
            <div class="reviews-section">
                <h4>Customer Reviews</h4>
                <div id="qv-reviews-list">
                    <!-- Reviews will be loaded here -->
                </div>
                <div id="add-review-container">
                    <!-- Add Review Form will be loaded here if logged in -->
                </div>
            </div>
            <div class="recommended-products-grid">
                <h4>Recommended for You</h4>
                <div id="qv-recommended-list" class="product-grid">
                    <!-- Recommended products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customer-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCustomerDetailsModal()">&times;</span>
            <h3>Your Delivery Details</h3>
            <form id="checkout-form" class="checkout-form">
                <input type="text" id="customer-full-name" placeholder="Full Name" required>
                <input type="text" id="customer-id" placeholder="ID Number (National ID/Passport)" required>
                <input type="tel" id="customer-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="text" id="customer-delivery-location" placeholder="Delivery Location (e.g., Street, Estate, Town)" required>
                <input type="text" id="customer-house-name" placeholder="House Name/Number (Optional)">
                <button type="submit">Continue to Payment</button>
            </form>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="payment-method-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentMethodModal()">&times;</span>
            <h3>Select Payment Method</h3>
            <form id="payment-form" class="payment-form" onsubmit="processPayment(event)">
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="mpesa" checked>
                        <span>M-Pesa</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="cash">
                        <span>Cash on Delivery</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-method" value="card">
                        <span>Card Payment</span>
                    </label>
                </div>

                <div id="mpesa-details" class="payment-details-section">
                    <input type="tel" id="mpesa-phone-number" placeholder="Your M-Pesa Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$">
                    <p>Amount to Pay: <strong>KES <span id="mpesa-amount">0.00</span></strong></p>
                </div>

                <div id="card-details" class="payment-details-section" style="display: none;">
                    <input type="text" id="card-number" placeholder="Card Number" pattern="[0-9]{16}" maxlength="16">
                    <input type="text" id="card-expiry" placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\/?([0-9]{2})" maxlength="5">
                    <input type="text" id="card-cvv" placeholder="CVV" pattern="[0-9]{3,4}" maxlength="4">
                </div>

                <button type="submit">Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Login/Signup Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeLoginModal()">&times;</span>
            <h3>Login to Your Account</h3>
            <form id="login-form-modal" class="auth-form">
                <input type="email" id="login-email-modal" placeholder="Email" required>
                <input type="password" id="login-password-modal" placeholder="Password" required>
                <button type="submit">Login</button>
                <p style="margin-top: 15px;">Don't have an account? <a href="#" onclick="openSignupModal(); return false;">Sign Up</a></p>
                <p><a href="#" onclick="openForgotPasswordModal(); return false;">Forgot Password?</a></p>
            </form>
        </div>
    </div>

    <div id="signup-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeSignupModal()">&times;</span>
            <h3>Create an Account</h3>
            <form id="signup-form-modal" class="auth-form">
                <input type="text" id="signup-fullname-modal" placeholder="Full Name" required>
                <input type="email" id="signup-email-modal" placeholder="Email" required>
                <input type="tel" id="signup-phone-modal" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="signup-password-modal" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p style="margin-top: 15px;">Already have an account? <a href="#" onclick="openLoginModal(); return false;">Login</a></p>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeForgotPasswordModal()">&times;</span>
            <h3>Reset Password</h3>
            <form id="forgot-password-form" class="auth-form">
                <p>Enter your email address to receive a password reset link.</p>
                <input type="email" id="reset-email" placeholder="Your Email" required>
                <button type="submit">Send Reset Link</button>
                <p style="margin-top: 15px;"><a href="#" onclick="closeForgotPasswordModal(); openLoginModal(); return false;">Back to Login</a></p>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close-button" onclick="closeEditProfileModal()">&times;</span>
            <h3>Edit Your Profile</h3>
            <form id="edit-profile-form" class="auth-form">
                <input type="text" id="edit-fullname" placeholder="Full Name" required>
                <input type="email" id="edit-email" placeholder="Email" required readonly> <!-- Email usually not editable -->
                <input type="tel" id="edit-phone" placeholder="Phone Number (e.g., 0712345678)" pattern="^07[0-9]{8}$" required>
                <input type="password" id="edit-password" placeholder="New Password (leave blank to keep current)">
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Slide-in Cart Preview Sidebar -->
    <div id="cart-preview-sidebar" class="cart-preview-sidebar">
        <span class="close-button" onclick="closeCartPreview()">&times;</span>
        <h3>Your Cart</h3>
        <div class="cart-preview-items" id="cart-preview-items">
            <!-- Items dynamically loaded here -->
            <p class="cart-preview-empty">Your cart is empty.</p>
        </div>
        <div class="cart-preview-totals">
            <p>Subtotal: KES <span id="cart-preview-subtotal">0.00</span></p>
            <p>Delivery: KES <span id="cart-preview-delivery">0.00</span></p>
            <p class="total">Total: KES <span id="cart-preview-total">0.00</span></p>
        </div>
        <div class="cart-preview-actions">
            <button class="view-cart-btn" onclick="showPage('cart-page'); closeCartPreview();">View Full Cart</button>
            <button class="checkout-preview-btn" onclick="openCustomerDetailsModal(); closeCartPreview();">Proceed to Checkout</button>
        </div>
    </div>


    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({
                duration: 800,
                easing: 'ease-out-quad',
                once: true, // Only animate once
            });
            // Set the current year in the copyright
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });

        const pages = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.page-link');
        const shopPage = document.getElementById('shop-page');
        const cartCountSpan = document.getElementById('cart-count');
        const cartItemsBody = document.getElementById('cart-items');
        const cartSubtotalPriceSpan = document.getElementById('cart-subtotal-price');
        const cartTransportFeeSpan = document.getElementById('cart-transport-fee');
        const cartGrandTotalPriceSpan = document.getElementById('cart-grand-total-price');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const mobileNavLinks = document.getElementById('nav-links');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const quickViewModal = document.getElementById('quick-view-modal');
        const productListDiv = document.getElementById('product-list');

        const customerDetailsModal = document.getElementById('customer-details-modal');
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const mpesaDetailsDiv = document.getElementById('mpesa-details');
        const cardDetailsDiv = document.getElementById('card-details');
        const mpesaAmountSpan = document.getElementById('mpesa-amount');

        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const forgotPasswordModal = document.getElementById('forgot-password-modal'); // New
        const editProfileModal = document.getElementById('edit-profile-modal'); // New

        const authLinkContainer = document.getElementById('auth-link-container');
        const accountUsernameSpan = document.getElementById('account-username');
        const profileEmailSpan = document.getElementById('profile-email');     // New
        const profilePhoneSpan = document.getElementById('profile-phone'); // New
        const loyaltyPointsSpan = document.getElementById('loyalty-points');

        const cartPreviewSidebar = document.getElementById('cart-preview-sidebar');
        const cartPreviewItemsDiv = document.getElementById('cart-preview-items');
        const cartPreviewSubtotalSpan = document.getElementById('cart-preview-subtotal');
        const cartPreviewDeliverySpan = document.getElementById('cart-preview-delivery');
        const cartPreviewTotalSpan = document.getElementById('cart-preview-total');
        
        const newsletterPopup = document.getElementById('newsletter-popup'); // Newsletter popup

        const testimonialCarousel = document.getElementById('testimonial-carousel');
        const testimonialPrevBtn = document.getElementById('testimonial-prev-btn');
        const testimonialNextBtn = document.getElementById('testimonial-next-btn');
        const testimonialIndicatorsContainer = document.getElementById('testimonial-indicators');

        const flashSaleCountdownDiv = document.getElementById('flash-sale-countdown');
        const countdownDaysSpan = document.getElementById('countdown-days');
        const countdownHoursSpan = document.getElementById('countdown-hours');
        const countdownMinutesSpan = document.getElementById('countdown-minutes');
        const countdownSecondsSpan = document.getElementById('countdown-seconds');

        const recommendedProductsList = document.getElementById('qv-recommended-list');


        const TRANSPORT_FEE = 100.00; // Fixed transportation fee for Vihiga County
        const MIN_ORDER_VALUE = 600.00; // Minimum order value for checkout

        let currentView = 'grid'; // Default view
        let firebaseUser = null; // Stores the currently logged in Firebase user object
        let allProducts = []; // Array to store products fetched from Firestore
        let userLoyaltyPoints = 0; // User's loyalty points

        // --- Utility Functions for Local Storage (will be replaced by Firestore for most data) ---
        function getFromLocalStorage(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Error parsing localStorage item "${key}":`, e);
                return defaultValue;
            }
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving to localStorage item "${key}":`, e);
            }
        }

        // --- Message Modal Functions ---
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML for strong tags
            messageModal.style.display = 'flex';
        }

        function closeModal() {
            messageModal.style.display = 'none';
        }

        // --- Newsletter Popup Functions ---
        function openNewsletterPopup() {
            newsletterPopup.style.display = 'flex';
        }

        function closeNewsletterPopup() {
            newsletterPopup.style.display = 'none';
        }

        // --- Product Quick View Functions ---
        function openQuickViewModal(productId) {
            const product = allProducts.find(p => p.id === productId);

            if (!product) return;

            document.getElementById('qv-image').src = product.image || `https://placehold.co/400x300/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`;
            document.getElementById('qv-image').alt = product.name;
            document.getElementById('qv-name').textContent = product.name;
            
            let qvPriceHtml = `KES ${product.price.toFixed(2)} ${product.unit}`;
            if (product.originalPrice && product.originalPrice > product.price) {
                qvPriceHtml = `<del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}`;
            }
            document.getElementById('qv-price').innerHTML = qvPriceHtml;

            document.getElementById('qv-description').textContent = product.description;

            // Render rating stars
            const qvRatingDiv = document.getElementById('qv-rating');
            qvRatingDiv.innerHTML = generateStarRating(product.rating);

            // Render stock indicator
            const qvStockDiv = document.getElementById('qv-stock');
            qvStockDiv.className = `stock-indicator ${product.stock > 0 ? 'in-stock' : 'sold-out'}`;
            qvStockDiv.textContent = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';

            // Render tags
            const qvTagsDiv = document.getElementById('qv-tags');
            qvTagsDiv.innerHTML = '';
            if (product.tags && product.tags.length > 0) {
                product.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'product-tag';
                    tagSpan.textContent = tag;
                    qvTagsDiv.appendChild(tagSpan);
                });
            }

            // Set Add to Cart button for quick view
            const qvAddToCartBtn = document.getElementById('qv-add-to-cart-btn');
            qvAddToCartBtn.onclick = () => {
                addToCart(product.id);
                // No automatic close, user can browse recommended or add multiple
                // closeQuickViewModal(); 
            };
            qvAddToCartBtn.disabled = product.stock <= 0;
            qvAddToCartBtn.textContent = product.stock <= 0 ? 'Sold Out' : 'Add to Cart';

            // Render reviews and add review form
            renderProductReviews(productId);
            renderRecommendedProducts(productId); // Render recommended products

            quickViewModal.style.display = 'flex';
            AOS.refresh(); // Refresh AOS for modal content
        }

        function closeQuickViewModal() {
            quickViewModal.style.display = 'none';
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            // Update desktop nav links
            navLinks.forEach(link => link.classList.remove('active'));
            const activeDesktopLink = document.querySelector(`.page-link[data-page="${pageId.replace('-page', '')}"]`);
            if (activeDesktopLink) {
                activeDesktopLink.classList.add('active');
            }
            // Update mobile bottom nav links
            const bottomNavLinks = document.querySelectorAll('.bottom-nav a');
            bottomNavLinks.forEach(link => link.classList.remove('active'));
            const activeBottomLink = document.querySelector(`.bottom-nav a[data-page="${pageId.replace('-page', '')}"]`);
            if (activeBottomLink) {
                activeBottomLink.classList.add('active');
            }

            // Close mobile menu if open
            mobileNavLinks.classList.remove('active');

            // Specific page rendering/updates
            if (pageId === 'cart-page') {
                renderCart();
            } else if (pageId === 'shop-page') {
                renderProducts();
            } else if (pageId === 'order-confirmation-page') {
                displayLastOrderConfirmation();
            } else if (pageId === 'my-account-page') {
                updateAccountPage();
                renderUserOrders(); // Render user's past orders
            } else if (pageId === 'login-page') { // Handle direct navigation to login
                // For the redesigned site, we prefer modals for auth
                openLoginModal();
                // Prevent login-page itself from being visible if only modals are used
                document.getElementById('login-page').classList.remove('active'); 
            }
            // Ensure AOS is refreshed for new content
            AOS.refreshHard();
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'login') {
                    openLoginModal();
                } else if (pageData === 'my-account') {
                    showPage('my-account-page');
                } else {
                    showPage(pageData + '-page');
                }
            });
        });

        // Event listeners for bottom navigation
        document.querySelectorAll('.bottom-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageData = link.dataset.page;
                if (pageData === 'my-account' && !firebaseUser) {
                    showModal('Login Required', 'Please log in to view your account details.');
                    openLoginModal();
                } else {
                    showPage(pageData + '-page');
                }
            });
        });

        document.getElementById('cart-icon').addEventListener('click', () => {
            openCartPreview(); // Open sidebar cart instead of full page
        });

        // --- Mobile Hamburger Menu ---
        hamburgerMenu.addEventListener('click', () => {
            mobileNavLinks.classList.toggle('active');
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Save preference to localStorage
            const isDarkMode = document.body.classList.contains('dark-mode');
            saveToLocalStorage('darkMode', isDarkMode);
            // Update icon
            darkModeToggle.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        });

        function applyDarkModePreference() {
            const isDarkMode = getFromLocalStorage('darkMode', false); // Default to light mode
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // --- Generate Star Rating HTML ---
        function generateStarRating(rating) {
            let starsHtml = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                starsHtml += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < (5 - fullStars - (hasHalfStar ? 1 : 0)); i++) {
                starsHtml += '<i class="far fa-star"></i>';
            }
            return starsHtml;
        }

        // --- Product Reviews (Firestore) ---
        async function getProductReviews(productId) {
            try {
                const reviewsRef = window.collection(window.db, "products", productId, "reviews");
                const q = window.query(reviewsRef, window.orderBy("date", "desc"));
                const querySnapshot = await window.getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error getting product reviews:", error);
                return [];
            }
        }

        async function saveProductReview(productId, review) {
            try {
                const reviewsRef = window.collection(window.db, "products", productId, "reviews");
                await window.addDoc(reviewsRef, review);
                return true;
            } catch (error) {
                console.error("Error saving product review:", error);
                return false;
            }
        }

        async function renderProductReviews(productId) {
            const qvReviewsList = document.getElementById('qv-reviews-list');
            const addReviewContainer = document.getElementById('add-review-container');
            const reviews = await getProductReviews(productId);

            qvReviewsList.innerHTML = '';
            if (reviews.length === 0) {
                qvReviewsList.innerHTML = '<p>No reviews yet. Be the first to review this product!</p>';
            } else {
                reviews.forEach(review => {
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-item';
                    reviewItem.innerHTML = `
                        <p><strong>${review.username}</strong> <span class="review-rating">${generateStarRating(review.rating)}</span></p>
                        <p>${review.comment}</p>
                        <small>${new Date(review.date).toLocaleString()}</small>
                    `;
                    qvReviewsList.appendChild(reviewItem);
                });
            }

            // Show add review form if logged in
            if (firebaseUser) {
                addReviewContainer.innerHTML = `
                    <h4>Add Your Review</h4>
                    <form class="add-review-form" onsubmit="submitProductReview(event, '${productId}')">
                        <input type="number" id="review-rating-input" placeholder="Rating (1-5)" min="1" max="5" step="0.5" required>
                        <textarea id="review-comment-input" rows="3" placeholder="Your comment..." required></textarea>
                        <button type="submit">Submit Review</button>
                    </form>
                `;
            } else {
                addReviewContainer.innerHTML = '<p>Please <a href="#" onclick="openLoginModal(); closeQuickViewModal(); return false;">log in</a> to add a review.</p>';
            }
        }

        async function submitProductReview(event, productId) {
            event.preventDefault();
            const rating = parseFloat(document.getElementById('review-rating-input').value);
            const comment = document.getElementById('review-comment-input').value;

            if (rating < 1 || rating > 5 || !comment) {
                showModal('Error', 'Please provide a rating between 1 and 5 and a comment.');
                return;
            }

            const newReview = {
                username: firebaseUser.displayName || firebaseUser.email, // Use Firebase user info
                rating: rating,
                comment: comment,
                date: new Date().toISOString()
            };
            const success = await saveProductReview(productId, newReview);
            if (success) {
                showModal('Review Submitted', 'Thank you for your review!');
                document.querySelector('.add-review-form').reset();
                renderProductReviews(productId); // Re-render reviews
            } else {
                showModal('Error', 'Failed to submit review. Please try again.');
            }
        }

        // --- Product Data Management (Firestore) ---
        async function loadProductsFromFirestore() {
            try {
                const productsCol = window.collection(window.db, "products");
                const q = window.query(productsCol, window.orderBy("createdAt", "desc"));
                const querySnapshot = await window.getDocs(q);
                allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(); // Render products once loaded
            } catch (error) {
                console.error("Error loading products from Firestore:", error);
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%; color: red;">Failed to load products. Please check console for errors.</p>';
            }
        }

        // --- Render Products on Shop Page ---
        function renderProducts() {
            productListDiv.innerHTML = '';
            let productsToDisplay = [...allProducts]; // Create a mutable copy
            const favorites = getFavorites(); 

            // Apply search filter
            const query = document.getElementById('search-input').value.toLowerCase();
            if (query) {
                productsToDisplay = productsToDisplay.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.description.toLowerCase().includes(query) ||
                    (p.tags && p.tags.some(tag => tag.toLowerCase().includes(query)))
                );
            }

            // Apply category filter
            const categoryFilter = document.getElementById('filter-category').value;
            if (categoryFilter) {
                productsToDisplay = productsToDisplay.filter(p => p.category && p.category.toLowerCase() === categoryFilter.toLowerCase());
            }

            // Apply sorting
            const sortBy = document.getElementById('sort-by').value;
            if (sortBy) {
                productsToDisplay.sort((a, b) => {
                    if (sortBy === 'name-asc') return a.name.localeCompare(b.name);
                    if (sortBy === 'name-desc') return b.name.localeCompare(a.name);
                    if (sortBy === 'price-asc') return a.price - b.price;
                    if (sortBy === 'price-desc') return b.price - a.price;
                    return 0;
                });
            }
            
            if (productsToDisplay.length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">No products found matching your criteria.</p>';
                return;
            }

            // Update view buttons
            document.getElementById('grid-view-btn').classList.toggle('active-view', currentView === 'grid');
            document.getElementById('list-view-btn').classList.toggle('active-view', currentView === 'list');

            // Apply view mode
            productListDiv.classList.remove('grid-view', 'list-view');
            productListDiv.classList.add(`${currentView}-view`);

            productsToDisplay.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-aos', 'zoom-in');
                productCard.setAttribute('data-aos-delay', '50');


                const isFavorite = favorites.includes(product.id);
                const favoriteIconClass = isFavorite ? 'fas' : 'far';
                const stockStatusClass = product.stock > 0 ? 'in-stock' : 'sold-out';
                const stockText = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';
                const addToCartDisabled = product.stock <= 0 ? 'disabled' : '';
                const addToCartText = product.stock <= 0 ? 'Add to Cart' : 'Add to Cart';

                let badgeHtml = '';
                if (product.badge) {
                    const badgeClass = product.badge.toLowerCase().replace(/\s/g, '');
                    badgeHtml = `<span class="product-badge ${badgeClass}">${product.badge}</span>`;
                }

                let tagsHtml = '';
                if (product.tags && product.tags.length > 0) {
                    tagsHtml = `<div class="product-tags">${product.tags.map(tag => `<span class="product-tag">${tag}</span>`).join('')}</div>`;
                }

                let priceHtml = `<p class="price">KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                if (product.originalPrice && product.originalPrice > product.price) {
                    priceHtml = `<p class="price"><del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                }


                if (currentView === 'grid') {
                    productCard.innerHTML = `
                        ${badgeHtml}
                        <div class="hover-icons">
                            <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                            <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                            <i class="fas fa-cart-plus" onclick="addToCart('${product.id}')"></i>
                        </div>
                        <img src="${product.image || `https://placehold.co/300x180/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x180/cccccc/333333?text=No+Image';">
                        <h3>${product.name}</h3>
                        <div class="product-rating">${generateStarRating(product.rating)}</div>
                        ${priceHtml}
                        <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                        ${tagsHtml}
                        <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                    `;
                } else { // List view
                    productCard.innerHTML = `
                        ${badgeHtml}
                        <img src="${product.image || `https://placehold.co/150x150/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/333333?text=No+Image';">
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-rating">${generateStarRating(product.rating)}</div>
                            ${priceHtml}
                            <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                            <p>${product.description}</p>
                            ${tagsHtml}
                        </div>
                        <div class="product-actions">
                             <div class="hover-icons" style="position: static; opacity: 1; visibility: visible; transform: none; flex-direction: row; gap: 10px; margin-bottom: 15px;">
                                <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                                <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                        </div>
                    `;
                }
                
                productListDiv.appendChild(productCard);
            });
            AOS.refresh(); // Refresh AOS for newly added elements
        }
        
        function filterProducts() {
            renderProducts(); // Re-render with current search input and category filter
        }

        function filterProductsByCategory(category) {
            document.getElementById('filter-category').value = category;
            renderProducts(); // Re-render with selected category filter
        }

        function sortProducts() {
            renderProducts(); // Re-render with current sort selection
        }

        function toggleView(view) {
            currentView = view;
            renderProducts();
        }
        
        // --- Shopping Cart functionality (Firestore) ---
        async function getCart() {
            if (!firebaseUser) {
                return getFromLocalStorage('guestCart', []); // Use local storage for guest cart
            }
            try {
                const cartDocRef = window.doc(window.db, "carts", firebaseUser.uid);
                const cartDocSnap = await window.getDoc(cartDocRef);
                return cartDocSnap.exists() ? cartDocSnap.data().items : [];
            } catch (error) {
                console.error("Error getting cart from Firestore:", error);
                return [];
            }
        }

        async function saveCart(cart) {
            if (!firebaseUser) {
                saveToLocalStorage('guestCart', cart); // Save to local storage for guests
            } else {
                try {
                    const cartDocRef = window.doc(window.db, "carts", firebaseUser.uid);
                    await window.setDoc(cartDocRef, { items: cart });
                } catch (error) {
                    console.error("Error saving cart to Firestore:", error);
                }
            }
            updateCartCount();
            updateCartPreview(); // Update sidebar cart
        }

        async function updateCartCount() {
            const cart = await getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        async function addToCart(productId) {
            const cart = await getCart();
            const productToAdd = allProducts.find(p => p.id === productId);

            if (!productToAdd) return;
            if (productToAdd.stock <= 0) {
                showModal('Out of Stock', `${productToAdd.name} is currently out of stock.`);
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity >= productToAdd.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${productToAdd.name}. Only ${productToAdd.stock} available.`);
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({ ...productToAdd, quantity: 1, price: productToAdd.price, unit: productToAdd.unit || '' });
            }
            await saveCart(cart);
            showModal('Success!', `${productToAdd.name} added to cart!`);
            openCartPreview(); // Show the cart preview after adding
        }

        async function renderCart() {
            const cart = await getCart();
            cartItemsBody.innerHTML = '';
            let subTotal = 0;

            if (cart.length === 0) {
                cartItemsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Your cart is empty.</td></tr>';
                cartSubtotalPriceSpan.textContent = '0.00';
                cartTransportFeeSpan.textContent = '0.00';
                cartGrandTotalPriceSpan.textContent = '0.00';
                return;
            }

            cart.forEach(item => {
                const row = document.createElement('tr');
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                row.innerHTML = `
                    <td class="cart-item-image"><img src="${item.image || `https://placehold.co/70x70/cccccc/333333?text=${item.name.replace(/\s/g, '+')}`}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/70x70/cccccc/333333?text=No+Image';"></td>
                    <td>${item.name}</td>
                    <td>KES ${item.price.toFixed(2)} ${item.unit || ''}</td>
                    <td>
                        <div class="quantity-controls">
                            <button onclick="updateQuantity('${item.id}', -1)"><i class="fas fa-minus"></i></button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity('${item.id}', 1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </td>
                    <td>KES ${itemTotal.toFixed(2)}</td>
                    <td><button onclick="confirmRemoveFromCart('${item.id}')" style="color: red; border: none; background: transparent; cursor: pointer;"><i class="fas fa-trash-alt"></i></button></td>
                `;
                cartItemsBody.appendChild(row);
            });
            
            const grandTotal = subTotal + TRANSPORT_FEE;
            cartSubtotalPriceSpan.textContent = subTotal.toFixed(2);
            cartTransportFeeSpan.textContent = TRANSPORT_FEE.toFixed(2);
            cartGrandTotalPriceSpan.textContent = grandTotal.toFixed(2);
        }

        async function updateQuantity(productId, change) {
            const cart = await getCart();
            const productInStore = allProducts.find(p => p.id === productId);
            const item = cart.find(i => i.id === productId);

            if (item) {
                if (change > 0 && item.quantity >= productInStore.stock) {
                    showModal('Stock Limit Reached', `You cannot add more ${item.name}. Only ${productInStore.stock} available.`);
                    return;
                }
                item.quantity += change;
                if (item.quantity <= 0) {
                    showModal('Remove Item', 'Are you sure you want to remove this item from your cart? <br><br><button onclick="confirmRemoveFromCart(\'' + productId + '\')">Yes, Remove</button> <button onclick="closeModal()">Cancel</button>');
                } else {
                    await saveCart(cart);
                    renderCart();
                }
            }
        }

        async function removeFromCart(productId) {
            let cart = await getCart();
            cart = cart.filter(item => item.id !== productId);
            await saveCart(cart);
            renderCart();
            updateCartPreview(); // Also update sidebar
            showModal('Removed!', 'Item removed from cart.');
        }

        async function confirmRemoveFromCart(productId) {
            closeModal(); // Close the confirmation modal
            let cart = await getCart();
            cart = cart.filter(item => item.id !== productId);
            await saveCart(cart);
            renderCart();
            updateCartPreview(); // Also update sidebar
            showModal('Removed!', 'Item removed from cart.');
        }

        // --- Slide-in Cart Preview Functions ---
        async function openCartPreview() {
            cartPreviewSidebar.classList.add('active');
            await updateCartPreview();
        }

        function closeCartPreview() {
            cartPreviewSidebar.classList.remove('active');
        }

        async function updateCartPreview() {
            const cart = await getCart();
            cartPreviewItemsDiv.innerHTML = '';
            let subTotal = 0;

            if (cart.length === 0) {
                cartPreviewItemsDiv.innerHTML = '<p class="cart-preview-empty">Your cart is empty.</p>';
                cartPreviewSubtotalSpan.textContent = '0.00';
                cartPreviewDeliverySpan.textContent = '0.00';
                cartPreviewTotalSpan.textContent = '0.00';
                return;
            }

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-preview-item';
                itemDiv.innerHTML = `
                    <img src="${item.image || `https://placehold.co/70x70/cccccc/333333?text=${item.name.replace(/\s/g, '+')}`}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/70x70/cccccc/333333?text=No+Image';">
                    <div class="cart-preview-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.quantity} x KES ${item.price.toFixed(2)} ${item.unit || ''} = KES ${itemTotal.toFixed(2)}</p>
                    </div>
                `;
                cartPreviewItemsDiv.appendChild(itemDiv);
            });

            const grandTotal = subTotal + TRANSPORT_FEE;
            cartPreviewSubtotalSpan.textContent = subTotal.toFixed(2);
            cartPreviewDeliverySpan.textContent = TRANSPORT_FEE.toFixed(2);
            cartPreviewTotalSpan.textContent = grandTotal.toFixed(2);
        }

        // --- Checkout Flow Functions ---
        async function openCustomerDetailsModal() {
            const cart = await getCart();
            const cartSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (cart.length === 0) {
                showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                return;
            }
            if (cartSubtotal < MIN_ORDER_VALUE) {
                showModal('Minimum Order Required', `The minimum order value is KES ${MIN_ORDER_VALUE.toFixed(2)}. Your current subtotal is KES ${cartSubtotal.toFixed(2)}.`);
                return;
            }

            if (!firebaseUser) {
                showModal('Login Required', 'Please log in or sign up to continue with your order.');
                openLoginModal();
                saveToLocalStorage('pendingCheckout', true); // Set flag to resume checkout after login
                return;
            }

            // Pre-fill customer details from user profile if available
            const userProfile = await getUserProfile(firebaseUser.uid);
            document.getElementById('customer-full-name').value = userProfile.fullname || firebaseUser.displayName || '';
            document.getElementById('customer-phone').value = userProfile.phoneNumber || firebaseUser.phoneNumber || '';
            // ID number and delivery location might not be stored in user profile by default,
            // so they remain empty for user to fill.

            customerDetailsModal.style.display = 'flex';
        }

        function closeCustomerDetailsModal() {
            customerDetailsModal.style.display = 'none';
            document.getElementById('checkout-form').reset(); // Clear form on close
        }

        async function collectCustomerDetails(event) {
            event.preventDefault();
            const fullName = document.getElementById('customer-full-name').value;
            const idNumber = document.getElementById('customer-id').value;
            const phoneNumber = document.getElementById('customer-phone').value;
            const deliveryLocation = document.getElementById('customer-delivery-location').value;
            const houseName = document.getElementById('customer-house-name').value;

            if (!fullName || !idNumber || !phoneNumber || !deliveryLocation) {
                showModal('Missing Information', 'Please fill in all required customer details.');
                return;
            }

            // Basic phone number validation (Kenyan format 07XXXXXXXX)
            const phoneRegex = /^07[0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            const customerDetails = { fullName, idNumber, phoneNumber, deliveryLocation, houseName };
            saveToLocalStorage('lastCustomerDetails', customerDetails); // Still using localStorage for this temporary detail
            
            closeCustomerDetailsModal();
            openPaymentMethodModal(customerDetails); // Pass customerDetails to the next step
        }

        async function openPaymentMethodModal(customerDetails) {
            const currentCartSubtotal = (await getCart()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            mpesaAmountSpan.textContent = grandTotal.toFixed(2); // Auto-fill Mpesa amount
            
            // Reset payment method selection to Mpesa by default
            document.querySelector('input[name="payment-method"][value="mpesa"]').checked = true;
            mpesaDetailsDiv.style.display = 'block';
            cardDetailsDiv.style.display = 'none';

            // Add event listener for radio button changes
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'mpesa') {
                        mpesaDetailsDiv.style.display = 'block';
                        cardDetailsDiv.style.display = 'none';
                    } else if (event.target.value === 'card') {
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'block';
                    } else { // Cash on Delivery
                        mpesaDetailsDiv.style.display = 'none';
                        cardDetailsDiv.style.display = 'none';
                    }
                });
            });

            paymentMethodModal.style.display = 'flex';
        }

        function closePaymentMethodModal() {
            paymentMethodModal.style.display = 'none';
            document.getElementById('payment-form').reset(); // Clear form on close
        }

        async function processPayment(event) {
            event.preventDefault();
            const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;
            const currentCartSubtotal = (await getCart()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = currentCartSubtotal + TRANSPORT_FEE;
            const customerDetails = getFromLocalStorage('lastCustomerDetails', {});

            if (selectedMethod === 'mpesa') {
                const mpesaPhoneNumber = document.getElementById('mpesa-phone-number').value;
                const phoneRegex = /^07[0-9]{8}$/;
                if (!phoneRegex.test(mpesaPhoneNumber)) {
                    showModal('Invalid M-Pesa Number', 'Please enter a valid M-Pesa phone number starting with 07.');
                    return;
                }
                // Updated message for M-Pesa payment
                showModal('M-Pesa Payment', `Prompt successful! Check your phone (${mpesaPhoneNumber}) and enter your M-Pesa PIN to complete the payment of KES ${grandTotal.toFixed(2)}.`);
                // Simulate payment completion after a short delay
                setTimeout(async () => {
                    await placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
                }, 3000); // Simulate network delay
            } else if (selectedMethod === 'cash') {
                showModal('Cash on Delivery', 'Your order will be processed, and payment will be collected upon delivery. Thank you!');
                await placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
            } else if (selectedMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;

                if (!cardNumber || !cardExpiry || !cardCvv) {
                    showModal('Missing Card Details', 'Please enter all card details.');
                    return;
                }
                // Basic mock validation for card details
                if (!/^[0-9]{16}$/.test(cardNumber) || !/^(0[1-9]|1[0-2])\/?([0-9]{2})$/.test(cardExpiry) || !/^[0-9]{3,4}$/.test(cardCvv)) {
                    showModal('Invalid Card Details', 'Please enter valid card number (16 digits), expiry (MM/YY), and CVV (3-4 digits).');
                    return;
                }

                showModal('Card Payment', `Processing your card payment of KES ${grandTotal.toFixed(2)}. This is a simulated transaction.`);
                // Simulate payment completion after a short delay
                setTimeout(async () => {
                    await placeOrderFinal(selectedMethod, customerDetails, TRANSPORT_FEE, grandTotal);
                }, 3000); // Simulate network delay
            }
            closePaymentMethodModal();
        }

        async function placeOrderFinal(paymentMethod, customerDetails, transportationFee, grandTotal) {
            const cart = await getCart();
            if (cart.length === 0) {
                showModal('Cart Empty', 'Your cart is empty. Please add items before placing an order.');
                return;
            }
            
            // Deduct stock
            let stockProblem = false;
            for (const cartItem of cart) {
                const productRef = window.doc(window.db, "products", cartItem.id);
                try {
                    const productSnap = await window.getDoc(productRef);
                    if (productSnap.exists()) {
                        const currentStock = productSnap.data().stock;
                        if (currentStock < cartItem.quantity) {
                            stockProblem = true;
                            showModal('Stock Error', `Not enough ${cartItem.name} in stock. Available: ${currentStock}`);
                            break; // Exit loop if stock issue found
                        }
                        await window.updateDoc(productRef, { stock: currentStock - cartItem.quantity });
                    } else {
                        stockProblem = true;
                        showModal('Product Not Found', `Product ${cartItem.name} not found in store.`);
                        break;
                    }
                } catch (error) {
                    console.error("Error updating stock:", error);
                    stockProblem = true;
                    showModal('Stock Update Error', `Failed to update stock for ${cartItem.name}.`);
                    break;
                }
            }

            if (stockProblem) {
                return; // Stop order placement if stock is insufficient or error occurred
            }
            
            // Save order to Firestore
            try {
                const ordersCol = window.collection(window.db, "orders");
                const newOrderRef = await window.addDoc(ordersCol, { 
                    items: cart, 
                    status: 'Pending', 
                    date: new Date().toISOString(),
                    subtotal: grandTotal - transportationFee,
                    transportationFee: transportationFee,
                    total: grandTotal,
                    customer: customerDetails,
                    paymentMethod: paymentMethod,
                    userEmail: firebaseUser ? firebaseUser.email : null,
                    userId: firebaseUser ? firebaseUser.uid : null // Link to Firebase User ID
                });
                const orderId = newOrderRef.id;

                // Award loyalty points (simplified for this example)
                if (firebaseUser) {
                    const pointsEarned = Math.floor(grandTotal / 100) * 5; // 5 points per 100 KES spent
                    userLoyaltyPoints += pointsEarned;
                    await saveLoyaltyPoints(firebaseUser.uid, userLoyaltyPoints);
                    showModal('Order Placed!', `Your order has been placed successfully! Your Order ID is: <strong>${orderId}</strong>.<br><br>You earned ${pointsEarned} loyalty points! Total points: ${userLoyaltyPoints}.<br><br>Delivery will be done in the next 30 minutes to your pinned location!`);
                } else {
                    showModal('Order Placed!', `Your order has been placed successfully! Your Order ID is: <strong>${orderId}</strong>.<br><br>Delivery will be done in the next 30 minutes to your pinned location!`);
                }

                // Clear cart after order
                await saveCart([]); // Clear user's cart in Firestore
                updateCartCount();

                // Save last order for confirmation page
                saveToLocalStorage('lastOrder', { ...newOrderRef.data(), id: orderId }); // Store in local storage for immediate display

                showPage('order-confirmation-page');
            } catch (error) {
                console.error("Error placing order:", error);
                showModal('Order Failed', 'There was an error placing your order. Please try again.');
            }
        }

        // --- Order Confirmation Page ---
        function displayLastOrderConfirmation() {
            const lastOrder = getFromLocalStorage('lastOrder', null);
            const lastOrderDetailsDiv = document.getElementById('last-order-details');
            if (lastOrder) {
                let itemsHtml = lastOrder.items.map(item => `<li>${item.name} (x${item.quantity}) - KES ${item.price.toFixed(2)} ${item.unit || ''}</li>`).join('');
                lastOrderDetailsDiv.innerHTML = `
                    <h3>Thank You for Your Order!</h3>
                    <p>Order ID: <strong>${lastOrder.id}</strong></p>
                    <p>Status: <strong>${lastOrder.status}</strong></p>
                    <p>Date Placed: ${new Date(lastOrder.date).toLocaleString()}</p>
                    <p>Subtotal: <strong>KES ${lastOrder.subtotal.toFixed(2)}</strong></p>
                    <p>Transportation Fee: <strong>KES ${lastOrder.transportationFee.toFixed(2)}</strong></p>
                    <p>Grand Total: <strong>KES ${lastOrder.total.toFixed(2)}</strong></p>
                    <p>Payment Method: <strong>${lastOrder.paymentMethod}</strong></p>
                    <h4>Customer Details:</h4>
                    <ul>
                        <li>Name: ${lastOrder.customer.fullName}</li>
                        <li>Phone: ${lastOrder.customer.phoneNumber}</li>
                        <li>Delivery: ${lastOrder.customer.deliveryLocation}, ${lastOrder.customer.houseName || 'N/A'}</li>
                    </ul>
                    <h4>Items Ordered:</h4>
                    <ul>${itemsHtml}</ul>
                    <p>Delivery will be done in the next 30 minutes to your pinned location. Please be available to meet our rider!</p>
                    <button class="cta-button" onclick="showPage('track-order-page')">Track My Order</button>
                `;
            } else {
                lastOrderDetailsDiv.innerHTML = '<p>No recent order found. Please place an order first.</p>';
            }
        }

        // --- Order Tracking Simulation (Firestore) ---
        async function trackOrder(event) {
            if (event) event.preventDefault();
            const orderIdInput = document.getElementById('order-id-input').value.trim();
            const statusDiv = document.getElementById('order-status');
            const idToTrack = orderIdInput;

            if (!idToTrack) {
                statusDiv.innerHTML = '<p style="color: red;">Please enter a valid Order ID.</p>';
                return;
            }

            try {
                const orderDocRef = window.doc(window.db, "orders", idToTrack);
                const orderDocSnap = await window.getDoc(orderDocRef);

                if (orderDocSnap.exists()) {
                    const order = orderDocSnap.data();
                    let itemsHtml = order.items.map(item => `<li>${item.name} (x${item.quantity})</li>`).join('');
                    statusDiv.innerHTML = `
                        <p>Order ID: <strong>${orderDocSnap.id}</strong></p>
                        <p>Status: <strong>${order.status}</strong></p>
                        <p>Date Placed: ${new Date(order.date).toLocaleString()}</p>
                        <p>Subtotal: KES ${order.subtotal.toFixed(2)}</p>
                        <p>Transportation Fee: KES ${order.transportationFee.toFixed(2)}</p>
                        <p>Grand Total: KES ${order.total.toFixed(2)}</p>
                        <p>Payment Method: ${order.paymentMethod}</p>
                        <p>Delivery to: ${order.customer.fullName}, ${order.customer.deliveryLocation}, ${order.customer.houseName || 'N/A'}</p>
                        <h4>Items:</h4>
                        <ul>${itemsHtml}</ul>
                        <p>Your order is currently being processed and will be shipped soon. Thank you for your patience!</p>
                    `;
                } else {
                    statusDiv.innerHTML = '<p style="color: red;">Order not found. Please check your Order ID.</p>';
                }
            } catch (error) {
                console.error("Error tracking order:", error);
                statusDiv.innerHTML = '<p style="color: red;">Error tracking order. Please try again.</p>';
            }
        }
        
        // --- Contact Form (Firestore) ---
        async function submitContactForm(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            
            // Basic validation
            if (name && email && message) {
                try {
                    await window.addDoc(window.collection(window.db, "contactSubmissions"), { 
                        name, 
                        email, 
                        message, 
                        date: new Date().toISOString() 
                    });
                    showModal('Message Sent!', `Thank you, ${name}! Your message has been sent. We will get back to you shortly.`);
                    document.querySelector('.contact-form').reset();
                } catch (error) {
                    console.error("Error submitting contact form:", error);
                    showModal('Error', 'Failed to send message. Please try again.');
                }
            } else {
                showModal('Error', 'Please fill out all fields.');
            }
        }

        // --- Newsletter Subscription (Firestore) ---
        async function subscribeToNewsletter(event) {
            event.preventDefault();
            const email = document.getElementById('newsletter-email').value;
            if (email) {
                try {
                    // Check if email already exists
                    const q = window.query(window.collection(window.db, "newsletterSubscriptions"), window.where("email", "==", email));
                    const querySnapshot = await window.getDocs(q);
                    if (!querySnapshot.empty) {
                        showModal('Already Subscribed', 'This email is already subscribed to our newsletter.');
                        return;
                    }

                    await window.addDoc(window.collection(window.db, "newsletterSubscriptions"), { 
                        email, 
                        subscribedAt: new Date().toISOString() 
                    });
                    showModal('Subscribed!', `Thank you for subscribing! Check your email for your 10% discount code.`);
                    document.querySelector('.newsletter-form').reset();
                    closeNewsletterPopup(); // Close the popup after successful subscription
                } catch (error) {
                    console.error("Error subscribing to newsletter:", error);
                    showModal('Error', 'Failed to subscribe. Please try again.');
                }
            } else {
                showModal('Error', 'Please enter a valid email address.');
            }
        }

        // --- User Authentication UI Update & Profile Management (Firestore) ---
        async function getUserProfile(uid) {
            try {
                const userDocRef = window.doc(window.db, "users", uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() ? userDocSnap.data() : {};
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return {};
            }
        }

        async function updateAuthUI() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="my-account">My Account (${firebaseUser.email})</a></li>`;
                accountUsernameSpan.textContent = userProfile.fullname || firebaseUser.displayName || firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
                profilePhoneSpan.textContent = userProfile.phoneNumber || 'N/A';
                userLoyaltyPoints = userProfile.loyaltyPoints || 0; // Load loyalty points
                loyaltyPointsSpan.textContent = userLoyaltyPoints;
            } else {
                authLinkContainer.innerHTML = `<li><a href="#" class="page-link" data-page="login">Login / Sign Up</a></li>`;
                accountUsernameSpan.textContent = 'Guest';
                profileEmailSpan.textContent = '';
                profilePhoneSpan.textContent = '';
                loyaltyPointsSpan.textContent = '0'; // Reset loyalty points for guests
            }
            // Re-attach event listener for the new link
            const newAuthLink = authLinkContainer.querySelector('.page-link');
            if (newAuthLink) {
                newAuthLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageData = newAuthLink.dataset.page;
                    if (pageData === 'login') {
                        openLoginModal();
                    } else if (pageData === 'my-account') {
                        showPage('my-account-page');
                    }
                });
            }
        }

        function openLoginModal() {
            closeSignupModal(); // Ensure signup modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            loginModal.style.display = 'flex';
            document.getElementById('login-form-modal').reset();
        }

        function closeLoginModal() {
            loginModal.style.display = 'none';
        }

        function openSignupModal() {
            closeLoginModal(); // Ensure login modal is closed
            closeForgotPasswordModal(); // Ensure forgot password modal is closed
            signupModal.style.display = 'flex';
            document.getElementById('signup-form-modal').reset();
        }

        function closeSignupModal() {
            signupModal.style.display = 'none';
        }

        function openForgotPasswordModal() {
            closeLoginModal();
            forgotPasswordModal.style.display = 'flex';
            document.getElementById('forgot-password-form').reset();
        }

        function closeForgotPasswordModal() {
            forgotPasswordModal.style.display = 'none';
        }

        async function openEditProfileModal() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                document.getElementById('edit-fullname').value = userProfile.fullname || firebaseUser.displayName || '';
                document.getElementById('edit-email').value = firebaseUser.email || '';
                document.getElementById('edit-phone').value = userProfile.phoneNumber || '';
                document.getElementById('edit-password').value = ''; // Password changes are separate in Firebase
                editProfileModal.style.display = 'flex';
            } else {
                showModal('Error', 'You must be logged in to edit your profile.');
            }
        }

        function closeEditProfileModal() {
            editProfileModal.style.display = 'none';
        }

        async function saveProfileDetails(event) {
            event.preventDefault();
            if (!firebaseUser) {
                showModal('Error', 'No user logged in.');
                return;
            }

            const newDisplayName = document.getElementById('edit-fullname').value;
            const newPhoneNumber = document.getElementById('edit-phone').value;
            const newPassword = document.getElementById('edit-password').value; // For password change

            const phoneRegex = /^07[0-9]{8}$/;
            if (newPhoneNumber && !phoneRegex.test(newPhoneNumber)) {
                showModal('Invalid Phone Number', 'Please enter a valid Kenyan phone number starting with 07 (e.g., 0712345678).');
                return;
            }

            try {
                const updatePromises = [];
                // Update Firebase Auth profile
                if (newDisplayName !== (firebaseUser.displayName || '')) {
                    updatePromises.push(window.updateProfile(firebaseUser, { displayName: newDisplayName }));
                }
                if (newPassword) {
                    updatePromises.push(window.updatePassword(firebaseUser, newPassword));
                }

                // Update Firestore user profile document
                const userDocRef = window.doc(window.db, "users", firebaseUser.uid);
                await window.setDoc(userDocRef, {
                    fullname: newDisplayName,
                    phoneNumber: newPhoneNumber,
                    email: firebaseUser.email // Keep email in Firestore for consistency
                }, { merge: true }); // Use merge to only update specified fields

                await Promise.all(updatePromises);
                showModal('Profile Updated', 'Your profile details have been saved.');
                closeEditProfileModal();
                // onAuthStateChanged will re-trigger and update UI
            } catch (error) {
                showModal('Update Failed', 'Failed to update profile: ' + error.message);
                console.error("Profile update error:", error);
            }
        }

        async function updateAccountPage() {
            if (firebaseUser) {
                const userProfile = await getUserProfile(firebaseUser.uid);
                accountUsernameSpan.textContent = userProfile.fullname || firebaseUser.displayName || firebaseUser.email;
                profileEmailSpan.textContent = firebaseUser.email;
                profilePhoneSpan.textContent = userProfile.phoneNumber || 'N/A';
                loyaltyPointsSpan.textContent = userProfile.loyaltyPoints || 0;
            } else {
                showModal('Access Denied', 'Please log in to view your account details.');
                showPage('home-page');
            }
        }

        // Render user's past orders on My Account page (Firestore)
        async function renderUserOrders() {
            const userOrdersListDiv = document.getElementById('user-orders-list');
            userOrdersListDiv.innerHTML = '<p style="text-align: center;">Loading your orders...</p>';
            
            if (!firebaseUser) {
                userOrdersListDiv.innerHTML = '<p style="text-align: center;">Please log in to view your past orders.</p>';
                return;
            }

            try {
                const ordersCol = window.collection(window.db, "orders");
                const q = window.query(ordersCol, window.where("userId", "==", firebaseUser.uid), window.orderBy("date", "desc"));
                const querySnapshot = await window.getDocs(q);

                if (querySnapshot.empty) {
                    userOrdersListDiv.innerHTML = '<p style="text-align: center;">You have no past orders.</p>';
                    return;
                }

                userOrdersListDiv.innerHTML = ''; // Clear loading message
                querySnapshot.forEach(doc => {
                    const order = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'admin-list-item'; // Reusing admin-list-item style
                    const itemsSummary = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    listItem.innerHTML = `
                        <div>
                            <strong>Order ID: ${doc.id}</strong><br>
                            Status: <span class="${order.status === 'Delivered' ? 'status-delivered' : ''}">${order.status}</span><br>
                            Date: ${new Date(order.date).toLocaleString()}<br>
                            Subtotal: KES ${order.subtotal.toFixed(2)}<br>
                            Transport Fee: KES ${order.transportationFee.toFixed(2)}<br>
                            Grand Total: KES ${order.total.toFixed(2)}<br>
                            Payment: ${order.paymentMethod}<br>
                            <span class="order-items-list">Items: ${itemsSummary}</span>
                        </div>
                    `;
                    userOrdersListDiv.appendChild(listItem);
                });
            } catch (error) {
                console.error("Error fetching user orders:", error);
                userOrdersListDiv.innerHTML = '<p style="text-align: center; color: red;">Error loading your orders.</p>';
            }
        }

        // --- Loyalty Points (Firestore) ---
        async function getLoyaltyPoints(uid) {
            try {
                const userDocRef = window.doc(window.db, "users", uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() && userDocSnap.data().loyaltyPoints ? userDocSnap.data().loyaltyPoints : 0;
            } catch (error) {
                console.error("Error getting loyalty points:", error);
                return 0;
            }
        }

        async function saveLoyaltyPoints(uid, points) {
            try {
                const userDocRef = window.doc(window.db, "users", uid);
                await window.setDoc(userDocRef, { loyaltyPoints: points }, { merge: true });
                loyaltyPointsSpan.textContent = points; // Update UI
            } catch (error) {
                console.error("Error saving loyalty points:", error);
            }
        }


        // --- Favorite Products (Firestore) ---
        async function getFavorites() {
            if (!firebaseUser) return []; // No favorites for guests
            try {
                const userDocRef = window.doc(window.db, "users", firebaseUser.uid);
                const userDocSnap = await window.getDoc(userDocRef);
                return userDocSnap.exists() && userDocSnap.data().favorites ? userDocSnap.data().favorites : [];
            } catch (error) {
                console.error("Error getting favorites:", error);
                return [];
            }
        }

        async function saveFavorites(favorites) {
            if (!firebaseUser) return; // Cannot save favorites for guests to Firestore
            try {
                const userDocRef = window.doc(window.db, "users", firebaseUser.uid);
                await window.setDoc(userDocRef, { favorites: favorites }, { merge: true });
            } catch (error) {
                console.error("Error saving favorites:", error);
            }
        }

        async function toggleFavorite(productId, iconElement) {
            if (!firebaseUser) {
                showModal('Login Required', 'Please log in to manage your favorite products.');
                openLoginModal();
                return;
            }
            let favorites = await getFavorites();
            if (favorites.includes(productId)) {
                favorites = favorites.filter(id => id !== productId);
                iconElement.classList.remove('fas');
                iconElement.classList.add('far');
            } else {
                favorites.push(productId);
                iconElement.classList.remove('far');
                iconElement.classList.add('fas');
            }
            await saveFavorites(favorites);
        }

        // --- Image Carousel Logic ---
        const heroImages = document.querySelectorAll('.hero-background-image');
        let currentImageIndex = 0;

        function changeHeroImage() {
            heroImages.forEach((img, index) => {
                if (index === currentImageIndex) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            currentImageIndex = (currentImageIndex + 1) % heroImages.length;
        }

        // --- Testimonial Carousel Logic ---
        const testimonialsData = [
            {
                name: "Mercy Wanjiku",
                photo: "https://placehold.co/100x100/A0D9B1/333333?text=MW",
                quote: "Prince Alex Store has transformed my cooking! The vegetables are incredibly fresh, and the delivery is always on time. Highly recommend for anyone in Vihiga!"
            },
            {
                name: "John Kamau",
                photo: "https://placehold.co/100x100/98C1D9/333333?text=JK",
                quote: "I've tried many online stores, but Prince Alex's produce stands out. It truly feels farm-fresh, and the convenience is unmatched. Their organic options are fantastic."
            },
            {
                name: "Amina Hassan",
                photo: "https://placehold.co/100x100/FFD1AA/333333?text=AH",
                quote: "Finally, a reliable source for healthy veggies! The quality is consistently excellent, and their customer service is top-notch. My family loves the variety."
            }
        ];
        let currentTestimonialIndex = 0;
        let testimonialInterval;

        function renderTestimonials() {
            testimonialCarousel.innerHTML = '';
            testimonialIndicatorsContainer.innerHTML = '';

            testimonialsData.forEach((testimonial, index) => {
                const card = document.createElement('div');
                card.className = 'testimonial-card';
                card.setAttribute('data-index', index);
                card.innerHTML = `
                    <img src="${testimonial.photo}" alt="${testimonial.name}">
                    <p>"${testimonial.quote}"</p>
                    <strong>- ${testimonial.name}</strong>
                `;
                testimonialCarousel.appendChild(card);

                const indicator = document.createElement('div');
                indicator.className = 'testimonial-indicator';
                indicator.setAttribute('data-index', index);
                indicator.addEventListener('click', () => showTestimonial(index));
                testimonialIndicatorsContainer.appendChild(indicator);
            });
            showTestimonial(0); // Show the first testimonial
        }

        function showTestimonial(index) {
            const cards = testimonialCarousel.querySelectorAll('.testimonial-card');
            const indicators = testimonialIndicatorsContainer.querySelectorAll('.testimonial-indicator');

            cards.forEach((card, i) => {
                card.classList.remove('active');
                card.style.display = 'none'; // Hide all initially
            });
            indicators.forEach(indicator => indicator.classList.remove('active'));

            cards[index].classList.add('active');
            cards[index].style.display = 'flex'; // Show only the active one
            indicators[index].classList.add('active');
            currentTestimonialIndex = index;
            resetTestimonialInterval();
        }

        function nextTestimonial() {
            let nextIndex = (currentTestimonialIndex + 1) % testimonialsData.length;
            showTestimonial(nextIndex);
        }

        function prevTestimonial() {
            let prevIndex = (currentTestimonialIndex - 1 + testimonialsData.length) % testimonialsData.length;
            showTestimonial(prevIndex);
        }

        testimonialNextBtn.addEventListener('click', nextTestimonial);
        testimonialPrevBtn.addEventListener('click', prevTestimonial);

        function startTestimonialCarousel() {
            testimonialInterval = setInterval(nextTestimonial, 7000); // Change every 7 seconds
        }

        function resetTestimonialInterval() {
            clearInterval(testimonialInterval);
            startTestimonialCarousel();
        }

        // --- Flash Sale Countdown Timer ---
        function updateCountdown() {
            const now = new Date().getTime();
            // Set your target end date/time for the flash sale (e.g., 2 days from now)
            const endDate = new Date(now + (2 * 24 * 60 * 60 * 1000) + (10 * 60 * 1000)).getTime(); // 2 days and 10 mins from now
            
            const distance = endDate - now;

            if (distance < 0) {
                flashSaleCountdownDiv.innerHTML = "SALE ENDED!";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownDaysSpan.textContent = String(days).padStart(2, '0');
            countdownHoursSpan.textContent = String(hours).padStart(2, '0');
            countdownMinutesSpan.textContent = String(minutes).padStart(2, '0');
            countdownSecondsSpan.textContent = String(seconds).padStart(2, '0');
        }

        // --- Recommended Products ---
        function renderRecommendedProducts(currentProductId) {
            recommendedProductsList.innerHTML = '';
            
            // Filter out the current product from the list of all products
            const otherProducts = allProducts.filter(p => p.id !== currentProductId);

            // Shuffle the remaining products and pick a few (e.g., 3)
            const shuffled = [...otherProducts].sort(() => 0.5 - Math.random());
            const selectedRecommendations = shuffled.slice(0, 3);

            if (selectedRecommendations.length === 0) {
                recommendedProductsList.innerHTML = '<p style="text-align: center; width: 100%;">No recommendations available.</p>';
                return;
            }

            selectedRecommendations.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                // Remove AOS animation from these small cards to avoid clutter
                // productCard.setAttribute('data-aos', 'zoom-in');
                // productCard.setAttribute('data-aos-delay', '50');

                const isFavorite = getFavorites().includes(product.id);
                const favoriteIconClass = isFavorite ? 'fas' : 'far';
                const stockStatusClass = product.stock > 0 ? 'in-stock' : 'sold-out';
                const stockText = product.stock > 0 ? `In Stock (${product.stock})` : 'Sold Out';
                const addToCartDisabled = product.stock <= 0 ? 'disabled' : '';
                const addToCartText = product.stock <= 0 ? 'Add to Cart' : 'Add to Cart';

                let badgeHtml = '';
                if (product.badge) {
                    const badgeClass = product.badge.toLowerCase().replace(/\s/g, '');
                    badgeHtml = `<span class="product-badge ${badgeClass}">${product.badge}</span>`;
                }

                let priceHtml = `<p class="price">KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                if (product.originalPrice && product.originalPrice > product.price) {
                    priceHtml = `<p class="price"><del>KES ${product.originalPrice.toFixed(2)}</del> KES ${product.price.toFixed(2)} ${product.unit}</p>`;
                }

                productCard.innerHTML = `
                    ${badgeHtml}
                    <div class="hover-icons">
                        <i class="${favoriteIconClass} fa-heart" onclick="toggleFavorite('${product.id}', this)"></i>
                        <i class="fas fa-eye" onclick="openQuickViewModal('${product.id}')"></i>
                        <i class="fas fa-cart-plus" onclick="addToCart('${product.id}')"></i>
                    </div>
                    <img src="${product.image || `https://placehold.co/300x180/cccccc/333333?text=${product.name.replace(/\s/g, '+')}`}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x180/cccccc/333333?text=No+Image';">
                    <h3>${product.name}</h3>
                    <div class="product-rating">${generateStarRating(product.rating)}</div>
                    ${priceHtml}
                    <p class="stock-indicator ${stockStatusClass}">${stockText}</p>
                    <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" ${addToCartDisabled}>${addToCartText}</button>
                `;
                recommendedProductsList.appendChild(productCard);
            });
            AOS.refresh();
        }

        // --- Google Maps Autocomplete Initialization ---
        // This function will be called by the Google Maps API script once it's loaded
        function initAutocomplete() {
            const deliveryLocationInput = document.getElementById('customer-delivery-location');
            if (deliveryLocationInput) {
                // Bias the search results towards Kenya (Nairobi coordinates for a general Kenya bias)
                const defaultBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(-4.8, 33.9), // Southwest corner of Kenya
                    new google.maps.LatLng(4.6, 41.9)  // Northeast corner of Kenya
                );

                const autocomplete = new google.maps.places.Autocomplete(deliveryLocationInput, {
                    bounds: defaultBounds,
                    componentRestrictions: { country: 'ke' }, // Restrict to Kenya
                    types: ['geocode', 'establishment'] // Suggest addresses and businesses
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        // User entered the name of a Place that was not suggested and pressed the Enter key.
                        console.log("No details available for input: '" + place.name + "'");
                        return;
                    }
                    // Set the input field's value to the selected place's formatted address
                    deliveryLocationInput.value = place.formatted_address;
                });
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            applyDarkModePreference();
            
            // Check if there's a last order to display on confirmation page on load
            if (getFromLocalStorage('lastOrder', null)) {
                displayLastOrderConfirmation();
            }

            // Start hero image carousel
            changeHeroImage(); // Show first image immediately
            setInterval(changeHeroImage, 5000); // Change image every 5 seconds

            // Render and start testimonial carousel
            renderTestimonials();
            startTestimonialCarousel();

            // Start flash sale countdown
            updateCountdown();
            setInterval(updateCountdown, 1000);

            // Attach form submission listeners for modals
            document.getElementById('login-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email-modal').value;
                const password = document.getElementById('login-password-modal').value;
                await window.loginUser(email, password); // Call global Firebase login
            });

            document.getElementById('signup-form-modal').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullname = document.getElementById('signup-fullname-modal').value;
                const email = document.getElementById('signup-email-modal').value;
                const phoneNumber = document.getElementById('signup-phone-modal').value;
                const password = document.getElementById('signup-password-modal').value;
                await window.registerUser(email, password, fullname, phoneNumber); // Call global Firebase register
            });
            
            document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                await window.resetPassword(email);
            });

            document.getElementById('edit-profile-form').addEventListener('submit', saveProfileDetails);
            document.getElementById('checkout-form').addEventListener('submit', collectCustomerDetails);

            // Show newsletter popup after 5 seconds if not already shown/subscribed
            const hasSubscribedToNewsletter = getFromLocalStorage('newsletterSubscribed', false);
            if (!hasSubscribedToNewsletter) {
                setTimeout(() => {
                    openNewsletterPopup();
                }, 5000); // Show after 5 seconds
            }

            // Set a flag to remember if the newsletter popup has been shown
            newsletterPopup.addEventListener('click', (event) => {
                if (event.target === newsletterPopup || event.target.classList.contains('close-button')) {
                    saveToLocalStorage('newsletterSubscribed', true); // Treat closing as opting out for this session
                }
            });

        });
    </script>
    <!-- Google Maps API Script -->
    <!-- IMPORTANT: Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API Key -->
    <!-- You can get one from the Google Cloud Console: https://console.cloud.google.com/apis/credentials -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initAutocomplete"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, addDoc, updateDoc, deleteDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, updatePassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

  // Global variables provided by Canvas environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      // Default config for local testing if __firebase_config is not available
      apiKey: "YOUR_FIREBASE_API_KEY", // Replace with your actual Firebase API Key if testing locally
      authDomain: "your-project-id.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "your-sender-id",
      appId: "your-app-id"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Expose Firebase functions globally for use in inline scripts and event listeners
  window.auth = auth; // Make auth object accessible
  window.db = db;     // Make db object accessible
  window.doc = doc;
  window.setDoc = setDoc;
  window.addDoc = addDoc;
  window.updateDoc = updateDoc;
  window.deleteDoc = deleteDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
  window.where = where;
  window.getDoc = getDoc;
  window.updateProfile = updateProfile; // Expose updateProfile
  window.updatePassword = updatePassword; // Expose updatePassword


  // Firebase Authentication Functions exposed globally
  window.registerUser = async function (email, password, fullname, phoneNumber) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      // Update Firebase Auth profile
      await updateProfile(userCredential.user, {
        displayName: fullname
      });

      // Save additional user details to Firestore 'users' collection
      await setDoc(doc(db, "users", userCredential.user.uid), {
        email: email,
        fullname: fullname,
        phoneNumber: phoneNumber,
        createdAt: new Date().toISOString(),
        loyaltyPoints: 0, // Initialize loyalty points
        favorites: [] // Initialize favorites
      });

      showModal('Registration Successful!', `Welcome, ${fullname || email}! You are now logged in.`);
      closeSignupModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      let errorMessage = 'Registration failed. Please try again.';
      if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'The email address is already in use by another account.';
      } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'The email address is not valid.';
      } else if (error.code === 'auth/weak-password') {
          errorMessage = 'The password is too weak. Please choose a stronger password.';
      }
      showModal('Registration Failed', 'Error: ' + errorMessage);
      console.error("Registration error:", error);
    }
  };

  window.loginUser = async function (email, password) {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      showModal('Login Successful!', `Welcome back, ${auth.currentUser.displayName || auth.currentUser.email}!`);
      closeLoginModal();
      // Check if there's a pending checkout
      if (getFromLocalStorage('pendingCheckout', false)) {
          localStorage.removeItem('pendingCheckout');
          openCustomerDetailsModal(); // Resume checkout
      } else {
          showPage('home-page'); // Or redirect to a dashboard
      }
    } catch (error) {
      let errorMessage = 'Login failed. Please try again.';
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = 'Invalid email or password. Please check your credentials.';
      } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email format.';
      } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Too many login attempts. Please try again later.';
      }
      showModal('Login Failed', 'Error: ' + errorMessage);
      console.error("Login error:", error);
    }
  };

  window.logoutUser = async function () {
    try {
      await signOut(auth);
      showModal('Logged Out', 'You have been successfully logged out.');
      showPage('home-page'); // Redirect to home after logout
    } catch (error) {
      showModal('Logout Failed', 'Error logging out: ' + error.message);
      console.error("Logout error:", error);
    }
  };

  window.resetPassword = async function(email) {
    try {
        await sendPasswordResetEmail(auth, email);
        showModal('Password Reset', `A password reset link has been sent to ${email}. Please check your inbox.`);
        closeForgotPasswordModal();
        openLoginModal();
    } catch (error) {
        showModal('Password Reset Failed', 'Error sending reset email: ' + error.message);
        console.error("Password reset error:", error);
    }
  };

  // Firebase Auth State Listener
  onAuthStateChanged(auth, async (user) => {
    firebaseUser = user; // Update the global firebaseUser variable
    await updateAuthUI(); // Update UI based on auth state

    // Authenticate with custom token if available, otherwise sign in anonymously
    if (initialAuthToken) {
        try {
            await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
            console.error("Error signing in with custom token:", error);
            // Fallback to anonymous if custom token fails (e.g., expired)
            await signInAnonymously(auth);
        }
    } else {
        await signInAnonymously(auth);
    }

    // Load products and update cart count after Firebase is ready
    await loadProductsFromFirestore();
    await updateCartCount();

    // Handle pending checkout after Firebase login
    if (user && getFromLocalStorage('pendingCheckout', false)) {
        localStorage.removeItem('pendingCheckout');
        openCustomerDetailsModal(); // Resume checkout
    }
    // If a guest logs in, merge their local cart with their Firestore cart
    if (user) {
        const guestCart = getFromLocalStorage('guestCart', []);
        if (guestCart.length > 0) {
            let userCart = await getCart();
            // Merge logic: add guest items to user cart, handling duplicates
            guestCart.forEach(guestItem => {
                const existingUserItem = userCart.find(item => item.id === guestItem.id);
                if (existingUserItem) {
                    existingUserItem.quantity += guestItem.quantity;
                } else {
                    userCart.push(guestItem);
                }
            });
            await saveCart(userCart);
            localStorage.removeItem('guestCart'); // Clear guest cart after merge
            await updateCartCount();
        }
    }
  });

</script>

</body>
</html>
