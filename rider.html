<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Prince Alex Store - Rider Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg: #f4f6f8;
      --panel: #ffffff;
      --panel-2: #f8f9fa;
      --border: #eef2f5;
      --text: #1a1a1a;
      --muted: #555555;
      --subtle: #f0f2f5;
      --brand: #00C853;
      --brand-2:#00E676;
      --blue: #2962FF;
      --warn:#FFB020;
      --danger:#FF4D4D;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 18px;
      --radius-sm: 12px;
      --header-h: 72px;
      --sidebar-w: 290px;
      --transition: 180ms ease;
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%;}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* Layout */
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .header{
      position:sticky;
      top:0;
      z-index:2000;
      height: var(--header-h);
      display:flex;
      align-items:center;
      backdrop-filter: blur(14px);
      background: rgba(255,255,255,0.85);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      width: min(1400px, 100%);
      margin:0 auto;
      padding: 0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .header-left{
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap: 10px; font-weight:800; letter-spacing: .2px;
      user-select:none;
      white-space:nowrap;
    }
    .brand .dot{
      width: 12px; height: 12px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-radius: 999px;
      box-shadow: 0 0 0 6px rgba(0,200,83,0.12);
    }
    .brand span{font-size: 18px;}
    .header-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    #sideOverlay { display: none; }
    #sideLogoutBtn { display: none; }

    .chip{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.22);
      max-width: 360px;
    }
    .avatar{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--subtle);
      object-fit: cover;
      flex: 0 0 auto;
    }
    .chip .meta{
      display:flex; flex-direction:column;
      min-width:0;
    }
    .chip .name{font-size: 13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .chip .sub{font-size: 12px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .btn{
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform var(--transition), background var(--transition), border-color var(--transition);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-weight:700;
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: var(--panel-2); border-color: #dce1e7;}
    .btn:active{transform: translateY(0px) scale(0.99);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(0,200,83,0.28), rgba(0,230,118,0.18));
      border-color: rgba(0,230,118,0.30);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,77,77,0.26), rgba(255,77,77,0.12));
      border-color: rgba(255,77,77,0.30);
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(41,98,255,0.22), rgba(41,98,255,0.12));
      border-color: rgba(41,98,255,0.30);
    }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none !important;}

    .status-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--panel);
      font-size: 12px;
      font-weight:800;
    }
    .status-pill .led{
      width: 9px; height: 9px; border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(255,77,77,0.15);
    }
    .status-pill.online .led{
      background: var(--brand);
      box-shadow: 0 0 0 6px rgba(0,200,83,0.16);
    }
    .status-pill span{color: var(--muted); font-weight:700; letter-spacing:.2px;}

    .main{
      width: min(1400px, 100%);
      margin: 16px auto 90px;
      padding: 0 18px;
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: 16px;
      align-items: start;
    }

    .sidebar{
      position: sticky;
      top: calc(var(--header-h) + 16px);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      z-index: 1000;
      overflow: hidden;
    }
    .side-head{
      padding: 16px 16px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap: 8px;
      background: linear-gradient(180deg, var(--subtle), transparent);
    }
    .side-head h2{font-size: 14px; letter-spacing:.2px;}
    .side-head p{font-size: 12px; color: var(--muted);}
    .nav{
      display:flex;
      flex-direction:column;
      padding: 10px;
      gap: 8px;
    }
    .nav .nav-item{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), transform var(--transition);
      text-align:left;
      font-weight:800;
      font-size: 13px;
    }
    .nav .nav-item:hover{background: var(--subtle); transform: translateY(-1px);}
    .nav .nav-item.active{
      background: linear-gradient(135deg, rgba(0,200,83,0.18), rgba(41,98,255,0.10));
      border-color: rgba(0,230,118,0.22);
    }
    .nav .nav-item i{opacity:.9;}
    .badge{
      min-width: 28px;
      height: 20px;
      padding: 0 8px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight:900;
      color: var(--text);
      background: var(--subtle);
      border: 1px solid var(--border);
    }

    /* Content */
    .content{
      display:flex;
      flex-direction:column;
      gap: 16px;
      min-width: 0;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      align-items: start;
    }

    .panel{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    #mapPanel {
      position: sticky;
      top: calc(var(--header-h) + 16px);
      height: fit-content;
      z-index: 900;
    }
    .panel-head{
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background: linear-gradient(180deg, var(--subtle), transparent);
    }
    .panel-head h3{
      font-size: 14px;
      letter-spacing:.2px;
    }
    .panel-head small{color: var(--muted); font-weight:700;}
    .panel-body{padding: 16px;}

    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .stat{
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      padding: 14px;
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .stat .icon{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: var(--white);
      border: 1px solid var(--border);
      flex: 0 0 auto;
    }
    .stat .icon i{font-size: 16px; opacity:.95;}
    .stat .kpi{display:flex; flex-direction:column; min-width:0;}
    .stat .kpi .v{font-size: 16px; font-weight:900; letter-spacing:.2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .stat .kpi .l{font-size: 12px; color: var(--muted); font-weight:700;}

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .card{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      transition: transform var(--transition), background var(--transition), border-color var(--transition);
    }
    .card:hover{transform: translateY(-1px); background: var(--white); border-color: #dce1e7;}
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap: 10px;
      min-width: 0;
    }
    .title strong{font-size: 13px; font-weight:900;}
    .title span{
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 460px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight:900;
      border: 1px solid var(--border);
      background: var(--white);
      text-transform: uppercase;
      letter-spacing: .4px;
      white-space:nowrap;
    }
    .pill.pending{border-color: rgba(255,176,32,0.35); background: rgba(255,176,32,0.10); color: #d48806;}
    .pill.pickup{border-color: rgba(0,230,118,0.32); background: rgba(0,230,118,0.10);}
    .pill.transit{border-color: rgba(41,98,255,0.32); background: rgba(41,98,255,0.10);}
    .pill.delivered{border-color: rgba(0,200,83,0.32); background: rgba(0,200,83,0.10);}
    .pill.cancelled{border-color: rgba(255,77,77,0.35); background: rgba(255,77,77,0.10);}

    .grid2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .kv{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--subtle);
      padding: 10px;
      min-width: 0;
    }
    .kv .k{font-size: 11px; color: var(--muted); font-weight:800; text-transform:uppercase; letter-spacing:.4px;}
    .kv .v{font-size: 13px; font-weight:800; margin-top: 4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    /* Map */
    #map{
      width: 100%;
      height: 500px;
      border-radius: 18px;
      overflow:hidden;
      background: #e0e0e0;
      border: 1px solid var(--border);
    }
    .map-hint{
      display:flex; gap: 8px; align-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight:700;
    }
    .map-hint i{opacity:.9;}

    /* Drawer (Active Delivery) */
    .drawer{
      position: fixed;
      right: 16px;
      bottom: 86px;
      width: min(420px, calc(100vw - 32px));
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      backdrop-filter: blur(16px);
      transform: translateY(20px);
      opacity: 0;
      pointer-events:none;
      transition: opacity 200ms ease, transform 200ms ease;
      z-index: 2100;
      overflow: hidden;
    }
    .drawer.open{opacity:1; transform: translateY(0); pointer-events:auto;}
    .drawer-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(135deg, rgba(0,200,83,0.14), rgba(41,98,255,0.10));
    }
    .drawer-head strong{font-size: 13px; font-weight:900;}
    .drawer-body{padding: 14px 16px; display:flex; flex-direction:column; gap: 10px;}
    .drawer-foot{padding: 14px 16px; border-top: 1px solid var(--border); display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap;}
    .mini{
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
    }

    /* Modals */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 3000;
      background: rgba(0,0,0,0.40);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(520px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 22px 70px rgba(0,0,0,0.15);
      overflow:hidden;
    }
    .modal .mhead{
      padding: 16px 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(0,200,83,0.14), rgba(41,98,255,0.10));
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .modal .mhead h2{font-size: 15px;}
    .modal .mbody{padding: 16px; display:flex; flex-direction:column; gap: 12px;}
    .field{
      display:flex; flex-direction:column; gap: 6px;
    }
    .field label{font-size: 12px; font-weight:900; color: var(--muted); text-transform:uppercase; letter-spacing:.4px;}
    .field input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--subtle);
      color: var(--text);
      outline: none;
      font-weight:700;
      transition: border-color var(--transition), background var(--transition);
    }
    .field input:focus{border-color: rgba(0,230,118,0.35); background: var(--white);}
    .help{font-size: 12px; color: var(--muted); font-weight:600; line-height: 1.5;}
    .mfoot{padding: 16px; border-top: 1px solid var(--border); display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap;}

    /* Toast */
    .toast{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 4000;
      width: min(420px, calc(100vw - 32px));
      background: var(--panel);
      border: 1px solid var(--border);
      border-left: 4px solid var(--brand);
      padding: 12px 14px;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.15);
      display:none;
      gap: 10px;
      align-items:flex-start;
      backdrop-filter: blur(14px);
    }
    .toast.show{display:flex;}
    .toast i{margin-top: 2px;}
    .toast .t{display:flex; flex-direction:column; gap: 2px; min-width:0;}
    .toast .t strong{font-size: 13px;}
    .toast .t span{font-size: 12px; color: var(--muted); font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .toast .close{margin-left:auto;}

    /* Mobile */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 2000;
      padding: 12px 14px 16px;
      background: rgba(255,255,255,0.90);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(16px);
      display:none;
    }
    .bottom-nav .bar{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      width: min(520px, 100%);
      margin: 0 auto;
    }
    .bbtn{
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--subtle);
      padding: 10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      color: var(--muted);
      font-weight:800;
      font-size: 10px;
      cursor:pointer;
      user-select:none;
      transition: background var(--transition), transform var(--transition), border-color var(--transition), color var(--transition);
      position:relative;
    }
    .bbtn i{font-size: 16px;}
    .bbtn.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(0,200,83,0.16), rgba(41,98,255,0.10));
      border-color: rgba(0,230,118,0.22);
    }
    .bbtn:hover{transform: translateY(-1px);}

    .bbadge{
      position:absolute;
      top: 8px;
      right: 10px;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      background: rgba(255,77,77,0.90);
      color: #fff;
      font-size: 11px;
      font-weight:900;
      display:none;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,0.50);
    }

    /* Stepper & Badges */
    .stepper{
      display:flex; justify-content:space-between; position:relative;
      margin: 16px 0 12px; padding: 0 4px;
    }
    .stepper::before{
      content:''; position:absolute; top:9px; left:12px; right:12px; height:2px;
      background: #e0e0e0; z-index:0;
    }
    .step{position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:6px; flex:1;}
    .step-dot{
      width:20px; height:20px; border-radius:999px; background: var(--bg);
      border: 2px solid #e0e0e0; transition: all 0.2s ease;
    }
    .step.active .step-dot{background: var(--brand); border-color: var(--brand); box-shadow: 0 0 0 4px rgba(0,200,83,0.2);}
    .step.done .step-dot{background: var(--brand); border-color: var(--brand);}
    .step-label{font-size:10px; color: var(--muted); font-weight:700; text-align:center;}
    .step.active .step-label, .step.done .step-label{color: var(--text);}

    .badges{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;}
    .badge-pill{
      padding:4px 10px; border-radius:8px; font-size:11px; font-weight:800;
      display:flex; align-items:center; gap:6px; border:1px solid transparent;
    }
    .badge-pill.cash{background: rgba(0,230,118,0.1); color: var(--brand-2); border-color: rgba(0,230,118,0.2);}
    .badge-pill.priority{background: rgba(255,77,77,0.1); color: var(--danger); border-color: rgba(255,77,77,0.2);}
    .badge-pill.dist{background: rgba(41,98,255,0.1); color: var(--blue); border-color: rgba(41,98,255,0.2);}

    /* Login Modal Specifics */
    .login-modal {
      max-width: 420px !important;
      padding: 0 !important;
    }
    .login-modal .mhead {
      background: transparent !important;
      border: none !important;
      padding: 32px 32px 10px !important;
      flex-direction: column;
      text-align: center;
    }
    .login-modal .mhead h2 {
      font-size: 22px;
      color: var(--text);
      margin-top: 10px;
    }
    .login-modal .mhead p {
      color: var(--muted);
      font-size: 14px;
      margin-top: 5px;
      font-weight: 500;
    }
    .login-modal .mbody {
      padding: 10px 32px 32px !important;
    }
    .login-modal .field label {
      text-align: left;
      margin-left: 4px;
    }
    .login-modal .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }
    .login-modal .divider::before, .login-modal .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .login-modal .divider span {
      padding: 0 12px;
    }
    .login-modal .google-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-modal .google-btn:hover {
      background: var(--subtle);
      border-color: #dce1e7;
    }
    .login-modal .footer-links {
      margin-top: 24px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    .login-modal .footer-links a {
      color: var(--brand);
      cursor: pointer;
      text-decoration: none;
    }
    .login-modal .footer-links a:hover {
      text-decoration: underline;
    }


    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr;}
      #map{height: 450px;}
      #mapPanel { position: static; z-index: auto; }
    }
    @media (max-width: 880px){
      /* Mobile-first: behave like an app (single column + bottom nav) */
      .main{grid-template-columns: 1fr; margin-bottom: calc(120px + env(safe-area-inset-bottom));}
      .header-actions .chip{display:none;}

      /* Make header compact */
      .header-inner{padding: 0 12px;}
      .brand span{font-size: 16px;}
      #toggleStatusBtn{padding: 10px 10px;}
      #toggleStatusBtn span{display:none;} /* icon-only on small screens */
      #statusPill{padding: 8px 9px;}
      #statusPill span{display:none;} /* keep LED only */
      
      /* Show bottom nav (app feel) */
      .bottom-nav{ display:block; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
      .bottom-nav .bar{grid-template-columns: repeat(4, 1fr);} /* available, active, history, more */

      /* Show hamburger */
      #mobileMenuBtn{ display:inline-flex !important; }
      #logoutBtn{ display:none; } /* Save space on mobile */
      #sideLogoutBtn{ display:flex; }

      /* Offcanvas sidebar */
      .sidebar{
        display: block; /* Ensure visible for transform */
        position: fixed !important;
        top: 0 !important;
        left: 0;
        height: 100vh;
        width: min(var(--sidebar-w), 86vw);
        transform: translateX(-110%);
        transition: transform 220ms ease;
        z-index: 3200; /* above header */
        border-radius: 0 22px 22px 0;
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      .sidebar.open{
        transform: translateX(0);
      }
      /* hide redundant sidebar-only items (still available via content views) */
      .sidebar .nav-item.hide-on-mobile{ display:none; }

      /* Overlay for sidebar */
      #sideOverlay{
        display: none; /* Controlled by JS */
      }
      #sideOverlay.show{ display:block; }

      /* Fix content cut-off */
      .stats { grid-template-columns: repeat(2, 1fr); }
      .card .grid2 { grid-template-columns: 1fr; }

      /* Prevent long text from getting clipped on mobile */
      .title{width:100%;}
      .title span{max-width: 100%; white-space: normal; overflow: visible; text-overflow: initial; word-break: break-word;}
      .kv .v{white-space: normal; overflow: visible; text-overflow: initial; word-break: break-word;}

      /* Map should not dominate on small screens */
      #map{height: 340px;}
    }
    @media (max-width: 520px){
      .stats{grid-template-columns: repeat(2, minmax(0, 1fr));}
      #map{height: 300px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="header">
      <div class="header-inner">
        <div class="header-left">
          <div class="brand" title="Prince Alex Store">
            <div class="dot"></div>
            <span>Rider Dashboard</span>
          </div>
        </div>

        <div class="header-actions">
          <div id="statusPill" class="status-pill">
            <div class="led"></div>
            <span id="statusText">OFFLINE</span>
          </div>

          <button id="toggleStatusBtn" class="btn primary" title="Go Online/Offline">
            <i class="fa-solid fa-toggle-on"></i> <span id="toggleStatusLabel">Go Online</span>
          </button>

          <button id="logoutBtn" class="btn danger" title="Logout">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </button>

          <div class="chip" id="riderChip" style="display:none;">
            <img id="riderAvatar" class="avatar" alt="Rider" />
            <div class="meta">
              <div class="name" id="riderName">Rider</div>
              <div class="sub" id="riderEmail">email</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <aside class="sidebar">
        <div class="side-head">
          <h2>Quick Menu</h2>
          <p id="sideNote">Sign in to start receiving orders.</p>
        </div>

        <div class="nav" id="nav">
          <button class="nav-item active hide-on-mobile" data-view="available">
            <span><i class="fa-solid fa-box"></i> Available Orders</span>
            <span class="badge" id="badgeAvailable">0</span>
          </button>

          <button class="nav-item hide-on-mobile" data-view="active">
            <span><i class="fa-solid fa-motorcycle"></i> My Active</span>
            <span class="badge" id="badgeActive">0</span>
          </button>

          <button class="nav-item hide-on-mobile" data-view="history">
            <span><i class="fa-solid fa-clock-rotate-left"></i> History</span>
            <span class="badge" id="badgeHistory">0</span>
          </button>

          <button class="nav-item" data-view="earnings">
            <span><i class="fa-solid fa-coins"></i> Earnings</span>
            <span class="badge" id="badgeEarnings">KES</span>
          </button>

          <button class="nav-item" data-view="profile">
            <span><i class="fa-solid fa-user-gear"></i> Profile</span>
            <span class="badge"><i class="fa-solid fa-pen"></i></span>
          </button>

          <button class="nav-item" id="sideLogoutBtn" style="color:var(--danger);">
            <span><i class="fa-solid fa-right-from-bracket"></i> Logout</span>
          </button>
        </div>
      </aside>

      <section class="content">
        <div class="panel" id="statsPanel">
          <div class="panel-head">
            <h3>Overview</h3>
            <div class="map-hint" id="mapHint">
               <i class="fa-solid fa-location-dot"></i>
               <span>Live Map (OpenStreetMap)</span>
            </div>
          </div>
          <div class="panel-body">
            <div class="stats" id="statsContainer">
              <div class="stat">
                <div class="icon"><i class="fa-solid fa-list-check"></i></div>
                <div class="kpi">
                  <div class="v" id="kpiTotal">0</div>
                  <div class="l">Total (Active + History)</div>
                </div>
              </div>
              <div class="stat">
                <div class="icon"><i class="fa-solid fa-box-open"></i></div>
                <div class="kpi">
                  <div class="v" id="kpiAvailable">0</div>
                  <div class="l">Available</div>
                </div>
              </div>
              <div class="stat">
                <div class="icon"><i class="fa-solid fa-check-double"></i></div>
                <div class="kpi">
                  <div class="v" id="kpiDeliveredToday">0</div>
                  <div class="l">Delivered Today</div>
                </div>
              </div>
              <div class="stat">
                <div class="icon"><i class="fa-solid fa-sack-dollar"></i></div>
                <div class="kpi">
                  <div class="v" id="kpiEarnings">KES 0</div>
                  <div class="l">Total Earnings</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="panel">
            <div class="panel-head">
              <h3 id="listTitle">Orders</h3>
              <small id="ordersCount">0 shown</small>
            </div>
            <div class="panel-body">
              <div class="list" id="ordersList">
                <div class="card">
                  <div class="row">
                    <div class="title">
                      <strong>Loading…</strong>
                      <span>Please sign in and go online to receive orders.</span>
                    </div>
                    <span class="pill pending">Info</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel" id="mapPanel">
            <div class="panel-head">
              <h3>Delivery Map</h3>
              <small id="mapSmall">No active delivery</small>
            </div>
            <div class="panel-body">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom Nav (Mobile) -->
    <div class="bottom-nav">
      <div class="bar" id="bottomBar">
        <button class="bbtn active" data-view="available">
          <span class="bbadge" id="mBadgeAvailable">0</span>
          <i class="fa-solid fa-box"></i> Available
        </button>
        <button class="bbtn" data-view="active">
          <i class="fa-solid fa-motorcycle"></i> My Active
        </button>
        <button class="bbtn" data-view="history">
          <i class="fa-solid fa-clock-rotate-left"></i> History
        </button>
        <button class="bbtn" id="mobileMenuBtn">
          <i class="fa-solid fa-ellipsis"></i> More
        </button>
      </div>
    </div>

    <!-- Active Delivery Drawer -->
    <div class="drawer" id="drawer">
      <div class="drawer-head">
        <strong id="drawerTitle">Active Delivery</strong>
        <button class="btn ghost" id="drawerClose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="drawer-body" id="drawerBody">
        <div class="mini">No active delivery selected.</div>
      </div>
      <div class="drawer-foot" id="drawerFoot" style="display:none;">
        <button class="btn blue" id="drawerNavigate"><i class="fa-solid fa-route"></i> Navigate</button>
        <button class="btn primary" id="drawerDelivered"><i class="fa-solid fa-check"></i> Mark Delivered</button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <i class="fa-solid fa-bell"></i>
      <div class="t">
        <strong id="toastTitle">Notification</strong>
        <span id="toastMsg">Message</span>
      </div>
      <button class="btn ghost close" id="toastClose"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- Login Overlay -->
    <div class="overlay" id="loginOverlay" style="display:flex;">
      <div class="modal login-modal">
        <div class="mhead">
          <div class="brand" style="justify-content:center; margin-bottom:10px;">
             <div class="dot" style="width:16px; height:16px;"></div>
             <span style="font-size:20px;">Prince Alex Store</span>
          </div>
          <h2>Rider Login</h2>
          <p>Welcome back! Please enter your details.</p>
        </div>
        <div class="mbody">
          <div class="help" id="loginMessage" style="color:var(--danger); font-weight:700; margin-bottom:10px;"></div>

          <div class="field">
            <label>Email</label>
            <input id="loginEmail" type="email" placeholder="rider@example.com" />
          </div>
          <div class="field">
            <label>Password</label>
            <input id="loginPassword" type="password" placeholder="••••••" />
          </div>
          <button class="btn primary" id="emailLoginBtn" style="justify-content:center; margin-top:10px; width:100%;">Sign In</button>

          <div class="divider"><span>OR</span></div>

          <button class="google-btn" id="googleSignInBtn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
            Sign in with Google
          </button>

          <div class="footer-links">
            New rider? <a id="googleApplyBtn">Apply with Google</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Completion Overlay -->
    <div class="overlay" id="profileOverlay">
      <div class="modal">
        <div class="mhead">
          <h2>Complete Your Profile</h2>
          <span class="pill pending">Required</span>
        </div>
        <form id="profileForm">
          <div class="mbody">
            <div class="help">Add your phone and vehicle details so the admin can approve you and customers can reach you during delivery.</div>

            <div class="field">
              <label>Phone Number</label>
              <input id="profilePhone" placeholder="e.g. 0712 345 678" inputmode="tel" required />
            </div>
            <div class="field">
              <label>Vehicle Model</label>
              <input id="profileVehicle" placeholder="e.g. Boxer 150" required />
            </div>
            <div class="field">
              <label>License Plate</label>
              <input id="profilePlate" placeholder="e.g. KMD 123A" required />
            </div>

            <div class="help">Tip: Use a WhatsApp number for faster customer communication.</div>
          </div>
          <div class="mfoot">
            <button type="button" class="btn ghost" id="profileCancel"><i class="fa-solid fa-xmark"></i> Later</button>
            <button type="submit" class="btn primary"><i class="fa-solid fa-check"></i> Save & Continue</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delivery Confirmation Modal -->
    <div class="overlay" id="confirmOverlay">
      <div class="modal">
        <div class="mhead">
          <h2>Confirm Delivery</h2>
          <span class="pill delivered">Complete</span>
        </div>
        <div class="mbody">
          <div class="help" id="confirmText">Confirm you delivered this order and received correct payment (if Cash on Delivery).</div>
          <div id="confirmDetails" class="kv" style="background: rgba(255,255,255,0.06);"></div>
        </div>
        <div class="mfoot">
          <button class="btn ghost" id="confirmNo"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button class="btn primary" id="confirmYes"><i class="fa-solid fa-check"></i> Yes, Complete</button>
        </div>
      </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="overlay" id="sideOverlay"></div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot, doc, getDoc, setDoc, updateDoc, addDoc, limit, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // --- Firebase Configuration (kept same as your project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
      authDomain: "princealextravel.firebaseapp.com",
      projectId: "princealextravel",
      storageBucket: "princealextravel.firebasestorage.app",
      messagingSenderId: "947577729462",
      appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- UI Elements ---
    const loginOverlay = document.getElementById("loginOverlay");
    const profileOverlay = document.getElementById("profileOverlay");
    const confirmOverlay = document.getElementById("confirmOverlay");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const emailLoginBtn = document.getElementById("emailLoginBtn");
    const googleApplyBtn = document.getElementById("googleApplyBtn");
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const loginMessage = document.getElementById("loginMessage");
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const sideLogoutBtn = document.getElementById("sideLogoutBtn");
    const sideOverlay = document.getElementById("sideOverlay");

    const riderChip = document.getElementById("riderChip");
    const riderAvatar = document.getElementById("riderAvatar");
    const riderName = document.getElementById("riderName");
    const riderEmail = document.getElementById("riderEmail");

    const logoutBtn = document.getElementById("logoutBtn");
    const toggleStatusBtn = document.getElementById("toggleStatusBtn");
    const toggleStatusLabel = document.getElementById("toggleStatusLabel");
    const statusPill = document.getElementById("statusPill");
    const statusText = document.getElementById("statusText");
    const sideNote = document.getElementById("sideNote");

    const statsPanel = document.getElementById("statsPanel");
    const listTitle = document.getElementById("listTitle");
    const ordersList = document.getElementById("ordersList");
    const ordersCount = document.getElementById("ordersCount");

    // badges
    const badgeAvailable = document.getElementById("badgeAvailable");
    const badgeActive = document.getElementById("badgeActive");
    const badgeHistory = document.getElementById("badgeHistory");
    const badgeEarnings = document.getElementById("badgeEarnings");
    const mBadgeAvailable = document.getElementById("mBadgeAvailable");

    // KPIs
    const kpiTotal = document.getElementById("kpiTotal");
    const kpiAvailable = document.getElementById("kpiAvailable");
    const kpiDeliveredToday = document.getElementById("kpiDeliveredToday");
    const kpiEarnings = document.getElementById("kpiEarnings");
    const statsContainer = document.getElementById("statsContainer");
    const mapPanel = document.getElementById("mapPanel");

    // Drawer
    const drawer = document.getElementById("drawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerBody = document.getElementById("drawerBody");
    const drawerFoot = document.getElementById("drawerFoot");
    const drawerClose = document.getElementById("drawerClose");
    const drawerNavigate = document.getElementById("drawerNavigate");
    const drawerDelivered = document.getElementById("drawerDelivered");

    // Confirm modal
    const confirmText = document.getElementById("confirmText");
    const confirmDetails = document.getElementById("confirmDetails");
    const confirmNo = document.getElementById("confirmNo");
    const confirmYes = document.getElementById("confirmYes");

    // Profile form
    const profileForm = document.getElementById("profileForm");
    const profilePhone = document.getElementById("profilePhone");
    const profileVehicle = document.getElementById("profileVehicle");
    const profilePlate = document.getElementById("profilePlate");
    const profileCancel = document.getElementById("profileCancel");

    // Toast
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    const toastClose = document.getElementById("toastClose");

    // Nav
    const nav = document.getElementById("nav");
    const bottomBar = document.getElementById("bottomBar");

    // --- State ---
    let currentUser = null;
    let currentRider = null;          // rider doc data {id: email, ...}
    let riderStatus = "offline";      // 'online' | 'offline'
    let view = "available";           // nav view
    let ordersUnsub = null;
    let riderUnsub = null;

    let allRealtime = [];
    let availableOrders = [];
    let myActiveOrders = [];
    let myHistory = [];

    let activeFocusOrder = null;      // order shown in drawer
    let completingOrder = null;       // order for confirmation modal

    const notificationSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
    let firstOrdersLoad = true;
    let prevAvailableIds = new Set();

    // --- Helpers ---
    function nowISO(){ return new Date().toISOString(); }
    function money(n){
      const v = Number(n || 0);
      return `KES ${v.toLocaleString()}`;
    }
    function safe(v, fallback="-"){
      if(v === undefined || v === null || v === "") return fallback;
      return String(v);
    }

    function getFriendlyErrorMessage(err){
      console.error(err);
      const c = err.code;
      if(c === "auth/invalid-credential" || c === "auth/user-not-found" || c === "auth/wrong-password") return "Invalid email or password.";
      if(c === "auth/invalid-email") return "Invalid email format.";
      if(c === "auth/too-many-requests") return "Too many attempts. Please wait a moment.";
      if(c === "auth/network-request-failed") return "Network error. Check your connection.";
      if(c === "permission-denied") return "Permission denied.";
      return err.message || "An unknown error occurred.";
    }

    function setStatusUI(){
      const online = riderStatus === "online";
      statusPill.classList.toggle("online", online);
      statusText.textContent = online ? "ONLINE" : "OFFLINE";
      toggleStatusLabel.textContent = online ? "Go Offline" : "Go Online";
      toggleStatusBtn.querySelector("i").className = online ? "fa-solid fa-toggle-on" : "fa-solid fa-toggle-off";
    }

    function showToast(title, msg, type="success"){
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.style.borderLeftColor = type === "error" ? "var(--danger)" : (type === "warn" ? "var(--warn)" : "var(--brand)");
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 8000);
    }
    toastClose.addEventListener("click", ()=>toast.classList.remove("show"));

    // --- Mobile Menu Logic ---
    function openSideMenu(){
      document.querySelector(".sidebar").classList.add("open");
      sideOverlay.classList.add("show");
    }
    function closeSideMenu(){
      document.querySelector(".sidebar").classList.remove("open");
      sideOverlay.classList.remove("show");
    }
    mobileMenuBtn.addEventListener("click", openSideMenu);
    sideOverlay.addEventListener("click", closeSideMenu);

    function setView(v){
      view = v;
      // update sidebar
      [...nav.querySelectorAll(".nav-item")].forEach(b=>b.classList.toggle("active", b.dataset.view===v));
      // update bottom
      [...bottomBar.querySelectorAll(".bbtn")].forEach(b=>b.classList.toggle("active", b.dataset.view===v));

      // title
      const titles = {
        available: "Available Orders",
        active: "My Active Deliveries",
        history: "Delivery History",
        earnings: "Earnings",
        profile: "My Profile"
      };
      if(listTitle) listTitle.textContent = titles[v] || "Orders";
      render();

      // Toggle sections based on view
      if(v === "available"){
        if(statsPanel) statsPanel.style.display = "block";
        if(mapPanel) mapPanel.style.display = "block";
        if(map) setTimeout(() => map.invalidateSize(), 200);
      } else if(v === "active"){
        if(statsPanel) statsPanel.style.display = "none";
        if(mapPanel) mapPanel.style.display = "block";
        if(map) setTimeout(() => map.invalidateSize(), 200);
      } else if(v === "history" || v === "earnings" || v === "profile"){
        if(statsPanel) statsPanel.style.display = "none";
        if(mapPanel) mapPanel.style.display = "none";
      } else {
        if(statsPanel) statsPanel.style.display = "block";
        if(mapPanel) mapPanel.style.display = "block";
      }
    }
    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest(".nav-item");
      if(!btn) return;
      setView(btn.dataset.view);
      closeSideMenu(); // Close on mobile selection
    });
    bottomBar.addEventListener("click", (e) => {
      const btn = e.target.closest(".bbtn");
      if(!btn) return;
      // The "More" button doesn't have a data-view, it's handled by the mobileMenuBtn listener
      if (btn.dataset.view) {
        setView(btn.dataset.view);
      }
    });

    drawerClose.addEventListener("click", ()=>drawer.classList.remove("open"));

    // --- Auth Actions ---
    emailLoginBtn.addEventListener("click", async () => {
      const email = loginEmail.value;
      const password = loginPassword.value;
      loginMessage.textContent = ""; // Clear inline message

      if(!email || !password){
        showToast("Missing Info", "Please enter both email and password.", "warn");
        return;
      }
      
      const originalText = emailLoginBtn.textContent;
      emailLoginBtn.textContent = "Signing in...";
      emailLoginBtn.disabled = true;

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        // Check rider doc
        const riderRef = doc(db, "riders", cred.user.email);
        const snap = await getDoc(riderRef);
        if(!snap.exists()){
          await signOut(auth);
          showToast("Account Not Found", "No rider account found. Please apply first.", "error");
        } else {
          showToast("Welcome Back", "Signed in successfully.", "success");
        }
      } catch(err) {
        showToast("Login Failed", getFriendlyErrorMessage(err), "error");
      } finally {
        emailLoginBtn.textContent = originalText;
        emailLoginBtn.disabled = false;
      }
    });

    async function googleAuth(isApply){
      const provider = new GoogleAuthProvider();
      try{
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // rider document uses email as ID
        const riderRef = doc(db, "riders", user.email);
        const snap = await getDoc(riderRef);

        if(isApply){
          if(!snap.exists()){
            await setDoc(riderRef, {
              name: user.displayName || "Rider",
              email: user.email,
              photoURL: user.photoURL || "",
              status: "pending",
              createdAt: nowISO(),
              phone: user.phoneNumber || ""
            });

            // Email queue (requires server/extension to send)
            await addDoc(collection(db, "mail"), {
              to: user.email,
              message: {
                subject: "Application Received - Prince Alex Store Rider",
                html: `
                  <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden">
                    <div style="background:#00C853;color:white;padding:18px 22px">
                      <h2 style="margin:0">Application Received</h2>
                    </div>
                    <div style="padding:22px">
                      <p style="margin:0 0 10px">Hi ${user.displayName || "Rider"},</p>
                      <p style="margin:0 0 10px;line-height:1.6;color:#374151">
                        Thank you for applying to join Prince Alex Store as a rider partner. Your application is <b>pending approval</b>.
                      </p>
                      <p style="margin:0;line-height:1.6;color:#374151">
                        You will receive an update once your status is approved.
                      </p>
                    </div>
                  </div>
                `
              },
              emailType: "rider_application",
              createdAt: nowISO(),
              status: "pending",
              priority: "high"
            });

            showToast("Application submitted", "Your rider account was created. Wait for approval.", "success");
          }else{
            showToast("Already applied", "This email already has a rider account. Use Sign In.", "warn");
          }
        }else{
          if(!snap.exists()){
            await signOut(auth);
            showToast("Account Not Found", "No rider account found. Please apply first.", "error");
            return;
          }
          showToast("Welcome Back", "Signed in successfully.", "success");
        }
      }catch(err){
        showToast("Authentication Failed", getFriendlyErrorMessage(err), "error");
      }
    }

    googleApplyBtn.addEventListener("click", ()=>googleAuth(true));
    googleSignInBtn.addEventListener("click", ()=>googleAuth(false));

    logoutBtn.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
        showToast("Logged out", "See you next time.", "success");
      }catch(err){
        showToast("Logout Failed", getFriendlyErrorMessage(err), "error");
      }
    });
    if(sideLogoutBtn) sideLogoutBtn.addEventListener("click", () => logoutBtn.click());

    // --- Profile Completion ---
    profileCancel.addEventListener("click", ()=>{
      profileOverlay.style.display = "none";
      showToast("Profile", "You can complete it later, but approval may be delayed.", "warn");
    });

    profileForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!currentRider) return;

      const phone = profilePhone.value.trim();
      const vehicle = profileVehicle.value.trim();
      const plate = profilePlate.value.trim().toUpperCase();

      if(!phone || !vehicle || !plate){
        showToast("Missing info", "Please fill all fields.", "warn");
        return;
      }

      try{
        const riderRef = doc(db, "riders", currentRider.id);
        await updateDoc(riderRef, {
          phone,
          vehicle: { model: vehicle, plate },
          // Do NOT auto-approve here. Admin can approve.
          updatedAt: nowISO()
        });
        profileOverlay.style.display = "none";
        showToast("Saved", "Profile updated successfully.", "success");
      }catch(err){
        showToast("Update Failed", getFriendlyErrorMessage(err), "error");
      }
    });

    // --- Rider status toggle ---
    toggleStatusBtn.addEventListener("click", async ()=>{
      if(!currentRider){
        showToast("Sign in required", "Please sign in first.", "warn");
        return;
      }
      if(currentRider.status !== "active"){
        showToast("Not approved yet", "Your account is not active. Wait for admin approval.", "warn");
        return;
      }

      riderStatus = riderStatus === "online" ? "offline" : "online";
      setStatusUI();

      try{
        await updateDoc(doc(db, "riders", currentRider.id), {
          availability: riderStatus,
          lastSeenAt: nowISO()
        });
        showToast("Status updated", `You are now ${riderStatus.toUpperCase()}.`, "success");
      }catch(err){
        showToast("Update Failed", getFriendlyErrorMessage(err), "error");
      }
    });

    // --- Orders listeners ---
    function stopListeners(){
      if(ordersUnsub) ordersUnsub();
      if(riderUnsub) riderUnsub();
      ordersUnsub = null;
      riderUnsub = null;
    }

    function startListeners(){
      if(!currentRider) return;

      // rider doc live
      const riderRef = doc(db, "riders", currentRider.id);
      riderUnsub = onSnapshot(riderRef, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data();
        currentRider = { id: snap.id, ...data };

        // Update UI
        riderChip.style.display = "flex";
        riderName.textContent = safe(currentRider.name, "Rider");
        riderEmail.textContent = safe(currentRider.email, currentRider.id);
        riderAvatar.src = currentRider.photoURL || "https://ui-avatars.com/api/?background=0b1220&color=ffffff&name=Rider";

        sideNote.textContent = currentRider.status === "active"
          ? "Go online to receive and accept delivery requests."
          : (currentRider.status === "pending" ? "Your account is pending approval." : "Your account is not active.");

        // If pending/incomplete profile, ask for details
        const needsProfile = !currentRider.phone || !currentRider.vehicle?.model || !currentRider.vehicle?.plate;
        if(needsProfile){
          profilePhone.value = currentRider.phone || "";
          profileVehicle.value = currentRider.vehicle?.model || "";
          profilePlate.value = currentRider.vehicle?.plate || "";
          profileOverlay.style.display = "flex";
        }

        // sync status pill from firestore if exists
        if(data.availability === "online" || data.availability === "offline"){
          riderStatus = data.availability;
          setStatusUI();
        }
      });

      // orders in realtime for ready pickup & transit
      const ordersRef = collection(db, "orders");
      const q = query(ordersRef, where("status","in",["Ready for Pickup","On Transit"]));
      ordersUnsub = onSnapshot(q, (snap)=>{
        allRealtime = [];
        snap.forEach(d=>allRealtime.push({ id: d.id, ...d.data() }));

        availableOrders = allRealtime.filter(o=>o.status==="Ready for Pickup");
        myActiveOrders = allRealtime.filter(o=>o.status==="On Transit" && o.riderId===currentRider.id);

        // notifications for new available orders
        if(!firstOrdersLoad && riderStatus==="online"){
          const newOnes = availableOrders.filter(o=>!prevAvailableIds.has(o.id));
          newOnes.forEach(o=>notifyNewOrder(o));
        }
        prevAvailableIds = new Set(availableOrders.map(o=>o.id));
        firstOrdersLoad = false;

        // update active focus if it changed
        if(activeFocusOrder){
          const updated = allRealtime.find(x=>x.id===activeFocusOrder.id) || myHistory.find(x=>x.id===activeFocusOrder.id);
          if(updated) activeFocusOrder = updated;
        }

        updateKPIs();
        render();
      });

      // history (delivered) - query riderId & status delivered
      // NOTE: This may require composite index. If it fails, we fallback to client filtering.
      // FIX: Use simple query to avoid index requirement
      const hq = query(ordersRef, where("riderId","==",currentRider.id));
      onSnapshot(hq, (snap)=>{
        myHistory = [];
        snap.forEach(d => {
            const data = d.data();
            if (data.status === 'Delivered') {
                myHistory.push({ id: d.id, ...data });
            }
        });
        myHistory.sort((a,b)=> new Date(b.deliveredAt || b.date || 0) - new Date(a.deliveredAt || a.date || 0));
        updateKPIs();
        if(view==="history" || view==="earnings") render();
      }, (err)=>{
        console.warn("History query failed (index may be required):", err.message);
      });
    }

    function notifyNewOrder(order){
      // sound
      notificationSound.play().catch(()=>{});
      // in-app toast
      showToast("New Delivery Request", `Order #${order.id} is ready for pickup.`, "success");

      // system notification
      if("Notification" in window && Notification.permission==="granted"){
        const n = new Notification("New Delivery Request 📦", {
          body: `Order #${order.id} is ready for pickup.`,
          requireInteraction: true
        });
        n.onclick = () => {
          window.focus();
          setView("available");
        };
      }
    }

    function updateKPIs(){
      // badges
      badgeAvailable.textContent = String(availableOrders.length);
      badgeActive.textContent = String(myActiveOrders.length);
      badgeHistory.textContent = String(myHistory.length);

      // mobile badge
      if(availableOrders.length>0){
        mBadgeAvailable.style.display = "inline-flex";
        mBadgeAvailable.textContent = String(availableOrders.length);
      }else{
        mBadgeAvailable.style.display = "none";
      }

      // totals
      const total = myActiveOrders.length + myHistory.length;
      kpiTotal.textContent = String(total);
      kpiAvailable.textContent = String(availableOrders.length);

      const today = new Date().toDateString();
      const deliveredToday = myHistory.filter(o=>{
        const d = new Date(o.deliveredAt || o.date || 0);
        return d.toDateString() === today;
      }).length;
      kpiDeliveredToday.textContent = String(deliveredToday);

      const earnings = myHistory.reduce((sum,o)=> sum + (Number(o.riderFee) || Number(o.transportationFee) || 0), 0);
      kpiEarnings.textContent = money(earnings);
      badgeEarnings.textContent = money(earnings).replace("KES ","KES ");
    }

    function pillFor(order){
      const s = order.status;
      if(s==="Ready for Pickup") return `<span class="pill pickup">Ready</span>`;
      if(s==="On Transit") return `<span class="pill transit">On Transit</span>`;
      if(s==="Delivered") return `<span class="pill delivered">Delivered</span>`;
      if(s==="Cancelled") return `<span class="pill cancelled">Cancelled</span>`;
      return `<span class="pill pending">${safe(s,"Pending")}</span>`;
    }

    function render(){
      if(!currentRider){
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>Sign in</strong>
                <span>Use Google to apply or sign in.</span>
              </div>
              <span class="pill pending">Auth</span>
            </div>
          </div>
        `;
        ordersCount.textContent = "0 shown";
        return;
      }

      // view specific
      if(view==="earnings"){
        const earnings = myHistory.reduce((sum,o)=> sum + (Number(o.riderFee) || Number(o.transportationFee) || 0), 0);
        const delivered = myHistory.length;
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>Earnings Summary</strong>
                <span>Based on your delivered orders.</span>
              </div>
              <span class="pill delivered">Summary</span>
            </div>
            <div class="grid2">
              <div class="kv"><div class="k">Total Earnings</div><div class="v">${money(earnings)}</div></div>
              <div class="kv"><div class="k">Delivered Orders</div><div class="v">${delivered}</div></div>
            </div>
            <div class="help">Tip: You can set a rider fee per order in admin. Earnings are calculated from <b>riderFee</b> or <b>transportationFee</b>.</div>
          </div>
        `;
        ordersCount.textContent = "1 shown";
        return;
      }

      if(view==="profile"){
        const r = currentRider;
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>${safe(r.name,"Rider")}</strong>
                <span>${safe(r.email,r.id)}</span>
              </div>
              <span class="pill ${r.status==="active" ? "delivered" : "pending"}">${safe(r.status,"pending")}</span>
            </div>

            <div class="grid2">
              <div class="kv"><div class="k">Phone</div><div class="v">${safe(r.phone,"Not set")}</div></div>
              <div class="kv"><div class="k">Availability</div><div class="v">${safe(r.availability,"offline")}</div></div>
              <div class="kv"><div class="k">Vehicle Model</div><div class="v">${safe(r.vehicle?.model,"Not set")}</div></div>
              <div class="kv"><div class="k">Plate</div><div class="v">${safe(r.vehicle?.plate,"Not set")}</div></div>
            </div>

            <div class="actions">
              <button class="btn blue" id="editProfileBtn"><i class="fa-solid fa-pen"></i> Edit Profile</button>
            </div>
          </div>
        `;
        ordersCount.textContent = "1 shown";
        setTimeout(()=>{
          const b = document.getElementById("editProfileBtn");
          if(b){
            b.addEventListener("click", ()=>{
              profilePhone.value = currentRider.phone || "";
              profileVehicle.value = currentRider.vehicle?.model || "";
              profilePlate.value = currentRider.vehicle?.plate || "";
              profileOverlay.style.display = "flex";
            });
          }
        }, 0);
        return;
      }

      let list = [];
      if(view==="available") list = availableOrders;
      if(view==="active") list = myActiveOrders;
      if(view==="history") list = myHistory;

      if(view==="available" && riderStatus!=="online"){
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>You are Offline</strong>
                <span>Go online to accept delivery requests.</span>
              </div>
              <span class="pill pending">Offline</span>
            </div>
          </div>
        `;
        ordersCount.textContent = "0 shown";
        return;
      }

      if(view==="available" && currentRider.status!=="active"){
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>Awaiting Approval</strong>
                <span>Your rider status is "${safe(currentRider.status)}". Admin must approve you.</span>
              </div>
              <span class="pill pending">Pending</span>
            </div>
          </div>
        `;
        ordersCount.textContent = "0 shown";
        return;
      }

      if(list.length===0){
        ordersList.innerHTML = `
          <div class="card">
            <div class="row">
              <div class="title">
                <strong>No orders</strong>
                <span>${view==="history" ? "No delivered orders yet." : "Nothing here right now. Stay online."}</span>
              </div>
              <span class="pill pending">Empty</span>
            </div>
          </div>
        `;
        ordersCount.textContent = "0 shown";
        return;
      }

      ordersList.innerHTML = list.map(order=>{
        const customer = order.customer || {};
        const loc = customer.deliveryLocation || order.deliveryLocation || "Unknown location";
        const phone = customer.phone || customer.phoneNumber || order.customerPhone || "";
        const pay = order.paymentMethod || order.paymentOption || "Cash on Delivery";
        const total = order.total || order.totalAmount || order.grandTotal || 0;

        // Badges
        let badgesHtml = "";
        if(pay.toLowerCase().includes("cash")){
          badgesHtml += `<div class="badge-pill cash"><i class="fa-solid fa-money-bill-wave"></i> Cash</div>`;
        }
        if(order.deliveryInfo?.estimatedDelivery){
          badgesHtml += `<div class="badge-pill dist"><i class="fa-solid fa-clock"></i> ${order.deliveryInfo.estimatedDelivery}</div>`;
        }
        // Example priority
        // badgesHtml += `<div class="badge-pill priority"><i class="fa-solid fa-fire"></i> Hot</div>`;

        // Stepper
        let stepIdx = 0;
        if(order.status === "Ready for Pickup") stepIdx = 0;
        else if(order.status === "On Transit") stepIdx = 2; // skip accepted visual or make it 2nd
        else if(order.status === "Delivered") stepIdx = 3;

        const getStepClass = (i) => i < stepIdx ? "done" : (i === stepIdx ? "active" : "");
        const stepperHtml = `
          <div class="stepper">
            <div class="step ${getStepClass(0)}"><div class="step-dot"></div><div class="step-label">Ready</div></div>
            <div class="step ${getStepClass(1)}"><div class="step-dot"></div><div class="step-label">Accepted</div></div>
            <div class="step ${getStepClass(2)}"><div class="step-dot"></div><div class="step-label">Transit</div></div>
            <div class="step ${getStepClass(3)}"><div class="step-dot"></div><div class="step-label">Delivered</div></div>
          </div>
        `;

        const actionButtons = (() => {
          if(view==="available"){
            return `
              <button class="btn primary js-accept" data-id="${order.id}">
                <i class="fa-solid fa-handshake"></i> Accept
              </button>
              <button class="btn blue js-view" data-id="${order.id}">
                <i class="fa-solid fa-eye"></i> Details
              </button>
            `;
          }
          if(view==="active"){
            return `
              <button class="btn blue js-nav" data-id="${order.id}">
                <i class="fa-solid fa-route"></i> Navigate
              </button>
              <button class="btn primary js-deliver" data-id="${order.id}">
                <i class="fa-solid fa-check"></i> Mark Delivered
              </button>
              <button class="btn ghost js-view" data-id="${order.id}">
                <i class="fa-solid fa-eye"></i> Details
              </button>
            `;
          }
          if(view==="history"){
            return `
              <button class="btn ghost js-view" data-id="${order.id}">
                <i class="fa-solid fa-receipt"></i> View
              </button>
            `;
          }
          return "";
        })();

        return `
          <div class="card">
            <div class="badges">${badgesHtml}</div>
            <div class="row">
              <div class="title">
                <strong>Order #${order.id}</strong>
                <span>${loc}</span>
              </div>
              ${pillFor(order)}
            </div>
            ${stepperHtml}

            <div class="grid2">
              <div class="kv"><div class="k">Customer</div><div class="v">${safe(customer.fullName || customer.name || order.customerName, "Customer")}</div></div>
              <div class="kv"><div class="k">Phone</div><div class="v">${safe(phone, "Not provided")}</div></div>
              <div class="kv"><div class="k">Payment</div><div class="v">${safe(pay)}</div></div>
              <div class="kv"><div class="k">Order Total</div><div class="v">${money(total)}</div></div>
            </div>

            <div class="actions">
              ${actionButtons}
            </div>
          </div>
        `;
      }).join("");

      ordersCount.textContent = `${list.length} shown`;

      // bind events
      ordersList.querySelectorAll(".js-view").forEach(b=>b.addEventListener("click", ()=>openDetails(b.dataset.id)));
      ordersList.querySelectorAll(".js-nav").forEach(b=>b.addEventListener("click", ()=>navigateOrder(b.dataset.id)));
      ordersList.querySelectorAll(".js-deliver").forEach(b=>b.addEventListener("click", ()=>openConfirm(b.dataset.id)));
      ordersList.querySelectorAll(".js-accept").forEach(b=>b.addEventListener("click", ()=>acceptOrder(b.dataset.id)));
    }

    function openDetails(orderId){
      const o = [...availableOrders, ...myActiveOrders, ...myHistory].find(x=>x.id===orderId);
      if(!o) return;
      activeFocusOrder = o;

      const customer = o.customer || {};
      const items = Array.isArray(o.items) ? o.items : (Array.isArray(o.orderItems) ? o.orderItems : []);
      const itemsHtml = items.length
        ? `<div class="kv" style="grid-column:1/-1;"><div class="k">Items</div><div class="v" style="white-space:normal;line-height:1.6">${items.map(it=>`${safe(it.name)} x${safe(it.quantity,1)}`).join(", ")}</div></div>`
        : `<div class="mini">No items list found on this order.</div>`;

      drawerTitle.textContent = `Order #${o.id}`;
      drawerBody.innerHTML = `
        <div class="grid2">
          <div class="kv"><div class="k">Status</div><div class="v">${safe(o.status)}</div></div>
          <div class="kv"><div class="k">Total</div><div class="v">${money(o.total || o.totalAmount || o.grandTotal || 0)}</div></div>
          <div class="kv"><div class="k">Customer</div><div class="v">${safe(customer.fullName || customer.name || o.customerName, "Customer")}</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v">${safe(customer.phone || o.customerPhone, "Not provided")}</div></div>
          <div class="kv" style="grid-column:1/-1;"><div class="k">Location</div><div class="v" style="white-space:normal;line-height:1.6">${safe(customer.deliveryLocation || o.deliveryLocation, "Unknown")}</div></div>
          ${itemsHtml}
        </div>
        <div class="help">Use Navigate for directions. Mark Delivered only after handing over items.</div>
      `;
      drawerFoot.style.display = (o.status==="On Transit") ? "flex" : "none";

      drawerNavigate.onclick = () => navigateOrder(o.id);
      drawerDelivered.onclick = () => openConfirm(o.id);

      drawer.classList.add("open");
      updateMapFocus(o);
    }

    function buildNavUrl(order){
      const c = order.customer || {};
      const lat = c.lat || c.latitude || order.lat;
      const lng = c.lng || c.longitude || order.lng;
      if(lat && lng){
        return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}&travelmode=driving`;
      }
      const addr = c.deliveryLocation || order.deliveryLocation;
      if(addr){
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      }
      return "https://www.google.com/maps";
    }

    function navigateOrder(orderId){
      const o = [...availableOrders, ...myActiveOrders, ...myHistory].find(x=>x.id===orderId);
      if(!o) return;
      window.open(buildNavUrl(o), "_blank");
    }

    async function acceptOrder(orderId){
      if(!currentRider) return;
      if(riderStatus!=="online"){
        showToast("Offline", "Go online first to accept orders.", "warn");
        return;
      }
      if(currentRider.status!=="active"){
        showToast("Not approved", "Your account must be active.", "warn");
        return;
      }

      try{
        const orderRef = doc(db, "orders", orderId);

        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(orderRef);
          if(!snap.exists()) throw new Error("Order not found.");
          const o = snap.data();
          if(o.status !== "Ready for Pickup") throw new Error("Order is no longer available.");
          if(o.riderId) throw new Error("Another rider already accepted this order.");

          tx.update(orderRef, {
            status: "On Transit",
            riderId: currentRider.id,
            riderName: currentRider.name || "",
            riderPhone: currentRider.phone || "",
            acceptedAt: nowISO()
          });
        });

        showToast("Accepted", `You accepted Order #${orderId}.`, "success");
        setView("active");
      }catch(err){
        showToast("Cannot Accept", getFriendlyErrorMessage(err), "error");
      }
    }

    window.resendVerificationCode = async function(orderId){
      const btn = document.getElementById("resendCodeBtn");
      if(btn) {
        btn.disabled = true;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Sending...`;
      }

      try {
        const o = completingOrder;
        if(!o || o.id !== orderId) throw new Error("Order context lost.");
        
        const code = o.deliveryVerificationCode;
        if(!code) throw new Error("No code found to resend.");

        const customerEmail = o.userEmail || (o.customer ? o.customer.email : null);
        if(!customerEmail) throw new Error("Customer email missing.");

        await addDoc(collection(db, "mail"), {
            to: customerEmail,
            message: {
            subject: `Resent: Delivery Code ${code}`,
            html: `
                <div style="font-family:sans-serif; padding:20px; border:1px solid #eee; border-radius:10px;">
                <h2 style="color:#00C853; margin-top:0;">Order Arriving!</h2>
                <p>Please provide this code to the rider to confirm delivery:</p>
                <div style="background:#f5f5f5; padding:15px; text-align:center; font-size:32px; font-weight:bold; letter-spacing:5px; border-radius:5px; margin:20px 0; color:#333;">
                    ${code}
                </div>
                <p style="color:#666; font-size:14px;">Order #${orderId}</p>
                </div>
            `
            },
            emailType: "delivery_verification_resend",
            orderId: orderId,
            createdAt: nowISO(),
            priority: "high",
            status: "pending"
        });

        showToast("Sent", "Code resent successfully.", "success");

        // Cooldown
        if(btn){
          let s = 30;
          const t = setInterval(()=>{
            s--;
            if(s<=0){
              clearInterval(t);
              btn.disabled = false;
              btn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Resend Code`;
            }else{
              btn.innerHTML = `Resend in ${s}s`;
            }
          }, 1000);
        }

      } catch(err){
        showToast("Error", err.message, "error");
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Resend Code`;
        }
      }
    };

    async function openConfirm(orderId){
      const o = [...myActiveOrders].find(x=>x.id===orderId);
      if(!o){
        showToast("Not available", "Only your active orders can be completed.", "warn");
        return;
      }
      completingOrder = o;

      const pay = o.paymentMethod || o.paymentOption || "Cash on Delivery";
      const isCash = pay.toLowerCase().includes("cash");
      
      // Hide default text, we will render a custom layout
      confirmText.style.display = 'none';
      confirmDetails.style.background = 'transparent';
      confirmDetails.style.border = 'none';
      confirmDetails.className = ''; // Remove kv class to reset styles

      const customer = o.customer || {};
      const total = o.total || o.totalAmount || o.grandTotal || 0;

      if(isCash){
        confirmDetails.innerHTML = `
        <div style="text-align:center; padding: 10px 0;">
           <div style="width:64px; height:64px; background:${isCash ? 'rgba(255,176,32,0.15)' : 'rgba(0,200,83,0.15)'}; color:${isCash ? 'var(--warn)' : 'var(--brand)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:28px;">
              <i class="fa-solid ${isCash ? 'fa-hand-holding-dollar' : 'fa-check-circle'}"></i>
           </div>
           <h3 style="margin-bottom:8px; font-size:18px; color:var(--text);">${isCash ? 'Collect Cash Payment' : 'Confirm Delivery'}</h3>
           <p style="color:var(--muted); font-size:14px; margin-bottom:24px; line-height:1.5;">
             ${isCash ? 'Please collect the total amount below from the customer before releasing items.' : 'This order is already paid. Confirm you have handed over the items.'}
           </p>
           
           <div style="background:var(--subtle); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid var(--border);">
             <div style="font-size:12px; color:var(--muted); text-transform:uppercase; font-weight:800; letter-spacing:0.5px;">Total Amount</div>
             <div style="font-size:28px; font-weight:900; color:var(--text); margin:4px 0;">${money(total)}</div>
             <div style="font-size:13px; font-weight:700; color:${isCash ? 'var(--warn)' : 'var(--brand)'}; display:flex; align-items:center; justify-content:center; gap:6px;">
               <i class="fa-solid ${isCash ? 'fa-money-bill' : 'fa-credit-card'}"></i> ${safe(pay)}
             </div>
           </div>
           <div style="margin-top: 15px; text-align:left;">
                <label style="display:block; margin-bottom:5px; font-weight:700; font-size:12px; color:var(--muted);">Cash Received (KES)</label>
                <input type="number" id="delivery-amount-received" style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--border); background:var(--bg); font-weight:700; font-size:16px;" placeholder="${total}">
           </div>
        </div>
        `;
      } else {
        // Paid Order - Verification Code Logic
        let code = o.deliveryVerificationCode;
        
        // If no code exists, generate and send it
        if(!code){
           showToast("Security", "Generating verification code...", "info");
           code = Math.floor(1000 + Math.random() * 9000).toString();
           
           // Optimistic update
           completingOrder.deliveryVerificationCode = code;

           try {
               // Save to DB
               await updateDoc(doc(db, "orders", orderId), { deliveryVerificationCode: code });
               
               // Send Email
               const customerEmail = o.userEmail || (o.customer ? o.customer.email : null);
               if(customerEmail){
                   await addDoc(collection(db, "mail"), {
                      to: customerEmail,
                      message: {
                        subject: `Delivery Code: ${code}`,
                        html: `
                          <div style="font-family:sans-serif; padding:20px; border:1px solid #eee; border-radius:10px;">
                            <h2 style="color:#00C853; margin-top:0;">Order Arriving!</h2>
                            <p>Please provide this code to the rider to confirm delivery:</p>
                            <div style="background:#f5f5f5; padding:15px; text-align:center; font-size:32px; font-weight:bold; letter-spacing:5px; border-radius:5px; margin:20px 0; color:#333;">
                              ${code}
                            </div>
                            <p style="color:#666; font-size:14px;">Order #${orderId}</p>
                          </div>
                        `
                      },
                      emailType: "delivery_verification",
                      orderId: orderId,
                      createdAt: nowISO(),
                      priority: "high",
                      status: "pending"
                   });
                   showToast("Code Sent", "Verification code sent to customer email.", "success");
               }
           } catch(e) {
               console.error(e);
               showToast("Error", "Failed to generate code. Try again.", "error");
           }
        }

        confirmDetails.innerHTML = `
          <div style="text-align:center; padding: 10px 0;">
             <div style="width:64px; height:64px; background:rgba(41,98,255,0.15); color:var(--blue); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:28px;"><i class="fa-solid fa-shield-halved"></i></div>
             <h3 style="margin-bottom:8px; font-size:18px; color:var(--text);">Verify Delivery</h3>
             <p style="color:var(--muted); font-size:14px; margin-bottom:24px; line-height:1.5;">Ask customer for the 4-digit code sent to their email.</p>
             <input type="text" id="delivery-code-input" style="width:100%; padding:16px; border-radius:12px; border:1px solid var(--border); background:var(--bg); text-align:center; font-size:24px; letter-spacing:8px; font-weight:bold;" placeholder="0000" maxlength="4" inputmode="numeric">
             <button class="btn ghost" id="resendCodeBtn" onclick="resendVerificationCode('${orderId}')" style="margin-top:12px; width:100%; font-size:13px; color:var(--blue);">
               <i class="fa-solid fa-paper-plane"></i> Resend Code
             </button>
          </div>
        `;
      }

      confirmOverlay.style.display = "flex";
    }

    confirmNo.addEventListener("click", ()=>{
      confirmOverlay.style.display = "none";
      completingOrder = null;
      // Reset styles for next time
      confirmText.style.display = 'block';
      confirmDetails.style.background = '';
      confirmDetails.style.border = '';
      confirmDetails.className = 'kv';
    });

    confirmYes.addEventListener("click", async ()=>{
      if(!completingOrder) return;
      const orderId = completingOrder.id;
      const o = completingOrder;
      const pay = o.paymentMethod || o.paymentOption || "Cash on Delivery";
      const isCash = pay.toLowerCase().includes("cash");

      if(isCash){
        const amountInput = document.getElementById('delivery-amount-received');
        const total = o.total || o.totalAmount || 0;
        const received = parseFloat(amountInput ? amountInput.value : 0);
        if(isNaN(received) || received < total){
            showToast("Invalid Amount", `Please collect full amount: ${money(total)}`, "error");
            return;
        }
      } else {
        const codeInput = document.getElementById('delivery-code-input');
        const entered = codeInput ? codeInput.value.trim() : "";
        const actual = o.deliveryVerificationCode;
        if(!actual || entered !== actual){
            showToast("Wrong Code", "Verification code is incorrect.", "error");
            return;
        }
      }
      const isMpesa = !pay.toLowerCase().includes("cash");

      try{
        await updateDoc(doc(db, "orders", orderId), {
          status: "Delivered",
          deliveredAt: nowISO(),
          deliveredBy: currentRider?.id || "",
          deliveryConfirmed: true
        });

        // If M-Pesa (Paid), send proof of delivery email
        if(isMpesa){
           const deliveryCode = "DEL-" + Math.random().toString(36).substr(2, 6).toUpperCase();
           const customerEmail = o.userEmail || (o.customer ? o.customer.email : null);
           
           if(customerEmail){
             await addDoc(collection(db, "mail"), {
                to: customerEmail,
                message: {
                  subject: `Order Delivered - Proof of Delivery`,
                  html: `
                    <div style="font-family:sans-serif; padding:24px; border:1px solid #eee; border-radius:12px; max-width:600px; margin:0 auto;">
                      <h2 style="color:#00C853; margin-top:0;">Order Delivered Successfully</h2>
                      <p style="color:#555; font-size:16px;">Hi ${o.customer?.name || o.customerName || 'Customer'},</p>
                      <p style="color:#555; line-height:1.5;">Your order <b>#${orderId}</b> has been successfully delivered by ${currentRider?.name || 'our rider'}.</p>
                      
                      <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin:24px 0; text-align:center; border:1px dashed #ddd;">
                        <p style="margin:0; font-size:12px; color:#888; font-weight:bold; letter-spacing:1px;">PROOF OF DELIVERY CODE</p>
                        <h1 style="margin:12px 0; letter-spacing:4px; color:#333; font-size:32px;">${deliveryCode}</h1>
                        <p style="margin:0; font-size:14px; color:#00C853; font-weight:bold;">Paid via ${pay}</p>
                      </div>

                      <p style="color:#888; font-size:14px;">Thank you for shopping with Prince Alex Store!</p>
                    </div>
                  `
                },
                emailType: "proof_of_delivery",
                orderId: orderId,
                deliveryCode: deliveryCode,
                createdAt: nowISO()
             });
           }
        }

        showToast("Delivered", `Order #${orderId} marked as Delivered.`, "success");
        confirmOverlay.style.display = "none";
        completingOrder = null;
        confirmText.style.display = 'block';
        confirmDetails.style.background = '';
        confirmDetails.className = 'kv';
        drawer.classList.remove("open");
        setView("history");
      }catch(err){
        showToast("Update Failed", getFriendlyErrorMessage(err), "error");
      }
    });

    // --- Map (Leaflet - No API Key) ---
    let map = null;
    let riderMarker = null;
    let destMarker = null;

    window.initializeMap = function initializeMap(){
      if(map) return;

      // Default: Nairobi
      const defaultLoc = [-1.2921, 36.8219];
      map = L.map('map').setView(defaultLoc, 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      // Live rider location marker
      if(navigator.geolocation){
        navigator.geolocation.watchPosition((pos)=>{
          const loc = [pos.coords.latitude, pos.coords.longitude];
          if(!riderMarker){
            riderMarker = L.marker(loc).addTo(map).bindPopup("You");
            // If no destination focused, center on rider
            if(!destMarker) map.setView(loc, 15);
          }else{
            riderMarker.setLatLng(loc);
          }
        }, (err)=>{ console.warn("Location access denied or error", err); }, { enableHighAccuracy:true, maximumAge: 10000, timeout: 10000 });
      }
    };

    function updateMapFocus(order){
      if(!map) return;
      const c = order.customer || {};
      
      // Extract coordinates with support for nested location object (from index.html)
      let lat = c.location?.latitude || c.lat || c.latitude || order.lat;
      let lng = c.location?.longitude || c.lng || c.longitude || order.lng;

      if(!lat || !lng) return;

      const loc = [Number(lat), Number(lng)];
      const popupContent = `
        <div style="font-size:13px; font-weight:600; color:#333;">
          Order #${order.id}<br>
          <span style="font-weight:400">${c.fullName || c.name || 'Customer'}</span>
        </div>
      `;

      if(!destMarker){
        destMarker = L.marker(loc).addTo(map).bindPopup(popupContent).openPopup();
      }else{
        destMarker.setLatLng(loc).bindPopup(popupContent).openPopup();
      }
      
      if(riderMarker){
         const group = new L.featureGroup([riderMarker, destMarker]);
         map.fitBounds(group.getBounds(), {padding: [50, 50]});
      } else {
         map.setView(loc, 15);
      }
      document.getElementById("mapSmall").textContent = `Focused: Order #${order.id}`;
    }

    // Initialize map immediately
    initializeMap();

    // Ask notification permission once
    document.addEventListener("DOMContentLoaded", ()=>{
      if("Notification" in window && Notification.permission !== "denied"){
        Notification.requestPermission().catch(()=>{});
      }
      setStatusUI();
    });

    // --- Auth State ---
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;

      // reset
      stopListeners();
      allRealtime = []; availableOrders = []; myActiveOrders = []; myHistory = [];
      firstOrdersLoad = true; prevAvailableIds = new Set();
      activeFocusOrder = null;
      drawer.classList.remove("open");

      if(!user){
        currentRider = null;
        loginOverlay.style.display = "flex";
        riderChip.style.display = "none";
        riderStatus = "offline";
        setStatusUI();
        setView("available");
        render();
        return;
      }

      // load rider doc
      const riderRef = doc(db, "riders", user.email);
      const snap = await getDoc(riderRef);

      if(!snap.exists()){
        // signed in without applying
        await signOut(auth);
        loginMessage.innerHTML = `<span style="color:#FF4D4D;font-weight:900">Account not found. Please Apply first.</span>`;
        loginOverlay.style.display = "flex";
        return;
      }

      currentRider = { id: snap.id, ...snap.data() };

      // show chip
      riderChip.style.display = "flex";
      riderAvatar.src = currentRider.photoURL || "https://ui-avatars.com/api/?background=0b1220&color=ffffff&name=Rider";
      riderName.textContent = safe(currentRider.name,"Rider");
      riderEmail.textContent = safe(currentRider.email, currentRider.id);

      loginOverlay.style.display = "none";

      // status from firestore
      riderStatus = currentRider.availability === "online" ? "online" : "offline";
      setStatusUI();

      // start listeners
      startListeners();

      // default view
      setView("available");
      render();
    });
  </script>
</body>
</html>
