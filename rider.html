<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Prince Alex Store - Rider Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... existing styles ... */
        :root {
            --primary-color: #00C853;
            --secondary-color: #00E676;
            --accent-color: #2962FF;
            --dark-text: #1a1a1a;
            --text-color: #555555;
            --light-bg: #f4f6f8;
            --white: #ffffff;
            --border-color: #eef2f5;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s ease;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            height: var(--header-height);
            display: flex;
            align-items: center;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .rider-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .rider-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .rider-status.online {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .rider-status.offline {
            background: #ffebee;
            color: #f44336;
        }

        .status-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        #rider-logout-btn {
            background: #f44336;
            color: white;
        }

        .status-toggle:hover {
            background: var(--secondary-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px 0;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 30px;
            text-align: center;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Orders Section */
        .orders-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--white);
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .filter-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-tab:hover {
            border-color: var(--primary-color);
        }

        /* Orders List */
        .orders-list {
            display: grid;
            gap: 20px;
        }

        .order-card {
            background: var(--light-bg);
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            transition: var(--transition);
            position: relative;
        }

        .order-card.active-delivery {
            background: #fff;
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }

        .order-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .order-id {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-status.processing {
            background: #e2e3e5;
            color: #383d41;
        }

        .order-status.on-transit {
            background: #cce5ff;
            color: #004085;
        }

        .order-status.delivered {
            background: #d4edda;
            color: #155724;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .order-detail {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 600;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 14px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .customer-location {
            background: #e8f5e8;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            margin: 10px 0;
        }

        .location-text {
            font-size: 14px;
            color: var(--dark-text);
            margin-bottom: 5px;
        }

        .coordinates {
            font-size: 12px;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.accept {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.accept:hover {
            background: var(--secondary-color);
        }

        .action-btn.navigate {
            background: #1976d2;
            color: white;
        }

        .action-btn.navigate:hover {
            background: #1565c0;
        }

        .action-btn.complete {
            background: #4CAF50;
            color: white;
        }

        .action-btn.complete:hover {
            background: #45a049;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Login Overlay */
        #rider-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-hover);
        }

        /* Loading States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
        }

        .loading-state i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 64px;
            color: #ccc;
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                height: auto;
                padding: 10px 0;
            }

            .header-content {
                flex-wrap: wrap;
                gap: 10px;
            }

            .logo {
                font-size: 20px;
            }

            .rider-info {
                flex-wrap: wrap;
                justify-content: flex-end;
                gap: 8px;
            }

            .rider-status, .status-toggle {
                padding: 6px 12px;
                font-size: 12px;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .filter-tabs {
                flex-wrap: wrap;
            }

            .order-details {
                grid-template-columns: 1fr;
            }

            .order-actions {
                flex-direction: column;
            }
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .dashboard-layout {
                grid-template-columns: 400px 1fr; /* Sidebar | Map */
                align-items: stretch;
                flex: 1;
                min-height: 0;
                overflow: hidden;
                padding-bottom: 20px;
            }
            
            .main-content {
                height: calc(100vh - var(--header-height));
                overflow: hidden;
                padding-bottom: 0;
            }
            
            .container {
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .orders-section, .map-section {
                height: 100%;
                overflow-y: auto;
                margin-bottom: 0;
            }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="rider-login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 10px; color: var(--dark-text);">Rider Partner Program</h2>
            <p style="margin-bottom: 25px; color: var(--text-color); font-size: 15px;">Join our team or sign in to your account.</p>
            <button id="google-signup-btn" class="status-toggle" style="width:100%; display:flex; align-items:center; justify-content:center; gap:10px; background:var(--primary-color); color:white; margin-bottom: 15px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="background:white; border-radius:50%; padding:2px;"> Apply with Google
            </button>
            <button id="google-login-btn" class="status-toggle" style="width:100%; display:flex; align-items:center; justify-content:center; gap:10px; background:white; color:#333; border:1px solid #ccc;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign In with Google
            </button>
            <div id="login-message" style="margin-top:20px; font-size:14px; min-height: 20px;"></div>
        </div>
    </div>

    <!-- Profile Update Overlay -->
    <div id="profile-update-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: var(--dark-text);">Complete Your Profile</h2>
            <p style="margin-bottom: 20px; color: var(--text-color);">Please provide your details to start working.</p>
            <form id="profile-update-form" style="text-align: left;">
                <label for="profile-phone" style="font-weight: 600; display: block; margin-bottom: 5px;">Phone Number</label>
                <input type="tel" id="profile-phone" placeholder="e.g., 0712345678" required style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc;">
                
                <label for="profile-vehicle-model" style="font-weight: 600; display: block; margin-bottom: 5px;">Vehicle Model</label>
                <input type="text" id="profile-vehicle-model" placeholder="e.g., Boxer 150" required style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc;">
                
                <label for="profile-license-plate" style="font-weight: 600; display: block; margin-bottom: 5px;">License Plate</label>
                <input type="text" id="profile-license-plate" placeholder="e.g., KMC A123B" required style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ccc;">
                
                <button type="submit" class="status-toggle" style="width: 100%;">Save and Start Working</button>
            </form>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-motorcycle"></i> Prince Alex Store - Rider
                </div>
                <div class="rider-info">
                    <span id="rider-name-display" style="font-weight: 600;"></span>
                    <div class="rider-status offline" id="rider-status">
                        <i class="fas fa-circle"></i>
                        <span>Offline</span>
                    </div>
                    <button class="status-toggle" id="status-toggle" onclick="toggleRiderStatus()">
                        Go Online
                    </button>
                    <button id="rider-logout-btn" class="status-toggle" onclick="handleLogout()">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Rider Dashboard</h1>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pending-orders">0</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="stat-number" id="delivered-orders">0</div>
                    <div class="stat-label">Delivered Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-number" id="rating">4.8</div>
                    <div class="stat-label">Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-number" id="total-earnings">KES 0</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
            </div>

            <div class="dashboard-layout">
            <!-- Orders Section -->
            <div class="orders-section">
                <div class="section-header">
                    <h2 class="section-title">Orders</h2>
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-status="available" onclick="filterOrders('available')">Available Jobs</div>
                        <div class="filter-tab" data-status="mine" onclick="filterOrders('mine')">My Deliveries</div>
                        <div class="filter-tab" data-status="history" onclick="filterOrders('history')">History</div>
                    </div>
                </div>
                <div class="orders-list" id="orders-list">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading orders...</p>
                    </div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="map-section">
                <h2 class="section-title">Delivery Map</h2>
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px;">
        <div class="login-box" style="animation: slideInUp 0.3s ease; max-width: 450px;">
            <h2 id="confirmation-title" style="margin-bottom: 15px; color: var(--dark-text);">Confirm Delivery</h2>
            <p id="confirmation-message" style="margin-bottom: 25px; color: var(--text-color); font-size: 16px; line-height: 1.5;">
                Are you sure you have delivered this order and received the correct payment?
            </p>
            <div id="confirmation-details" style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: left; border: 1px solid var(--border-color);">
                <!-- Details will be injected here -->
            </div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="confirm-yes-btn" class="status-toggle" style="background: var(--primary-color); flex: 1;">Yes, Complete</button>
                <button id="confirm-no-btn" class="status-toggle" style="background: #6c757d; flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, where, onSnapshot, doc, updateDoc, limit, getDoc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables
        let riderStatus = 'offline';
        let allOrders = []; // Will hold all relevant orders for the rider
        let myOrders = []; // Orders assigned to this rider
        let availableOrders = []; // Orders ready for pickup
        let myHistory = []; // Delivered orders for history
        let filteredOrders = []; // Orders to be displayed based on tab
        let currentRider = null; // To store rider info
        let map;
        let riderMarker = null;
        let destinationMarker = null;
        let ordersUnsubscribe = null; // To store the listener unsubscribe function
        let riderDocUnsubscribe = null; // To store the rider doc listener
        let isAppInitialized = false; // Track if app has been initialized
        let previousAvailableOrderIds = new Set();
        let isFirstLoad = true;
        const notificationSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            const loginOverlay = document.getElementById('rider-login-overlay');
            const logoutBtn = document.getElementById('rider-logout-btn');
            const profileUpdateOverlay = document.getElementById('profile-update-overlay');
            const profileUpdateForm = document.getElementById('profile-update-form');

            if (profileUpdateForm) {
                profileUpdateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const phone = document.getElementById('profile-phone').value.trim();
                    const vehicleModel = document.getElementById('profile-vehicle-model').value.trim();
                    const licensePlate = document.getElementById('profile-license-plate').value.trim().toUpperCase();

                    if (!phone || !vehicleModel || !licensePlate) {
                        showError("Please fill all fields.");
                        return;
                    }

                    if (!currentRider) {
                        showError("Rider data not found. Please re-login.");
                        return;
                    }

                    try {
                        const riderRef = doc(db, 'riders', currentRider.id);
                        await updateDoc(riderRef, {
                            phone: phone,
                            vehicle: { model: vehicleModel, plate: licensePlate },
                            status: 'active' // Promote rider to active
                        });

                        profileUpdateOverlay.style.display = 'none';
                        showSuccess("Profile updated! You can now start working.");
                        location.reload(); // Easiest way to re-trigger auth state and load app
                    } catch (error) {
                        console.error("Error updating profile:", error);
                        showError("Failed to update profile: " + error.message);
                    }
                });
            }

            const handleGoogleAuth = async (event) => {
                const isSignup = event.currentTarget.id === 'google-signup-btn';
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;

                    // Check if rider exists
                    const riderRef = doc(db, 'riders', user.email);
                    const riderSnap = await getDoc(riderRef);

                    if (isSignup && !riderSnap.exists()) {
                        // Create new rider doc
                        await setDoc(riderRef, {
                            name: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            phone: user.phoneNumber || ''
                        });

                        // Send email
                        await addDoc(collection(db, 'mail'), {
                            to: user.email,
                            message: {
                                subject: 'Application Received - Prince Alex Store Rider',
                                html: `
                                    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                        <div style="background-color: #4CAF50; padding: 20px; text-align: center; color: white;">
                                            <h2 style="margin: 0;">Application Received</h2>
                                        </div>
                                        <div style="padding: 30px;">
                                            <p style="font-size: 16px; color: #333;">Hi ${user.displayName},</p>
                                            <p style="font-size: 16px; color: #555; line-height: 1.6;">Thank you for applying to join Prince Alex Store as a rider partner.</p>
                                            <p style="font-size: 16px; color: #555; line-height: 1.6;">Your application has been received and is currently <strong>pending approval</strong>. Our team will review your details shortly.</p>
                                            <p style="font-size: 16px; color: #555; line-height: 1.6;">You will receive another email notification once your account status is updated.</p>
                                        </div>
                                    </div>
                                `
                            },
                            emailType: 'rider_application',
                            createdAt: new Date().toISOString(),
                            status: 'pending',
                            priority: 'high'
                        });
                    } else if (!isSignup && !riderSnap.exists()) {
                        // Login attempted but no account
                        await signOut(auth);
                        const msgEl = document.getElementById('login-message');
                        if(msgEl) msgEl.innerHTML = `<span style="color:red; font-weight:bold;">Account not found. Please Apply first.</span>`;
                        return;
                    }
                } catch (error) {
                    console.error("Login failed", error);
                    const msgEl = document.getElementById('login-message');
                    if (msgEl) {
                        let userMsg = "Unable to sign in. Please try again.";
                        if (error.code === 'auth/popup-closed-by-user') userMsg = "Sign-in was cancelled.";
                        else if (error.code === 'auth/network-request-failed') userMsg = "Network error. Please check your connection.";
                        
                        msgEl.innerHTML = `<span style="color:red">${userMsg}</span>`;
                    }
                }
            };

            document.getElementById('google-login-btn').addEventListener('click', handleGoogleAuth);
            document.getElementById('google-signup-btn').addEventListener('click', handleGoogleAuth);

            onAuthStateChanged(auth, async (user) => {
                // Clean up previous rider listener if exists
                if (riderDocUnsubscribe) {
                    riderDocUnsubscribe();
                    riderDocUnsubscribe = null;
                }

                if (user) {
                    const msgEl = document.getElementById('login-message');
                    if(msgEl) msgEl.textContent = "Checking account status...";
                    
                    const riderRef = doc(db, 'riders', user.email);
                    
                    // Real-time listener for rider status
                    riderDocUnsubscribe = onSnapshot(riderRef, async (riderSnap) => {
                        if (!riderSnap.exists()) {
                            if(msgEl) msgEl.innerHTML = `<span style="color:red; font-weight:bold;">Account not found. Please use 'Apply with Google' if you are new.</span>`;
                        } else {
                            const data = riderSnap.data();
                            currentRider = { id: user.email, ...data };

                            // Update UI elements
                            const nameDisplay = document.getElementById('rider-name-display');
                            if (nameDisplay) nameDisplay.textContent = `Rider: ${data.name}`;

                            if (data.status === 'active') {
                                loginOverlay.style.display = 'none';
                                profileUpdateOverlay.style.display = 'none';
                                if (!isAppInitialized) {
                                    initRiderApp();
                                    isAppInitialized = true;
                                }
                            } else if (data.status === 'approved') {
                                loginOverlay.style.display = 'none';
                                profileUpdateOverlay.style.display = 'flex';
                            } else {
                                // Pending, Suspended, or Unknown
                                loginOverlay.style.display = 'flex';
                                profileUpdateOverlay.style.display = 'none';
                                
                                let statusMsg = '';
                                if (data.status === 'pending') statusMsg = `<span style="color:orange; font-weight:bold;">Account Pending Approval. Please wait for admin confirmation.</span>`;
                                else if (data.status === 'suspended') statusMsg = `<span style="color:red; font-weight:bold;">Account Suspended. Contact support.</span>`;
                                else statusMsg = `<span style="color:red; font-weight:bold;">Account ${data.status}. Contact support.</span>`;

                                if(msgEl) {
                                    msgEl.innerHTML = statusMsg;
                                    if (!document.getElementById('overlay-signout-btn')) {
                                        const soBtn = document.createElement('button');
                                        soBtn.id = 'overlay-signout-btn';
                                        soBtn.textContent = "Sign Out";
                                        soBtn.style.cssText = "display:block; margin:15px auto 0; padding:8px 16px; border:1px solid #ccc; background:#f8f9fa; cursor:pointer; border-radius:4px; font-size:13px;";
                                        soBtn.onclick = async () => { await signOut(auth); location.reload(); };
                                        msgEl.appendChild(soBtn);
                                    }
                                }
                            }
                        }
                    });
                } else {
                    loginOverlay.style.display = 'flex';
                    if(profileUpdateOverlay) profileUpdateOverlay.style.display = 'none';
                    currentRider = null;
                    isAppInitialized = false;
                    if (ordersUnsubscribe) ordersUnsubscribe();
                }
            });
        });

        function initRiderApp() {
            initializeMap();
            if ("Notification" in window && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
            startRealTimeUpdates();
        }

        // Initialize Google Maps
        function initializeMap() {
            if (typeof google === 'undefined') return;
            if (map) return; // Prevent re-initialization

            const defaultLocation = { lat: -1.2921, lng: 36.8219 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: defaultLocation,
                mapTypeId: 'roadmap',
                streetViewControl: false,
                mapTypeControl: false
            });

            // Watch rider's current location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((position) => {
                    const riderLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (!riderMarker) {
                        map.setCenter(riderLocation);
                        riderMarker = new google.maps.Marker({
                            position: riderLocation,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                            }
                        });
                    } else {
                        riderMarker.setPosition(riderLocation);
                    }
                });
            }
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            if (ordersUnsubscribe) {
                ordersUnsubscribe(); // Unsubscribe from previous listener if it exists
            }

            const ordersRef = collection(db, 'orders');
            // Query for orders that are either 'Ready for Pickup' OR assigned to the current rider
            const ordersQuery = query(ordersRef, where('status', 'in', ['Ready for Pickup', 'On Transit']));
            
            ordersUnsubscribe = onSnapshot(ordersQuery, (snapshot) => {
                allOrders = [];
                snapshot.forEach((doc) => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });

                // Separate orders into available and my deliveries
                availableOrders = allOrders.filter(order => order.status === 'Ready for Pickup');
                myOrders = allOrders.filter(order => order.status === 'On Transit' && order.riderId === currentRider.id);

                // Check for new available orders to notify
                if (!isFirstLoad && riderStatus === 'online') {
                    const newOrders = availableOrders.filter(o => !previousAvailableOrderIds.has(o.id));
                    newOrders.forEach(order => notifyRider(order));
                }
                previousAvailableOrderIds = new Set(availableOrders.map(o => o.id));
                isFirstLoad = false;

                updateStats();
                // Display orders based on the currently active tab
                const currentFilter = getCurrentFilter();
                filterOrders(currentFilter);
            });

            // Separate listener for History (Delivered orders)
            // Note: This requires a composite index on [riderId, status]. If missing, it might fail or require client-side filtering.
            // For simplicity/robustness without index, we can query by riderId and filter client-side if dataset is small, 
            // but here we'll try the specific query.
            const historyQuery = query(ordersRef, where('riderId', '==', currentRider.id), where('status', '==', 'Delivered'), limit(50));
            
            onSnapshot(historyQuery, (snapshot) => {
                myHistory = [];
                snapshot.forEach((doc) => {
                    myHistory.push({ id: doc.id, ...doc.data() });
                });
                // Sort client-side
                myHistory.sort((a, b) => new Date(b.deliveredAt || b.date) - new Date(a.deliveredAt || a.date));
                
                updateStats();
                if (getCurrentFilter() === 'history') filterOrders('history');
            });
        }

        // Notify rider of new order
        function notifyRider(order) {
            // 1. Play Sound
            notificationSound.play().catch(e => console.log("Audio play failed", e));

            // 2. Show In-App Toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white;
                padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999; cursor: pointer; animation: slideInRight 0.3s ease; font-weight: 600;
                display: flex; align-items: center; gap: 12px;
            `;
            toast.innerHTML = `<i class="fas fa-bell" style="font-size: 1.2em;"></i> <div><div>New Order #${order.id}</div><div style="font-size:0.85em; font-weight:normal; opacity:0.9;">${order.customer?.deliveryLocation || 'New location'}</div></div>`;
            
            toast.onclick = () => {
                filterOrders('available');
                toast.remove();
            };
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 30000); // Keep visible for 30 seconds

            // 3. System Notification
            if ("Notification" in window && Notification.permission === "granted") {
                const notif = new Notification("New Delivery Request ðŸ“¦", {
                    body: `Order #${order.id} is ready for pickup at ${order.customer?.deliveryLocation || 'Location'}`,
                    requireInteraction: true // Keep notification until user interacts
                });
                notif.onclick = () => {
                    window.focus();
                    filterOrders('available');
                };
            }
        }

        // Update statistics
        function updateStats() {
            // Stats can now be more specific
            document.getElementById('total-orders').textContent = myOrders.length + myHistory.length;
            document.getElementById('pending-orders').textContent = availableOrders.length;
            
            const deliveredToday = myHistory.filter(order => {
                const orderDate = new Date(order.deliveredAt || order.date); 
                const today = new Date();
                return orderDate.toDateString() === today.toDateString();
            }).length;
            document.getElementById('delivered-orders').textContent = deliveredToday;

            // Calculate Total Earnings
            const totalEarnings = myHistory.reduce((sum, order) => sum + (Number(order.riderFee) || Number(order.transportationFee) || 0), 0);
            document.getElementById('total-earnings').textContent = `KES ${totalEarnings.toLocaleString()}`;
        }

        // Filter orders
        function filterOrders(status) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            // Filter orders
            if (status === 'available') {
                filteredOrders = (riderStatus === 'online') ? availableOrders : [];
            } else if (status === 'mine') {
                filteredOrders = myOrders;
            } else if (status === 'history') {
                filteredOrders = myHistory;
            } else { filteredOrders = []; }
            
            displayOrders();
        }

        // Get current filter
        function getCurrentFilter() {
            const activeTab = document.querySelector('.filter-tab.active');
            return activeTab ? activeTab.dataset.status : 'all';
        }

        // Display orders
        function displayOrders() {
            const ordersList = document.getElementById('orders-list');
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = ` 
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No orders in this category.</p>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = filteredOrders.map(order => {
                const statusClass = order.status ? order.status.toLowerCase().replace(' ', '-') : 'pending';
                const fee = order.riderFee || order.transportationFee || 0;
                
                const isActive = order.status === 'On Transit' && order.riderId === currentRider.id;
                const activeClass = isActive ? 'active-delivery' : '';

                let actionButtonHtml = '';
                if (order.status === 'Ready for Pickup' && riderStatus === 'online') {
                    actionButtonHtml = `
                        <button class="action-btn accept" onclick="acceptOrder('${order.id}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                    `;
                } else if (order.status === 'On Transit' && order.riderId === currentRider.id) {
                    actionButtonHtml = `
                        <button class="action-btn navigate" onclick="navigateToOrder('${order.id}')">
                            <i class="fas fa-route"></i> Navigate
                        </button>
                        <button class="action-btn complete" onclick="completeOrder('${order.id}')">
                            <i class="fas fa-check-circle"></i> Mark Delivered
                        </button>
                    `;
                }
                
                return `
                    <div class="order-card ${activeClass}">
                        <div class="order-header">
                            <div class="order-id">Order #${order.id}</div>
                            <div class="order-status ${statusClass}">${order.status}</div>
                        </div>
                        
                        <div class="order-details">
                            <div class="order-detail">
                                <div class="detail-label">Customer</div>
                                <div class="detail-value">${order.customer ? order.customer.fullName : 'N/A'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="detail-label">Earnings</div>
                                <div class="detail-value" style="color: var(--primary-color); font-weight: bold;">KES ${fee}</div>
                            </div>
                            <div class="order-detail">
                                <div class="detail-label">Total</div>
                                <div class="detail-value">KES ${order.total ? order.total.toFixed(2) : '0.00'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="detail-label">Date</div>
                                <div class="detail-value">${new Date(order.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        
                        ${order.customer && order.customer.location ? `
                            <div class="customer-location">
                                <div class="location-text">
                                    <i class="fas fa-map-marker-alt"></i> 
                                    ${order.customer.deliveryLocation}
                                </div>
                                <div class="coordinates">
                                    ${order.customer.location.latitude ? 
                                        `${order.customer.location.latitude.toFixed(6)}, ${order.customer.location.longitude.toFixed(6)}` : 
                                        'No coordinates available'
                                    }
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="order-actions">
                            ${actionButtonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle rider status
        function toggleRiderStatus() {
            riderStatus = riderStatus === 'offline' ? 'online' : 'offline';
            
            const statusElement = document.getElementById('rider-status');
            const toggleButton = document.getElementById('status-toggle');
            
            if (riderStatus === 'online') {
                statusElement.className = 'rider-status online';
                statusElement.innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                toggleButton.textContent = 'Go Offline';
            } else {
                statusElement.className = 'rider-status offline';
                statusElement.innerHTML = '<i class="fas fa-circle"></i><span>Offline</span>';
                toggleButton.textContent = 'Go Online';
            }
            
            // Refresh orders to update action buttons
            const currentFilter = getCurrentFilter();
            filterOrders(currentFilter);
        }

        async function sendDeliveryConfirmationWithVoucher(order) {
            try {
                const customerEmail = order.userEmail || (order.customer ? order.customer.email : null);
                if (!customerEmail) {
                    console.log('No customer email found, skipping delivery confirmation email');
                    return;
                }

                const customerName = order.customer ? order.customer.fullName : 'Valued Customer';
                
                // Generate random voucher code
                const voucherCode = 'THANKYOU' + Math.random().toString(36).substring(2, 7).toUpperCase();
                const voucherValue = 50; // KES 50
                
                // Create voucher in Firestore
                const now = new Date();
                const expiryDate = new Date();
                expiryDate.setDate(now.getDate() + 30); // 30 days expiry
                
                const voucherData = {
                    id: voucherCode,
                    code: voucherCode,
                    description: 'Thank you gift for your delivered order',
                    discountType: 'fixed',
                    discountAmount: voucherValue,
                    minOrderAmount: 200,
                    usageLimit: 1,
                    usageCount: 0,
                    expiryDate: expiryDate.toISOString(),
                    isActive: true,
                    allowedEmail: customerEmail,
                    terms: 'One-time use. Valid for 30 days.',
                    createdAt: new Date().toISOString(),
                    createdBy: 'system_delivery_rider'
                };
                
                await setDoc(doc(db, 'vouchers', voucherCode), voucherData);
                console.log(`Generated thank you voucher ${voucherCode} for ${customerEmail}`);

                // Send Email
                await addDoc(collection(db, 'mail'), {
                    to: customerEmail,
                    message: {
                        subject: `Order Delivered! ðŸ“¦ Plus a Gift for You ðŸŽ`,
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 30px; text-align: center; color: white;">
                                    <h1 style="margin: 0; font-size: 28px;">Order Delivered! âœ…</h1>
                                    <p style="margin: 10px 0 0 0; font-size: 16px;">Your fresh vegetables have arrived.</p>
                                </div>
                                <div style="padding: 30px; background: white;">
                                    <p style="font-size: 16px; color: #333;">Hello ${customerName},</p>
                                    <p style="font-size: 16px; color: #333;">We are pleased to inform you that your order <strong>#${order.id}</strong> has been successfully delivered by our rider.</p>
                                    <p style="font-size: 16px; color: #333;">We hope you enjoy your fresh produce! If you have any issues with your order or if anything is missing, please don't hesitate to reach out to us.</p>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196F3;">
                                        <h4 style="color: #2196F3; margin: 0 0 10px 0;">ðŸ“ž Support Contact</h4>
                                        <p style="margin: 5px 0;"><strong>Phone:</strong> 0717384875</p>
                                        <p style="margin: 5px 0;"><strong>Email:</strong> info@princealex.pro</p>
                                    </div>
                                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; border: 1px solid #ffeeba;">
                                        <h3 style="color: #856404; margin: 0 0 15px 0;">ðŸŽ A Thank You Gift!</h3>
                                        <p style="margin: 5px 0; color: #856404;">As a token of our appreciation, please enjoy this voucher on your next order:</p>
                                        <div style="background: #FF6B35; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; display: inline-block; min-width: 200px;">
                                            <div style="font-size: 24px; font-weight: 700; letter-spacing: 1px;">${voucherCode}</div>
                                            <div style="font-size: 14px; margin-top: 5px;">KES ${voucherValue} OFF</div>
                                        </div>
                                        <p style="margin: 5px 0; color: #856404; font-size: 12px;">Valid for 30 days â€¢ Min order KES 200</p>
                                    </div>
                                    <div style="text-align: center; margin-top: 30px;">
                                        <a href="https://store.princealex.pro" style="display: inline-block; background: #4CAF50; color: white; padding: 12px 25px; text-decoration: none; border-radius: 50px; font-weight: bold;">Shop Again</a>
                                    </div>
                                    <p style="font-size: 14px; color: #666; margin-top: 30px; text-align: center;">Thank you for choosing Prince Alex Store!</p>
                                </div>
                            </div>
                        `
                    },
                    emailType: 'order_delivered',
                    orderId: order.id,
                    customerEmail: customerEmail,
                    customerName: customerName,
                    voucherCode: voucherCode,
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    priority: 'high'
                });
                console.log(`Delivery confirmation email queued for ${customerEmail}`);
            } catch (error) {
                console.error("Error sending delivery confirmation:", error);
                // Don't show an error to the rider, just log it.
            }
        }

        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, detailsHtml, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').innerHTML = message;
            document.getElementById('confirmation-details').innerHTML = detailsHtml;

            const modal = document.getElementById('confirmation-modal');
            modal.style.display = 'flex';

            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');

            // Clone and replace to remove old event listeners, this is a robust way
            const newYesBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            
            newYesBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });

            noBtn.onclick = hideConfirmationModal;
        }

        // Accept order
        window.acceptOrder = async function(orderId) {
            if (!currentRider) {
                showError('You must be logged in to accept orders.');
                return;
            }
            if (!confirm('Are you sure you want to accept this delivery?')) {
                return;
            }

            try {
                const orderRef = doc(db, 'orders', orderId);
                await updateDoc(orderRef, {
                    status: 'On Transit',
                    riderId: currentRider.id,
                    riderName: currentRider.name,
                    riderAcceptedAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                });
                
                showSuccess('Order accepted! It has been moved to "My Deliveries".');
                // The onSnapshot listener will automatically refresh the UI.
            } catch (error) {
                console.error('Error accepting order:', error);
                showError('Failed to accept order. It may have been taken by another rider.');
            }
        }

        // Navigate to order
        window.navigateToOrder = async function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.customer) {
                showError('Order details not found');
                return;
            }
            
            // This is redundant if the button only shows for 'On Transit' orders, but safe to keep.
            if (order.status !== 'On Transit') {
                await updateOrderStatus(orderId, 'On Transit');
            }
            
            let destination = null;
            let destinationAddress = null;

            if (order.customer.location && order.customer.location.latitude && order.customer.location.longitude) {
                const { latitude, longitude } = order.customer.location;
                destination = { lat: latitude, lng: longitude };
                destinationAddress = `${latitude},${longitude}`;
            } else if (order.customer.deliveryLocation) {
                // Fallback to address string
                destinationAddress = encodeURIComponent(order.customer.deliveryLocation);
            } else {
                showError('Location not available for this order');
                return;
            }

            // Open Google Maps with directions
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationAddress}`;
            window.open(mapsUrl, '_blank');
            
            // Update embedded map to show destination marker
            if (map && destination) {
                // Remove previous destination marker if it exists
                if (destinationMarker) {
                    destinationMarker.setMap(null);
                }
                
                // Add new destination marker
                destinationMarker = new google.maps.Marker({
                    position: destination,
                    map: map,
                    title: `Delivery to ${order.customer.fullName}`,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    }
                });

                // Adjust map bounds to show both rider and destination
                if (riderMarker) {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(riderMarker.getPosition());
                    bounds.extend(destinationMarker.getPosition());
                    map.fitBounds(bounds);
                } else {
                    map.setCenter(destination);
                    map.setZoom(15);
                }
            }
        }

        function hideConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            modal.style.display = 'none';
        }

        // Complete order
        window.completeOrder = async function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showError("Order details not found.");
                return;
            }

            const paymentMethod = order.paymentMethod || 'Cash on Delivery';
            const totalAmount = order.total ? order.total.toFixed(2) : '0.00';

            const title = 'Confirm Delivery';
            const message = `Please confirm you have delivered order <strong>#${orderId}</strong> and received the correct payment.`;
            const detailsHtml = `
                <div style="font-size: 14px;">
                    <p style="display:flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Order ID:</span> 
                        <strong style="font-family: monospace;">${orderId}</strong>
                    </p>
                    <p style="display:flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Payment Method:</span> 
                        <strong>${paymentMethod}</strong>
                    </p>
                    <p style="display:flex; justify-content: space-between; font-size: 18px; color: var(--primary-color); border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                        <span>Amount to Collect:</span> 
                        <strong>KES ${totalAmount}</strong>
                    </p>
                </div>
            `;

            const onConfirm = async () => {
                try {
                    const orderRef = doc(db, 'orders', orderId);

                    // Update the status first
                    await updateDoc(orderRef, { 
                        status: 'Delivered', 
                        deliveredAt: new Date().toISOString(), 
                        lastUpdated: new Date().toISOString() 
                    });

                    // Then, re-fetch the complete, updated order data to ensure all fields are present for the email
                    const updatedOrderSnap = await getDoc(orderRef);
                    if (!updatedOrderSnap.exists()) {
                        showError('Order could not be found.');
                        return;
                    }
                    const orderData = { id: updatedOrderSnap.id, ...updatedOrderSnap.data() };

                    await sendDeliveryConfirmationWithVoucher(orderData);
                    showSuccess('Order marked as delivered!');
                    // The onSnapshot listener will automatically refresh the UI.
                } catch (error) {
                    console.error('Error completing order:', error);
                    showError('Failed to complete order');
                }
            };

            showConfirmationModal(title, message, detailsHtml, onConfirm);
        }

        // Update order status
        async function updateOrderStatus(orderId, status) {
            try {
                const orderRef = doc(db, 'orders', orderId);
                await updateDoc(orderRef, {
                    status: status,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        }

        // Show success message
        function showSuccess(message) {
            // Simple success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Show error message
        function showError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Global Logout Function
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                location.reload();
            } catch (error) {
                console.error("Logout failed", error);
                showError("Logout failed: " + error.message);
            }
        };

        // Expose functions globally for HTML event handlers and Google Maps callback
        window.toggleRiderStatus = toggleRiderStatus;
        window.filterOrders = filterOrders;
        window.acceptOrder = acceptOrder;
        window.navigateToOrder = navigateToOrder;
        window.completeOrder = completeOrder;
        window.initializeMap = initializeMap;

        // Load Google Maps API dynamically to prevent race conditions
        const script = document.createElement('script');
        script.src = "https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initializeMap";
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
